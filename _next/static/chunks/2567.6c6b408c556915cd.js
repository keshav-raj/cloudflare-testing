(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[2567],{52567:function(t,e,i){"use strict";i.r(e),i.d(e,{default:function(){return Ga}});var n={};i.r(n),i.d(n,{OptionTypes:function(){return sa},create:function(){return la},destroy:function(){return ca},find:function(){return ua},getOptions:function(){return da},parse:function(){return ha},setOptions:function(){return pa},supported:function(){return ra}});var r=i(35230),o=i.n(r),a=i(24246),s=i(2113),l=i(27378),c="https://cdn-getsignedurl.learnyst.com",h={allowedImageTypes:["image/*",".jpg",".jpeg",".png",".gif"]};function u(t,e){return null!=e&&"undefined"!==typeof Symbol&&e[Symbol.hasInstance]?e[Symbol.hasInstance](t):t instanceof e}function d(t){return(d="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function p(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function f(t){for(var e=arguments,i=function(i){var n=null!=e[i]?e[i]:{},r=Object.keys(n);"function"==typeof Object.getOwnPropertySymbols&&(r=r.concat(Object.getOwnPropertySymbols(n).filter((function(t){return Object.getOwnPropertyDescriptor(n,t).enumerable})))),r.forEach((function(e){p(t,e,n[e])}))},n=1;n<arguments.length;n++)i(n);return t}function m(t){throw new Error('"'+t+'" is read-only')}function g(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var i=[],n=!0,r=!1,o=void 0;try{for(var a,s=t[Symbol.iterator]();!(n=(a=s.next()).done)&&(i.push(a.value),!e||i.length!==e);n=!0);}catch(l){r=!0,o=l}finally{try{n||null==s.return||s.return()}finally{if(r)throw o}}return i}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function v(t){return function(t){if(Array.isArray(t)){for(var e=0,i=new Array(t.length);e<t.length;e++)i[e]=t[e];return i}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}var b=function(t){return u(t,HTMLElement)},_=function(t,e){return e.parentNode.insertBefore(t,e)},y=function(t,e){return e.parentNode.insertBefore(t,e.nextSibling)},E=function(t){return"object"===d(t)&&null!==t},T=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[],n=f({},t),r=[],o=[],a=function(t,e,i){i?o.push({type:t,data:e}):(h[t]&&h[t](e),r.push({type:t,data:e}))},s=function(t){for(var e,i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];return c[t]?(e=c)[t].apply(e,n):null},l={getState:function(){return f({},n)},processActionQueue:function(){var t=[].concat(r);return r.length=0,t},processDispatchQueue:function(){var t=[].concat(o);o.length=0,t.forEach((function(t){var e=t.type,i=t.data;a(e,i)}))},dispatch:a,query:s},c={};e.forEach((function(t){c=f({},t(n),c)}));var h={};return i.forEach((function(t){h=f({},t(a,s,n),h)})),l},w=function(t,e){for(var i in t)t.hasOwnProperty(i)&&e(i,t[i])},x=function(t){var e={};return w(t,(function(i){!function(t,e,i){"function"!=typeof i?Object.defineProperty(t,e,i):t[e]=i}(e,i,t[i])})),e},C=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;if(null===i)return t.getAttribute(e)||t.hasAttribute(e);t.setAttribute(e,i)},R="http://www.w3.org/2000/svg",A=["svg","path"],S=function(t){return A.includes(t)},I=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};"object"===d(e)&&(i=e,e=null);var n=S(t)?document.createElementNS(R,t):document.createElement(t);return e&&(S(t)?C(n,"class",e):n.className=e),w(i,(function(t,e){C(n,t,e)})),n},k=function(t){return function(e,i){void 0!==i&&t.children[i]?t.insertBefore(e,t.children[i]):t.appendChild(e)}},$=function(t,e){return function(t,i){return void 0!==i?e.splice(i,0,t):e.push(t),t}},O=function(t,e){return function(i){var n=e.splice(e.indexOf(i),1);return n.length&&n[0]._destroy(),i.element.parentNode&&t.removeChild(i.element),i}},L=function(t,e,i,n){var r=i[0]||t.left,o=i[1]||t.top,a=r+t.width,s=o+t.height*(n[1]||1),l={element:f({},t),inner:{left:t.left,top:t.top,right:t.right,bottom:t.bottom},outer:{left:r,top:o,right:a,bottom:s}};return e.filter((function(t){return!t.isRectIgnored()})).map((function(t){return t.rect})).forEach((function(t){M(l.inner,f({},t.inner)),M(l.outer,f({},t.outer))})),D(l.inner),l.outer.bottom+=l.element.marginBottom,l.outer.right+=l.element.marginRight,D(l.outer),l},M=function(t,e){e.top+=t.top,e.right+=t.left,e.bottom+=t.top,e.left+=t.left,e.bottom>t.bottom&&(t.bottom=e.bottom),e.right>t.right&&(t.right=e.right)},D=function(t){t.width=t.right-t.left,t.height=t.bottom-t.top},P=function(t){return"number"==typeof t},N=function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:.001;return Math.abs(t-e)<n&&Math.abs(i)<n},B=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.stiffness,i=void 0===e?.5:e,n=t.damping,r=void 0===n?.75:n,o=t.mass,a=void 0===o?10:o,s=t.delay,l=void 0===s?0:s,c=null,h=null,u=0,d=!1,p=null,f=x({interpolate:function(t){if(null===p&&(p=t),!(t-l<p||d)){if(!P(c)||!P(h))return d=!0,void(u=0);N(h+=u+=-(h-c)*i/a,c,u*=r)?(h=c,u=0,d=!0,f.onupdate(h),f.oncomplete(h)):f.onupdate(h)}},target:{set:function(t){if(P(t)&&!P(h)&&(h=t,p=null),null===c&&(c=t,h=t,p=null),d&&(p=null),h===(c=t)||void 0===c)return d=!0,u=0,p=null,f.onupdate(h),void f.oncomplete(h);d=!1},get:function(){return c}},resting:{get:function(){return d}},onupdate:function(){},oncomplete:function(){},position:{get:function(){return h}}});return f},F=function(t){return t<.5?2*t*t:(4-2*t)*t-1},U={spring:B,tween:function(){var t,e,i=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},n=i.duration,r=void 0===n?500:n,o=i.easing,a=void 0===o?F:o,s=i.delay,l=void 0===s?0:s,c=null,h=!0,u=!1,d=null,p=x({interpolate:function(i){h||null===d||(null===c&&(c=i),i-c<l||((t=i-c-l)<r?(e=t/r,p.onupdate((t>=0?a(u?1-e:e):0)*d)):(t=1,e=u?0:1,p.onupdate(e*d),p.oncomplete(e*d),h=!0)))},target:{get:function(){return u?0:d},set:function(t){if(null===d)return d=t,p.onupdate(t),void p.oncomplete(t);t<d?(d=1,u=!0):(u=!1,d=t),h=!1,c=null}},resting:{get:function(){return h}},onupdate:function(){},oncomplete:function(){}});return p}},G=function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3];(e=Array.isArray(e)?e:[e]).forEach((function(e){t.forEach((function(t){var r=t,o=function(){return i[t]},a=function(e){return i[t]=e};"object"===d(t)&&(r=t.key,o=t.getter||o,a=t.setter||a),e[r]&&!n||(e[r]={get:o,set:a})}))}))},z=function(t){return function(e,i){t.addEventListener(e,i)}},H=function(t){return function(e,i){t.removeEventListener(e,i)}},V={opacity:1,scaleX:1,scaleY:1,translateX:0,translateY:0,rotateX:0,rotateY:0,rotateZ:0,originX:0,originY:0},W=function(t,e){if(Object.keys(t).length!==Object.keys(e).length)return!0;for(var i in e)if(e[i]!==t[i])return!0;return!1},j=function(t,e){var i=e.opacity,n=e.perspective,r=e.translateX,o=e.translateY,a=e.scaleX,s=e.scaleY,l=e.rotateX,c=e.rotateY,h=e.rotateZ,u=e.originX,d=e.originY,p=e.width,f=e.height,m="",g="";null==u&&null==d||(g+="transform-origin: ".concat(u||0,"px ").concat(d||0,"px;")),null!=n&&(m+="perspective(".concat(n,"px) ")),null==r&&null==o||(m+="translate3d(".concat(r||0,"px, ").concat(o||0,"px, 0) ")),null==a&&null==s||(m+="scale3d(".concat(null!=a?a:1,", ").concat(null!=s?s:1,", 1) ")),null!=h&&(m+="rotateZ(".concat(h,"rad) ")),null!=l&&(m+="rotateX(".concat(l,"rad) ")),null!=c&&(m+="rotateY(".concat(c,"rad) ")),""!=m&&(g+="transform:".concat(m,";")),null!=i&&(g+="opacity:".concat(i,";"),i<1&&(g+="pointer-events:none;"),0===i&&"BUTTON"===t.nodeName&&(g+="visibility:hidden;")),null!=p&&(g+="width:".concat(p,"px;")),null!=f&&(g+="height:".concat(f,"px;"));var v=t.elementCurrentStyle||"";g.length===v.length&&g===v||(t.style.cssText=g,t.elementCurrentStyle=g)},q={styles:function(t){var e=t.mixinConfig,i=t.viewProps,n=t.viewInternalAPI,r=t.viewExternalAPI,o=t.view,a=f({},i),s={};G(e,[n,r],i);var l=function(){return o.rect?L(o.rect,o.childViews,[i.translateX||0,i.translateY||0],[i.scaleX||0,i.scaleY||0]):null};return n.rect={get:l},r.rect={get:l},e.forEach((function(t){i[t]=void 0===a[t]?V[t]:a[t]})),{write:function(){if(W(s,i))return j(o.element,i),Object.assign(s,f({},i)),!0},destroy:function(){}}},listeners:function(t){var e=t.viewExternalAPI,i=t.view,n=[],r=z(i.element),o=H(i.element);return e.on=function(t,e){n.push({type:t,fn:e}),r(t,e)},e.off=function(t,e){n.splice(n.findIndex((function(i){return i.type===t&&i.fn===e})),1),o(t,e)},{write:function(){return!0},destroy:function(){n.forEach((function(t){o(t.type,t.fn)}))}}},animations:function(t){var e=t.mixinConfig,i=t.viewProps,n=t.viewInternalAPI,r=t.viewExternalAPI,o=f({},i),a=[];return w(e,(function(t,e){var s=function(t,e,i){var n=t[e]&&"object"===d(t[e][i])?t[e][i]:t[e]||t,r="string"==typeof n?n:n.type,o="object"===d(n)?f({},n):{};return U[r]?U[r](o):null}(e);s&&(s.onupdate=function(e){i[t]=e},s.target=o[t],G([{key:t,setter:function(t){s.target!==t&&(s.target=t)},getter:function(){return i[t]}}],[n,r],i,!0),a.push(s))})),{write:function(t){var e=!0;return a.forEach((function(i){i.resting||(e=!1),i.interpolate(t)})),e},destroy:function(){}}},apis:function(t){var e=t.mixinConfig,i=t.viewProps,n=t.viewExternalAPI;G(e,n,i)}},Y=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return e.layoutCalculated||(t.paddingTop=parseInt(i.paddingTop,10)||0,t.marginTop=parseInt(i.marginTop,10)||0,t.marginRight=parseInt(i.marginRight,10)||0,t.marginBottom=parseInt(i.marginBottom,10)||0,t.marginLeft=parseInt(i.marginLeft,10)||0,e.layoutCalculated=!0),t.left=e.offsetLeft||0,t.top=e.offsetTop||0,t.width=e.offsetWidth||0,t.height=e.offsetHeight||0,t.right=t.left+t.width,t.bottom=t.top+t.height,t.scrollTop=e.scrollTop,t.hidden=null===e.offsetParent&&"fixed"!==i.position,t},K=void 0!==window.document,Z=function(){return K},X="children"in(Z()?I("svg"):{})?function(t){return t.children.length}:function(t){return t.childNodes.length},Q=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=t.tag,i=void 0===e?"div":e,n=t.name,r=void 0===n?null:n,o=t.attributes,a=void 0===o?{}:o,s=t.read,l=void 0===s?function(){}:s,c=t.write,h=void 0===c?function(){}:c,u=t.create,d=void 0===u?function(){}:u,p=t.destroy,m=void 0===p?function(){}:p,g=t.filterFrameActionsForChild,v=void 0===g?function(t,e){return e}:g,b=t.didCreateView,_=void 0===b?function(){}:b,y=t.didWriteView,E=void 0===y?function(){}:y,T=t.shouldUpdateChildViews,w=void 0===T?function(){return!0}:T,C=t.ignoreRect,R=void 0!==C&&C,A=t.ignoreRectUpdate,S=void 0!==A&&A,M=t.mixins,D=void 0===M?[]:M;return function(t){var e,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},o=I(i,r?"doka--".concat(r):null,a),s=window.getComputedStyle(o,null),c=Y(),u=null,p=!1,g=[],b=[],y={},T={},C=[h],A=[l],M=[m],P=function(){return o},N=function(){return[].concat(g)},B=function(){return u||(u=L(c,g,[0,0],[1,1]))},F=function(){return o.layoutCalculated=!1},U={element:{get:P},style:{get:function(){return s}},childViews:{get:N}},G=f({},U,{rect:{get:B},ref:{get:function(){return y}},is:function(t){return r===t},appendChild:k(o),createChildView:(e=t,function(t,i){return t(e,i)}),linkView:function(t){return g.push(t),t},unlinkView:function(t){g.splice(g.indexOf(t),1)},appendChildView:$(0,g),removeChildView:O(o,g),registerWriter:function(t){return C.push(t)},registerReader:function(t){return A.push(t)},registerDestroyer:function(t){return M.push(t)},invalidateLayout:F,dispatch:t.dispatch,query:t.query}),z={element:{get:P},childViews:{get:N},rect:{get:B},resting:{get:function(){return p}},isRectIgnored:function(){return R},invalidateLayout:F,_read:function(){u=null,w({root:V,props:n})&&g.forEach((function(t){return t._read()})),!(S&&c.width&&c.height)&&Y(c,o,s);var t={root:V,props:n,rect:c};A.forEach((function(e){return e(t)}))},_write:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:[],i=0===e.length;return C.forEach((function(r){!1===r({props:n,root:V,actions:e,timestamp:t})&&(i=!1)})),b.forEach((function(e){!1===e.write(t)&&(i=!1)})),w({props:n,root:V,actions:e,timestamp:t})&&(g.filter((function(t){return!!t.element.parentNode})).forEach((function(n){n._write(t,v(n,e))||(i=!1)})),g.forEach((function(n,r){n.element.parentNode||(V.appendChild(n.element,r),n._read(),n._write(t,v(n,e)),i=!1)}))),p=i,E({props:n,root:V,actions:e,timestamp:t}),i},_destroy:function(){b.forEach((function(t){return t.destroy()})),M.forEach((function(t){t({root:V})})),g.forEach((function(t){return t._destroy()}))}},H=f({},U,{rect:{get:function(){return c}}});Object.keys(D).sort((function(t,e){return"styles"===t?1:"styles"===e?-1:0})).forEach((function(t){var e=q[t]({mixinConfig:D[t],viewProps:n,viewState:T,viewInternalAPI:G,viewExternalAPI:z,view:x(H)});e&&b.push(e)}));var V=x(G);d({root:V,props:n});var W=X(o)||0;return g.forEach((function(t,e){V.appendChild(t.element,W+e)})),_(V),x(z)}},J=function(t,e){return function(i){var n=i.root,r=i.props,o=i.actions,a=void 0===o?[]:o,s=i.timestamp;if(a.filter((function(e){return t[e.type]})).forEach((function(e){return t[e.type]({root:n,props:r,action:e.data,timestamp:s})})),e)return e({root:n,props:r,actions:a,timestamp:s})}},tt=function(t){return Array.isArray(t)},et=function(t){return null==t},it=function(t){return t.trim()},nt=function(t){return""+t},rt=function(t){return"boolean"==typeof t},ot=function(t){return"string"==typeof t},at=function(t){return P(t)?t:ot(t)?nt(t).replace(/[a-z]+/gi,""):0},st=function(t){return parseInt(at(t),10)},lt=function(t){return P(t)&&isFinite(t)&&Math.floor(t)===t},ct=function(t){if(lt(t))return t;var e=nt(t).trim();return/MB$/i.test(e)?(e=e.replace(/MB$i/,"").trim(),1e3*st(e)*1e3):/KB/i.test(e)?(e=e.replace(/KB$i/,"").trim(),1e3*st(e)):st(e)},ht=function(t){return tt(t)?"array":function(t){return null===t}(t)?"null":lt(t)?"int":/^[0-9]+ ?(?:GB|MB|KB)$/gi.test(t)?"bytes":d(t)},ut={array:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:",";return et(t)?[]:tt(t)?t:nt(t).split(e).map(it).filter((function(t){return t.length}))},boolean:function(t){return rt(t)?t:"true"===t},int:function(t){return"bytes"===ht(t)?ct(t):st(t)},float:function(t){return parseFloat(at(t))},bytes:ct,string:function(t){return function(t){return"function"==typeof t}(t)?t:nt(t)},object:function(t){try{return JSON.parse(function(t){return t.replace(/{\s*'/g,'{"').replace(/'\s*}/g,'"}').replace(/'\s*:/g,'":').replace(/:\s*'/g,':"').replace(/,\s*'/g,',"').replace(/'\s*,/g,'",')}(t))}catch(e){return t}},file:function(t){return t},function:function(t){return function(t){for(var e=self,i=t.split("."),n=null;n=i.shift();)if(!(e=e[n]))return null;return e}(t)}},dt=function(t,e,i){if(t===e)return t;var n=ht(t);if(n!==i){var r=function(t,e){return ut[e](t)}(t,i);if(n=ht(r),null===r)throw'Trying to assign value with incorrect type, allowed type: "'.concat(i,'"');t=r}return t},pt=function(t){var e={};return w(t,(function(i){var n=ot(t[i])?t[i]:i,r=t[n];e[i]=n===i?function(t,e){var i=t;return{enumerable:!0,get:function(){return i},set:function(n){i=dt(n,t,e)}}}(r[0],r[1]):e[n]})),x(e)},ft=function(t){t.file=null,t.activeView=null,t.markup=[],t.markupToolValues={},t.rootRect={x:0,y:0,left:0,top:0,width:0,height:0},t.stage=null,t.stageOffset=null,t.image=null,t.zoomTimeoutId=null,t.instantUpdate=!1,t.filePromise=null,t.fileLoader=null,t.instructions={size:null,crop:null,filter:null,color:null},t.filter=null,t.filterName=null,t.filterValue=null,t.colorValues={},t.colorMatrices={},t.size={width:!1,height:!1,aspectRatioLocked:!0,aspectRatioPrevious:!1},t.crop={rectangle:null,transforms:null,rotation:null,flip:null,aspectRatio:null,isRotating:!1,isDirty:!1,limitToImageBounds:!0,draft:{rectangle:null,transforms:null}}},mt=function(t){var e={noImageTimeout:null,options:pt(t)};return ft(e),e},gt=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"-";return t.split(/(?=[A-Z])/).map((function(t){return t.toLowerCase()})).join(e)},vt=function(t,e){var i={};return w(e,(function(n){var r=ot(e[n])?e[n]:n;i[n]={get:function(){return t.getState().options[r]},set:function(e){t.dispatch("SET_".concat(gt(r,"_").toUpperCase()),{value:e})}}})),i},bt=function(t){return function(e,i,n){var r={};return w(t,(function(t){var i=gt(t,"_").toUpperCase();r["SET_".concat(i)]=function(r){var o;try{o=n.options[t],n.options[t]=r.value}catch(a){}e("DID_SET_".concat(i),{value:n.options[t],prevValue:o})}})),r}},_t=function(t){return function(e){var i={};return w(t,(function(t){i["GET_".concat(gt(t,"_").toUpperCase())]=function(){return e.options[t]}})),i}},yt=function(){return Math.random().toString(36).substr(2,9)},Et=function(){var t=[],e=function(e,i){!function(t,e){t.splice(e,1)}(t,t.findIndex((function(t){return t.event===e&&(t.cb===i||!i)})))};return{fire:function(e){for(var i=arguments.length,n=new Array(i>1?i-1:0),r=1;r<i;r++)n[r-1]=arguments[r];t.filter((function(t){return t.event===e})).map((function(t){return t.cb})).forEach((function(t){setTimeout((function(){t.apply(void 0,n)}),0)}))},on:function(e,i){t.push({event:e,cb:i})},onOnce:function(i,n){t.push({event:i,cb:function(){e(i,n),n.apply(void 0,arguments)}})},off:e}},Tt="boolean",wt="int",xt="number",Ct="string",Rt="array",At="object",St="function",It=null,kt=function(){return null===It&&(It=(/iPad|iPhone|iPod/.test(navigator.userAgent)||"MacIntel"===navigator.platform&&navigator.maxTouchPoints>1)&&!window.MSStream),It},$t=function(){return f({},Lt)},Ot=function(t,e){t=function(t){return ot(Lt[t])?Lt[t]:t}(t),Lt[t][0]=dt(e,Lt[t][0],Lt[t][1])},Lt={id:[null,Ct],className:[null,Ct],src:[null,"file"],storageName:["doka",Ct],maxImagePreviewWidth:[1500,wt],maxImagePreviewHeight:[1500,wt],imagePreviewScaleMode:["stage",Ct],allowPreviewFitToView:[!0,Tt],allowButtonCancel:[!0,Tt],allowButtonConfirm:[!0,Tt],allowButtonReset:[!0,Tt],allowDropFiles:[!1,Tt],allowBrowseFiles:[!0,Tt],allowAutoClose:[!0,Tt],allowAutoDestroy:[!1,Tt],utils:[["crop","filter","color","markup"],Rt],util:[null,Ct],initialState:[null,At],outputData:[!1,Tt],outputFile:[!0,Tt],outputCorrectImageExifOrientation:[!0,Tt],outputStripImageHead:[!0,Tt],outputType:[null,Ct],outputQuality:[null,wt],outputFit:["cover",Ct],outputUpscale:[!0,Tt],outputWidth:[null,wt],outputHeight:[null,wt],outputCanvasBackgroundColor:[null,Ct],outputCanvasMemoryLimit:[Z()&&kt()?16777216:null,wt],outputCanvasSyncTarget:[null,At],size:[null,At],sizeMin:[{width:1,height:1},At],sizeMax:[{width:9999,height:9999},At],filter:[null,At],filters:[{original:{label:"Original",matrix:function(){return null}},chrome:{label:"Chrome",matrix:function(){return[1.398,-.316,.065,-.273,.201,-.051,1.278,-.08,-.273,.201,-.051,.119,1.151,-.29,.215,0,0,0,1,0]}},fade:{label:"Fade",matrix:function(){return[1.073,-.015,.092,-.115,-.017,.107,.859,.184,-.115,-.017,.015,.077,1.104,-.115,-.017,0,0,0,1,0]}},mono:{label:"Mono",matrix:function(){return[.212,.715,.114,0,0,.212,.715,.114,0,0,.212,.715,.114,0,0,0,0,0,1,0]}},noir:{label:"Noir",matrix:function(){return[.15,1.3,-.25,.1,-.2,.15,1.3,-.25,.1,-.2,.15,1.3,-.25,.1,-.2,0,0,0,1,0]}}},At],crop:[null,At],cropShowSize:[!1,Tt],cropZoomTimeout:[null,wt],cropMask:[null,St],cropMaskInset:[0,wt],cropAllowResizeRect:[!0,Tt],cropAllowImageTurnLeft:[!0,Tt],cropAllowImageTurnRight:[!1,Tt],cropAllowImageFlipHorizontal:[!0,Tt],cropAllowImageFlipVertical:[!0,Tt],cropAllowToggleLimit:[!1,Tt],cropLimitToImageBounds:[!0,Tt],cropAllowInstructionZoom:[!1,Tt],cropAllowRotate:[!0,Tt],cropResizeMatchImageAspectRatio:[!1,Tt],cropResizeKeyCodes:[[18,91,92,93],Rt],cropResizeScrollRectOnly:[!1,Tt],cropAspectRatio:[null,Ct],cropAspectRatioOptions:[null,Rt],cropMinImageWidth:[1,wt],cropMinImageHeight:[1,wt],colorBrightness:[0,xt],colorBrightnessRange:[[-.25,.25],Rt],colorContrast:[1,xt],colorContrastRange:[[.5,1.5],Rt],colorExposure:[1,xt],colorExposureRange:[[.5,1.5],Rt],colorSaturation:[1,xt],colorSaturationRange:[[0,2],Rt],markup:[null,Rt],markupUtil:["select",Ct],markupFilter:[function(){return!0},St],markupAllowAddMarkup:[!0,Tt],markupAllowCustomColor:[!0,Tt],markupDrawDistance:[4,xt],markupColor:["#000",Ct],markupColorOptions:[[["White","#fff","#f6f6f6"],["Silver","#9e9e9e"],["Black","#000","#333"],["Red","#f44336"],["Orange","#ff9800"],["Yellow","#ffeb3b"],["Green","#4caf50"],["Blue","#2196f3"],["Violet","#3f51b5"],["Purple","#9c27b0"]],Rt],markupFontSize:[.1,xt],markupFontSizeOptions:[[["XL",.15],["L",.125],["M",.1],["S",.075],["XS",.05]],Rt],markupFontFamily:["Helvetica, Arial, Verdana",Ct],markupFontFamilyOptions:[[["Serif","Palatino, 'Times New Roman', serif"],["Sans Serif","Helvetica, Arial, Verdana"],["Monospaced","Monaco, 'Lucida Console', monospaced"]],Rt],markupShapeStyle:[[.015,null],Rt],markupShapeStyleOptions:[[["Fill",0,null,0],["Outline thick",.025,null,4],["Outline default",.015,null,2],["Outline thin",.005,null,1],["Outline dashed",.005,[.01],1]],Rt],markupLineStyle:[[.015,null],Rt],markupLineStyleOptions:[[["Thick",.025,null,4],["Default",.015,null,2],["Thin",.005,null,1],["Dashed",.005,[.01],1]],Rt],markupLineDecoration:[["arrow-end"],Rt],markupLineDecorationOptions:[[["None",[]],["Single arrow",["arrow-end"]],["Double arrow",["arrow-begin","arrow-end"]]],Rt],beforeLoadImage:[null,St],beforeCreateBlob:[null,St],afterCreateBlob:[null,St],afterCreateOutput:[null,St],onconfirm:[null,St],oncancel:[null,St],onclose:[null,St],onloadstart:[null,St],onload:[null,St],onloaderror:[null,St],oninit:[null,St],onready:[null,St],onupdate:[null,St],ondestroy:[null,St],labelButtonReset:["Reset",Ct],labelButtonCancel:["Cancel",Ct],labelButtonConfirm:["Done",Ct],labelButtonUtilCrop:["Crop",Ct],labelButtonUtilResize:["Resize",Ct],labelButtonUtilFilter:["Filter",Ct],labelButtonUtilColor:["Colors",Ct],labelButtonUtilMarkup:["Markup",Ct],labelStatusMissingWebGL:["WebGL is required but is disabled on your browser",Ct],labelStatusAwaitingImage:["Waiting for image\u2026",Ct],labelStatusLoadImageError:["Error loading image\u2026",Ct],labelStatusLoadingImage:["Loading image\u2026",Ct],labelStatusProcessingImage:["Processing image\u2026",Ct],labelColorBrightness:["Brightness",Ct],labelColorContrast:["Contrast",Ct],labelColorExposure:["Exposure",Ct],labelColorSaturation:["Saturation",Ct],labelMarkupTypeRectangle:["Square",Ct],labelMarkupTypeEllipse:["Circle",Ct],labelMarkupTypeText:["Text",Ct],labelMarkupTypeLine:["Arrow",Ct],labelMarkupSelectFontSize:["Size",Ct],labelMarkupSelectFontFamily:["Font",Ct],labelMarkupSelectLineDecoration:["Decoration",Ct],labelMarkupSelectLineStyle:["Style",Ct],labelMarkupSelectShapeStyle:["Style",Ct],labelMarkupRemoveShape:["Remove",Ct],labelMarkupToolSelect:["Select",Ct],labelMarkupToolDraw:["Draw",Ct],labelMarkupToolLine:["Arrow",Ct],labelMarkupToolText:["Text",Ct],labelMarkupToolRect:["Square",Ct],labelMarkupToolEllipse:["Circle",Ct],labelResizeWidth:["Width",Ct],labelResizeHeight:["Height",Ct],labelResizeApplyChanges:["Apply",Ct],labelCropInstructionZoom:["Zoom in and out with your scroll wheel or touchpad.",Ct],labelButtonCropZoom:["Zoom",Ct],labelButtonCropRotateLeft:["Rotate left",Ct],labelButtonCropRotateRight:["Rotate right",Ct],labelButtonCropRotateCenter:["Center rotation",Ct],labelButtonCropFlipHorizontal:["Flip horizontal",Ct],labelButtonCropFlipVertical:["Flip vertical",Ct],labelButtonCropAspectRatio:["Aspect ratio",Ct],labelButtonCropToggleLimit:["Crop selection",Ct],labelButtonCropToggleLimitEnable:["Limited to image",Ct],labelButtonCropToggleLimitDisable:["Select outside image",Ct],pointerEventsPolyfillScope:["root",Ct],styleCropCorner:["circle",Ct],styleFullscreenSafeArea:[Z()&&/iPad|iPhone|iPod/.test(navigator.userAgent)&&!window.MSStream?"bottom":"none",Ct],styleLayoutMode:[null,Ct]},Mt=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0,i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1;return Math.min(i,Math.max(e,t))},Dt=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:10;return parseFloat(t.toFixed(e))},Pt=function(t,e){return{x:Dt(t.x,e),y:Dt(t.y,e)}},Nt=function(t,e){return zt(t.x-e.x,t.y-e.y)},Bt=function(t,e){return function(t,e){return t.x*e.x+t.y*e.y}(Nt(t,e),Nt(t,e))},Ft=function(t,e){return Math.sqrt(Bt(t,e))},Ut=function(t,e){return zt(Mt(t.x,e.x,e.x+e.width),Mt(t.y,e.y,e.y+e.height))},Gt=function(t,e,i){var n=Math.cos(e),r=Math.sin(e),o=zt(t.x-i.x,t.y-i.y);return zt(i.x+n*o.x-r*o.y,i.y+r*o.x+n*o.y)},zt=function(){return{x:arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,y:arguments.length>1&&void 0!==arguments[1]?arguments[1]:0}},Ht=function(t,e){return t.x===e.x&&t.y===e.y&&t.width===e.width&&t.height===e.height},Vt=function(t,e){return Xt(t.x+e.x,t.y+e.y,t.width,t.height)},Wt={translate:Vt,rotate:function(t,e,i){var n=function(t,e,i){return 0===e?{tl:t.tl,tr:t.tr,br:t.br,bl:t.bl}:{tl:Gt(t.tl,e,i),tr:Gt(t.tr,e,i),br:Gt(t.br,e,i),bl:Gt(t.bl,e,i)}}(Zt(t),e,i),r=n.tl,o=n.tr,a=n.br,s=n.bl,l=Math.min(r.x,o.x,a.x,s.x),c=Math.min(r.y,o.y,a.y,s.y),h=Math.max(r.x,o.x,a.x,s.x),u=Math.max(r.y,o.y,a.y,s.y);return Xt(l,c,h-l,u-c)},scale:function(t,e,i){return Xt(e*(t.x-i.x)+i.x,e*(t.y-i.y)+i.y,e*t.width,e*t.height)}},jt=function(t){return Xt(t.x,t.y,t.width,t.height)},qt=function(t){return{top:t.y,right:t.x+t.width,bottom:t.y+t.height,left:t.x}},Yt=function(t){var e=t.top,i=t.right,n=t.bottom,r=t.left;return{x:r,y:e,width:i-r,height:n-e}},Kt=function(t){return zt(t.x+.5*t.width,t.y+.5*t.height)},Zt=function(t){return{tl:{x:t.x,y:t.y},tr:{x:t.x+t.width,y:t.y},br:{x:t.x+t.width,y:t.y+t.height},bl:{x:t.x,y:t.y+t.height}}},Xt=function(t,e,i,n){return{x:t,y:e,width:i,height:n}},Qt=function(t){if(et(t))return t;if(/:/.test(t)){var e=t.split(":"),i=e[0];return e[1]/i}return parseFloat(t)},Jt=function(t,e){var i=t.width,n=i*e;return n>t.height&&(i=(n=t.height)/e),{x:.5*(t.width-i),y:.5*(t.height-n),width:i,height:n}},te=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=t.height/t.width,r=e,o=1,a=n;a>r&&(o=(a=r)/n);var s=Math.max(1/o,r/a),l=t.width/(i*s*o);return{width:l,height:l*e}},ee=function(t,e){return{x:t,y:e}},ie=function(t,e){return ee(t.x-e.x,t.y-e.y)},ne=function(t,e){return Math.sqrt(function(t,e){return function(t,e){return t.x*e.x+t.y*e.y}(ie(t,e),ie(t,e))}(t,e))},re=function(t,e){var i=t,n=e,r=1.5707963267948966-e,o=Math.sin(1.5707963267948966),a=Math.sin(n),s=Math.sin(r),l=Math.cos(r),c=i/o;return ee(l*(c*a),l*(c*s))},oe=function(t,e){var i=t.width,n=t.height,r=re(i,e),o=re(n,e),a=ee(t.x+Math.abs(r.x),t.y-Math.abs(r.y)),s=ee(t.x+t.width+Math.abs(o.y),t.y+Math.abs(o.x)),l=ee(t.x-Math.abs(o.y),t.y+t.height-Math.abs(o.x));return{width:ne(a,s),height:ne(a,l)}},ae=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:0,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{x:.5,y:.5},r=n.x>.5?1-n.x:n.x,o=n.y>.5?1-n.y:n.y,a=2*r*t.width,s=2*o*t.height,l=oe(e,i);return Math.max(l.width/a,l.height/s)},se=function(t,e){var i=e.origin,n=e.translation;return function(t,e,i){return e.reduce((function(t,e){return(0,Wt[e[0]])(t,e[1],i)}),t)}(t,[["scale",e.scale],["translate",n]],i)},le=function(t,e){var i=t,n=e,r=1.5707963267948966-e,o=Math.sin(1.5707963267948966),a=Math.sin(n),s=Math.sin(r),l=Math.cos(r),c=i/o;return zt(l*(c*a),l*(c*s))},ce=function(t,e,i,n){var r={x:t.x+e.x,y:t.y+e.y},o=function(t,e){var i=t.width,n=t.height,r=e%(Math.PI/2),o=le(i,r),a=le(n,r),s=Zt(t);return{tl:zt(s.tl.x+Math.abs(o.x),s.tl.y-Math.abs(o.y)),tr:zt(s.tr.x+Math.abs(a.y),s.tr.y+Math.abs(a.x)),br:zt(s.br.x-Math.abs(o.x),s.br.y+Math.abs(o.y)),bl:zt(s.bl.x-Math.abs(a.y),s.bl.y-Math.abs(a.x))}}(n,i),a=Gt(o.tl,-i,r),s=Gt(o.tr,-i,r),l=Gt(o.br,-i,r);return Xt(Math.min(a.x,s.x,l.x),Math.min(a.y,s.y,l.y),Math.max(a.x,s.x,l.x)-Math.min(a.x,s.x,l.x),Math.max(a.y,s.y,l.y)-Math.min(a.y,s.y,l.y))},he=function(t,e,i){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=i.origin,o=i.translation,a=se(t,i),s=2*Math.PI+i.rotation%(2*Math.PI),l=ce(r,o,s,e),c=Kt(l),h=e.height/e.width,u={x:(c.x-a.x)/a.width,y:(c.y-a.y)/a.height},d=u.y>.5?1-u.y:u.y,p=2*(u.x>.5?1-u.x:u.x)*a.width,f=2*d*a.height;return{center:u,zoom:n?Math.min(p/l.width,f/l.height):Math.min(a.width/l.width,a.height/l.height),rotation:i.rotation,aspectRatio:h,scaleToFit:n}},ue=function(t,e){var i=de(t,e);return{center:{x:Dt(i.center.x),y:Dt(i.center.y)},rotation:Dt(i.rotation),zoom:Dt(i.zoom),aspectRatio:Dt(i.aspectRatio),flip:f({},e.flip),scaleToFit:i.scaleToFit}},de=function(t,e){var i=he(t,e.rectangle,e.transforms,e.limitToImageBounds);return{center:{x:i.center.x,y:i.center.y},rotation:i.rotation,zoom:i.zoom,aspectRatio:i.aspectRatio,flip:f({},e.flip),scaleToFit:i.scaleToFit}},pe=function(t,e,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:"width",o=t.width,a=t.height;return o||a?(o=o&&Mt(o,e.width,i.width),a=a&&Mt(a,e.height,i.height),n?(a?o?"width"===r?a=o/n:"height"===r?o=a*n:(a*n<e.width?a=(o=e.width)/n:o/n<e.height&&(o=(a=e.height)*n),a*n>i.width?a=(o=i.width)/n:o/n>i.height&&(o=(a=i.height)*n)):a=Mt(a*n,e.width,i.width)/n:o=Mt(o/n,e.height,i.height)*n,{width:o,height:a}):{width:o,height:a}):{width:o,height:a}},fe=function(t){var e;if(/^#/.test(t)){if(4===t.length){var i=t.split("");t="#"+i[1]+i[1]+i[2]+i[2]+i[3]+i[3]}var n=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);e=[parseInt(n[1],16),parseInt(n[2],16),parseInt(n[3],16)]}else/^rgb/.test(t)&&((e=t.match(/\d+/g).map((function(t){return parseInt(t,10)}))).length=3);return e},me=[],ge=function(t){var e=[];return w(t,(function(t,i){return e.push(i)})),e.length?e.reduce((function(t,e){return function(t,e){var i=new Array(20);return i[0]=t[0]*e[0]+t[1]*e[5]+t[2]*e[10]+t[3]*e[15],i[1]=t[0]*e[1]+t[1]*e[6]+t[2]*e[11]+t[3]*e[16],i[2]=t[0]*e[2]+t[1]*e[7]+t[2]*e[12]+t[3]*e[17],i[3]=t[0]*e[3]+t[1]*e[8]+t[2]*e[13]+t[3]*e[18],i[4]=t[0]*e[4]+t[1]*e[9]+t[2]*e[14]+t[3]*e[19]+t[4],i[5]=t[5]*e[0]+t[6]*e[5]+t[7]*e[10]+t[8]*e[15],i[6]=t[5]*e[1]+t[6]*e[6]+t[7]*e[11]+t[8]*e[16],i[7]=t[5]*e[2]+t[6]*e[7]+t[7]*e[12]+t[8]*e[17],i[8]=t[5]*e[3]+t[6]*e[8]+t[7]*e[13]+t[8]*e[18],i[9]=t[5]*e[4]+t[6]*e[9]+t[7]*e[14]+t[8]*e[19]+t[9],i[10]=t[10]*e[0]+t[11]*e[5]+t[12]*e[10]+t[13]*e[15],i[11]=t[10]*e[1]+t[11]*e[6]+t[12]*e[11]+t[13]*e[16],i[12]=t[10]*e[2]+t[11]*e[7]+t[12]*e[12]+t[13]*e[17],i[13]=t[10]*e[3]+t[11]*e[8]+t[12]*e[13]+t[13]*e[18],i[14]=t[10]*e[4]+t[11]*e[9]+t[12]*e[14]+t[13]*e[19]+t[14],i[15]=t[15]*e[0]+t[16]*e[5]+t[17]*e[10]+t[18]*e[15],i[16]=t[15]*e[1]+t[16]*e[6]+t[17]*e[11]+t[18]*e[16],i[17]=t[15]*e[2]+t[16]*e[7]+t[17]*e[12]+t[18]*e[17],i[18]=t[15]*e[3]+t[16]*e[8]+t[17]*e[13]+t[18]*e[18],i[19]=t[15]*e[4]+t[16]*e[9]+t[17]*e[14]+t[18]*e[19]+t[19],i}(v(t),e)}),e.shift()):[]},ve=function(t){return t.crop.draft.transforms?t.crop.draft.transforms.scale:t.crop.transforms.scale},be=function(t){var e=t.image.width/t.image.naturalWidth,i=ve(t);return{width:t.options.cropMinImageWidth*i*e,height:t.options.cropMinImageHeight*i*e}},_e=function(t){var e=ve(t);return{width:t.image.width*e,height:t.image.height*e}},ye=function(t){return t.options.cropAspectRatioOptions?t.options.cropAspectRatioOptions.map((function(t){var e={aspectRatio:null,width:null,height:null};return"number"==typeof t.value&&(e.aspectRatio=t.value),"string"==typeof t.value&&(e.aspectRatio=Qt(t.value)),"object"===d(t.value)&&null!==t.value&&(e.width=t.value.width,e.height=t.value.height,e.aspectRatio=e.height/e.width),{label:t.label,value:e}})):null},Ee=function(t){var e=t.image.naturalWidth,i=t.image.naturalHeight,n=i/e;return t.stage.width<e&&(i=n*(e=t.stage.width)),t.stage.height<i&&(e=(i=t.stage.height)/n),Xt(.5*t.stage.width-.5*e,.5*t.stage.height-.5*i,e,i)},Te=function(t){return{GET_SIZE:function(){return!1!==t.size.width&&!1!==t.size.height?{width:t.size.width,height:t.size.height}:{width:null,height:null}},GET_SIZE_INPUT:function(){return{width:t.size.width,height:t.size.height}},GET_SIZE_ASPECT_RATIO_LOCK:function(){return t.size.aspectRatioLocked},IS_ACTIVE_VIEW:function(e){return t.activeView===e},GET_ACTIVE_VIEW:function(){return t.activeView},GET_STYLES:function(){return Object.keys(t.options).filter((function(t){return/^style/.test(t)})).map((function(e){return{name:e,value:t.options[e]}}))},GET_FILE:function(){return t.file},GET_IMAGE:function(){return t.image},GET_STAGE:function(){return f({},t.stage,t.stageOffset)},GET_STAGE_RECT:function(e){var i,n=t.options.imagePreviewScaleMode;return(i="crop"===n?e?function(t,e){e.aspectRatio||(e.aspectRatio=t.image.height/t.image.width);var i=Re(t.image,e,e.scaleToFit),n=i.width/i.height;return t.stage.width<i.width&&(i.width=t.stage.width,i.height=i.width/n),t.stage.height<i.height&&(i.height=t.stage.height,i.width=i.height*n),Xt(.5*t.stage.width-.5*i.width,.5*t.stage.height-.5*i.height,i.width,i.height)}(t,e):Ee(t):"image"===n?Ee(t):f({},t.stage)).fits=i.width<t.stage.width&&i.height<t.stage.height,i.mode=n,i},GET_IMAGE_STAGE_RECT:function(){return Ee(t)},GET_ROOT:function(){return t.rootRect},GET_ROOT_SIZE:function(){return{width:t.rootRect.width,height:t.rootRect.height}},GET_MIN_IMAGE_SIZE:function(){return{width:t.options.cropMinImageWidth,height:t.options.cropMinImageHeight}},GET_IMAGE_PREVIEW_SCALE_FACTOR:function(){return t.image.width/t.image.naturalWidth},GET_MIN_PREVIEW_IMAGE_SIZE:function(){var e=t.image.width/t.image.naturalWidth;return{width:t.options.cropMinImageWidth*e,height:t.options.cropMinImageHeight*e}},GET_MIN_CROP_SIZE:function(){return be(t)},GET_MAX_CROP_SIZE:function(){return _e(t)},GET_MIN_PIXEL_CROP_SIZE:function(){var e=t.crop.transforms.scale,i=be(t);return{width:i.width/e,height:i.height/e}},GET_MAX_PIXEL_CROP_SIZE:function(){var e=t.crop.transforms.scale,i=_e(t);return{width:i.width/e,height:i.height/e}},GET_CROP_ASPECT_RATIO_OPTIONS:function(){return ye(t)},GET_ACTIVE_CROP_ASPECT_RATIO:function(){var e=t.crop.aspectRatio;return ot(e)?Qt(e):e},GET_CROP_ASPECT_RATIO:function(){var e=ot(t.options.cropAspectRatio)?Qt(t.options.cropAspectRatio):t.options.cropAspectRatio,i=ye(t);return!i||i&&!i.length||i.find((function(t){return t.value.aspectRatio===e}))?e:i[0].value.aspectRatio},GET_CROP_RECTANGLE_ASPECT_RATIO:function(){var e=t.crop,i=e.rectangle,n=e.aspectRatio;return i?i.width/i.height:n},GET_CROP:function(e,i){var n=me[e];if(n&&n.ts===i)return n;var r=Se(t);return r&&(r.ts=i,me[e]=r),r},GET_COLOR_MATRIX:function(){return ge(t.colorMatrices)},GET_COLOR_VALUES:function(){return f({exposure:t.options.colorExposure,brightness:t.options.colorBrightness,contrast:t.options.colorContrast,saturation:t.options.colorSaturation},t.colorValues)},GET_MARKUP_TOOL_VALUES:function(){return f({color:t.options.markupColor,fontFamily:t.options.markupFontFamily,fontSize:t.options.markupFontSize,shapeStyle:t.options.markupShapeStyle,lineStyle:t.options.markupLineStyle,lineDecoration:t.options.markupLineDecoration},t.markupToolValues)},GET_PREVIEW_IMAGE_DATA:function(){return t.file.preview},GET_THUMB_IMAGE_DATA:function(){return t.file.thumb},GET_FILTER:function(){return t.filter},GET_UID:function(){return t.uid},GET_MARKUP_BY_ID:function(e){return t.markup.find((function(t){return t[1].id===e}))},GET_BACKGROUND_COLOR:function(){var e=t.options.outputCanvasBackgroundColor;if(!e)return xe;if(we[e])return we[e];var i=fe(e);return we[e]=i.concat(1),we[e]}}},we={},xe=[0,0,0,0],Ce=function(t,e){var i=function(t){return!1===t.size.width?function(t){return t.options.size?t.options.size.width:null}(t):t.size.width}(t),n=function(t){return!1===t.size.height?function(t){return t.options.size?t.options.size.height:null}(t):t.size.height}(t),r=e.width/e.height;return pe({width:i,height:n},t.options.sizeMin,t.options.sizeMax,r)},Re=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=!(arguments.length>2&&void 0!==arguments[2])||arguments[2],n=e.zoom,r=e.rotation,o=e.center,a=e.aspectRatio,s=te(t,a,n),l={x:.5*s.width,y:.5*s.height},c={x:0,y:0,width:s.width,height:s.height,center:l},h=n*ae(t,Jt(c,a),r,i?o:{x:.5,y:.5});return{widthFloat:s.width/h,heightFloat:s.height/h,width:Math.round(s.width/h),height:Math.round(s.height/h)}},Ae=function(t,e){var i=Kt(e);return!function(t,e){return Dt(t.x)===Dt(e.x)&&Dt(t.y)===Dt(e.y)}(Kt(t),i)},Se=function(t){if(!t.stage||!t.image)return null;var e=t.crop.draft.rectangle||{free:t.crop.rectangle,limited:t.crop.rectangle},i=t.crop.draft.transforms||t.crop.transforms,n=i.origin,r=i.translation,o=i.scale,a=i.interaction,s=t.crop.rotation,l=t.crop.flip,c=!(!t.crop.draft.rectangle&&!t.crop.draft.transforms),h=c||t.instantUpdate,u=Ae(e.limited,t.stage),d=t.crop.isDirty||c,p=t.crop.isRotating,f=void 0===t.crop.limitToImageBounds||t.crop.limitToImageBounds,m={width:t.image.naturalWidth,height:t.image.naturalHeight},g=ge(t.colorMatrices),v=de(t.image,{rectangle:e.limited,transforms:{origin:n,translation:r,scale:o,rotation:s.main+s.sub},flip:l,limitToImageBounds:t.crop.limitToImageBounds}),b={props:v,crop:Re(m,v,t.crop.limitToImageBounds),image:Ce(t,e.limited)},_=b.image,y=b.crop,E=y.width,T=y.height,x=y.widthFloat/y.heightFloat;_.width&&_.height?(E=_.width,T=_.height):_.width&&!_.height?(E=_.width,T=_.width/x):_.height&&!_.width&&(T=_.height,E=_.height*x),b.currentWidth=Math.round(E),b.currentHeight=Math.round(T);var C={x:0,y:0},R=0,A=0;if(h&&a){if(a.translation){var S=a.translation.x-r.x,I=a.translation.y-r.y;C.x=100*Math.sign(S)*Math.log10(1+Math.abs(S)/100),C.y=100*Math.sign(I)*Math.log10(1+Math.abs(I)/100)}if(a.scale){var k=a.scale-o;R=.25*Math.sign(k)*Math.log10(1+Math.abs(k)/.25)}if(a.rotation){var $=a.rotation-(s.main+s.sub);A=.05*Math.sign($)*Math.log10(1+Math.abs($)/.05)}}var O={},L=e.free,M=qt(L),D=qt(e.limited);return w(M,(function(t){var e=M[t]-D[t];O[t]=D[t]+5*Math.sign(e)*Math.log10(1+Math.abs(e)/5)})),{canRecenter:u,canReset:d,isDraft:h,isRotating:p,isLimitedToImageBounds:f,cropRect:{x:O.left,y:O.top,width:O.right-O.left,height:O.bottom-O.top},origin:n,translation:r,translationBand:C,scale:o,scaleBand:R,rotation:s,rotationBand:A,flip:l,interaction:a,cropStatus:b,colorMatrix:g,markup:t.markup,previewSize:{width:t.image.width,height:t.image.height}}},Ie=function(t){return/^image/.test(t.type)},ke={1:function(){return[1,0,0,1,0,0]},2:function(t){return[-1,0,0,1,t,0]},3:function(t,e){return[-1,0,0,-1,t,e]},4:function(t,e){return[1,0,0,-1,0,e]},5:function(){return[0,1,1,0,0,0]},6:function(t,e){return[0,1,-1,0,e,0]},7:function(t,e){return[0,-1,-1,0,e,t]},8:function(t){return[0,-1,1,0,0,t]}},$e=function(t,e,i){return-1===i&&(i=1),ke[i](t,e)},Oe=function(t){t.width=1,t.height=1,t.getContext("2d").clearRect(0,0,1,1)},Le=function(t){return t&&(t.horizontal||t.vertical)},Me=function(t,e,i){if(e<=1&&!Le(i))return t.width=t.naturalWidth,t.height=t.naturalHeight,t;var n=document.createElement("canvas"),r=t.naturalWidth,o=t.naturalHeight,a=e>=5&&e<=8;a?(n.width=o,n.height=r):(n.width=r,n.height=o);var s=n.getContext("2d");if(e&&s.transform.apply(s,$e(r,o,e)),Le(i)){var l=[1,0,0,1,0,0];(!a&&i.horizontal||a&i.vertical)&&(l[0]=-1,l[4]=r),(!a&&i.vertical||a&&i.horizontal)&&(l[3]=-1,l[5]=o),s.transform.apply(s,l)}return s.drawImage(t,0,0,r,o),n},De=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=n.canvasMemoryLimit,o=n.background,a=void 0===o?null:o,s=i.zoom||1,l=Me(t,e,i.flip),c={width:l.width,height:l.height},h=i.aspectRatio||c.height/c.width,u=te(c,h,s);if(r){var d=u.width*u.height;if(d>r){var p=Math.sqrt(r)/Math.sqrt(d);c.width=Math.floor(c.width*p),c.height=Math.floor(c.height*p),u=te(c,h,s)}}var f=document.createElement("canvas"),m={x:.5*u.width,y:.5*u.height},g={x:0,y:0,width:u.width,height:u.height,center:m},v=void 0===i.scaleToFit||i.scaleToFit,b=s*ae(c,Jt(g,h),i.rotation,v?i.center:{x:.5,y:.5});f.width=Math.round(u.width/b),f.height=Math.round(u.height/b),m.x/=b,m.y/=b;var _=m.x-c.width*(i.center?i.center.x:.5),y=m.y-c.height*(i.center?i.center.y:.5),E=f.getContext("2d");a&&(E.fillStyle=a,E.fillRect(0,0,f.width,f.height)),E.translate(m.x,m.y),E.rotate(i.rotation||0),E.drawImage(l,_-m.x,y-m.y,c.width,c.height);var T=E.getImageData(0,0,f.width,f.height);return Oe(f),T};void 0!==window.document&&(HTMLCanvasElement.prototype.toBlob||Object.defineProperty(HTMLCanvasElement.prototype,"toBlob",{value:function(t,e,i){var n=this.toDataURL(e,i).split(",")[1];setTimeout((function(){for(var i=atob(n),r=i.length,o=new Uint8Array(r),a=0;a<r;a++)o[a]=i.charCodeAt(a);t(new Blob([o],{type:e||"image/png"}))}))}}));var Pe=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null;return new Promise((function(n){var r=i?i(t):t;Promise.resolve(r).then((function(t){t.toBlob(n,e.type,e.quality)}))}))},Ne=function(t,e){return Ge(t.x*e,t.y*e)},Be=function(t,e){return Ge(t.x+e.x,t.y+e.y)},Fe=function(t){var e=Math.sqrt(t.x*t.x+t.y*t.y);return 0===e?{x:0,y:0}:Ge(t.x/e,t.y/e)},Ue=function(t,e,i){var n=Math.cos(e),r=Math.sin(e),o=Ge(t.x-i.x,t.y-i.y);return Ge(i.x+n*o.x-r*o.y,i.y+r*o.x+n*o.y)},Ge=function(){return{x:arguments.length>0&&void 0!==arguments[0]?arguments[0]:0,y:arguments.length>1&&void 0!==arguments[1]?arguments[1]:0}},ze=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=arguments.length>3?arguments[3]:void 0;return"string"==typeof t?parseFloat(t)*i:"number"==typeof t?t*(n?e[n]:Math.min(e.width,e.height)):void 0},He=function(t,e,i){var n=t.borderStyle||t.lineStyle||"solid",r=t.backgroundColor||t.fontColor||"transparent",o=t.borderColor||t.lineColor||"transparent",a=ze(t.borderWidth||t.lineWidth,e,i);return{"stroke-linecap":t.lineCap||"round","stroke-linejoin":t.lineJoin||"round","stroke-width":a||0,"stroke-dasharray":"string"==typeof n?"":n.map((function(t){return ze(t,e,i)})).join(","),stroke:o,fill:r,opacity:t.opacity||1}},Ve=function(t){return null!=t},We=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:1,n=ze(t.x,e,i,"width")||ze(t.left,e,i,"width"),r=ze(t.y,e,i,"height")||ze(t.top,e,i,"height"),o=ze(t.width,e,i,"width"),a=ze(t.height,e,i,"height"),s=ze(t.right,e,i,"width"),l=ze(t.bottom,e,i,"height");return Ve(r)||(r=Ve(a)&&Ve(l)?e.height-a-l:l),Ve(n)||(n=Ve(o)&&Ve(s)?e.width-o-s:s),Ve(o)||(o=Ve(n)&&Ve(s)?e.width-n-s:0),Ve(a)||(a=Ve(r)&&Ve(l)?e.height-r-l:0),{x:n||0,y:r||0,width:o||0,height:a||0}},je=function(t){return t.map((function(t,e){return"".concat(0===e?"M":"L"," ").concat(t.x," ").concat(t.y)})).join(" ")},qe=function(t,e){return Object.keys(e).forEach((function(i){return t.setAttribute(i,e[i])}))},Ye=function(t,e){var i=document.createElementNS("http://www.w3.org/2000/svg",t);return e&&qe(i,e),i},Ke={contain:"xMidYMid meet",cover:"xMidYMid slice"},Ze={left:"start",center:"middle",right:"end"},Xe=function(t){return function(e){return Ye(t,{id:e.id})}},Qe={image:function(t){var e=Ye("image",{id:t.id,"stroke-linecap":"round","stroke-linejoin":"round",opacity:"0"});return e.onload=function(){e.setAttribute("opacity",t.opacity||1)},e.setAttributeNS("http://www.w3.org/1999/xlink","xlink:href",t.src),e},rect:Xe("rect"),ellipse:Xe("ellipse"),text:Xe("text"),path:function(t){var e=Ye("g",{id:t.id}),i=Ye("path");e.appendChild(i);var n=Ye("path",{style:"stroke-width: 40; stroke-opacity: 0;"});return e.appendChild(n),e},line:function(t){var e=Ye("g",{id:t.id,"stroke-linecap":"round","stroke-linejoin":"round"}),i=Ye("line");e.appendChild(i);var n=Ye("path");e.appendChild(n);var r=Ye("path");e.appendChild(r);var o=Ye("line",{style:"stroke-width: 40; stroke-opacity: 0;"});return e.appendChild(o),e}},Je={rect:function(t){return qe(t,f({},t.rect,t.styles))},ellipse:function(t){var e=t.rect.x+.5*t.rect.width,i=t.rect.y+.5*t.rect.height,n=.5*t.rect.width,r=.5*t.rect.height;return qe(t,f({cx:e,cy:i,rx:n,ry:r},t.styles))},image:function(t,e){qe(t,f({},t.rect,t.styles,{preserveAspectRatio:Ke[e.fit]||"none"}))},text:function(t,e,i,n){var r=ze(e.fontSize,i,n),o=e.fontFamily||"sans-serif",a=e.fontWeight||"normal",s=Ze[e.textAlign]||"start";qe(t,f({},t.rect,t.styles,{"stroke-width":0,"font-weight":a,"font-size":r,"font-family":o,"text-anchor":s})),t.text!==e.text&&(t.text=e.text,t.textContent=e.text.length?e.text:" ")},path:function(t,e,i,n){qe(t,f({},t.styles,{fill:"none"}));var r=t.childNodes[0],o=t.childNodes[1],a=je(e.points.map((function(t){return{x:ze(t.x,i,n,"width"),y:ze(t.y,i,n,"height")}})));qe(r,{d:a}),qe(o,{d:a})},line:function(t,e,i,n){qe(t,f({},t.rect,t.styles,{fill:"none"}));var r=t.childNodes[0],o=t.childNodes[1],a=t.childNodes[2],s=t.childNodes[3],l=t.rect,c={x:t.rect.x+t.rect.width,y:t.rect.y+t.rect.height};if(qe(r,{x1:l.x,y1:l.y,x2:c.x,y2:c.y}),qe(s,{x1:l.x,y1:l.y,x2:c.x,y2:c.y}),e.lineDecoration){o.style.display="none",a.style.display="none";var h=Fe({x:c.x-l.x,y:c.y-l.y}),u=ze(.05,i,n);if(-1!==e.lineDecoration.indexOf("arrow-begin")){var d=Ne(h,u),p=Be(l,d),m=Ue(l,2,p),g=Ue(l,-2,p);qe(o,{style:"display:block;",d:"M".concat(m.x,",").concat(m.y," L").concat(l.x,",").concat(l.y," L").concat(g.x,",").concat(g.y)})}if(-1!==e.lineDecoration.indexOf("arrow-end")){var v=Ne(h,-u),b=Be(c,v),_=Ue(c,2,b),y=Ue(c,-2,b);qe(a,{style:"display:block;",d:"M".concat(_.x,",").concat(_.y," L").concat(c.x,",").concat(c.y," L").concat(y.x,",").concat(y.y)})}}}},ti=function(t,e){return Qe[t](e)},ei=function(t,e,i,n,r){"path"!==e&&(t.rect=We(i,n,r)),t.styles=He(i,n,r),Je[e](t,i,n,r)},ii=function(t,e){return t[1].zIndex>e[1].zIndex?1:t[1].zIndex<e[1].zIndex?-1:0},ni=function(t,e,i,n){return new Promise((function(r){var o=n.background,a=void 0===o?null:o,s=new FileReader;s.onloadend=function(){var t=s.result,n=document.createElement("div");n.style.cssText="position:absolute;pointer-events:none;width:0;height:0;visibility:hidden;",n.innerHTML=t;var o=n.querySelector("svg");document.body.appendChild(n);var l=o.getBBox();n.parentNode.removeChild(n);var c=n.querySelector("title"),h=o.getAttribute("viewBox")||"",u=o.getAttribute("width")||"",d=o.getAttribute("height")||"",p=parseFloat(u)||null,f=parseFloat(d)||null,m=(u.match(/[a-z]+/)||[])[0]||"",g=(d.match(/[a-z]+/)||[])[0]||"",v=h.split(" ").map(parseFloat),b=v.length?{x:v[0],y:v[1],width:v[2],height:v[3]}:l,_=null!=p?p:b.width,y=null!=f?f:b.height;o.style.overflow="visible",o.setAttribute("width",_),o.setAttribute("height",y);var E="";if(i&&i.length){var T={width:_,height:y};E=i.sort(ii).reduce((function(t,e){var i=ti(e[0],e[1]);return ei(i,e[0],e[1],T),i.removeAttribute("id"),1===i.getAttribute("opacity")&&i.removeAttribute("opacity"),t+"\n"+i.outerHTML+"\n"}),""),E="\n\n<g>".concat(E.replace(/&nbsp;/g," "),"</g>\n\n")}var w=e.aspectRatio||y/_,x=_,C=x*w,R=void 0===e.scaleToFit||e.scaleToFit,A=ae({width:_,height:y},Jt({width:x,height:C},w),e.rotation,R?e.center:{x:.5,y:.5}),S=e.zoom*A,I=e.rotation*(180/Math.PI),k={x:.5*x,y:.5*C},$={x:k.x-_*e.center.x,y:k.y-y*e.center.y},O=["rotate(".concat(I," ").concat(k.x," ").concat(k.y,")"),"translate(".concat(k.x," ").concat(k.y,")"),"scale(".concat(S,")"),"translate(".concat(-k.x," ").concat(-k.y,")"),"translate(".concat($.x," ").concat($.y,")")],L=["scale(".concat(e.flip.horizontal?-1:1," ").concat(e.flip.vertical?-1:1,")"),"translate(".concat(e.flip.horizontal?-_:0," ").concat(e.flip.vertical?-y:0,")")],M='<?xml version="1.0" encoding="UTF-8"?>\n<svg width="'.concat(x).concat(m,'" height="').concat(C).concat(g,'" \nviewBox="0 0 ').concat(x," ").concat(C,'" ').concat(a?'style="background:'+a+'" ':"",'\npreserveAspectRatio="xMinYMin"\nxmlns:xlink="http://www.w3.org/1999/xlink"\nxmlns="http://www.w3.org/2000/svg">\n\x3c!-- Generated by PQINA - https://pqina.nl/ --\x3e\n<title>').concat(c?c.textContent:"",'</title>\n<g transform="').concat(O.join(" "),'">\n<g transform="').concat(L.join(" "),'">\n').concat(o.outerHTML).concat(E,"\n</g>\n</g>\n</svg>");r(M)},s.readAsText(t)}))},ri=function(t){var e;try{e=new ImageData(t.width,t.height)}catch(i){e=document.createElement("canvas").getContext("2d").createImageData(t.width,t.height)}return e.data.set(t.data),e},oi=function(){var t=function(t,e,i){var n=e[t]/255,s=e[t+1]/255,l=e[t+2]/255,c=e[t+3]/255,h=n*i[0]+s*i[1]+l*i[2]+c*i[3]+i[4],u=n*i[5]+s*i[6]+l*i[7]+c*i[8]+i[9],d=n*i[10]+s*i[11]+l*i[12]+c*i[13]+i[14],p=n*i[15]+s*i[16]+l*i[17]+c*i[18]+i[19],f=Math.max(0,h*p)+r*(1-p),m=Math.max(0,u*p)+o*(1-p),g=Math.max(0,d*p)+a*(1-p);e[t]=255*Math.max(0,Math.min(1,f)),e[t+1]=255*Math.max(0,Math.min(1,m)),e[t+2]=255*Math.max(0,Math.min(1,g))},e=function(t){return self.JSON.stringify(t||[])===s},i=function(t,i){if(!i||e(i))return t;for(var n=t.data,s=n.length,l=i[0],c=i[1],h=i[2],u=i[3],d=i[4],p=i[5],f=i[6],m=i[7],g=i[8],v=i[9],b=i[10],_=i[11],y=i[12],E=i[13],T=i[14],w=i[15],x=i[16],C=i[17],R=i[18],A=i[19],S=0,I=0,k=0,$=0,O=0,L=0,M=0,D=0,P=0,N=0,B=0,F=0;S<s;S+=4)L=(I=n[S]/255)*l+(k=n[S+1]/255)*c+($=n[S+2]/255)*h+(O=n[S+3]/255)*u+d,M=I*p+k*f+$*m+O*g+v,D=I*b+k*_+$*y+O*E+T,P=I*w+k*x+$*C+O*R+A,N=Math.max(0,L*P)+r*(1-P),B=Math.max(0,M*P)+o*(1-P),F=Math.max(0,D*P)+a*(1-P),n[S]=255*Math.max(0,Math.min(1,N)),n[S+1]=255*Math.max(0,Math.min(1,B)),n[S+2]=255*Math.max(0,Math.min(1,F));return t},n={resize:function(n,r){var o=r.mode,a=void 0===o?"contain":o,s=r.upscale,l=void 0!==s&&s,c=r.width,h=r.height,u=r.matrix;if(u=!u||e(u)?null:u,!c&&!h)return i(n,u);if(null===c?c=h:null===h&&(h=c),"force"!==a){var d=c/n.width,p=h/n.height,f=1;if("cover"===a?f=Math.max(d,p):"contain"===a&&(f=Math.min(d,p)),f>1&&!1===l)return i(n,u);c=n.width*f,h=n.height*f}for(var m=n.width,g=n.height,v=Math.round(c),b=Math.round(h),_=n.data,y=new Uint8ClampedArray(v*b*4),E=m/v,T=g/b,w=Math.ceil(.5*E),x=Math.ceil(.5*T),C=0;C<b;C++)for(var R=0;R<v;R++){for(var A=4*(R+C*v),S=0,I=0,k=0,$=0,O=0,L=0,M=0,D=(C+.5)*T,P=Math.floor(C*T);P<(C+1)*T;P++)for(var N=Math.abs(D-(P+.5))/x,B=(R+.5)*E,F=N*N,U=Math.floor(R*E);U<(R+1)*E;U++){var G=Math.abs(B-(U+.5))/w,z=Math.sqrt(F+G*G);if(z>=-1&&z<=1&&(S=2*z*z*z-3*z*z+1)>0){var H=_[3+(G=4*(U+P*m))];M+=S*H,k+=S,H<255&&(S=S*H/250),$+=S*_[G],O+=S*_[G+1],L+=S*_[G+2],I+=S}}y[A]=$/I,y[A+1]=O/I,y[A+2]=L/I,y[A+3]=M/k,u&&t(A,y,u)}return{data:y,width:v,height:b}},filter:i};self.onmessage=function(t){!function(t,e){var i,r,o=t.transforms,a=null;if(o.forEach((function(t){"filter"===t.type&&(a=t)})),a){var s=null;o.forEach((function(t){"resize"===t.type&&(s=t)})),s&&(s.data.matrix=a.data,o=o.filter((function(t){return"filter"!==t.type})))}e((i=o,r=t.imageData,i.forEach((function(t){r=n[t.type](r,t.data)})),r))}(t.data.message,(function(e){self.postMessage({id:t.data.id,message:e},[e.data.buffer])}))};var r=1,o=1,a=1,s=self.JSON.stringify([1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0])},ai=function(t,e){if(1165519206===t.getUint32(e+4,!1)){e+=4;var i=18761===t.getUint16(e+=6,!1);e+=t.getUint32(e+4,i);var n=t.getUint16(e,i);e+=2;for(var r=0;r<n;r++)if(274===t.getUint16(e+12*r,i))return t.setUint16(e+12*r+8,1,i),!0;return!1}},si=function(t){return new Promise((function(e){var i=new FileReader;i.onload=function(){return e(function(t){var e=new DataView(t);if(65496!==e.getUint16(0))return null;for(var i,n,r=2,o=!1;r<e.byteLength&&(i=e.getUint16(r,!1),n=e.getUint16(r+2,!1)+2,i>=65504&&i<=65519||65534===i)&&(o||(o=ai(e,r)),!(r+n>e.byteLength));)r+=n;return t.slice(0,r)}(i.result)||null)},i.readAsArrayBuffer(t.slice(0,262144))}))},li=function(t,e){var i=window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder;if(i){var n=new i;return n.append(t),n.getBlob(e)}return new Blob([t],{type:e})},ci=function(t){var e=new Blob(["(",t.toString(),")()"],{type:"application/javascript"}),i=URL.createObjectURL(e),n=new Worker(i),r=[];return{transfer:function(){},post:function(t,e,i){var o=Math.random().toString(36).substr(2,9);r[o]=e,n.onmessage=function(t){var e=r[t.data.id];e&&(e(t.data.message),delete r[t.data.id])},n.postMessage({id:o,message:t},i)},terminate:function(){n.terminate(),URL.revokeObjectURL(i)}}},hi=function(t){return new Promise((function(e,i){var n=new Image;n.onload=function(){e(n)},n.onerror=function(t){i(t)},n.src=t}))},ui=function(t,e){return new Promise((function(i){var n,r={width:t.width,height:t.height},o=t.getContext("2d"),a=e.sort(ii).map((function(t){return function(){return new Promise((function(e){fi[t[0]](o,r,t[1],e)&&e()}))}}));(n=a,n.reduce((function(t,e){return t.then((function(t){return e().then(Array.prototype.concat.bind(t))}))}),Promise.resolve([]))).then((function(){return i(t)}))}))},di=function(t,e){t.beginPath(),t.lineCap=e["stroke-linecap"],t.lineJoin=e["stroke-linejoin"],t.lineWidth=e["stroke-width"],e["stroke-dasharray"].length&&t.setLineDash(e["stroke-dasharray"].split(",")),t.fillStyle=e.fill,t.strokeStyle=e.stroke,t.globalAlpha=e.opacity||1},pi=function(t){t.fill(),t.stroke(),t.globalAlpha=1},fi={rect:function(t,e,i){var n=We(i,e),r=He(i,e);return di(t,r),t.rect(n.x,n.y,n.width,n.height),pi(t),!0},ellipse:function(t,e,i){var n=We(i,e),r=He(i,e);di(t,r);var o=n.x,a=n.y,s=n.width,l=n.height,c=s/2*.5522848,h=l/2*.5522848,u=o+s,d=a+l,p=o+s/2,f=a+l/2;return t.moveTo(o,f),t.bezierCurveTo(o,f-h,p-c,a,p,a),t.bezierCurveTo(p+c,a,u,f-h,u,f),t.bezierCurveTo(u,f+h,p+c,d,p,d),t.bezierCurveTo(p-c,d,o,f+h,o,f),pi(t),!0},image:function(t,e,i,n){var r=We(i,e),o=He(i,e);di(t,o);var a=new Image;a.onload=function(){if("cover"===i.fit){var e=r.width/r.height,o=e>1?a.width:a.height*e,s=e>1?a.width/e:a.height,l=.5*a.width-.5*o,c=.5*a.height-.5*s;t.drawImage(a,l,c,o,s,r.x,r.y,r.width,r.height)}else if("contain"===i.fit){var h=Math.min(r.width/a.width,r.height/a.height),u=h*a.width,d=h*a.height,p=r.x+.5*r.width-.5*u,f=r.y+.5*r.height-.5*d;t.drawImage(a,0,0,a.width,a.height,p,f,u,d)}else t.drawImage(a,0,0,a.width,a.height,r.x,r.y,r.width,r.height);pi(t),n()},a.src=i.src},text:function(t,e,i){var n=We(i,e),r=He(i,e);di(t,r);var o=ze(i.fontSize,e),a=i.fontFamily||"sans-serif",s=i.fontWeight||"normal",l=i.textAlign||"left";return t.font="".concat(s," ").concat(o,"px ").concat(a),t.textAlign=l,t.fillText(i.text,n.x,n.y),pi(t),!0},line:function(t,e,i){var n=We(i,e),r=He(i,e);di(t,r),t.beginPath();var o={x:n.x,y:n.y},a={x:n.x+n.width,y:n.y+n.height};t.moveTo(o.x,o.y),t.lineTo(a.x,a.y);var s=Fe({x:a.x-o.x,y:a.y-o.y}),l=.04*Math.min(e.width,e.height);if(-1!==i.lineDecoration.indexOf("arrow-begin")){var c=Ne(s,l),h=Be(o,c),u=Ue(o,2,h),d=Ue(o,-2,h);t.moveTo(u.x,u.y),t.lineTo(o.x,o.y),t.lineTo(d.x,d.y)}if(-1!==i.lineDecoration.indexOf("arrow-end")){var p=Ne(s,-l),f=Be(a,p),m=Ue(a,2,f),g=Ue(a,-2,f);t.moveTo(m.x,m.y),t.lineTo(a.x,a.y),t.lineTo(g.x,g.y)}return pi(t),!0},path:function(t,e,i){var n=He(i,e);di(t,n),t.beginPath();var r=i.points.map((function(t){return{x:ze(t.x,e,1,"width"),y:ze(t.y,e,1,"height")}}));t.moveTo(r[0].x,r[0].y);for(var o=r.length,a=1;a<o;a++)t.lineTo(r[a].x,r[a].y);return pi(t),!0}},mi=function(t){var e=document.createElement("canvas");return e.width=t.width,e.height=t.height,e.getContext("2d").putImageData(t,0,0),e},gi=function(t,e){if(1165519206!==t.getUint32(e+=2,!1))return-1;var i=18761===t.getUint16(e+=6,!1);e+=t.getUint32(e+4,i);var n=t.getUint16(e,i);e+=2;for(var r=0;r<n;r++)if(274===t.getUint16(e+12*r,i))return t.getUint16(e+12*r+8,i)},vi=function(t){return new Promise((function(e){var i=new FileReader;i.onload=function(){return e(function(t){var e=new DataView(t);if(65496!=e.getUint16(0,!1))return null;for(var i,n=e.byteLength,r=2;r<n;){if(e.getUint16(r+2,!1)<=8)return-1;if(i=e.getUint16(r,!1),r+=2,65505===i)return gi(e,r);if(65280!=(65280&i))return null;r+=e.getUint16(r,!1)}}(i.result)||-1)},i.readAsArrayBuffer(t.slice(0,262144))}))},bi=1,_i=2,yi=function(t,e,i){var n=!(arguments.length>3&&void 0!==arguments[3])||arguments[3],r=t.center,o=t.zoom,a=t.aspectRatio,s=Kt(e),l={x:s.x-i.width*r.x,y:s.y-i.height*r.y},c=2*Math.PI+t.rotation%(2*Math.PI),h=o*ae(i,Jt(e,a||i.height/i.width),c,n?r:{x:.5,y:.5});return{origin:{x:r.x*i.width,y:r.y*i.height},translation:l,scale:h,rotation:t.rotation}},Ei=function(t){return{origin:f({},t.origin),translation:f({},t.translation),rotation:t.rotation,scale:t.scale}},Ti=function(t,e,i,n){var r=i.translation,o=i.scale,a=i.rotation,s=i.origin,l={origin:f({},s),translation:f({},r),scale:o,rotation:2*Math.PI+a%(2*Math.PI)},c=t.height/t.width,h=ce(s,r,l.rotation,e),u=Kt(h),d=qt(h),p=se(t,i),m=Kt(p),g={x:p.x,y:p.y},v={x:m.x,y:m.y},b=u.x,_=u.y,y={x:g.x,y:g.y,width:p.width,height:p.height};if(!function(t,e){var i=qt(t),n=qt(e);return i.left>=n.left&&i.top>=n.top&&i.bottom<=n.bottom&&i.right<=n.right}(h,p))if("moving"===n){y.y>h.y?y.y=h.y:y.y+y.height<d.bottom&&(y.y=d.bottom-y.height),y.x>h.x?y.x=h.x:y.x+y.width<d.right&&(y.x=d.right-y.width);var E=se(t,f({},i,{scale:l.scale})),T=Kt(E);v.x=T.x,v.y=T.y,g.x=E.x,g.y=E.y,y.x=v.x-.5*y.width,y.y=v.y-.5*y.height,y.y>h.y?y.y=h.y:y.y+y.height<d.bottom&&(y.y=d.bottom-y.height),y.x>h.x?y.x=h.x:y.x+y.width<d.right&&(y.x=d.right-y.width);var w={x:y.x-g.x,y:y.y-g.y},x={x:w.x*Math.cos(l.rotation)-w.y*Math.sin(l.rotation),y:w.x*Math.sin(l.rotation)+w.y*Math.cos(l.rotation)};l.translation.x+=x.x,l.translation.y+=x.y}else if("resizing"===n){p.width<h.width&&(y.width=h.width,y.height=y.width*c,y.height<h.height&&(y.height=h.height,y.width=y.height/c)),p.height<h.height&&(y.height=h.height,y.width=y.height/c,y.width<h.width&&(y.width=h.width,y.height=y.width*c)),y.x=v.x-.5*y.width,y.y=v.y-.5*y.height,y.y>h.y?y.y=h.y:y.y+y.height<d.bottom&&(y.y=d.bottom-y.height),y.x>h.x?y.x=h.x:y.x+y.width<d.right&&(y.x=d.right-y.width),l.scale=ae(t,e,l.rotation,{x:(b-y.x)/y.width,y:(_-y.y)/y.height});var C=se(t,f({},i,{scale:l.scale})),R=Kt(C);v.x=R.x,v.y=R.y,g.x=C.x,g.y=C.y,y.x=v.x-.5*y.width,y.y=v.y-.5*y.height,y.y>h.y?y.y=h.y:y.y+y.height<d.bottom&&(y.y=d.bottom-y.height),y.x>h.x?y.x=h.x:y.x+y.width<d.right&&(y.x=d.right-y.width);var A={x:y.x-g.x,y:y.y-g.y},S={x:A.x*Math.cos(l.rotation)-A.y*Math.sin(l.rotation),y:A.x*Math.sin(l.rotation)+A.y*Math.cos(l.rotation)};l.translation.x+=S.x,l.translation.y+=S.y}else if("rotating"===n){var I=!1;if(y.y>h.y){var k=y.y-h.y;y.y=h.y,y.height+=2*k,I=!0}if(y.y+y.height<d.bottom){var $=d.bottom-(y.y+y.height);y.y=d.bottom-y.height,y.height+=2*$,I=!0}if(y.x>h.x){var O=y.x-h.x;y.x=h.x,y.width+=2*O,I=!0}if(y.x+y.width<d.right){var L=d.right-(y.x+y.width);y.x=d.right-y.width,y.width+=2*L,I=!0}I&&(l.scale=ae(t,e,l.rotation,{x:(b-p.x)/p.width,y:(_-p.y)/p.height}))}return f({},l,{rotation:i.rotation})},wi={n:function(t){return{x:t.x+.5*t.width,y:t.y}},e:function(t){return{x:t.x+t.width,y:t.y+.5*t.height}},s:function(t){return{x:t.x+.5*t.width,y:t.y+t.height}},w:function(t){return{x:t.x,y:t.y+.5*t.height}}},xi=function(t,e){return wi[t](e)},Ci=function(t,e,i){var n=i.origin,r=i.translation,o=2*Math.PI+i.rotation%(2*Math.PI),a=se(t,i),s={x:n.x+r.x,y:n.y+r.y},l=ce(n,r,o,e),c=qt(l),h=qt(a),u=a;if(c.top<h.top||c.right>h.right||c.bottom>h.bottom||c.left<h.left){var d=f({},h);if(c.top<=d.top){var p=d.bottom-d.top,m=d.right-d.left,g=Math.max(1,l.height/p),v=p*g,b=m*g-m;d.bottom=c.top+v,d.top=c.top,d.left-=.5*b,d.right+=.5*b}if(c.bottom>=d.bottom){var _=d.bottom-d.top,y=d.right-d.left,E=Math.max(1,l.height/_),T=_*E,w=y*E-y;d.bottom=c.bottom,d.top=c.bottom-T,d.left-=.5*w,d.right+=.5*w}if(c.left<=d.left){var x=d.bottom-d.top,C=d.right-d.left,R=Math.max(1,l.width/C),A=C*R,S=x*R-x;d.right=c.left+A,d.left=c.left,d.top-=.5*S,d.bottom+=.5*S}if(c.right>=d.right){var I=d.bottom-d.top,k=d.right-d.left,$=Math.max(1,l.width/k),O=k*$,L=I*$-I;d.right=c.right,d.left=c.right-O,d.top-=.5*L,d.bottom+=.5*L}u=Xt(d.left,d.top,d.right-d.left,d.bottom-d.top)}var M=Zt(u),D=Kt(u),P=Gt(M.tl,o,s),N=Gt(M.br,o,s),B=P.x+.5*(N.x-P.x),F=P.y+.5*(N.y-P.y),U=Vt(u,{x:B-D.x,y:F-D.y}),G=Vt(l,{x:B-D.x,y:F-D.y}),z=Kt(G),H={x:U.x,y:U.y},V=U.width,W=U.height,j=(z.x-H.x)/V,q=(z.y-H.y)/W,Y=V/t.width,K={x:j*t.width,y:q*t.height},Z=1-Y,X=K.x*Z,Q=K.y*Z,J={x:H.x+V*j,y:H.y+W*q},tt=Gt(H,o,{x:H.x+.5*V,y:H.y+.5*W}),et=Gt(H,o,J),it=tt.x-et.x,nt=tt.y-et.y;return{origin:K,translation:{x:H.x-X+it,y:H.y-Q+nt},scale:Y,rotation:i.rotation}},Ri={nw:function(t){return{x:t.x,y:t.y}},ne:function(t){return{x:t.x+t.width,y:t.y}},se:function(t){return{x:t.x+t.width,y:t.y+t.height}},sw:function(t){return{x:t.x,y:t.y+t.height}}},Ai=function(t,e){return Ri[t](e)},Si=Math.PI/2,Ii=Math.PI/4,ki=function(t){var e=Dt(Ii),i=Dt(Si),n=t/i,r=Math.floor(n)*i,o=t-r;return o>e&&(o-=i,r+=i),{main:r,sub:o}},$i=function(t,e){var i={width:t.width,height:t.height};if(t.width>e.width||t.height>e.height){var n=t.height/t.width,r=e.width/t.width,o=e.height/t.height;r<o?(i.width=t.width*r,i.height=i.width*n):(i.height=t.height*o,i.width=i.height/n)}return i},Oi=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";return(e+t).slice(-e.length)},Li=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:new Date;return"".concat(t.getFullYear(),"-").concat(Oi(t.getMonth()+1,"00"),"-").concat(Oi(t.getDate(),"00"),"_").concat(Oi(t.getHours(),"00"),"-").concat(Oi(t.getMinutes(),"00"),"-").concat(Oi(t.getSeconds(),"00"))},Mi=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{},n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:{},r=t("GET_CROP_ASPECT_RATIO"),o={center:{x:.5,y:.5},flip:{horizontal:!1,vertical:!1},zoom:1,rotation:0,aspectRatio:null};i?Object.assign(o,i):e.options.crop?Object.assign(o,e.options.crop):o.aspectRatio=r;var a=n.width,s=n.height;if(a&&s)o.aspectRatio=s/a;else if(e.instructions.size){var l=e.instructions.size,c=l.width,h=l.height;c&&h&&(o.aspectRatio=h/c)}return o},Di=function(t){return t.charAt(0).toUpperCase()+t.slice(1)},Pi=function(t){return t.split(".").pop()},Ni=function(t){if("string"!=typeof t)return"";var e=t.split("/").pop();return/svg/.test(e)?"svg":/zip|compressed/.test(e)?"zip":/plain/.test(e)?"txt":/msword/.test(e)?"doc":/[a-z]+/.test(e)?"jpeg"===e?"jpg":e:""},Bi={jpeg:"jpg","svg+xml":"svg"},Fi=function(t){return Array.isArray(t)&&20===t.length},Ui=["x","y","left","top","right","bottom","width","height"],Gi=function(t){var e=g(t,2),i=e[0],n=e[1],r=!1!==n.allowSelect,o=!1!==n.allowMove,a=!1!==n.allowResize,s=!1!==n.allowInput,l=!1!==n.allowDestroy,c=void 0===n.allowEdit||n.allowEdit;(!0===n.allowResize||!0===n.allowMove||!0===n.allowInput||n.allowEdit)&&(r=!0),!1===n.allowMove&&(a=!1),!0===n.allowResize&&(o=!0);var h=n.points?{}:Ui.reduce((function(t,e){return t[e]=function(t){return"string"==typeof t&&/%/.test(t)?parseFloat(t)/100:t}(n[e]),t}),{});return n.points&&(a=!1),[i,f({zIndex:0,id:Math.random().toString(36).substr(2,9)},n,h,{isDestroyed:!1,isSelected:!1,isDirty:!0,allowDestroy:l,allowSelect:r,allowMove:o,allowResize:a,allowInput:s,allowEdit:c})]},zi=function(t){if(!t)return null;var e=t.split(/filename=|filename\*=.+''/).splice(1).map((function(t){return t.trim().replace(/^["']|[;"']{0,2}$/g,"")})).filter((function(t){return t.length}));return e.length?decodeURI(e[e.length-1]):null},Hi=void 0,Vi=Z()?new Image:{};Vi.onload=function(){Hi=Vi.naturalWidth>Vi.naturalHeight,Vi=void 0},Vi.src="data:image/jpg;base64,/9j/4AAQSkZJRgABAQEASABIAAD/4QA6RXhpZgAATU0AKgAAAAgAAwESAAMAAAABAAYAAAEoAAMAAAABAAIAAAITAAMAAAABAAEAAAAAAAD/2wBDAP//////////////////////////////////////////////////////////////////////////////////////wAALCAABAAIBASIA/8QAJgABAAAAAAAAAAAAAAAAAAAAAxABAAAAAAAAAAAAAAAAAAAAAP/aAAgBAQAAPwBH/9k=";var Wi=null,ji=function(){return null===Wi&&(Wi=/MSIE|Trident/.test(window.navigator.userAgent)),Wi},qi={contrast:function(t){return[t,0,0,0,.5*(1-t),0,t,0,0,.5*(1-t),0,0,t,0,.5*(1-t),0,0,0,1,0]},exposure:function(t){return[t,0,0,0,0,0,t,0,0,0,0,0,t,0,0,0,0,0,1,0]},brightness:function(t){return[1,0,0,0,t,0,1,0,0,t,0,0,1,0,t,0,0,0,1,0]},saturation:function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:0;return[.213+.787*t,.715-.715*t,.072-.072*t,0,0,.213-.213*t,.715+.285*t,.072-.072*t,0,0,.213-.213*t,.715-.715*t,.072+.928*t,0,0,0,0,0,1,0]}},Yi=Math.PI/2,Ki=function(t){var e={upscale:t("GET_OUTPUT_UPSCALE"),mode:t("GET_OUTPUT_FIT"),width:t("GET_OUTPUT_WIDTH"),height:t("GET_OUTPUT_HEIGHT")},i=t("GET_SIZE_INPUT");if(i.width||i.height){var n=i.width,r=i.height,o=t("GET_CROP_RECTANGLE_ASPECT_RATIO");n&&!r?r=n/o:r&&!n&&(n=r*o),e.width=n,e.height=r,e.upscale=!0,e.mode="force"}return e},Zi=function(t,e){var i=e("GET_UID"),n=e("GET_CROP",i,Date.now()),r={width:n.cropStatus.currentWidth,height:n.cropStatus.currentHeight},o=t.mode,a=t.width,s=t.height,l=t.upscale;if(!a&&!s)return r;if(null===a?a=s:null===s&&(s=a),"force"!==o){var c=a/r.width,h=s/r.height,u=1;if("cover"===o?u=Math.max(c,h):"contain"===o&&(u=Math.min(c,h)),u>1&&!1===l)return r;a=r.width*u,s=r.height*u}return{width:Math.round(a),height:Math.round(s)}},Xi=function(t,e,i){return new Promise((function(n,r){var o,a,s={data:null,file:null},l=ue(e.image,e.crop),c=Ki(i),h={crop:l,image:f({},Zi(c,i),{orientation:e.file.orientation}),size:c,output:{type:i("GET_OUTPUT_TYPE"),quality:i("GET_OUTPUT_QUALITY"),background:e.options.outputCanvasBackgroundColor},filter:e.colorMatrices.filter?{id:e.filterName,value:e.filterValue,matrix:e.colorMatrices.filter}:null,color:Object.keys(e.colorValues).length?Object.keys(e.colorValues).reduce((function(t,i){return t[i]={value:e.colorValues[i],matrix:e.colorMatrices[i].map((function(t){return Dt(t,5)}))},t}),{}):null,markup:(o=(a=e,a.markup.filter((function(t){return!t[1].isDestroyed}))).map((function(t){return[t[0],f({},t[1])]})),o.map((function(t){var e=f({},t[1]);return Object.keys(e).forEach((function(t){void 0===e[t]&&delete e[t]})),delete e.isDestroyed,delete e.isSelected,delete e.isDirty,[t[0],e]}))),colorMatrix:i("GET_COLOR_MATRIX")};if(t.data&&(s.data=h),t.file){var u={beforeCreateBlob:i("GET_BEFORE_CREATE_BLOB"),afterCreateBlob:i("GET_AFTER_CREATE_BLOB"),stripImageHead:i("GET_OUTPUT_STRIP_IMAGE_HEAD"),canvasMemoryLimit:i("GET_OUTPUT_CANVAS_MEMORY_LIMIT")},d=e.file.data,p=f({},h,{filter:h.colorMatrix,markup:h.markup});(function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return new Promise((function(n,r){if(!t||!Ie(t))return r({status:"not an image file",file:t});var o=i.stripImageHead,a=i.beforeCreateBlob,s=i.afterCreateBlob,l=i.canvasMemoryLimit,c=e.crop,h=e.size,u=e.filter,d=e.markup,p=e.output,f=e.image&&e.image.orientation?Math.max(1,Math.min(8,e.image.orientation)):null,m=p&&p.quality,g=null===m?null:m/100,v=p&&p.type||null,b=p&&p.background||null,_=[];!h||"number"!=typeof h.width&&"number"!=typeof h.height||_.push({type:"resize",data:h}),u&&20===u.length&&_.push({type:"filter",data:u});var y=function(t){var e=s?s(t):t;Promise.resolve(e).then(n)},E=function(e,i){var n=mi(e),s=d.length?ui(n,d):n;Promise.resolve(s).then((function(e){Pe(e,i,a).then((function(i){if(Oe(e),o)return y(i);si(t).then((function(t){null!==t&&(i=new Blob([t,i.slice(20)],{type:i.type})),y(i)}))})).catch(r)}))};if(/svg/.test(t.type)&&null===v)return ni(t,c,d,{background:b}).then((function(t){n(li(t,"image/svg+xml"))}));var T=URL.createObjectURL(t);hi(T).then((function(e){URL.revokeObjectURL(T);var i=De(e,f,c,{canvasMemoryLimit:l,background:b}),n={quality:g,type:v||t.type};if(!_.length)return E(i,n);var r=ci(oi);r.post({transforms:_,imageData:i},(function(t){E(ri(t),n),r.terminate()}),[i.data.buffer])})).catch(r)}))})(d,p,u).then((function(t){s.file=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:null,n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null,r="string"==typeof i?t.slice(0,t.size,i):t.slice(0,t.size,t.type);return r.lastModifiedDate=new Date,ot(e)||(e=Li()),e&&null===n&&Pi(e)?r.name=e:(n=n||Ni(r.type),r.name=e+(n?"."+n:"")),r}(t,function(t,e){var i=function(t){return t.substr(0,t.lastIndexOf("."))||t}(t),n=e.split("/")[1],r=Bi[n]||n;return"".concat(i,".").concat(r)}(d.name,function(t){return/jpeg|png|svg\+xml/.test(t)?t:"image/jpeg"}(t.type))),n(s)})).catch(r)}else n(s)}))},Qi=function(t){t.crop.draft.rotateMinScale=null},Ji=function(t){t.crop.draft.rotateMinScale||(t.crop.draft.rotateMinScale=t.crop.transforms.scale)},tn=function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]&&arguments[3],r=!(arguments.length>4&&void 0!==arguments[4])||arguments[4];Ji(t);var o=f({},t.crop.transforms,{scale:t.crop.draft.rotateMinScale});t.crop.draft.transforms=hn(t.image,t.crop.rectangle,o,e.main+e.sub,i,t.crop.draft.transforms?t.crop.draft.transforms.rotation:t.crop.rotation.main+t.crop.rotation.sub,n,r),t.crop.rotation=ki(t.crop.draft.transforms.rotation)},en=function(t,e){if(null!==t.stage){var i=void 0===t.instructions.crop.scaleToFit?void 0===t.crop.limitToImageBounds?t.options.cropLimitToImageBounds:t.crop.limitToImageBounds:t.instructions.crop.scaleToFit,n=e("GET_STAGE_RECT",t.instructions.crop);t.crop.rectangle=Jt(n.fits?n:t.stage,t.instructions.crop.aspectRatio||t.image.aspectRatio),t.crop.draft.rectangle=null,"stage"!==n.mode&&n.fits&&(t.crop.rectangle.x=n.x,t.crop.rectangle.y=n.y),t.crop.transforms=yi(t.instructions.crop,n,t.image,i),t.crop.draft.transforms=null,t.crop.rotation=ki(t.instructions.crop.rotation),t.crop.flip=f({},t.instructions.crop.flip);var r=e("GET_CROP_ASPECT_RATIO_OPTIONS")||[],o=r.map((function(t){return t.value.aspectRatio})).find((function(e){return e===t.instructions.crop.aspectRatio})),a=r.find((function(t){return null===t.value.aspectRatio}));o?t.crop.aspectRatio=o:a&&r.length?t.crop.aspectRatio=null:t.crop.aspectRatio=e("GET_CROP_ASPECT_RATIO"),t.crop.isDirty=!1}},nn=function(t,e,i){if(null!==t.stage){sn(t),t.size.width=!!t.instructions.size&&t.instructions.size.width,t.size.height=!!t.instructions.size&&t.instructions.size.height,t.size.aspectRatioLocked=!0,t.size.aspectRatioPrevious=!1;var n=void 0===t.instructions.crop.scaleToFit?void 0===t.crop.limitToImageBounds?t.options.cropLimitToImageBounds:t.crop.limitToImageBounds:t.instructions.crop.scaleToFit;en(t,e),t.instructions.markup&&i("MARKUP_SET_VALUE",{value:t.instructions.markup}),i("CROP_SET_LIMIT",{value:n,silent:!0}),Object.keys(t.instructions.color).forEach((function(e){return i("COLOR_SET_VALUE",{key:e,value:t.instructions.color[e]})})),i("FILTER_SET_VALUE",{value:t.instructions.filter}),Qi(t)}},rn=function(t,e){if(t.stage){sn(t);var i=t.crop.rectangle,n=i.height/i.width,r=t.crop.aspectRatio;if(null!==r&&Dt(n,3)!==Dt(r,3)){var o=e("GET_MIN_CROP_SIZE");o.width=Dt(o.width),o.height=Dt(o.height);var a=Math.min(i.width,i.height);Math.min(a*r,a/r)<Math.max(o.width,o.height)&&(t.crop.rectangle=function(t,e,i){var n=jt(t);return n.width=Math.min(n.height,n.width),n.height=n.width,n.height=n.width*e,n.height<i.height&&(n.height=i.height,n.width=n.height/e),n.width<i.width&&(n.width=i.width,n.height=n.width*e),n}(f({},t.crop.rectangle),r,o),t.crop.draft.transforms=Ci(t.image,t.crop.rectangle,t.crop.transforms))}var s=t.crop.draft.transforms||t.crop.transforms,l=he(t.image,t.crop.rectangle,s,t.crop.limitToImageBounds);t.crop.aspectRatio&&(l.aspectRatio=t.crop.aspectRatio);var c=e("GET_STAGE_RECT",l);t.crop.transforms=yi(l,c,t.image,l.scaleToFit),t.crop.draft.transforms=null;var h=t.crop.aspectRatio||t.crop.rectangle.height/t.crop.rectangle.width;t.crop.rectangle=Jt(c,h),t.crop.draft.rectangle=null,"stage"!==c.mode&&(t.crop.rectangle.x+=c.x,t.crop.rectangle.y+=c.y),Qi(t)}},on=function(t,e,i){var n=e("GET_CROP_ZOOM_TIMEOUT");n&&(clearTimeout(t.zoomTimeoutId),t.zoomTimeoutId=setTimeout((function(){i("CROP_ZOOM")}),n))},an=function(t,e,i){sn(t),on(t,e,i)},sn=function(t){clearTimeout(t.zoomTimeoutId)},ln=function(t){t.crop.draft.transforms=Ei(t.crop.transforms),t.crop.draft.rectangle={limited:jt(t.crop.rectangle),free:jt(t.crop.rectangle)},sn(t)},cn=function(t,e){return Math.min(t.width/e.width,t.height/e.height)},hn=function(t,e,i,n,r,o,a,s){var l=f({},Ei(i),{rotation:n}),c=s?Ti(t,e,l,"rotating"):l,h=cn(e,r);return Dt(c.scale,5)>Dt(h,5)?(a&&(o+=2*a),f({},Ei(i),{rotation:o,interaction:{rotation:c.rotation}})):(c.scale=Math.min(h,c.scale),c.interaction={rotation:c.rotation},c)},un=function(t,e,i,n,r,o){var a=Math.max(1e-10,n),s=f({},Ei(i),{scale:a}),l=o?Ti(t,e,s,"resizing"):s,c=cn(e,r);return l.scale=Math.min(c,l.scale),l.interaction={scale:a},l},dn=function(t){t.crop.draft.rectangle=null,t.crop.transforms=t.crop.draft.transforms||t.crop.transforms,t.crop.transforms.interaction=null,t.crop.draft.transforms=null,t.crop.transforms=f({},t.crop.transforms,function(t,e,i){var n=i.origin,r=i.translation,o=i.scale,a=2*Math.PI+i.rotation%(2*Math.PI),s={x:n.x+r.x,y:n.y+r.y},l=ce(n,r,a,e),c=se(t,i),h=Zt(c),u=Kt(c),d=Gt(h.tl,a,s),p=Gt(h.br,a,s),f=d.x+.5*(p.x-d.x),m=d.y+.5*(p.y-d.y),g=Vt(c,{x:f-u.x,y:m-u.y}),v=Vt(l,{x:f-u.x,y:m-u.y}),b=Kt(v),_={x:g.x,y:g.y},y=g.width,E=g.height,T=(b.x-_.x)/y,w=(b.y-_.y)/E,x={x:T*t.width,y:w*t.height},C=1-o,R=x.x*C,A=x.y*C,S={x:_.x+y*T,y:_.y+E*w},I=Gt(_,a,{x:_.x+.5*y,y:_.y+.5*E}),k=Gt(_,a,S),$=I.x-k.x,O=I.y-k.y;return{origin:Pt(x),translation:Pt({x:_.x-R+$,y:_.y-A+O})}}(t.image,t.crop.rectangle,t.crop.transforms)),t.crop.isRotating=!1,t.crop.isDirty=!0},pn=function(t,e){return t.getAllResponseHeaders().indexOf(e)>=0?t.getResponseHeader(e):null},fn=function(t){for(var e=t.split(","),i=e[0].match(/([a-z]+\/[a-z]+)/)[0],n=atob(e[1]),r=n.length,o=new ArrayBuffer(n.length),a=new Uint8Array(o),s=0;s<r;s++)a[s]=n.charCodeAt(s);return new Blob([o],{type:i})},mn=function(t,e){var i=e.progress;return new Promise((function(e,n){if(ot(t)){var r=/^data:/.test(t);return r&&ji()?e({file:fn(t)}):void function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=e.progress,n=void 0===i?function(t){}:i,r=e.load,o=void 0===r?function(t,e){}:r,a=e.error,s=void 0===a?function(){}:a,l=new XMLHttpRequest;l.onprogress=function(t){return n(t.lengthComputable?t.loaded/t.total:null)},l.onerror=function(){return s(l)},l.onload=function(){var t=l.status>=200&&l.status<300,e=l.response;if(!t||!e)return s(l);var i=l.getResponseHeader("Content-Type"),n=pn(l,"Content-Disposition"),r=n?zi(n):null,a=pn(l,"Content-Doka"),c=null;if(a)try{c=JSON.parse(a)}catch(h){}!e.type.length&&i&&(m("blob"),e=e.slice(0,e.size,i)),r&&(e.name=r),o(e,c)},l.open("GET",t),l.responseType="blob",l.send()}(t,{progress:r?function(){}:i,error:n,load:function(t,i){return e({file:t,fileInstructions:i})}})}if(u(t,Blob))e({file:t});else{if("IMG"===t.nodeName){var o=function(t){var i=document.createElement("canvas");i.width=t.naturalWidth,i.height=t.naturalHeight,i.getContext("2d").drawImage(t,0,0),i.toBlob((function(t){return e({file:t})}))};return t.complete?void o(t):void(t.onload=function(){return o(t)})}"CANVAS"!==t.nodeName?n(t):t.toBlob((function(t){return e({file:t})}))}}))},gn=function(t){return!1===t.file},vn=function(t,e,i){return f({SET_UID:function(t){var e=t.id;i.uid=e},AWAIT_IMAGE:function(){i.file||(i.noImageTimeout=setTimeout((function(){t("AWAITING_IMAGE")}),250))},REQUEST_REMOVE_IMAGE:function(){t("UNLOAD_IMAGE"),i.file=!1,i.noImageTimeout=setTimeout((function(){t("AWAITING_IMAGE")}),500)},DID_UNLOAD_IMAGE:function(){t("ABORT_IMAGE")},REQUEST_ABORT_IMAGE:function(e){t("UNLOAD_IMAGE"),i.file=!1,i.queuedFile=e},DID_SET_SRC:function(e){e.value!==e.prevValue&&(clearTimeout(i.noImageTimeout),t("REQUEST_LOAD_IMAGE",{source:e.value}))},ABORT_IMAGE:function(){if(i.file=null,i.queuedFile){var e=i.queuedFile;i.queuedFile=null,t("REQUEST_LOAD_IMAGE",e)}},REQUEST_LOAD_IMAGE:function(e){var n=e.source,r=e.success,o=void 0===r?function(){}:r,a=e.failure,s=void 0===a?function(t){}:a,l=e.options,c=e.resolveOnConfirm,h=void 0!==c&&c;if(clearTimeout(i.noImageTimeout),!n)return s("no-image-source");if(null===i.file){ft(i),i.file={uid:yt()},t("DID_REQUEST_LOAD_IMAGE",{source:n});var u=function(e){if(gn(i))return t("ABORT_IMAGE");t("DID_LOAD_IMAGE_ERROR",{error:{status:"IMAGE_LOAD_ERROR",data:e}}),s(e)};mn(n,{progress:function(e){return null!==e&&t("DID_MAKE_PROGRESS",{progress:e})}}).then((function(e){var n=e.file,r=e.fileInstructions;if(!l&&r){var a=r.crop,c=r.filter,d=r.colorMatrix,p=r.color,f=r.markup,m=r.size;l={crop:a,filter:c?c.id||c.matrix:d,color:p,markup:f,size:m}}if(gn(i))return t("ABORT_IMAGE");var g=i.options.beforeLoadImage,v=g?g(n):n;Promise.resolve(v).then((function(e){e.name||(e.name=Li()),i.file.orientation=-1,i.file.data=e,t("LOAD_IMAGE",{success:o,failure:s,options:l,resolveOnConfirm:h},!0),t("KICK")})).catch((function(t){setTimeout((function(){u(t)}),100)}))})).catch(u)}else t("REQUEST_ABORT_IMAGE",{source:n,success:o,failure:s,options:l,resolveOnConfirm:h})},LOAD_IMAGE:function(n){var r=n.success,o=n.failure,a=n.options,s=void 0===a?{}:a,l=n.resolveOnConfirm;if(gn(i))return t("ABORT_IMAGE");var c,h=i.file.data;Promise.all([(c=h,new Promise((function(t,e){var i=new Image;i.src=URL.createObjectURL(c),i.onerror=function(t){clearInterval(n),e(t)};var n=setInterval((function(){i.naturalWidth&&i.naturalHeight&&(clearInterval(n),URL.revokeObjectURL(i.src),t({width:i.naturalWidth,height:i.naturalHeight}))}),1)}))),vi(h)]).then((function(n){var a=g(n,2),c=a[0],h=a[1];if(gn(i))return t("ABORT_IMAGE");if(i.file.orientation=e("GET_OUTPUT_CORRECT_IMAGE_EXIF_ORIENTATION")&&Hi?h:-1,i.file.orientation>-1){var u=c.width,d=c.height;h>=5&&h<=8&&(c.width=d,c.height=u)}var p=e("GET_MIN_IMAGE_SIZE");if(c.width<p.width||c.height<p.height)return t("DID_LOAD_IMAGE_ERROR",{error:{status:"IMAGE_MIN_SIZE_VALIDATION_ERROR",data:{size:c,minImageSize:p}}}),ft(i),void o();var m=$i(c,{width:e("GET_MAX_IMAGE_PREVIEW_WIDTH"),height:e("GET_MAX_IMAGE_PREVIEW_HEIGHT")});if(i.image={x:0,y:0,width:m.width,height:m.height,naturalWidth:c.width,naturalHeight:c.height,aspectRatio:c.height/c.width,orientation:h},s.size&&(s.size.hasOwnProperty("mode")&&s.size.hasOwnProperty("upscale")?(i.options.outputWidth=s.size.width,i.options.outputHeight=s.size.height,i.options.outputFit=s.size.mode,i.options.upscale=s.size.upscale):(i.size.width=s.size.width,i.size.height=s.size.height,i.size.aspectRatioLocked=!0,i.size.aspectRatioPrevious=!1,i.instructions.size={width:s.size.width,height:s.size.height})),i.instructions.crop=Mi(e,i,s.crop?f({},s.crop):null,i.size),i.crop.limitToImageBounds=i.options.cropLimitToImageBounds,!1===i.instructions.crop.scaleToFit&&(i.crop.limitToImageBounds=i.instructions.crop.scaleToFit),void 0===s.filter)i.instructions.filter=i.options.filter;else{var v=s.filter;i.instructions.filter=null===v?v:v.id||v.matrix||v}var b=i.options.markup||[];i.instructions.markup=b.concat(s.markup||[]),i.instructions.color=Object.keys(qi).reduce((function(t,e){return t[e]=s.color&&void 0!==s.color[e]?"number"==typeof s.color[e]?s.color[e]:s.color[e].value:i.options["color".concat(Di(e))],t}),{}),t("DID_LOAD_IMAGE",{image:f({size:i.file.data.size,name:i.file.data.name,type:i.file.data.type,orientation:h},c)}),i.filePromise={resolveOnConfirm:l,success:r,failure:o}})).catch((function(e){if(gn(i))return t("ABORT_IMAGE");t("DID_LOAD_IMAGE_ERROR",{error:{status:"IMAGE_UNKNOWN_ERROR",data:e}}),ft(i),o()}))},CHANGE_VIEW:function(e){var n=e.id;i.activeView=n,t("SHOW_VIEW",{id:n})},UPDATE_ROOT_RECT:function(t){var e=t.rect;i.rootRect=e},DID_RESIZE_STAGE:function(n){var r=n.size,o=n.offset,a=n.animate,s=null===i.stage;if(i.stage=Xt(0,0,r.width,r.height),i.stageOffset=zt(o.x,o.y),!e("GET_ALLOW_PREVIEW_FIT_TO_VIEW")){var l=e("GET_IMAGE_STAGE_RECT");i.stage=Xt(0,0,l.width,l.height),i.stageOffset=zt(i.stageOffset.x+l.x,i.stageOffset.y+l.y)}if(s){if(nn(i,e,t),t("DID_SHOW_IMAGE",{image:{size:i.file.data.size,name:i.file.data.name,type:i.file.data.type,orientation:i.image.orientation,width:i.image.naturalWidth,height:i.image.naturalHeight}}),!i.filePromise.resolveOnConfirm){var c=ue(i.image,i.crop),h=Ki(e);i.filePromise.success({crop:c,image:{orientation:i.file.orientation},size:h,output:{type:e("GET_OUTPUT_TYPE"),quality:e("GET_OUTPUT_QUALITY")}})}}else i.instantUpdate=!a,rn(i,e),setTimeout((function(){i.instantUpdate=!1}),16)},RESIZE_SET_OUTPUT_SIZE_ASPECT_RATIO_LOCK:function(t){var e=t.value;i.size.aspectRatioLocked=e},RESIZE_SET_OUTPUT_SIZE:function(n){var r=n.width,o=n.height,a=pe({width:r=r||null,height:o=o||null},e("GET_SIZE_MIN"),e("GET_SIZE_MAX"),e("GET_CROP_RECTANGLE_ASPECT_RATIO"));if(i.size.width=a.width?Math.round(a.width):null,i.size.height=a.height?Math.round(a.height):null,r&&o){var s=o/r;if(s===i.crop.aspectRatio)return;!1===i.size.aspectRatioPrevious&&(i.size.aspectRatioPrevious=i.crop.aspectRatio),t("CROP_SET_ASPECT_RATIO",{value:s})}else!1!==i.size.aspectRatioPrevious&&(t("CROP_SET_ASPECT_RATIO",{value:i.size.aspectRatioPrevious}),i.size.aspectRatioPrevious=!1)},CROP_SET_ASPECT_RATIO:function(t){var n=t.value;if(sn(i),i.crop.aspectRatio=ot(n)?Qt(n):n,i.crop.aspectRatio&&rn(i,e),i.crop.isDirty=!0,i.size.width&&i.size.height)if(i.crop.aspectRatio){var r=i.size.width*i.crop.aspectRatio,o=Mt(r,e("GET_SIZE_MIN").height,e("GET_SIZE_MAX").height);i.size.height=o,i.size.width=o/i.crop.aspectRatio}else i.size.height=null},DID_SET_CROP_ASPECT_RATIO:function(e){var i=e.value,n=e.prevValue;Qt(i)!==Qt(n)&&t("CROP_SET_ASPECT_RATIO",{value:i})},CROP_ZOOM:function(){i.stage&&(sn(i),rn(i,e))},DID_SET_CROP_LIMIT_TO_IMAGE_BOUNDS:function(e){var n=e.value,r=e.prevValue;i.crop.limitToImageBounds=n,!1===r&&!0===n&&t("CROP_ENABLED_LIMIT_TO_IMAGE_BOUNDS")},CROP_ENABLED_LIMIT_TO_IMAGE_BOUNDS:function(){var t=i.stage,n=i.image;if(i.crop.rectangle){var r=i.crop.rectangle.height/i.crop.rectangle.width,o=Jt(t,r);i.crop.rectangle=o,i.crop.transforms=Ti(n,i.crop.rectangle,i.crop.transforms,"moving"),i.crop.transforms=Ti(n,i.crop.rectangle,i.crop.transforms,"resizing"),i.crop.transforms=Ti(n,i.crop.rectangle,i.crop.transforms,"rotating"),i.crop.draft.rectangle=null,i.crop.draft.transforms=null,rn(i,e)}},CROP_SET_LIMIT:function(e){var n=e.value,r=e.silent,o=void 0!==r&&r,a=i.crop.limitToImageBounds!==n;i.crop.limitToImageBounds=n,a&&!o&&(i.crop.isDirty=!0),a&&n&&t("CROP_ENABLED_LIMIT_TO_IMAGE_BOUNDS")},CROP_IMAGE_RESIZE_GRAB:function(){ln(i),sn(i)},CROP_IMAGE_ROTATE_GRAB:function(){ln(i),sn(i),i.crop.isRotating=!0},CROP_RECT_DRAG_GRAB:function(){ln(i),sn(i)},CROP_RECT_DRAG_RELEASE:function(){var n;(n=i).crop.rectangle=n.crop.draft.rectangle.limited,n.crop.draft.rectangle=null,dn(n),Qi(n),on(i,e,t)},CROP_RECT_EDGE_DRAG:function(t){var n=t.offset,r=t.origin,o=t.anchor,a=i.image,s=i.stage,l=/n|s/.test(r)?_i:bi,c=xi(r,i.crop.rectangle),h=xi(o,i.crop.rectangle),u=Ut({x:c.x+(l===bi?n.x:0),y:c.y+(l===_i?n.y:0)},s),d=e("GET_MIN_CROP_SIZE"),p=e("GET_MAX_CROP_SIZE");d.width=Dt(d.width),d.height=Dt(d.height);var f=cn(i.crop.rectangle,e("GET_MIN_PREVIEW_IMAGE_SIZE"))/(i.crop.draft.transforms.scale||i.crop.transforms.scale);p.width=Dt(p.width*f),p.height=Dt(p.height*f);var m={x:Math.sign(c.x-h.x),y:Math.sign(c.y-h.y)};i.crop.draft.rectangle=function(t,e,i,n,r,o,a,s,l){var c=o.left,h=o.right,u=o.top,d=o.bottom,p=h-c,f=d-u,m=r.left,g=r.right,v=r.top,b=r.bottom;if(i===_i){if(v=t.y>0?n.y:Math.min(n.y,Math.max(e.y,u)),b=t.y>0?Math.max(n.y,Math.min(e.y,d)):n.y,a){var _=(b-v)/a;m=n.x-.5*_,g=n.x+.5*_}}else if(m=t.x>0?n.x:Math.min(n.x,Math.max(e.x,c)),g=t.x>0?Math.max(n.x,Math.min(e.x,h)):n.x,a){var y=(g-m)*a;v=n.y-.5*y,b=n.y+.5*y}var E,T,w,x,C=s.width,R=s.height;if(i===_i?(E=n.x-.5*C,T=n.x+.5*C,t.y<0?(w=n.y-R,x=n.y):t.y>0&&(w=n.y,x=n.y+R)):(w=n.y-.5*R,x=n.y+.5*R,t.x<0?(E=n.x-C,T=n.x):t.x>0&&(E=n.x,T=n.x+C)),a)if(i===_i){var A=Math.min((b-v)/a,p),S=A*a;m<c&&(g=(m=c)+A),g>h&&(m=(g=h)-A),n.x=m+.5*A,t.y<0?v=n.y-S:t.y>0&&(b=n.y+S)}else{var I=Math.min((g-m)*a,f),k=I/a;v<u&&(b=(v=u)+I),b>d&&(v=(b=d)-I),n.y=v+.5*I,t.x<0?m=n.x-k:t.x>0&&(g=n.x+k)}var $=Yt({top:v,right:g,bottom:b,left:m}),O=function(){var e=C*a;i===bi?(v=n.y-.5*e,b=n.y+.5*e):t.y<0?(b=n.y,v=b-e):t.y>0&&(v=n.y,b=v+e)},L=function(){var e=R/a;i===_i?(m=n.x-.5*e,g=n.x+.5*e):t.x<0?(g=n.x,m=g-e):t.x>0&&(m=n.x,g=m+e)};g<T&&(g=T,m=T-C,a&&O()),m>E&&(m=E,g=E+C,a&&O()),v>w&&(v=w,b=w+R,a&&L()),b<x&&(b=x,v=x-R,a&&L());var M=l.width,D=l.height;if(a&&(a<1?M=D/a:D=M*a),g-m>M&&(t.x<0?m=n.x-M:g=n.x+M),b-v>D&&(t.y<0?v=n.y-D:b=n.y+D),g-m==0&&(t.x>0?g=n.x+2:m=n.x-2),b-v==0&&(t.y>0?b=n.y+2:v=n.y-2),Math.round(m)<c||Math.round(g)>h||Math.round(v)<u||Math.round(b)>d){var P=d-u,N=h-c;if(m<c){m=c;var B=Math.min(g-m,N);g=m+B}if(g>h){g=h;var F=Math.min(g-m,N);m=g-F}if(v<u){v=u;var U=Math.min(b-v,P);b=v+U}if(b>d){b=d;var G=Math.min(b-v,P);v=b-G}$=Yt({top:v,right:g,bottom:b,left:m})}return{free:$,limited:Yt({top:v,right:g,bottom:b,left:m})}}(m,u,l,h,qt(i.crop.rectangle),qt(s),i.crop.aspectRatio,d,p),i.crop.limitToImageBounds&&(i.crop.draft.transforms=Ci(a,i.crop.draft.rectangle.limited,i.crop.transforms))},CROP_RECT_CORNER_DRAG:function(t){var n=t.offset,r=t.origin,o=t.anchor,a=i.image,s=i.stage,l=Ai(r,i.crop.rectangle),c=Ai(o,i.crop.rectangle),h={x:l.x+n.x,y:l.y+n.y},u=e("GET_MIN_CROP_SIZE"),d=e("GET_MAX_CROP_SIZE");u.width=Dt(u.width),u.height=Dt(u.height);var p=cn(i.crop.rectangle,e("GET_MIN_PREVIEW_IMAGE_SIZE"))/(i.crop.draft.transforms.scale||i.crop.transforms.scale);d.width=Dt(d.width*p),d.height=Dt(d.height*p);var f={x:Math.sign(l.x-c.x),y:Math.sign(l.y-c.y)};i.crop.draft.rectangle=function(t,e,i,n,r,o,a){var s=qt(n),l=s.left,c=s.right,h=s.top,u=s.bottom,d=Ut({x:e.x,y:e.y},n),p=t.x>0?i.x:Math.min(d.x,i.x),f=t.x>0?Math.max(i.x,d.x):i.x,m=t.y>0?i.y:Math.min(d.y,i.y),g=t.y>0?Math.max(i.y,d.y):i.y;if(r){var v=d.x-i.x;t.x>0?f=Math.max(i.x,i.x+t.x*v):p=Math.min(i.x,i.x-t.x*v),t.y>0?g=Math.max(i.y,i.y+t.x*v*r):m=Math.min(i.y,i.y-t.x*v*r)}var b=Yt({top:m,right:f,bottom:g,left:p});if(Yt({top:m,right:f,bottom:g,left:p}),o.width&&o.height){var _=o.width,y=o.height;r&&(1===r?y=_=Math.max(_,y):_<y?_=y/r:_>y?y=_*r:_=y/r),f-p<_&&(t.x>0?f=i.x+_:p=i.x-_),g-m<y&&(t.y>0?g=i.y+y:m=i.y-y);var E=a.width,T=a.height;r&&(r<1?E=T/r:T=E*r),f-p>E&&(t.x<0?p=i.x-E:f=i.x+E),g-m>T&&(t.y<0?m=i.y-T:g=i.y+T)}if(f-p==0&&(t.x>0?f=i.x+2:p=i.x-2),g-m==0&&(t.y>0?g=i.y+2:m=i.y-2),Math.round(p)<l||Math.round(f)>c||Math.round(m)<h||Math.round(g)>u){var w=u-h,x=c-l;if(p<l){p=l;var C=Math.min(f-p,x);f=p+C,r&&(t.y>0&&(g=i.y+C*r),t.y<0&&(m=i.y-C*r))}if(f>c){f=c;var R=Math.min(f-p,x);p=f-R,r&&(t.y>0&&(g=i.y+R*r),t.y<0&&(m=i.y-R*r))}if(m<h){m=h;var A=Math.min(g-m,w);g=m+A,r&&(t.x>0&&(f=i.x+A/r),t.x<0&&(p=i.x-A/r))}if(g>u){g=u;var S=Math.min(g-m,w);m=g-S,r&&(t.x>0&&(f=i.x+S/r),t.x<0&&(p=i.x-S/r))}b=Yt({top:m,right:f,bottom:g,left:p})}return{free:b,limited:Yt({top:m,right:f,bottom:g,left:p})}}(f,h,c,s,i.crop.aspectRatio,u,d),i.crop.limitToImageBounds&&(i.crop.draft.transforms=Ci(a,i.crop.draft.rectangle.limited,i.crop.transforms))},CROP_IMAGE_DRAG_GRAB:function(){return ln(i)||sn(i)},CROP_IMAGE_DRAG_RELEASE:function(){dn(i),Qi(i),on(i,e,t)},CROP_IMAGE_ROTATE_RELEASE:function(){dn(i),on(i,e,t)},CROP_IMAGE_DRAG:function(t){var e=t.value;sn(i),i.crop.draft.transforms=function(t,e,i,n,r){var o={x:i.translation.x+n.x,y:i.translation.y+n.y},a=f({},Ei(i),{translation:o}),s=r?Ti(t,e,a,"moving"):a;return s.interaction={translation:o},s}(i.image,i.crop.rectangle,i.crop.transforms,e,i.crop.limitToImageBounds)},CROP_IMAGE_RESIZE_RELEASE:function(){e("GET_CROP_RESIZE_MATCH_IMAGE_ASPECT_RATIO")&&function(t,e){var i=Dt(t.crop.draft.transforms.scale,5);if(!(Dt(t.crop.draft.targetSize,5)<i))return!1;if(null!==t.crop.aspectRatio)return!1;if(!1===t.crop.limitToImageBounds)return!1;if(0!==Dt(t.crop.rotation.sub,5))return!1;var n=Dt(t.crop.rotation.main/Yi,5)%2!=0?t.image.width/t.image.height:t.image.height/t.image.width;if(n===t.crop.rectangle.height/t.crop.rectangle.width)return!1;var r=t.stage.x+.5*t.stage.width,o=t.stage.y+.5*t.stage.height,a=t.crop.rectangle.x+.5*t.crop.rectangle.width,s=t.crop.rectangle.y+.5*t.crop.rectangle.height;if(a!==r||s!==o)return!1;var l=e("GET_STAGE_RECT");t.crop.rectangle=Jt(l,n),"stage"!==l.mode&&(t.crop.rectangle.x+=l.x,t.crop.rectangle.y+=l.y),t.crop.transforms=yi({center:{x:.5,y:.5},rotation:t.crop.transforms.rotation,zoom:1,aspectRatio:n},l,t.image,!0),t.crop.draft.transforms=null}(i,e),dn(i),Qi(i),on(i,e,t)},CROP_IMAGE_RESIZE:function(t){var n=t.value;sn(i);var r=i.crop.transforms;i.crop.draft.targetSize=r.scale+r.scale*n,i.crop.draft.transforms=un(i.image,i.crop.rectangle,r,i.crop.draft.targetSize,e("GET_MIN_PREVIEW_IMAGE_SIZE"),i.crop.limitToImageBounds)},CROP_IMAGE_RESIZE_SET:function(t){var n=t.value,r=Math.max(i.crop.rectangle.width/i.image.width,i.crop.rectangle.height/i.image.height);sn(i);var o=i.crop.transforms;i.crop.draft.targetSize=n*r,i.crop.draft.transforms=un(i.image,i.crop.rectangle,o,i.crop.draft.targetSize,e("GET_MIN_PREVIEW_IMAGE_SIZE"),i.crop.limitToImageBounds)},CROP_IMAGE_RESIZE_MULTIPLY:function(t){var n=t.value;sn(i);var r=i.crop.transforms;i.crop.draft.targetSize=r.scale*n,i.crop.draft.transforms=un(i.image,i.crop.rectangle,r,i.crop.draft.targetSize,e("GET_MIN_PREVIEW_IMAGE_SIZE"),i.crop.limitToImageBounds)},CROP_IMAGE_RESIZE_AMOUNT:function(t){var n=t.value;sn(i);var r=i.crop.transforms;i.crop.draft.targetSize=(i.crop.draft.transforms?i.crop.draft.transforms.scale:r.scale)+n,i.crop.draft.transforms=un(i.image,i.crop.rectangle,r,i.crop.draft.targetSize,e("GET_MIN_PREVIEW_IMAGE_SIZE"),i.crop.limitToImageBounds)},CROP_IMAGE_ROTATE:function(t){var n=t.value;sn(i),i.crop.isRotating=!0,tn(i,{main:i.crop.rotation.main,sub:n},e("GET_MIN_PREVIEW_IMAGE_SIZE"),!1,i.crop.limitToImageBounds)},CROP_IMAGE_ROTATE_ADJUST:function(t){var n=t.value;sn(i),tn(i,{main:i.crop.rotation.main,sub:Math.min(Math.PI/4,Math.max(-Math.PI/4,i.crop.rotation.sub+n))},e("GET_MIN_PREVIEW_IMAGE_SIZE"),!1,i.crop.limitToImageBounds),dn(i)},CROP_IMAGE_ROTATE_CENTER:function(){sn(i),tn(i,{main:i.crop.rotation.main,sub:0},e("GET_MIN_PREVIEW_IMAGE_SIZE"),!1,i.crop.limitToImageBounds),dn(i)},CROP_IMAGE_ROTATE_LEFT:function(){an(i,e,t),tn(i,{main:i.crop.rotation.main-Yi,sub:i.crop.rotation.sub},e("GET_MIN_PREVIEW_IMAGE_SIZE"),-Yi,i.crop.limitToImageBounds),dn(i),e("GET_CROP_FORCE_LETTERBOX")&&t("CROP_UPDATE_LETTERBOX")},CROP_IMAGE_ROTATE_RIGHT:function(){an(i,e,t),tn(i,{main:i.crop.rotation.main+Yi,sub:i.crop.rotation.sub},e("GET_MIN_PREVIEW_IMAGE_SIZE"),Yi,i.crop.limitToImageBounds),dn(i),e("GET_CROP_FORCE_LETTERBOX")&&t("CROP_UPDATE_LETTERBOX")},CROP_IMAGE_FLIP_HORIZONTAL:function(){an(i,e,t),0===Dt(i.crop.rotation.main%Math.PI/2,5)?i.crop.flip.horizontal=!i.crop.flip.horizontal:i.crop.flip.vertical=!i.crop.flip.vertical,i.crop.isDirty=!0},CROP_IMAGE_FLIP_VERTICAL:function(){an(i,e,t),0===Dt(i.crop.rotation.main%Math.PI/2,5)?i.crop.flip.vertical=!i.crop.flip.vertical:i.crop.flip.horizontal=!i.crop.flip.horizontal,i.crop.isDirty=!0},DID_RECEIVE_IMAGE_DATA:function(t){var e=t.previewData,n=t.thumbData;i.file.preview=e,i.file.thumb=n},MARKUP_SET_VALUE:function(t){var e=t.value;i.markup=(e||[]).map(Gi).sort(ii)},MARKUP_ADD_DEFAULT:function(i){var n=i.value,r=function(){return-.5+Math.random()},o=e("GET_CROP_RECTANGLE_ASPECT_RATIO"),a=o>1?.5/o:.5,s=o>1?.5:.5*o,l=function(){return{width:a,height:s,x:.5+.5*r()-.5*a,y:.5+.5*r()-.5*s}},c=function(t){return e("GET_MARKUP_TOOL_VALUES")[t]},h=function(){var t=c("shapeStyle"),e=c("color"),i=t[0]||t[1]?null:e;return{backgroundColor:i,borderWidth:t[0],borderStyle:t[1]?t[1]:null,borderColor:null!==i?null:e}},u={rect:function(){return f({},l(),h())},ellipse:function(){return f({},l(),h())},text:function(){return{x:.5+.5*r()-.1,y:.5+.5*r(),width:0,height:0,fontColor:c("color"),fontSize:c("fontSize"),fontFamily:c("fontFamily"),text:"Text"}},line:function(){var t=c("lineStyle");return f({},l(),{lineColor:c("color"),lineWidth:t[0],lineStyle:t[1]?t[1]:null,lineDecoration:c("lineDecoration")})}}[n]();t("MARKUP_ADD",[n,u])},MARKUP_ADD:function(n){i.markup.forEach((function(t){return t[1].isSelected=!1})),i.markup=i.markup.filter((function(t){return!t[1].isDestroyed}));var r=Gi(n);i.markup.push(r),i.markup.sort(ii),"draw"!==e("GET_MARKUP_UTIL")&&t("MARKUP_SELECT",{id:r[1].id}),i.crop.isDirty=!0},MARKUP_SELECT:function(t){var e=t.id;i.markup.forEach((function(t){t[1].isSelected=t[1].id===e,t[1].isDirty=!0}))},MARKUP_ELEMENT_DRAG:function(t){var e=t.id,n=t.origin,r=t.offset,o=t.size,a=i.markup.find((function(t){return t[1].id===e}));if(a){var s=a[1],l=n.x/o.width,c=n.y/o.height,h=n.width/o.width,u=n.height/o.height,d=r.x/o.width,p=r.y/o.height;s.x=l+d,s.y=c+p,s.width=h,s.height=u,s.left=void 0,s.top=void 0,s.right=void 0,s.bottom=void 0,s.isDirty=!0,i.crop.isDirty=!0}},MARKUP_ELEMENT_RESIZE:function(t){var e=t.id,n=t.corner,r=t.origin,o=t.offset,a=t.size,s=i.markup.find((function(t){return t[1].id===e}));if(s){var l=g(s,2),c=l[0],h=l[1],u=(r.x+o.x)/a.width,d=(r.y+o.y)/a.height;if(/n/.test(n))if("line"===c)h.height=h.height-(d-h.y),h.y=d;else{var p=h.y+h.height;d>p&&(d=p),h.height=h.height-(d-h.y),h.y=d}if(/w/.test(n))if("line"===c)h.width=h.width-(u-h.x),h.x=u;else{var f=h.x+h.width;u>f&&(u=f),h.width=h.width-(u-h.x),h.x=u}/s/.test(n)&&(h.height="line"===c?d-h.y:Math.max(0,d-h.y)),/e/.test(n)&&(h.width="line"===c?u-h.x:Math.max(0,u-h.x)),h.left=void 0,h.top=void 0,h.right=void 0,h.bottom=void 0,h.isDirty=!0,i.crop.isDirty=!0}},MARKUP_DELETE:function(e){var n=e.id,r=i.markup.find((function(t){return t[1].id===n}));if(r){var o=r[1];o.allowDestroy&&(o.isDestroyed=!0,o.isSelected=!1,o.isDirty=!0);for(var a=null,s=i.markup.length;s>0;){s--;var l=i.markup[s][1];if(!l.isDestroyed&&l.allowDestroy){a=l.id;break}}t("MARKUP_SELECT",{id:a})}},MARKUP_UPDATE:function(t){var e=t.style,n=t.value;i.markupToolValues[e]=n,i.markup.map((function(t){return t[1]})).filter((function(t){return t.isSelected})).forEach((function(t){if("color"===e)t[function(t){return t.borderWidth?"borderColor":t.lineWidth?"lineColor":t.fontColor?"fontColor":t.backgroundColor?"backgroundColor":void 0}(t)]=n;else if("shapeStyle"===e){var i=function(t){var e=t.fontColor,i=t.backgroundColor,n=t.lineColor,r=t.borderColor;return e||i||n||r}(t);t.borderColor=i,t.borderWidth=n[0],t.borderStyle=n[1],t.backgroundColor=n[0]||n[1]?null:i,null!==t.backgroundColor&&(t.borderColor=null)}else"lineStyle"===e?(t.lineWidth=n[0],t.lineStyle=n[1]):t[e]=n;t.isDirty=!0})),i.crop.isDirty=!0}},["color","shapeStyle","lineStyle","textDecoration","fontSize","fontFamily"].reduce((function(e,n){var r=n.split(/(?=[A-Z])/).join("_").toUpperCase(),o=Di(n);return e["SET_MARKUP_"+r]=function(e){var r=e.value;r!==e.prevValue&&(i.options["markup".concat(o)]=r,t("MARKUP_UPDATE",{style:n,value:r}))},e}),{}),{DID_SET_CROP:function(e){var i=e.value;i!==e.prevValue&&t("SET_DATA",{crop:i})},COLOR_SET_COLOR_VALUE:function(e){var n=e.key,r=e.value;i.crop.isDirty=!0,t("COLOR_SET_VALUE",{key:n,value:r})},COLOR_SET_VALUE:function(e){var n=e.key,r=e.value;i.colorValues[n]=r,t("SET_COLOR_MATRIX",{key:n,matrix:qi[n](r)})}},Object.keys(qi).reduce((function(n,r){var o=r.toUpperCase(),a=Di(r);return n["SET_COLOR_".concat(o)]=function(n){var s=n.value;if(s!==n.prevValue){var l=g(e("GET_COLOR_".concat(o,"_RANGE")),2),c=l[0],h=l[1],u=Mt(s,c,h);i.options["color".concat(a)]=u,i.instructions.color||(i.instructions.color={}),i.instructions.color[r]=u,t("COLOR_SET_VALUE",{key:r,value:u})}},n}),{}),{SET_COLOR_MATRIX:function(e){var n=e.key,r=e.matrix;r?i.colorMatrices[n]=v(r):delete i.colorMatrices[n],t("DID_SET_COLOR_MATRIX",{key:n,matrix:r})},FILTER_SET_FILTER:function(e){var n=e.value;i.crop.isDirty=!0,t("FILTER_SET_VALUE",{value:n})},FILTER_SET_VALUE:function(n){var r=n.value,o=Fi(r)?r:null;if(ot(r)){var a=e("GET_FILTERS");w(a,(function(t,e){t===r&&(o=e.matrix())}))}i.filter=r,i.filterName=ot(r)?r:null,t("SET_COLOR_MATRIX",{key:"filter",matrix:o})},DID_SET_UTIL:function(e){var n=e.value;e.prevValue,-1!==i.options.utils.indexOf(n)&&t("CHANGE_VIEW",{id:n})},DID_SET_FILTER:function(e){var i=e.value;i!==e.prevValue&&(t("FILTER_SET_VALUE",{value:i}),t("SET_DATA",{filter:i}))},DID_SET_SIZE:function(e){var i=e.value;i!==e.prevValue&&t("SET_DATA",{size:i})},DID_SET_MARKUP_UTIL:function(e){var i=e.value;i!==e.prevValue&&i&&(/^(draw|line|text|rect|ellipse)$/.test(i)||(i="select"),t("SWITCH_MARKUP_UTIL",{util:i}))},DID_SET_MARKUP:function(e){var i=e.value,n=e.prevValue;i!==n&&JSON.stringify(i)===JSON.stringify(n)||(t("MARKUP_SET_VALUE",{value:i}),t("SET_DATA",{markup:i}))},SET_DATA:function(n){if(n.size){var r=f({width:null,height:null},n.size),o=pe(r,e("GET_SIZE_MIN"),e("GET_SIZE_MAX"),null);i.instructions.size=f({},o),t("RESIZE_SET_OUTPUT_SIZE",o)}n.filter&&(i.instructions.filter=n.filter?n.filter.id||n.filter.matrix:n.colorMatrix),i.instructions.markup=n.markup||[],i.instructions.markup.forEach((function(t){return t[1].isDirty=!0})),i.instructions.color=Object.keys(qi).reduce((function(t,e){var r=void 0===n.color||void 0===n.color[e],o=i.options["color".concat(Di(e))];return t[e]=r?o:P(n.color[e])?n.color[e]:n.color[e].value,t}),{}),n.crop&&(i.instructions.crop=Mi(e,i,n.crop,i.size),i.crop.limitToImageBounds=i.options.cropLimitToImageBounds,!1===i.instructions.crop.scaleToFit&&(i.crop.limitToImageBounds=i.instructions.crop.scaleToFit),en(i,e))},DID_SET_INITIAL_STATE:function(t){var n=t.value||{},r=n.crop,o=n.filter,a=n.color,s=n.size,l=void 0===s?{}:s,c=n.markup,h=void 0===c?[]:c,u=f({width:null,height:null},l),d=pe(u,e("GET_SIZE_MIN"),e("GET_SIZE_MAX"),null);i.instructions.size=f({},d),i.instructions.crop=Mi(e,i,r),i.crop.limitToImageBounds=i.options.cropLimitToImageBounds,!1===i.instructions.crop.scaleToFit&&(i.crop.limitToImageBounds=i.instructions.crop.scaleToFit),i.instructions.filter=o||null,i.instructions.color=Object.keys(qi).reduce((function(t,e){return t[e]=void 0===a||void 0===a[e]?i.options["color".concat(Di(e))]:a[e],t}),{}),i.instructions.markup=h,i.crop.isDirty=!0},GET_DATA:function(n){var r=n.success,o=n.failure,a=n.file,s=n.data;if(!i.file)return o("no-image-source");if(!i.stage)return o("image-not-fully-loaded");var l={file:rt(a)?a:e("GET_OUTPUT_FILE"),data:rt(s)?s:e("GET_OUTPUT_DATA"),success:r,failure:o};t(l.file?"REQUEST_PREPARE_OUTPUT":"PREPARE_OUTPUT",l)},REQUEST_PREPARE_OUTPUT:function(e){var i=e.file,n=e.data,r=e.success,o=e.failure;t("PREPARE_OUTPUT",{file:i,data:n,success:r,failure:o},!0),t("DID_REQUEST_PREPARE_OUTPUT")},PREPARE_OUTPUT:function(n){var r=n.file,o=n.data,a=n.success,s=void 0===a?function(){}:a,l=n.failure,c=void 0===l?function(){}:l;if(gn(i))return t("ABORT_IMAGE");var h=function(e){if(t("DID_PREPARE_OUTPUT"),gn(i))return t("ABORT_IMAGE");s(e)};Xi({file:r,data:o},i,e).then((function(e){var n=i.options.afterCreateOutput,r=n?n(e,(function(e,i){return t("DID_REQUEST_POSTPROCESS_OUTPUT",{label:e,progress:i}),function(e){t("DID_MAKE_PROGRESS",{progress:e})}})):e;Promise.resolve(r).then(h).catch((function(e){t("DID_REQUEST_POSTPROCESS_OUTPUT_ERROR",{error:e})}))})).catch((function(e){if(gn(i))return t("ABORT_IMAGE");c(e)}))},EDIT_RESET:function(){sn(i),nn(i,e,t)},EDIT_CONFIRM:function(){if(i.file&&i.stage){sn(i),t("CROP_ZOOM");var n={file:e("GET_OUTPUT_FILE"),data:e("GET_OUTPUT_DATA"),success:function(e){i.filePromise.resolveOnConfirm&&i.filePromise.success(e),t("DID_CONFIRM",{output:e})},failure:console.error};t(n.file?"REQUEST_PREPARE_OUTPUT":"PREPARE_OUTPUT",n)}},EDIT_CANCEL:function(){i.filePromise&&i.filePromise.success(null),t("DID_CANCEL")},EDIT_CLOSE:function(){sn(i)},EDIT_DESTROY:function(){ft(i)},SET_OPTIONS:function(e){var i=e.options;w(i,(function(e,i){t("SET_".concat(gt(e,"_").toUpperCase()),{value:i})}))}})},bn=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:24;return'<svg width="'.concat(e,'" height="').concat(e,'" viewBox="0 0 ').concat(e," ").concat(e,'" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">').concat(t,"</svg>")},_n=Q({ignoreRect:!0,ignoreRectUpdate:!0,name:"button",mixins:{styles:["opacity"],animations:{opacity:{type:"tween",duration:250}},apis:["id"],listeners:!0},tag:"button",create:function(t){var e=t.root,i=t.props;e.element.innerHTML="".concat(i.icon||"","<span>").concat(i.label,"</span>"),e.element.setAttribute("type",i.type||"button"),i.name&&i.name.split(" ").forEach((function(t){e.element.className+=" doka--button-".concat(t)})),e.ref.handleClick=function(){"string"==typeof i.action?e.dispatch(i.action):i.action()},e.element.addEventListener("click",e.ref.handleClick),e.ref.handlePointer=function(t){return t.stopPropagation()},e.element.addEventListener("pointerdown",e.ref.handlePointer),i.create&&i.create({root:e,props:i})},destroy:function(t){var e=t.root;e.element.removeEventListener("pointerdown",e.ref.handlePointer),e.element.removeEventListener("click",e.ref.handleClick)}}),yn=Q({name:"status-progress",tag:"svg",ignoreRect:!0,ignoreRectUpdate:!0,mixins:{apis:["progress"],animations:{progress:{type:"spring",stiffness:.25,damping:.25,mass:2.5}}},create:function(t){var e=t.root,i=t.props;e.element.setAttribute("data-value",0),e.element.setAttribute("width",24),e.element.setAttribute("height",24),e.element.setAttribute("viewBox","0 0 20 20");var n=e.ref.circle=document.createElementNS("http://www.w3.org/2000/svg","circle"),r={r:5,cx:10,cy:10,fill:"none",stroke:"currentColor","stroke-width":10,transform:"rotate(-90) translate(-20)"};e.element.appendChild(n),Object.keys(r).forEach((function(t){n.setAttribute(t,r[t])})),e.ref.updateStroke=function(t){e.ref.circle.setAttribute("stroke-dasharray","".concat(31.42*Math.min(1,t)," 31.42"))},"number"==typeof i.progress?(e.progress=i.progress,e.element.setAttribute("data-value",Math.max(i.progress,.001)),e.ref.updateStroke(e.progress)):e.progress=0},write:J({DID_MAKE_PROGRESS:function(t){var e=t.root,i=t.action;e.progress=i.progress,e.element.setAttribute("data-value",Math.max(i.progress,.001))}},(function(t){var e=t.root;e.ref.updateStroke(e.progress)}))}),En=Q({name:"status-bubble-inner",create:function(t){var e=t.root,i=t.props;i.onClose?e.appendChildView(e.createChildView(_n,{label:"Close",name:"icon-only status-bubble-close",icon:bn('<g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></g>'),action:i.onClose})):e.ref.progressIndicator=e.appendChildView(e.createChildView(yn,{progress:i.progress})),e.appendChildView(e.createChildView(Q({ignoreRect:!0,tag:"p",create:function(t){var e=t.root,i=t.props;e.element.textContent=i.text}}),{text:i.label}))}}),Tn=Q({name:"status-bubble",mixins:{styles:["opacity","translateY"],apis:["markedForRemoval"],animations:{opacity:{type:"tween",duration:500},translateY:{type:"spring",mass:20}}},create:function(t){var e=t.root,i=t.props;return e.appendChildView(e.createChildView(En,i))}}),wn=function(t){t.element.dataset.viewStatus="idle",xn(t)},xn=function(t){t.ref.busyIndicators.forEach((function(t){t.translateY=-10,t.opacity=0,t.markedForRemoval=!0}))},Cn=function(t,e,i,n){t.element.dataset.viewStatus="busy";var r=Rn(t,e,i,n);xn(t),t.ref.busyIndicators.push(r),r.markedForRemoval=!1,r.translateY=0,r.opacity=1},Rn=function(t,e){var i=arguments.length>2&&void 0!==arguments[2]&&arguments[2],n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:null;return t.appendChildView(t.createChildView(Tn,{translateY:20,opacity:0,label:e,onClose:i,progress:n}))},An=Q({name:"edit-status",ignoreRect:!0,create:function(t){var e=t.root;e.ref.busyIndicators=[],e.element.setAttribute("tabindex",-1)},write:J({MISSING_WEBGL:function(t){var e=t.root,i=/fullscreen/.test(e.query("GET_STYLE_LAYOUT_MODE"));Cn(e,e.query("GET_LABEL_STATUS_MISSING_WEB_G_L"),i?function(){e.dispatch("EDIT_CANCEL")}:null)},AWAITING_IMAGE:function(t){var e=t.root;Cn(e,e.query("GET_LABEL_STATUS_AWAITING_IMAGE"))},DID_PRESENT_IMAGE:function(t){var e=t.root;wn(e)},DID_LOAD_IMAGE_ERROR:function(t){var e=t.root,i=t.action,n=/fullscreen/.test(e.query("GET_STYLE_LAYOUT_MODE")),r=e.query("GET_LABEL_STATUS_LOAD_IMAGE_ERROR"),o="function"==typeof r?r(i.error):r;Cn(e,o,n?function(){e.dispatch("EDIT_CANCEL")}:null)},DID_REQUEST_LOAD_IMAGE:function(t){var e=t.root;Cn(e,e.query("GET_LABEL_STATUS_LOADING_IMAGE"))},DID_REQUEST_PREPARE_OUTPUT:function(t){var e=t.root;Cn(e,e.query("GET_LABEL_STATUS_PROCESSING_IMAGE"))},DID_REQUEST_POSTPROCESS_OUTPUT:function(t){var e=t.root,i=t.action;Cn(e,i.label,null,i.progress)},DID_REQUEST_POSTPROCESS_OUTPUT_ERROR:function(t){var e=t.root,i=t.action.error;Cn(e,i,(function(){return e.dispatch("DID_PREPARE_OUTPUT")}))},DID_PREPARE_OUTPUT:function(t){var e=t.root;wn(e)}}),didWriteView:function(t){var e=t.root;e.ref.busyIndicators=e.ref.busyIndicators.filter((function(t){return!t.markedForRemoval||0!==t.opacity||(e.removeChildView(t),!1)}))}}),Sn={down:"pointerdown",move:"pointermove",up:"pointerup"},In=function(){var t=[],e=function(e){return t.findIndex((function(t){return t.pointerId===e.pointerId}))};return{update:function(i){var n=e(i);n<0||(t[n]=i)},multiple:function(){return t.length>1},count:function(){return t.length},active:function(){return t.concat()},push:function(i){e(i)>=0||t.push(i)},pop:function(i){var n=e(i);n<0||t.splice(n,1)}}},kn=function(t,e,i,n){return t.addEventListener(Sn[e],i,n)},$n=function(t,e,i){return t.removeEventListener(Sn[e],i)},On=function(t,e){"contains"in t&&t.contains(e);var i=e;do{if(i===t)return!0}while(i=i.parentNode);return!1},Ln=function(t,e,i,n){var r=arguments.length>4&&void 0!==arguments[4]?arguments[4]:{stopPropagation:!0,cancelOnMultiple:!1},o={x:0,y:0},a={enabled:!0,origin:null,cancel:!1,cancelled:!1,pointers:In()},s=null,l=function(t,e){e&&(s||c(t,e),cancelAnimationFrame(s),s=requestAnimationFrame((function(){c(t,e),s=null})))},c=function(t,e){return e.apply(null,[t,(i=t,{x:i.pageX-o.x,y:i.pageY-o.y})]);var i},h=function(i){var n=0===a.pointers.count();n&&(a.active=!1,a.cancel=!1,a.cancelled=!1),(t===i.target||On(t,i.target))&&(n?i.isPrimary&&(a.pointers.push(i),kn(document.documentElement,"up",d),i.preventDefault(),r.stopPropagation&&(i.stopPropagation(),i.stopImmediatePropagation()),a.active=!0,o.x=i.pageX,o.y=i.pageY,kn(document.documentElement,"move",u),e(i)):r.cancelOnMultiple&&(a.cancel=!0))},u=function(t){t.isPrimary&&(a.cancelled||(t.preventDefault(),r.stopPropagation&&t.stopPropagation(),l(t,i),a.cancel&&(a.cancelled=!0,l(t,n))))},d=function t(e){a.pointers.pop(e),0===a.pointers.count()&&($n(document.documentElement,"move",u),$n(document.documentElement,"up",t)),a.active&&(a.cancelled||(e.preventDefault(),r.stopPropagation&&e.stopPropagation(),l(e,i),l(e,n)))};return kn(document.documentElement,"down",h),{enable:function(){a.enabled||kn(document.documentElement,"down",h),a.enabled=!0},disable:function(){a.enabled&&$n(document.documentElement,"down",h),a.enabled=!1},destroy:function(){$n(document.documentElement,"up",d),$n(document.documentElement,"move",u),$n(document.documentElement,"down",h)}}},Mn={type:"spring",stiffness:.4,damping:.65,mass:7},Dn=function(t,e,i){if(/^(line|text|ellipse|rect)$/.test(i))t.dispatch("MARKUP_ADD_DEFAULT",{value:i}),t.dispatch("SET_MARKUP_UTIL",{value:"select"});else if("draw"===i&&!t.ref.drawInput){var n=t.ref,r=n.drawState,o=n.viewSize,a=0,s=0,l={},c=t.query("GET_MARKUP_DRAW_DISTANCE");t.ref.drawInput=Ln(t.element,(function(i){var n=t.query("GET_MARKUP_TOOL_VALUES"),c=n.lineStyle[0],h=n.lineStyle[1];r.lineColor=n.color,r.lineWidth=c,r.lineStyle=h;var u=t.query("GET_ROOT"),d=void 0!==i.offsetX?i.offsetX:i.pageX-u.x-e.stageOffsetX-window.pageXOffset,p=void 0!==i.offsetY?i.offsetY:i.pageY-u.y-e.stageOffsetY-window.pageYOffset;a=d-t.markupX,s=p-t.markupY,l.x=0,l.y=0,r.points.push({x:a/o.width,y:s/o.height})}),(function(e,i){if(t.dispatch("KICK"),c){var n=Ft(i,l);if(n>c){var h=function(t,e){var i=Nt(t,e);return Math.atan2(i.y,i.x)}(l,i)+Math.PI/2,u=c-n;l.x+=Math.sin(h)*u,l.y-=Math.cos(h)*u,r.points.push({x:(a+l.x)/o.width,y:(s+l.y)/o.height})}}else r.points.push({x:(a+i.x)/o.width,y:(s+i.y)/o.height})}),(function(e,i){r.points.length>1&&t.dispatch("MARKUP_ADD",["path",f({},r)]),r.points=[]}))}"draw"!==i&&t.ref.drawInput&&(t.ref.drawInput.destroy(),t.ref.drawInput=null)},Pn=function(t,e){return Object.keys(e).forEach((function(i){t.setAttribute(i,e[i])}))},Nn=function(t,e){var i=document.createElementNS("http://www.w3.org/2000/svg",t);return e&&Pn(i,e),i},Bn=["nw","se"],Fn=["nw","n","ne","w","e","sw","s","se"],Un={nw:"nwse",n:"ns",ne:"nesw",w:"ew",e:"ew",sw:"nesw",s:"ns",se:"nwse"},Gn={nw:function(t){return{x:t.x,y:t.y}},n:function(t){return{x:t.x+.5*t.width,y:t.y}},ne:function(t){return{x:t.x+t.width,y:t.y}},w:function(t){return{x:t.x,y:t.y+.5*t.height}},e:function(t){return{x:t.x+t.width,y:t.y+.5*t.height}},sw:function(t){return{x:t.x,y:t.y+t.height}},s:function(t){return{x:t.x+.5*t.width,y:t.y+t.height}},se:function(t){return{x:t.x+t.width,y:t.y+t.height}}},zn=Q({tag:"div",name:"image-markup",ignoreRect:!0,mixins:{styles:["opacity"],animations:{opacity:"spring",markupX:Mn,markupY:Mn,markupWidth:Mn,markupHeight:Mn},listeners:!0,apis:["toolsReference","onSelect","onDrag","markupX","markupY","markupWidth","markupHeight","allowInteraction","stageOffsetX","stageOffsetY"]},create:function(t){var e=t.root,i=t.props,n=i.onSelect,r=void 0===n?function(){}:n,o=i.onUpdate,a=void 0===o?function(){}:o,s=Nn("svg",{xmlns:"http://www.w3.org/2000/svg","xmlns:xlink":"http://www.w3.org/1999/xlink"});e.ref.canvas=s;var l=e.query("GET_ROOT_SIZE");s.setAttribute("width",l.width),s.setAttribute("height",l.height);var c=document.createElement("input");Pn(c,{type:"text",autocomplete:"off",autocapitalize:"off"}),c.addEventListener("keydown",(function(t){t.stopPropagation(),13===t.keyCode||9===t.keyCode?(t.target.blur(),h()):8!==t.keyCode||e.ref.input.value.length||e.dispatch("MARKUP_DELETE",{id:e.ref.selected.id})})),e.ref.input=c,e.ref.elements=[],e.ref.viewSize={width:0,height:0,scale:0},e.ref.resetSelected=function(){return e.ref.selected={id:null,type:null,settings:{}},e.ref.selected},e.ref.resetSelected();var h=function(){e.ref.resetSelected(),r(null)};e.ref.handleDeselect=function(t){var n,r;e.query("IS_ACTIVE_VIEW","markup")&&e.ref.selected.id&&t.target!==e.ref.removeButton.element&&(n=t.target,e.ref.selected.id!==(r=n,r.id?r:r.parentNode).id&&(function(t){return On(e.ref.manipulatorGroup,t)||t===e.ref.input}(t.target)||i.isMarkupUtil(t.target)||h()))},kn(document.body,"down",e.ref.handleDeselect),e.ref.handleTextInput=function(){return a("text",e.ref.input.value)},e.ref.input.addEventListener("input",e.ref.handleTextInput),e.ref.handleAttemptDelete=function(t){e.query("IS_ACTIVE_VIEW","markup")&&(!e.ref.selected.id||8!==t.keyCode&&46!==t.keyCode||(t.stopPropagation(),t.preventDefault(),e.dispatch("MARKUP_DELETE",{id:e.ref.selected.id})))},document.body.addEventListener("keydown",e.ref.handleAttemptDelete);var u=Nn("g"),d=Nn("g",{class:"doka--shape-group"});u.appendChild(d),e.ref.shapeGroup=d;var p=Nn("g",{fill:"none",class:"doka--manipulator-group"}),f=Nn("rect",{x:0,y:0,width:0,height:0,fill:"none"}),m=Nn("path");p.appendChild(m),p.appendChild(f),e.ref.manipulatorPath=m,e.ref.manipulatorRect=f,e.ref.manipulators=[];for(var g=0;g<10;g++){var v=Nn("circle",{r:6,"stroke-width":2}),b=Nn("circle",{r:22,class:"doka--hitbox",style:"opacity: 0"});p.appendChild(b),p.appendChild(v),e.ref.manipulators.push({visual:v,hitbox:b,dragger:null})}u.appendChild(p),e.ref.manipulatorGroup=p,s.appendChild(u),e.ref.shapeOffsetGroup=u,e.ref.removeButton=e.appendChildView(e.createChildView(_n,{label:e.query("GET_LABEL_MARKUP_REMOVE_SHAPE"),name:"destroy-shape",action:function(){e.dispatch("MARKUP_DELETE",{id:e.ref.selected.id})}})),e.query("IS_ACTIVE_VIEW","markup")&&(e.element.dataset.active=!0),e.ref.drawInput=null,e.ref.drawState={lineColor:null,lineWidth:null,lineStyle:null,points:[]};var _=Nn("path",{fill:"none",class:"doka--draw-path"});e.ref.drawPath=_,s.appendChild(_);var y=I("div","doka--image-markup-clip");y.appendChild(c),y.appendChild(s),e.ref.clip=y,e.element.appendChild(y),"draw"===e.query("GET_MARKUP_UTIL")&&Dn(e,i,"draw")},destroy:function(t){var e=t.root;e.ref.elements.concat(e.ref.manipulators).forEach((function(t){t.dragger&&t.dragger.destroy()})),e.ref.input.removeEventListener("input",e.ref.handleTextInput),document.body.removeEventListener("keydown",e.ref.handleAttemptDelete),$n(document.body,"down",e.ref.handleDeselect)},read:function(t){var e=t.root;if(!e.rect.element.hidden)for(var i in e.ref.elements){var n=e.ref.elements[i];if(n&&"text"===n.nodeName&&n.parentNode){var r=n.getBBox();n.bbox={x:r.x,y:r.y,width:r.width,height:r.height}}}},write:J({SHOW_VIEW:function(t){var e=t.root,i=t.props;"markup"===t.action.id?e.element.dataset.active=!0:(e.element.dataset.active=!1,i.onSelect(null))},MARKUP_SET_VALUE:function(t){var e=t.root;w(e.ref.elements,(function(t,e){e&&e.dragger&&e.dragger.destroy()})),e.ref.elements=[],e.ref.shapeGroup.innerHTML=""},UPDATE_ROOT_RECT:function(t){var e=t.root,i=t.action,n=e.ref.canvas;n.setAttribute("width",i.rect.width),n.setAttribute("height",i.rect.height),e.ref.previousScale=null},SWITCH_MARKUP_UTIL:function(t){var e=t.root,i=t.action,n=t.props,r=i.util;Dn(e,n,r)}},(function(t){var e=t.root,i=t.props,n=t.timestamp;if(!(e.opacity<=0)){var r=e.query("GET_CROP",i.id,n);if(r){var o=e.query("GET_MARKUP_UTIL");e.element.dataset.util=o||"";var a=r.markup,s=r.cropStatus,l=i.onSelect,c=i.onDrag,h=e.ref,u=h.clip,d=h.manipulatorGroup,p=h.drawPath,m=h.viewSize,v=h.shapeOffsetGroup,b=h.manipulators,_=h.manipulatorPath,y=h.manipulatorRect,E=h.removeButton,T=h.drawState,w=e.query("GET_OUTPUT_WIDTH"),x=e.query("GET_OUTPUT_HEIGHT"),C=s.image,R=s.crop,A=R.width,S=R.height,I=R.widthFloat/R.heightFloat;if(w||x){var k=e.query("GET_OUTPUT_FIT");w&&!x&&(x=w),x&&!w&&(w=x);var $,O=w/A,L=x/S;"force"===k?(A=w,S=x):("cover"===k?$=Math.max(O,L):"contain"===k&&($=Math.min(O,L)),A*=$,S*=$)}else C.width&&C.height?(A=C.width,S=C.height):C.width&&!C.height?(A=C.width,S=C.width/I):C.height&&!C.width&&(S=C.height,A=C.height*I);var M=T.points.length,D=Dt(e.markupX,3),P=Dt(e.markupY,3),N=Dt(e.markupWidth,3),B=Dt(e.markupHeight,3),F=Dt(Math.min(e.markupWidth/A,e.markupHeight/S),4);if(m.width=N,m.height=B,m.scale=F,Vn(e,{drawLength:M,markupX:D,markupY:P,scale:F,markup:a,currentWidth:A,currentHeight:S})){var U=D,G=e.rect.element.width-D-N,z=P,H=e.rect.element.height-P-B,V="inset(".concat(z,"px ").concat(G,"px ").concat(H,"px ").concat(U,"px)");if(u.style.clipPath=V,u.style.webkitClipPath=V,v.setAttribute("transform","translate(".concat(D," ").concat(P,")")),e.ref.previousDrawLength=M,e.ref.previousX=D,e.ref.previousY=P,e.ref.previousScale=F,e.ref.previousCurrentHeight=S,e.ref.previousCurrentWidth=A,e.ref.previousMarkupLength=a.length,!(m.width<1||m.height<1)){var W,j=a.find((function(t){return t[1].isSelected})),q=j&&e.ref.selected.id!==j[1].id||e.ref.selected.id&&!j;if(W=j?e.ref.selected={id:j[1].id,type:j[0],settings:j[1]}:e.ref.resetSelected(),T.points.length){var Y=He(T,m,F);return Y.d=je(T.points.map((function(t){return{x:D+t.x*m.width,y:P+t.y*m.height}}))),void Pn(p,Y)}p.removeAttribute("d"),e.ref.input.hidden="text"!==e.ref.selected.type,E.element.dataset.active=null!==e.ref.selected.id,_.setAttribute("style","opacity:0"),y.setAttribute("style","opacity:0"),b.forEach((function(t){t.visual.setAttribute("style","opacity:0; pointer-events:none;"),t.hitbox.setAttribute("style","pointer-events:none;")}));var K=e.query("GET_MARKUP_FILTER");a.filter(K).sort(ii).forEach((function(t,n){var r=g(t,2),o=r[0],a=r[1],s=a.id,h=a.isDestroyed,u=a.isDirty,p=a.isSelected,v=a.allowSelect,T=a.allowMove,w=a.allowResize,x=a.allowInput;if(h){var C=e.ref.elements[s];C&&(C.dragger&&C.dragger.destroy(),e.ref.elements[s]=null,C.parentNode.removeChild(C))}else{var R,A,S,I=e.ref.elements[s];if(I||(I=ti(o,a),e.ref.elements[s]=I,v?(I.dragger=Ln(I,(function(){A=Date.now(),R=f({},I.rect),(S=s===e.ref.selected.id)||l(s)}),(function(t,e){T&&c(s,R,e,m,F)}),(function(t,i){if(x&&"text"===o&&S){var n=Bt({x:0,y:0},i),r=Date.now()-A;if(!(n>10||r>750)){e.ref.input.focus();var a=e.markupX+I.bbox.x,s=I.bbox.width,l=(t.offsetX-a)/s,c=Math.round(e.ref.input.value.length*l);e.ref.input.setSelectionRange(c,c)}}})),I.dragger.disable()):I.setAttribute("style","pointer-events:none;")),I.dragger&&(i.allowInteraction?I.dragger.enable():I.dragger.disable()),n!==I.index){I.index=n;var k=e.ref.shapeGroup;k.insertBefore(I,k.childNodes[n+1])}if(u&&ei(I,o,a,m,F),p){var $=E.rect.element.width,O=E.rect.element.height,L=e.markupX-.5*$,M=e.markupY-O-15,D="text"===o?I.bbox:I.rect,P=!1,N=function(t){var e=t.fontColor,i=t.backgroundColor,n=t.lineColor,r=t.borderColor;return e||i||n||r}(a);if(N){var B=fe(N);P=(.2126*B[0]+.7152*B[1]+.0722*B[2])/255>.65,d.setAttribute("is-bright-color",P)}"line"===o?(L+=D.x,M+=D.y,Pn(_,{d:"M ".concat(D.x," ").concat(D.y," L ").concat(D.x+D.width," ").concat(D.y+D.height),style:"opacity:1"})):"path"===o?(L+=(D={x:a.points[0].x*m.width,y:a.points[0].y*m.height,width:0,height:0}).x,M+=D.y,Pn(_,{d:je(a.points.map((function(t){return{x:t.x*m.width,y:t.y*m.height}}))),style:"opacity:1"})):D&&(L+=D.x+.5*D.width,M+=D.y,Pn(y,{x:D.x-("text"===o?5:0),y:D.y,width:D.width+("text"===o?10:0),height:D.height,style:"opacity:1"}));var U=e.markupY+10,G=e.markupY+e.markupHeight-10,z=e.markupX+10,H=e.markupX+e.markupWidth-10;if(M<U?M=U:M+O>G&&(M=G-O),L<z?L=z:L+$>H&&(L=H-$),D||(E.element.dataset.active="false"),E.element.setAttribute("style","transform: translate3d(".concat(L,"px, ").concat(M,"px, 0)")),"text"===o&&D){var V=D.width+65,W=e.markupWidth-D.x,j="\n                        width: ".concat(Math.min(V,W),"px;\n                        height: ").concat(D.height,"px;\n                        color: ").concat(I.getAttribute("fill"),";\n                        font-family: ").concat(I.getAttribute("font-family"),";\n                        font-size: ").concat(I.getAttribute("font-size").replace(/px/,""),"px;\n                        font-weight: ").concat(I.getAttribute("font-weight")||"normal",";\n                    ");kt()?j+="\n                            left: ".concat(Math.round(e.markupX+D.x),"px;\n                            top: ").concat(Math.round(e.markupY+D.y),"px;\n                        "):j+="\n                            transform: translate3d(".concat(Math.round(e.markupX+D.x),"px,").concat(Math.round(e.markupY+D.y),"px,0);\n                        "),e.ref.input.setAttribute("style",j),I.setAttribute("fill","none")}if("text"===o)return;if(!w)return;var q="line"===o?Bn:Fn;b.forEach((function(t,e){var i=q[e];if(i){var n="line"===o?"move":"".concat(Un[i],"-resize"),r=Gn[i](I.rect);Pn(t.visual,{cx:r.x,cy:r.y,style:"opacity:1"}),Pn(t.hitbox,{cx:r.x,cy:r.y,style:"cursor:".concat(n)})}}))}a.isDirty=!1}})),q&&(jn(e),"text"===W.type?e.ref.input.value=W.settings.text:e.ref.selected.id&&Wn(e,i.onResize))}}}}}))}),Hn=function(t){return t.forEach((function(t){return t[1].isDirty=!0}))},Vn=function(t,e){var i=e.drawLength,n=e.markup,r=e.markupX,o=e.markupY,a=e.currentWidth,s=e.currentHeight,l=e.scale;return i!==t.ref.previousDrawLength||(r!==t.ref.previousX||o!==t.ref.previousY||l!==t.ref.previousScale||s!==t.ref.previousCurrentHeight||a!==t.ref.previousCurrentWidth?(Hn(n),!0):n.length!==t.ref.previousMarkupLength||!!n.find((function(t){return t[1].isDirty})))},Wn=function(t,e){var i=t.ref.selected.id,n="g"===t.ref.elements[i].nodeName?Bn:Fn;t.ref.manipulators.forEach((function(r,o){var a=n[o];if(a){var s=null;r.dragger=Ln(r.hitbox,(function(){s={x:parseFloat(C(r.hitbox,"cx")),y:parseFloat(C(r.hitbox,"cy"))}}),(function(n,r){e(i,a,s,r,t.ref.viewSize)}),null,{stopPropagation:!0})}}))},jn=function(t){t.ref.manipulators.forEach((function(t){t.dragger&&(t.dragger.destroy(),t.dragger=null)}))},qn={38:"up",40:"down",37:"left",39:"right",189:"minus",187:"plus",72:"h",76:"l",81:"q",82:"r",84:"t",86:"v",90:"z",219:"left_bracket",221:"right_bracket"},Yn=function(t,e,i,n,r){var o=null,a=!0,s={enabled:!0},l=function(t){var r=qn[t.keyCode]||t.keyCode;i[r]&&(t.stopPropagation(),a&&(o=e(r),a=!1),i[r](o),n(o))},c=function(t){var e=qn[t.keyCode]||t.keyCode;i[e]&&(t.stopPropagation(),r(o),a=!0)};return t.addEventListener("keydown",l),t.addEventListener("keyup",c),{enable:function(){s.enabled||(t.addEventListener("keydown",l),t.addEventListener("keyup",c)),s.enabled=!0},disable:function(){s.enabled&&(t.removeEventListener("keydown",l),t.removeEventListener("keyup",c)),s.enabled=!1},destroy:function(){t.removeEventListener("keydown",l),t.removeEventListener("keyup",c)}}},Kn=function(t,e,i){var n=arguments.length>3&&void 0!==arguments[3]?arguments[3]:1,r=arguments.length>4?arguments[4]:void 0;e=Math.round(e),i=Math.round(i);var o=r||document.createElement("canvas"),a=o.getContext("2d");return n>=5&&n<=8?(o.width=i,o.height=e):(o.width=e,o.height=i),a.save(),-1!==n&&a.transform.apply(a,$e(e,i,n)),a.drawImage(t,0,0,e,i),a.restore(),o},Zn=function(){self.onmessage=function(t){createImageBitmap(t.data.message.file).then((function(e){self.postMessage({id:t.data.id,message:e},[e])}))}},Xn=function(t,e,i){var n=t.createShader(i);return t.shaderSource(n,e),t.compileShader(n),n},Qn=function(t,e,i){var n=t.createProgram();return t.attachShader(n,Xn(t,e,t.VERTEX_SHADER)),t.attachShader(n,Xn(t,i,t.FRAGMENT_SHADER)),t.linkProgram(n),n},Jn=function(){var t=new Float32Array(16);return t[0]=1,t[5]=1,t[10]=1,t[15]=1,t},tr=function(t,e,i,n,r){var o=1/Math.tan(e/2),a=1/(n-r);t[0]=o/i,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=o,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[11]=-1,t[12]=0,t[13]=0,t[15]=0,t[10]=(r+n)*a,t[14]=2*r*n*a},er=function(t,e){var i=e[0],n=e[1],r=e[2];t[12]=t[0]*i+t[4]*n+t[8]*r+t[12],t[13]=t[1]*i+t[5]*n+t[9]*r+t[13],t[14]=t[2]*i+t[6]*n+t[10]*r+t[14],t[15]=t[3]*i+t[7]*n+t[11]*r+t[15]},ir=function(t,e){var i=e[0],n=e[1],r=e[2];t[0]=t[0]*i,t[1]=t[1]*i,t[2]=t[2]*i,t[3]=t[3]*i,t[4]=t[4]*n,t[5]=t[5]*n,t[6]=t[6]*n,t[7]=t[7]*n,t[8]=t[8]*r,t[9]=t[9]*r,t[10]=t[10]*r,t[11]=t[11]*r},nr=function(t,e){var i=Math.sin(e),n=Math.cos(e),r=t[4],o=t[5],a=t[6],s=t[7],l=t[8],c=t[9],h=t[10],u=t[11];t[4]=r*n+l*i,t[5]=o*n+c*i,t[6]=a*n+h*i,t[7]=s*n+u*i,t[8]=l*n-r*i,t[9]=c*n-o*i,t[10]=h*n-a*i,t[11]=u*n-s*i},rr=function(t,e){var i=Math.sin(e),n=Math.cos(e),r=t[0],o=t[1],a=t[2],s=t[3],l=t[8],c=t[9],h=t[10],u=t[11];t[0]=r*n-l*i,t[1]=o*n-c*i,t[2]=a*n-h*i,t[3]=s*n-u*i,t[8]=r*i+l*n,t[9]=o*i+c*n,t[10]=a*i+h*n,t[11]=s*i+u*n},or=function(t,e){var i=Math.sin(e),n=Math.cos(e),r=t[0],o=t[1],a=t[2],s=t[3],l=t[4],c=t[5],h=t[6],u=t[7];t[0]=r*n+l*i,t[1]=o*n+c*i,t[2]=a*n+h*i,t[3]=s*n+u*i,t[4]=l*n-r*i,t[5]=c*n-o*i,t[6]=h*n-a*i,t[7]=u*n-s*i},ar="\nattribute vec4 aPosition;\nvoid main() {\n\tgl_Position = aPosition;\n}\n",sr=function(t,e,i){var n={width:0,height:0},r={x:0,y:0},o=null,a=30*Math.PI/180,s=Math.tan(a/2),l={antialias:!1,alpha:!1},c=t.getContext("webgl",l)||t.getContext("experimental-webgl",l);if(!c)return null;c.enable(c.BLEND),c.blendFunc(c.SRC_ALPHA,c.ONE_MINUS_SRC_ALPHA);var h=Qn(c,ar,"\nprecision mediump float;\n\nuniform vec2 uViewportSize;\nuniform vec3 uColorStart;\nuniform vec3 uColorEnd;\nuniform vec2 uOverlayLeftTop;\nuniform vec2 uOverlayRightBottom;\nuniform vec4 uColorCanvasBackground;\n\nvoid main() {\n\n\tfloat x = gl_FragCoord.x;\n\tfloat y = gl_FragCoord.y;\n\n\tvec2 center = vec2(.5, .5);\n\tvec2 st = vec2(x / uViewportSize.x, y / uViewportSize.y);\n\tfloat mixValue = distance(st, center) * 1.5; // expand outside view (same as doka--root::after)\n\tvec3 color = mix(uColorStart, uColorEnd, mixValue);\n\n\tif (uColorCanvasBackground[3] == 1.0) {\n\n\t\tfloat innerLeft = uOverlayLeftTop.x;\n\t\tfloat innerRight = uOverlayRightBottom.x;\n\t\tfloat innerTop = uOverlayRightBottom.y;\n\t\tfloat innerBottom = uOverlayLeftTop.y;\n\n\t\tif (x < innerLeft || x > innerRight || y < innerTop || y > innerBottom) {\n\t\t\tgl_FragColor = vec4(color, 1.0);\n\t\t\treturn;\n\t\t}\n\n\t\tgl_FragColor = uColorCanvasBackground;\n\t\treturn;\n\t}\n\t\n\tgl_FragColor = vec4(color, 1.0);\n}\n"),u=c.getUniformLocation(h,"uColorStart"),d=c.getUniformLocation(h,"uColorEnd"),p=c.getUniformLocation(h,"uViewportSize"),f=c.getAttribLocation(h,"aPosition"),m=c.getUniformLocation(h,"uOverlayLeftTop"),g=c.getUniformLocation(h,"uOverlayRightBottom"),b=c.getUniformLocation(h,"uColorCanvasBackground"),_=c.createBuffer(),y=new Float32Array([1,-1,1,1,-1,-1,-1,1]);c.bindBuffer(c.ARRAY_BUFFER,_),c.bufferData(c.ARRAY_BUFFER,y,c.STATIC_DRAW),c.bindBuffer(c.ARRAY_BUFFER,null);var E=Qn(c,ar,"\nprecision mediump float;\n\nuniform vec2 uOverlayLeftTop;\nuniform vec2 uOverlayRightBottom;\nuniform vec4 uOutlineColor;\nuniform float uOutlineWidth;\n\nvoid main() {\n\n\tfloat x = gl_FragCoord.x;\n\tfloat y = gl_FragCoord.y;\n\n\tfloat innerLeft = uOverlayLeftTop.x;\n\tfloat innerRight = uOverlayRightBottom.x;\n\tfloat innerTop = uOverlayRightBottom.y;\n\tfloat innerBottom = uOverlayLeftTop.y;\n\n\tfloat outerLeft = innerLeft - uOutlineWidth;\n\tfloat outerRight = innerRight + uOutlineWidth;\n\tfloat outerTop = innerTop - uOutlineWidth;\n\tfloat outerBottom = innerBottom + uOutlineWidth;\n\t\n\tif (x < outerLeft || x >= outerRight || y < outerTop || y >= outerBottom) {\n\t\tdiscard;\n\t}\n\n\tif (x < innerLeft || x >= innerRight || y < innerTop || y >= innerBottom) {\n\t\tgl_FragColor = uOutlineColor;\n\t}\n}\n"),T=c.getAttribLocation(E,"aPosition"),w=c.getUniformLocation(E,"uOutlineWidth"),x=c.getUniformLocation(E,"uOutlineColor"),C=c.getUniformLocation(E,"uOverlayLeftTop"),R=c.getUniformLocation(E,"uOverlayRightBottom"),A=c.createBuffer(),S=new Float32Array([1,-1,1,1,-1,-1,-1,1]);c.bindBuffer(c.ARRAY_BUFFER,A),c.bufferData(c.ARRAY_BUFFER,S,c.STATIC_DRAW),c.bindBuffer(c.ARRAY_BUFFER,null);var I=Qn(c,"\nattribute vec4 aPosition;\nattribute vec2 aTexCoord;\nuniform mat4 uMatrix;\n\n// send to fragment shader\nvarying vec2 vTexCoord;\nvarying vec4 vPosition;\n\nvoid main () {\n    vPosition = uMatrix * aPosition;\n    gl_Position = vPosition;\n    vTexCoord = aTexCoord;\n}\n","\nprecision mediump float;\n\nuniform sampler2D uTexture;\nuniform vec2 uTextureSize;\n\nuniform float uColorOpacity;\nuniform mat4 uColorMatrix;\nuniform vec4 uColorOffset;\n\nuniform vec4 uOverlayColor;\nuniform vec2 uOverlayLeftTop;\nuniform vec2 uOverlayRightBottom;\n\nvarying vec2 vTexCoord;\nvarying vec4 vPosition;\n\nvoid main () {\n\n    vec3 cB = vec3(1.0);\n\n\tvec4 cF = texture2D(uTexture, vTexCoord);\n\t\n\tvec4 cM = (cF * uColorMatrix) + uColorOffset;\n\n    float r = max(0.0, cM.r * cM.a) + (cB.r * (1.0 - cM.a));\n    float g = max(0.0, cM.g * cM.a) + (cB.g * (1.0 - cM.a));\n    float b = max(0.0, cM.b * cM.a) + (cB.b * (1.0 - cM.a));\n\n\tvec4 color = vec4(r, g, b, cF.a);\n\t\n\t// test if falls within\n    if ((gl_FragCoord.x < uOverlayLeftTop.x || gl_FragCoord.x > uOverlayRightBottom.x) || \n        (gl_FragCoord.y > uOverlayLeftTop.y || gl_FragCoord.y < uOverlayRightBottom.y)) {\n\t\tcolor *= uOverlayColor;\n\t}\n\t\n    gl_FragColor = color * uColorOpacity;\n}\n");c.useProgram(I);var k=c.getUniformLocation(I,"uMatrix"),$=c.getUniformLocation(I,"uTexture"),O=c.getUniformLocation(I,"uTextureSize"),L=c.getUniformLocation(I,"uOverlayColor"),M=c.getUniformLocation(I,"uOverlayLeftTop"),D=c.getUniformLocation(I,"uOverlayRightBottom"),P=c.getUniformLocation(I,"uColorOpacity"),N=c.getUniformLocation(I,"uColorOffset"),B=c.getUniformLocation(I,"uColorMatrix"),F=c.getAttribLocation(I,"aPosition"),U=c.getAttribLocation(I,"aTexCoord"),G=function(t,e,i,n,r){var o=t.createTexture();t.activeTexture(t.TEXTURE0+n),t.bindTexture(t.TEXTURE_2D,o),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MIN_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_MAG_FILTER,t.LINEAR),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_S,t.CLAMP_TO_EDGE),t.texParameteri(t.TEXTURE_2D,t.TEXTURE_WRAP_T,t.CLAMP_TO_EDGE),t.uniform1i(e,n),t.uniform2f(i,r.width,r.height);try{t.texImage2D(t.TEXTURE_2D,0,t.RGBA,t.RGBA,t.UNSIGNED_BYTE,r)}catch(a){t.texImage2D(t.TEXTURE_2D,0,t.RGBA,r.width,r.height,0,t.RGBA,t.UNSIGNED_BYTE,null)}return o}(c,$,O,0,e),z=e.width*i,H=e.height*i,V=-.5*z,W=.5*H,j=.5*z,q=-.5*H,Y=new Float32Array([V,W,V,q,j,W,j,q]),K=new Float32Array([0,0,0,1,1,0,1,1]),Z=Y.length/2,X=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,X),c.bufferData(c.ARRAY_BUFFER,Y,c.STATIC_DRAW),c.bindBuffer(c.ARRAY_BUFFER,null);var Q=c.createBuffer();c.bindBuffer(c.ARRAY_BUFFER,Q),c.bufferData(c.ARRAY_BUFFER,K,c.STATIC_DRAW),c.bindBuffer(c.ARRAY_BUFFER,null);var J=0,tt=0,et={release:function(){t.width=1,t.height=1},resize:function(e,a){t.width=e*i,t.height=a*i,t.style.width="".concat(e,"px"),t.style.height="".concat(a,"px"),n.width=e*i,n.height=a*i,r.x=.5*n.width,r.y=.5*n.height,o=n.width/n.height,c.viewport(0,0,c.canvas.width,c.canvas.height)},update:function(t,l,y,S,$,O,z,H,V,W,j,q,Y,K,it,nt,rt,ot,at){var st=j?j.height*i:n.height;J=e.width*i,tt=e.height*i,t*=i,l*=i,y*=i,S*=i;var lt=tt/2/s*(n.height/st)*-1;lt/=-s*lt*2/n.height;var ct=.5*J,ht=.5*tt;t-=ct,l-=ht;var ut=H,dt=-(r.x-ct)+y,pt=r.y-ht-S,ft=Jn();tr(ft,a,o,1,2*-lt),er(ft,[dt,pt,lt]),er(ft,[t,-l,0]),ir(ft,[ut,ut,ut]),or(ft,-z),er(ft,[-t,l,0]),rr(ft,O),nr(ft,$),c.clearColor(K[0],K[1],K[2],1),c.clear(c.COLOR_BUFFER_BIT);var mt=q.x*i,gt=q.y*i,vt=q.width*i,bt=q.height*i,_t=mt,yt=_t+vt,Et=n.height-gt,Tt=n.height-(gt+bt);c.useProgram(h),c.uniform3fv(u,it),c.uniform3fv(d,nt),c.uniform4fv(b,at.map((function(t,e){return e<3?t/255:t}))),c.uniform2f(p,n.width,n.height),c.uniform2f(m,_t,Et),c.uniform2f(g,yt,Tt),c.bindBuffer(c.ARRAY_BUFFER,_),c.vertexAttribPointer(f,2,c.FLOAT,!1,0,0),c.enableVertexAttribArray(f),c.drawArrays(c.TRIANGLE_STRIP,0,4),c.useProgram(I),c.bindFramebuffer(c.FRAMEBUFFER,null),c.bindTexture(c.TEXTURE_2D,G),c.bindBuffer(c.ARRAY_BUFFER,X),c.vertexAttribPointer(F,2,c.FLOAT,!1,0,0),c.enableVertexAttribArray(F),c.bindBuffer(c.ARRAY_BUFFER,Q),c.vertexAttribPointer(U,2,c.FLOAT,!1,0,0),c.enableVertexAttribArray(U),c.uniformMatrix4fv(k,!1,ft),c.uniform2f(M,_t,Et),c.uniform2f(D,yt,Tt),c.uniform4fv(L,Y),c.uniform1f(P,W),c.uniform4f(N,V[4],V[9],V[14],V[19]),c.uniformMatrix4fv(B,!1,[].concat(v(V.slice(0,4)),v(V.slice(5,9)),v(V.slice(10,14)),v(V.slice(15,19)))),c.drawArrays(c.TRIANGLE_STRIP,0,Z),c.useProgram(E),c.uniform1f(w,rt),c.uniform4fv(x,ot),c.uniform2f(C,_t,Et),c.uniform2f(R,yt,Tt),c.bindBuffer(c.ARRAY_BUFFER,A),c.vertexAttribPointer(T,2,c.FLOAT,!1,0,0),c.enableVertexAttribArray(T),c.drawArrays(c.TRIANGLE_STRIP,0,4),et.onupdate(c)},onupdate:function(){}};return et},lr=function(t){var e=0,i={},n=B(t),r=B(t),o=B(t),a=B(t);return n.onupdate=function(t){return i.x=t},n.oncomplete=function(){return e++},r.onupdate=function(t){return i.y=t},r.oncomplete=function(){return e++},o.onupdate=function(t){return i.width=t},o.oncomplete=function(){return e++},a.onupdate=function(t){return i.height=t},a.oncomplete=function(){return e++},{interpolate:function(t){n.interpolate(t),r.interpolate(t),o.interpolate(t),a.interpolate(t)},setTarget:function(t){e=0,n.target=t?t.x:null,r.target=t?t.y:null,o.target=t?t.width:null,a.target=t?t.height:null},getRect:function(){return i},isStable:function(){return 4===e}}},cr=function(t){var e=0,i={},n=B(t),r=B(t),o=B(t);return n.onupdate=function(t){return i.r=t},n.oncomplete=function(){return e++},r.onupdate=function(t){return i.g=t},r.oncomplete=function(){return e++},o.onupdate=function(t){return i.b=t},o.oncomplete=function(){return e++},{interpolate:function(t){n.interpolate(t),r.interpolate(t),o.interpolate(t)},setTarget:function(t){e=0,n.target=t?t[0]:null,r.target=t?t[1]:null,o.target=t?t[2]:null},getColor:function(){return[i.r,i.g,i.b]},isStable:function(){return 3===e}}},hr={stiffness:.25,damping:.25,mass:2.5},ur=[1,0,0,0,0,0,1,0,0,0,0,0,1,0,0,0,0,0,1,0],dr=Q({name:"image-gl",ignoreRect:!0,ignoreRectUpdate:!0,mixins:{apis:["top","left","width","height","xOrigin","yOrigin","xTranslation","yTranslation","xRotation","yRotation","zRotation","scale","overlay","stage","colorMatrix","colorOpacity","overlayOpacity","outlineWidth","isDraft"],animations:{xTranslation:Mn,yTranslation:Mn,xOrigin:Mn,yOrigin:Mn,scale:Mn,xRotation:{type:"spring",stiffness:.25,damping:.25,mass:2.5},yRotation:{type:"spring",stiffness:.25,damping:.25,mass:2.5},zRotation:{type:"spring",stiffness:.25,damping:.25,mass:2.5},colorOpacity:{type:"tween",delay:150,duration:750},overlayOpacity:"spring",introScale:{type:"spring",stiffness:.25,damping:.75,mass:15},outlineWidth:Mn}},create:function(t){var e=function(t){!function(){var e=t,n=B(hr);n.target=ur[e],n.onupdate=function(t){i.ref.colorMatrixPositions[e]=t},n.oncomplete=function(){i.ref.colorMatrixStableCount++},i.ref.colorMatrixSpring[e]=n}()},i=t.root;i.ref.canvas=document.createElement("canvas"),i.ref.canvas.width=0,i.ref.canvas.height=0,i.appendChild(i.ref.canvas),i.ref.gl=null,i.introScale=1,i.ref.isPreview="preview"===i.query("GET_STYLE_LAYOUT_MODE"),i.ref.shouldZoom=!i.ref.isPreview,i.ref.didZoom=!1,i.ref.backgroundColor=null,i.ref.backgroundColorSpring=cr(hr),i.ref.backgroundColorCenter=null,i.ref.backgroundColorCenterSpring=cr(hr),i.ref.overlaySpring=lr(Mn),i.ref.stageSpring=lr(Mn),i.ref.outlineSpring=B(Mn),i.ref.colorMatrixSpring=[],i.ref.colorMatrixStable=!0,i.ref.colorMatrixStableCount=0,i.ref.colorMatrixPositions=[];for(var n=0;n<20;n++)e(n);i.ref.dragger=Ln(i.element,(function(){i.dispatch("CROP_IMAGE_DRAG_GRAB")}),(function(t,e){i.dispatch("CROP_IMAGE_DRAG",{value:e})}),(function(){i.dispatch("CROP_IMAGE_DRAG_RELEASE")}),{cancelOnMultiple:!0});var r=0,o=0;i.ref.keyboard=Yn(i.element,(function(){return r=0,o=0,{x:0,y:0}}),{up:function(t){t.y-=20},down:function(t){t.y+=20},left:function(t){t.x-=20},right:function(t){t.x+=20},plus:function(){r+=.1,i.dispatch("CROP_IMAGE_RESIZE_AMOUNT",{value:r}),i.dispatch("CROP_IMAGE_RESIZE_RELEASE")},minus:function(){r-=.1,i.dispatch("CROP_IMAGE_RESIZE_AMOUNT",{value:r}),i.dispatch("CROP_IMAGE_RESIZE_RELEASE")},left_bracket:function(){o-=Math.PI/128,i.dispatch("CROP_IMAGE_ROTATE_ADJUST",{value:o})},right_bracket:function(){o+=Math.PI/128,i.dispatch("CROP_IMAGE_ROTATE_ADJUST",{value:o})},h:function(){i.dispatch("CROP_IMAGE_FLIP_HORIZONTAL")},l:function(){i.dispatch("CROP_IMAGE_ROTATE_LEFT")},q:function(){i.dispatch("CROP_RESET")},r:function(){i.dispatch("CROP_IMAGE_ROTATE_RIGHT")},v:function(){i.dispatch("CROP_IMAGE_FLIP_VERTICAL")},z:function(){i.dispatch("CROP_ZOOM")}},(function(t){t&&i.dispatch("CROP_IMAGE_DRAG",{value:t})}),(function(t){t&&i.dispatch("CROP_IMAGE_DRAG_RELEASE")}));var a=i.query("GET_FILE"),s=URL.createObjectURL(a.data),l=function(t){var e=$i(t,{width:i.query("GET_MAX_IMAGE_PREVIEW_WIDTH"),height:i.query("GET_MAX_IMAGE_PREVIEW_HEIGHT")}),n=Kn(t,e.width,e.height,a.orientation),r=Math.max(1,.75*window.devicePixelRatio),o=n.height/n.width,s=96*r,l=Kn(n,o>1?s:s/o,o>1?s*o:s),c=n.getContext("2d").getImageData(0,0,n.width,n.height),h=l.getContext("2d").getImageData(0,0,l.width,l.height);Oe(n),Oe(l),i.ref.gl=sr(i.ref.canvas,c,r);var u=i.query("GET_OUTPUT_CANVAS_SYNC_TARGET");u&&(i.ref.gl.onupdate=function(){var t=i.ref.overlaySpring.getRect();u.getContext("2d").drawImage(i.ref.canvas,t.x*r,t.y*r,t.width*r,t.height*r,0,0,u.width,u.height)}),i.ref.gl?(i.dispatch("DID_RECEIVE_IMAGE_DATA",{previewData:c,thumbData:h}),i.dispatch("DID_PRESENT_IMAGE")):i.dispatch("MISSING_WEBGL")},c=function(){var t;(t=s,new Promise((function(e,i){var n=new Image;n.onload=function(){e(n)},n.onerror=function(t){i(t)},n.src=t}))).then(l)};if(function(t){var e=window.navigator.userAgent.match(/Firefox\/([0-9]+)\./);return!((e?parseInt(e[1]):null)<=58)&&"createImageBitmap"in window&&function(t){return/^image/.test(t.type)&&!/svg/.test(t.type)}(t)}(a.data)){var h=ci(Zn);h.post({file:a.data},(function(t){h.terminate(),t?l(t):c()}))}else c();i.ref.canvasStyle=getComputedStyle(i.ref.canvas),i.ref.previousBackgroundColor,i.ref.previousLeft,i.ref.previousTop,i.ref.previousWidth,i.ref.previousHeight,i.element.dataset.showInteractionIndicator=!1,i.ref.handleFocus=function(t){9===t.keyCode&&(i.element.dataset.showInteractionIndicator=!0)},i.ref.handleBlur=function(t){i.element.dataset.showInteractionIndicator=!1},z(i.element)("keyup",i.ref.handleFocus),z(i.element)("blur",i.ref.handleBlur)},destroy:function(t){var e=t.root;e.ref.gl&&(e.ref.gl.release(),e.ref.gl=null),e.ref.dragger.destroy(),H(e.element)("keyup",e.ref.handleFocus),H(e.element)("blur",e.ref.handleBlur)},read:function(t){var e=t.root,i=e.ref.canvasStyle.backgroundColor,n=e.ref.canvasStyle.color;if("transparent"!==n&&""!==n||(n=null),"transparent"!==i&&""!==i||(i=null),i&&i!==e.ref.previousBackgroundColor){var r=fe(i).map((function(t){return t/255})),o=(r[0]+r[1]+r[2])/3;e.ref.backgroundColor=r,e.ref.backgroundColorCenter=r.map((function(t){return o>.5?t-.15:t+.15})),e.ref.previousBackgroundColor=i}n&&n!==e.ref.previousOutlineColor&&(e.ref.outlineColor=fe(n).map((function(t){return t/255})).concat(1),e.ref.previousOutlineColor=n)},write:J({SHOW_VIEW:function(t){var e=t.root;"crop"===t.action.id?(e.ref.dragger.enable(),e.element.setAttribute("tabindex","0")):(e.ref.dragger.disable(),e.element.removeAttribute("tabindex"))}},(function(t){var e=t.root,i=t.props,n=(t.actions,t.timestamp);if(e.ref.gl&&i.width&&i.height){var r=e.ref,o=r.gl,a=r.previousWidth,s=r.previousHeight,l=r.shouldZoom,c=r.stageSpring,h=r.overlaySpring,u=r.backgroundColorSpring,d=r.backgroundColorCenterSpring;i.width===a&&i.height===s||(e.ref.gl.resize(i.width,i.height),e.ref.previousWidth=i.width,e.ref.previousHeight=i.height),i.left===e.ref.previousLeft&&i.top===e.ref.previousTop||(e.ref.canvas.style.transform="translate(".concat(-i.left,"px, ").concat(-i.top,"px)"),e.ref.previousLeft=i.left,e.ref.previousTop=i.top),l&&!e.ref.didZoom&&(e.introScale=null,e.introScale=1.15,e.introScale=1,e.ref.didZoom=!0),u.setTarget(e.ref.backgroundColor),u.interpolate(n);var p=u.isStable();d.setTarget(e.ref.backgroundColorCenter),d.interpolate(n);var f=d.isStable();e.ref.colorMatrixStableCount=0;var m=i.colorMatrix||ur,g=e.ref.colorMatrixSpring.map((function(t,i){return t.target=m[i],t.interpolate(n),e.ref.colorMatrixPositions[i]})),v=20===e.ref.colorMatrixStableCount;i.isDraft&&h.setTarget(null),h.setTarget(i.overlay),h.interpolate(n);var b=h.isStable();i.isDraft&&c.setTarget(null),c.setTarget(i.stage),c.interpolate(n);var _=c.isStable();return o.update(e.xOrigin,e.yOrigin,e.xTranslation+i.left,e.yTranslation+i.top,e.xRotation,e.yRotation,e.zRotation,e.scale*e.introScale,g,e.ref.isPreview?1:e.colorOpacity,c.getRect(),h.getRect(),[1,1,1,1-e.overlayOpacity],u.getColor(),d.getColor(),u.getColor(),e.outlineWidth,e.ref.outlineColor,e.query("GET_BACKGROUND_COLOR")),b&&_&&v&&p&&f}}))}),pr=Q({name:"image",ignoreRect:!0,mixins:{apis:["offsetTop"]},create:function(t){var e=t.root,i=t.props;e.ref.imageGL=e.appendChildView(e.createChildView(dr)),/markup/.test(e.query("GET_UTILS"))&&(e.ref.markup=e.appendChildView(e.createChildView(zn,{id:i.id,opacity:0,onSelect:function(t){e.dispatch("MARKUP_SELECT",{id:t})},onDrag:function(t,i,n,r,o){e.dispatch("MARKUP_ELEMENT_DRAG",{id:t,origin:i,offset:n,size:r,scale:o})},onResize:function(t,i,n,r,o){e.dispatch("MARKUP_ELEMENT_RESIZE",{id:t,corner:i,origin:n,offset:r,size:o})},onUpdate:function(t,i){e.dispatch("MARKUP_UPDATE",{style:t,value:i})},isMarkupUtil:function(t){var e=t;do{if("doka--markup-tools"===e.className)return!0}while(e=e.parentNode);return!1}}))),e.ref.isModal=/modal/.test(e.query("GET_STYLE_LAYOUT_MODE"))},write:J({DID_PRESENT_IMAGE:function(t){t.root.ref.imageGL.colorOpacity=1}},(function(t){var e=t.root,i=t.props,n=t.timestamp,r=e.ref.imageGL,o=e.ref.markup,a=e.query("GET_CROP",i.id,n);if(a){var s=a.isDraft,l=a.cropRect,c=a.cropStatus,h=a.origin,u=a.translation,d=a.translationBand,p=a.scale,m=a.scaleBand,g=a.rotation,v=a.rotationBand,b=a.flip,_=a.colorMatrix,y=e.query("GET_ROOT"),E=e.query("GET_STAGE"),T=E.x,w=E.y;s&&(r.scale=null,r.zRotation=null,r.xTranslation=null,r.yTranslation=null,r.xOrigin=null,r.yOrigin=null),r.colorMatrix=_;var x=e.query("IS_ACTIVE_VIEW","crop"),C=e.query("IS_ACTIVE_VIEW","markup"),R=x?.75:.95,A=f({},l),S=1,I=x?1:5;if(e.query("IS_ACTIVE_VIEW","resize")){var k=c.image.width,$=c.image.height;S=null===k&&null===$?c.crop.width/l.width:null===k?$/l.height:k/l.width,S/=window.devicePixelRatio;var O=l.width*S,L=l.height*S;A.x=A.x+(.5*l.width-.5*O),A.y=A.y+(.5*l.height-.5*L),A.width=O,A.height=L}var M=e.ref.isModal?0:y.left,D=e.ref.isModal?0:y.top,P=e.ref.isModal?0:y.width-e.rect.element.width,N=e.ref.isModal?0:y.height-e.rect.element.height-i.offsetTop,B=(p+m)*S;r.isDraft=s,r.overlayOpacity=R,r.xOrigin=h.x,r.yOrigin=h.y,r.xTranslation=u.x+d.x+T,r.yTranslation=u.y+d.y+w,r.left=M,r.top=D+i.offsetTop,r.width=e.rect.element.width+P,r.height=e.rect.element.height+N+i.offsetTop,r.scale=B,r.xRotation=b.vertical?Math.PI:0,r.yRotation=b.horizontal?Math.PI:0,r.zRotation=g.main+g.sub+v,r.stage={x:E.x+M,y:E.y+D+i.offsetTop,width:E.width,height:E.height},r.overlay={x:A.x+T+M,y:A.y+w+D+i.offsetTop,width:A.width,height:A.height},r.outlineWidth=I,o&&(s&&(o.translateX=null,o.translateY=null,o.markupX=null,o.markupY=null,o.markupWidth=null,o.markupHeight=null),o.opacity=x?.3:1,o.stageOffsetX=T,o.stageOffsetY=w,o.markupX=A.x+T,o.markupY=A.y+w,o.markupWidth=A.width,o.markupHeight=A.height,o.allowInteraction=C)}}))}),fr=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:"group",e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:["opacity"],i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};return Q({ignoreRect:!0,name:t,mixins:{styles:["opacity"].concat(v(e)),animations:f({opacity:{type:"spring",stiffness:.25,damping:.5,mass:5}},i)},create:function(t){var e=t.root,i=t.props;(i.controls||[]).map((function(t){var i=e.createChildView(t.view,t);t.didCreateView&&t.didCreateView(i),e.appendChildView(i)})),i.element&&e.element.appendChild(i.element)}})},mr=Q({ignoreRect:!0,tag:"div",name:"dropdown-list",mixins:{styles:["translateY","opacity"],apis:["selectedValue","options","onSelect"],animations:{translateY:"spring",opacity:{type:"tween",duration:250}}},create:function(t){var e=t.root,i=t.props;e.element.setAttribute("role","list"),e.ref.handleClick=function(){return i.action&&i.action()},e.element.addEventListener("click",e.ref.handleClick),e.ref.activeOptions=null,e.ref.activeSelectedValue},write:function(t){var e=t.root,i=t.props;if(i.options!==e.ref.activeOptions&&(e.ref.activeOptions=i.options,e.childViews.forEach((function(t){return e.removeChildView(t)})),i.options.map((function(t){var n=e.createChildView(_n,f({},t,{action:function(){return i.onSelect(t.value)}}));return e.appendChildView(n)}))),i.selectedValue!==e.ref.activeSelectedValue){e.ref.activeSelectedValue=i.selectedValue;var n=i.options.findIndex((function(t){return"object"===d(t.value)&&i.selectedValue?JSON.stringify(t.value)===JSON.stringify(i.selectedValue):t.value===i.selectedValue}));e.childViews.forEach((function(t,e){t.element.setAttribute("aria-selected",e===n)}))}},destroy:function(t){var e=t.root;e.element.removeEventListener("click",e.ref.handleClick)}}),gr=Q({ignoreRect:!0,tag:"div",name:"dropdown",mixins:{styles:["opacity"],animations:{opacity:"spring"},apis:["direction","selectedValue","options","onSelect"]},create:function(t){var e=t.root,i=t.props;e.ref.open=!1;var n=function(t){e.ref.open=t,e.dispatch("KICK")};e.ref.button=e.appendChildView(e.createChildView(_n,f({},i,{action:function(){n(!e.ref.open)}}))),e.ref.list=e.appendChildView(e.createChildView(mr,f({},i,{opacity:0,action:function(){n(!1)}}))),e.ref.handleBodyClick=function(t){e.element.contains(t.target)||n(!1)},e.element.addEventListener("focusin",(function(t){t.target!==e.ref.button.element&&n(!0)})),e.element.addEventListener("focusout",(function(t){e.element.contains(t.relatedTarget)||n(!1)})),document.body.addEventListener("click",e.ref.handleBodyClick)},destroy:function(t){var e=t.root;document.body.removeEventListener("click",e.ref.handleBodyClick)},write:function(t){var e=t.root,i=t.props;if(e.ref.list.opacity=e.ref.open?1:0,e.ref.list.selectedValue=i.selectedValue,e.ref.list.options=i.options,"up"===i.direction){var n=e.ref.list.rect.element.height;e.ref.list.translateY=(e.ref.open?-(n+5):-n)-e.rect.element.height}else e.ref.list.translateY=e.ref.open?0:-5}}),vr=Q({name:"crop-rotator-line",ignoreRect:!0,ignoreRectUpdate:!0,mixins:{styles:["translateX"],animations:{translateX:"spring"}},create:function(t){for(var e=t.root,i='<svg viewBox="-90 -5 180 10" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">',n=0;n<=180;n+=2){var r=n*(176/180)-90+2,o=n%10==0?.5:.2;i+='<circle fill="currentColor" cx="'.concat(r,'" cy="').concat(0,'" r="').concat(o,'"/>'),n%10==0&&(i+='<text fill="currentColor" x="'.concat(r+(r<0?-2.25:0===r?-.75:-1.5),'" y="').concat(3.5,'">').concat(-90+n,"&deg;</text>"))}i+="</svg>",e.element.innerHTML=i}}),br=Q({name:"crop-rotator",ignoreRect:!0,mixins:{styles:["opacity","translateY"],animations:{opacity:{type:"spring",damping:.5,mass:5},translateY:"spring"},apis:["rotation","animate","setAllowInteraction"]},create:function(t){var e=t.root,i=t.props;e.element.setAttribute("tabindex",0);var n=document.createElement("button");n.innerHTML="<span>".concat(e.query("GET_LABEL_BUTTON_CROP_ROTATE_CENTER"),"</span>"),n.className="doka--crop-rotator-center",n.addEventListener("click",(function(){e.dispatch("CROP_IMAGE_ROTATE_CENTER")})),e.appendChild(n);var r=null;e.appendChildView(e.createChildView(Q({name:"crop-rotator-line-mask",ignoreRect:!0,create:function(t){var e=t.root,i=t.props;r=e.appendChildView(e.createChildView(vr,{translateX:Math.round(312*i.rotation)}))}}),i)),e.ref.line=r;var o=document.createElement("div");o.className="doka--crop-rotator-bar",e.appendChild(o);var a=Math.PI/4,s=0;e.ref.dragger=Ln(o,(function(){s=r.translateX/312,e.dispatch("CROP_IMAGE_ROTATE_GRAB")}),(function(t,i){var n=i.x/e.rect.element.width*(Math.PI/2),r=Mt(s+n,-a,a);e.dispatch("CROP_IMAGE_ROTATE",{value:-r})}),(function(){e.dispatch("CROP_IMAGE_ROTATE_RELEASE")}),{stopPropagation:!0}),i.setAllowInteraction=function(t){t?e.ref.dragger.enable():e.ref.dragger.disable()},e.ref.keyboard=Yn(e.element,(function(){s=0}),{left:function(){s+=Math.PI/128,e.dispatch("CROP_IMAGE_ROTATE_ADJUST",{value:s})},right:function(){s-=Math.PI/128,e.dispatch("CROP_IMAGE_ROTATE_ADJUST",{value:s})}},(function(){}),(function(){})),e.ref.prevRotation},destroy:function(t){var e=t.root;e.ref.dragger.destroy(),e.ref.keyboard.destroy()},write:function(t){var e=t.root,i=t.props,n=t.timestamp,r=i.animate,o=i.rotation;if(e.ref.prevRotation!==o){e.ref.prevRotation=o,r||0===o||(e.ref.line.translateX=null);var a=0,s=e.query("GET_CROP",i.id,n);if(s&&s.interaction&&s.interaction.rotation){var l=ki(s.interaction.rotation).sub-o;a=.025*Math.sign(l)*Math.log10(1+Math.abs(l)/.025)}e.ref.line.translateX=Math.round(312*(-o-a))}}}),_r=["nw","ne","se","sw"],yr=["n","e","s","w"],Er=Z()&&1===window.devicePixelRatio?function(t){return Math.round(t)}:function(t){return t},Tr=Q({ignoreRect:!0,ignoreRectUpdate:!0,name:"crop-rect-focal-line",mixins:{styles:["translateX","translateY","scaleX","scaleY","opacity"],animations:{translateX:"spring",translateY:"spring",scaleX:"spring",scaleY:"spring",opacity:"spring"}}}),wr=function(t){return Q({ignoreRect:!0,ignoreRectUpdate:!0,tag:"div",name:"crop-rect-edge-".concat(t),mixins:{styles:["translateX","translateY","scaleX","scaleY"],apis:["setAllowInteraction"]},create:function(e){var i=e.root,n=e.props;i.element.classList.add("doka--crop-rect-edge"),i.element.setAttribute("tabindex",0),i.element.setAttribute("role","button");var r,o=t,a=(r=t,yr[(yr.indexOf(r)+2)%yr.length]);i.ref.dragger=Ln(i.element,(function(){i.dispatch("CROP_RECT_DRAG_GRAB")}),(function(t,e){return i.dispatch("CROP_RECT_EDGE_DRAG",{offset:e,origin:o,anchor:a})}),(function(){return i.dispatch("CROP_RECT_DRAG_RELEASE")}),{stopPropagation:!0,cancelOnMultiple:!0}),n.setAllowInteraction=function(t){t?i.ref.dragger.enable():i.ref.dragger.disable()},i.ref.keyboard=Yn(i.element,(function(){return{x:0,y:0}}),{up:function(t){t.y-=20},down:function(t){t.y+=20},left:function(t){t.x-=20},right:function(t){t.x+=20}},(function(t){i.dispatch("CROP_RECT_DRAG_GRAB"),i.dispatch("CROP_RECT_EDGE_DRAG",{offset:t,origin:o,anchor:a})}),(function(){i.dispatch("CROP_RECT_DRAG_RELEASE")}))},destroy:function(t){var e=t.root;e.ref.keyboard.destroy(),e.ref.dragger.destroy()}})},xr=function(t,e,i){return Q({ignoreRect:!0,ignoreRectUpdate:!0,tag:"div",name:"crop-rect-corner-".concat(t),mixins:{styles:["translateX","translateY","scaleX","scaleY"],animations:{translateX:Mn,translateY:Mn,scaleX:{type:"spring",delay:i},scaleY:{type:"spring",delay:i},opacity:{type:"spring",delay:e}},apis:["setAllowInteraction"]},create:function(e){var i=e.root,n=e.props;i.element.classList.add("doka--crop-rect-corner"),i.element.setAttribute("role","button"),i.element.setAttribute("tabindex",-1);var r,o=t,a=(r=t,_r[(_r.indexOf(r)+2)%_r.length]);i.ref.dragger=Ln(i.element,(function(){i.dispatch("CROP_RECT_DRAG_GRAB")}),(function(t,e){i.dispatch("CROP_RECT_CORNER_DRAG",{offset:e,origin:o,anchor:a})}),(function(){i.dispatch("CROP_RECT_DRAG_RELEASE")}),{stopPropagation:!0,cancelOnMultiple:!0}),n.setAllowInteraction=function(t){t?i.ref.dragger.enable():i.ref.dragger.disable()}},destroy:function(t){t.root.ref.dragger.destroy()}})},Cr=Q({ignoreRect:!0,ignoreRectUpdate:!0,name:"crop-rect",mixins:{apis:["rectangle","draft","rotating","enabled"]},create:function(t){var e=t.root;e.ref.wasRotating=!1,_r.forEach((function(t,i){var n=10*i,r=250+n+50,o=250+n;e.ref[t]=e.appendChildView(e.createChildView(xr(t,r,o),{opacity:0,scaleX:.5,scaleY:.5}))})),yr.forEach((function(t){e.ref[t]=e.appendChildView(e.createChildView(wr(t)))})),e.ref.lines=[];for(var i=0;i<10;i++)e.ref.lines.push(e.appendChildView(e.createChildView(Tr,{opacity:0})));e.ref.animationDir=null,e.ref.previousRotating,e.ref.previousRect={},e.ref.previousEnabled,e.ref.previousDraft},write:function(t){var e=t.root,i=t.props,n=i.rectangle,r=i.draft,o=i.rotating,a=i.enabled;if(n&&(!Ht(n,e.ref.previousRect)||o!==e.ref.previousRotating||a!==e.ref.previousEnabled||r!==e.ref.previousDraft)){e.ref.previousRect=n,e.ref.previousRotating=o,e.ref.previousEnabled=a,e.ref.previousDraft=r;var s=e.ref,l=s.n,c=s.e,h=s.s,u=s.w,d=s.nw,p=s.ne,f=s.se,m=s.sw,g=s.lines,v=s.animationDir,b=n.x,_=n.y,y=n.x+n.width,E=n.y+n.height,T=E-_,w=y-b,x=Math.min(w,T);e.element.dataset.indicatorSize=x<80?"none":"default",yr.forEach((function(t){return e.ref[t].setAllowInteraction(a)})),_r.forEach((function(t){return e.ref[t].setAllowInteraction(a)}));var C=e.query("IS_ACTIVE_VIEW","crop");if(C&&"in"!==v?(e.ref.animationDir="in",_r.map((function(t){return e.ref[t]})).forEach((function(t){t.opacity=1,t.scaleX=1,t.scaleY=1}))):C||"out"===v||(e.ref.animationDir="out",_r.map((function(t){return e.ref[t]})).forEach((function(t){t.opacity=0,t.scaleX=.5,t.scaleY=.5}))),Ar(r,d,b,_),Ar(r,p,y,_),Ar(r,f,y,E),Ar(r,m,b,E),Rr(r,l,b,_,w/100,1),Rr(r,c,y,_,1,T/100),Rr(r,h,b,E,w/100,1),Rr(r,u,b,_,1,T/100),o){e.ref.wasRotating=!0;var R=g.slice(0,5),A=1/R.length;R.forEach((function(t,e){Rr(r,t,b,_+T*(A+e*A),w/100,.01),t.opacity=.5}));var S=g.slice(5);A=1/S.length,S.forEach((function(t,e){Rr(r,t,b+w*(A+e*A),_,.01,T/100),t.opacity=.5}))}else if(r){e.ref.wasRotating=!1;var I=g[0],k=g[1],$=g[2],O=g[3];Rr(r,I,b,_+.333*T,w/100,.01),Rr(r,k,b,_+.666*T,w/100,.01),Rr(r,$,b+.333*w,_,.01,T/100),Rr(r,O,b+.666*w,_,.01,T/100),I.opacity=.5,k.opacity=.5,$.opacity=.5,O.opacity=.5}else{var L=g[0],M=g[1],D=g[2],P=g[3];!e.ref.wasRotating&&L.opacity>0&&(Rr(r,L,b,_+.333*T,w/100,.01),Rr(r,M,b,_+.666*T,w/100,.01),Rr(r,D,b+.333*w,_,.01,T/100),Rr(r,P,b+.666*w,_,.01,T/100)),g.forEach((function(t){return t.opacity=0}))}}}}),Rr=function(t,e,i,n,r,o){t&&(e.translateX=null,e.translateY=null,e.scaleX=null,e.scaleY=null),e.translateX=Er(i),e.translateY=Er(n),e.scaleX=r,e.scaleY=o},Ar=function(t,e,i,n){t&&(e.translateX=null,e.translateY=null),e.translateX=Er(i),e.translateY=Er(n)},Sr=function(t,e){if(!/svg/.test(t.namespaceURI)||"innerHTML"in t)t.innerHTML=e;else{var i=document.createElement("div");i.innerHTML="<svg>"+e+"</svg>";for(var n=i.firstChild;n.firstChild;)t.appendChild(n.firstChild)}},Ir=Q({ignoreRect:!0,ignoreRectUpdate:!0,name:"crop-mask",tag:"svg",mixins:{styles:["opacity","translateX","translateY"],animations:{scale:Mn,maskWidth:Mn,maskHeight:Mn,translateX:Mn,translateY:Mn,opacity:{type:"tween",delay:0,duration:1e3}},apis:["rectangle","animate","maskWidth","maskHeight","scale"]},create:function(t){t.root.ref.writer=null},write:function(t){var e=t.root,i=e.query("GET_CROP_MASK");i!==e.ref.writer&&(e.ref.writer=i,e.ref.writerFn=i?i(e.element,Sr):null,e.ref.writer||Sr(e.element,""))},didWriteView:function(t){var e=t.root,i=t.props,n=i.maskWidth,r=i.maskHeight,o=i.scale;if(e.ref.writer&&n&&r&&(e.element.setAttribute("width",Er(n)),e.element.setAttribute("height",Er(r)),e.ref.writerFn)){var a=e.query("GET_CROP_MASK_INSET");e.ref.writerFn({x:o*a,y:o*a,width:n-o*a*2,height:r-o*a*2},{width:n,height:r})}}}),kr=function(t,e){var i=t.childNodes[0];i?e!==i.nodeValue&&(i.nodeValue=e):(i=document.createTextNode(e),t.appendChild(i))},$r={type:"spring",stiffness:.25,damping:.1,mass:1},Or=Q({ignoreRect:!0,name:"crop-size",mixins:{styles:["translateX","translateY","opacity"],animations:{translateX:"spring",translateY:"spring",opacity:"spring",sizeWidth:$r,sizeHeight:$r},apis:["sizeWidth","sizeHeight"],listeners:!0},create:function(t){var e=t.root,i=I("span");i.className="doka--crop-size-info doka--crop-resize-percentage",e.ref.resizePercentage=i,e.appendChild(i);var n=I("span");n.className="doka--crop-size-info";var r=I("span");r.className="doka--crop-size-multiply",r.textContent="\xd7";var o=I("span"),a=I("span");e.ref.outputWidth=o,e.ref.outputHeight=a,n.appendChild(o),n.appendChild(r),n.appendChild(a),e.appendChild(n),e.ref.previousValues={width:0,height:0,percentage:0}},write:function(t){var e=t.root,i=t.props,n=t.timestamp;if(!(e.opacity<=0)){var r=e.query("GET_CROP",i.id,n);if(r){var o=r.cropStatus,a=r.isDraft,s=e.ref,l=s.outputWidth,c=s.outputHeight,h=s.resizePercentage,u=s.previousValues,d=o.image,p=o.crop,f=o.currentWidth,m=o.currentHeight,g=d.width?Math.round(d.width/p.width*100):0;a&&(e.sizeWidth=null,e.sizeHeight=null),e.sizeWidth=f,e.sizeHeight=m;var v=Math.round(e.sizeWidth),b=Math.round(e.sizeHeight);v!==u.width&&(kr(l,v),u.width=v),b!==u.height&&(kr(c,b),u.height=b),g!==u.percentage&&(d.width?kr(h,"".concat(g,"%")):kr(h,""),u.percentage=g)}}}}),Lr=function(){return console.log("Doka: localStorage not available")},Mr=function(t){try{JSON.parse(localStorage.getItem(t)||"{}")}catch(e){Lr()}return{}},Dr=function(){return window.matchMedia("(pointer: fine) and (hover: hover)").matches},Pr=Q({ignoreRect:!0,ignoreRectUpdate:!0,name:"instructions-bubble",mixins:{styles:["opacity","translateX","translateY"],animations:{opacity:{type:"tween",duration:400}},apis:["seen"]},create:function(t){var e=t.root,i=t.props;return e.element.innerHTML=(i.iconBefore||"")+i.text},write:function(t){var e=t.root;t.props.seen&&(e.opacity=0)}}),Nr={type:"spring",stiffness:.4,damping:.65,mass:7},Br=Q({name:"crop-subject",ignoreRect:!0,mixins:{styles:["opacity","translateX","translateY"],animations:{opacity:{type:"tween",duration:250},translateX:Nr,translateY:Nr}},create:function(t){var e=t.root,i=t.props;e.opacity=1,e.ref.timestampOffset=null,e.query("GET_CROP_ALLOW_INSTRUCTION_ZOOM")&&Dr()&&(function(t,e,i){var n=Mr(t);return void 0===n[e]?i:n[e]}(e.query("GET_STORAGE_NAME"),"instruction_zoom_shown",!1)||(e.ref.instructions=e.appendChildView(e.createChildView(Pr,{opacity:0,seen:!1,text:e.query("GET_LABEL_CROP_INSTRUCTION_ZOOM"),iconBefore:bn('<rect stroke-width="1.5" fill="none" stroke="currentColor" x="5" y="1" width="14" height="22" rx="7" ry="7"></rect><circle fill="currentColor" stroke="none" cx="12" cy="8" r="2"></circle>')})))),e.ref.maskView=e.appendChildView(e.createChildView(Ir)),e.query("GET_CROP_ALLOW_RESIZE_RECT")&&(e.ref.cropView=e.appendChildView(e.createChildView(Cr))),e.query("GET_CROP_SHOW_SIZE")&&(e.ref.cropSize=e.appendChildView(e.createChildView(Or,{id:i.id,opacity:1,scaleX:1,scaleY:1,translateX:null}))),e.query("GET_CROP_ZOOM_TIMEOUT")||(e.ref.btnZoom=e.appendChildView(e.createChildView(Q({ignoreRect:!0,name:"zoom-wrapper",mixins:{styles:["opacity","translateX","translateY"],animations:{opacity:{type:"tween",duration:250}}},create:function(t){var e=t.root,i=t.props;i.className&&e.element.classList.add(i.className),i.controls.map((function(t){var i=e.createChildView(t.view,t);t.didCreateView&&t.didCreateView(i),e.appendChildView(i)}))}}),{opacity:0,controls:[{view:_n,label:e.query("GET_LABEL_BUTTON_CROP_ZOOM"),name:"zoom",icon:bn('<g fill="currentColor" fill-rule="nonzero"><path d="M12.5 19a6.5 6.5 0 1 1 0-13 6.5 6.5 0 0 1 0 13zm0-2a4.5 4.5 0 1 0 0-9 4.5 4.5 0 0 0 0 9z"/><path d="M15.765 17.18a1 1 0 1 1 1.415-1.415l3.527 3.528a1 1 0 0 1-1.414 1.414l-3.528-3.527z"/></g>',26),action:function(){return e.dispatch("CROP_ZOOM")}}]})))},write:J({CROP_IMAGE_RESIZE_MULTIPLY:function(t){var e=t.root,i=e.ref.instructions;i&&!i.seen&&(i.seen=!0,function(t,e,i){var n=Mr(t);n[e]=i;try{localStorage.setItem(t,JSON.stringify(n))}catch(r){Lr()}}(e.query("GET_STORAGE_NAME"),"instruction_zoom_shown",!0))},CROP_RECT_DRAG_RELEASE:function(t){var e=t.root,i=t.props,n=t.timestamp,r=e.ref.btnZoom;if(r){var o=e.query("GET_CROP",i.id,n).cropRect,a=o.x+.5*o.width,s=o.y+.5*o.height;r.translateX=a,r.translateY=s}}},(function(t){var e=t.root,i=t.props,n=t.timestamp,r=e.ref,o=r.cropView,a=r.maskView,s=r.btnZoom,l=r.cropSize,c=r.instructions;if(!e.query("IS_ACTIVE_VIEW","crop")&&o)return o.enabled=!1,e.ref.timestampOffset=null,void(l&&(l.opacity=0));e.ref.timestampOffset||(e.ref.timestampOffset=n);var h=e.query("GET_CROP",i.id,n);if(h){var u=h.cropRect,d=h.isRotating,p=h.isDraft,f=h.scale,m=e.query("GET_STAGE");if(e.translateX=m.x-e.rect.element.left,e.translateY=m.y-e.rect.element.top,o&&(o.draft=p,o.rotating=d,o.rectangle=u,o.enabled=!0),l){l.opacity=1,p&&(l.translateX=null,l.translateY=null);var g=Fr(e.rect.element,l.rect.element,u);l.translateX=p?g.x:Er(g.x),l.translateY=p?g.y:Er(g.y)}if(e.query("GET_CROP_MASK")&&(p&&(a.translateX=null,a.translateY=null,a.maskWidth=null,a.maskHeight=null),a.translateX=Er(u.x),a.translateY=Er(u.y),a.maskWidth=u.width,a.maskHeight=u.height,a.scale=f),h.canRecenter)c&&(c.opacity=0),s&&(s.opacity=h.isDraft?0:1);else if(s&&(s.opacity=0),c&&!c.seen&&!h.isDraft){var v=u.x+.5*u.width,b=u.y+.5*u.height;c.translateX=Math.round(v-.5*c.rect.element.width),c.translateY=Math.round(b-.5*c.rect.element.height),n-e.ref.timestampOffset>2e3&&(c.opacity=1)}}}))}),Fr=function(t,e,i){var n=i.x,r=i.x+i.width,o=i.y+i.height,a=r-e.width-16,s=o-e.height-16;return e.width>i.width-32&&(a=n+(.5*i.width-.5*e.width),(s=o+16)>t.height-e.height&&(s=o-e.height-16)),{x:a=Math.max(0,Math.min(a,t.width-e.width)),y:s}},Ur=function(){return performance.now()},Gr=function(t,e){for(;1===t.nodeType&&!e(t);)t=t.parentNode;return 1===t.nodeType?t:null},zr=function(t,e){var i=Gr(e,(function(t){return t.classList.contains("doka--root")}));return!!i&&i.contains(t)},Hr=function(t){var e=t.root,i=t.props,n=t.action.position,r=i.pivotPoint,o=e.ref,a=o.indicatorA,s=o.indicatorB,l=r.x-n.x,c=r.y-n.y,h={x:r.x+l,y:r.y+c},u={x:r.x-l,y:r.y-c};a.style.cssText="transform: translate3d(".concat(h.x,"px, ").concat(h.y,"px, 0)"),s.style.cssText="transform: translate3d(".concat(u.x,"px, ").concat(u.y,"px, 0)")},Vr=function(t){return{x:t.pageX,y:t.pageY}},Wr=Q({ignoreRect:!0,ignoreRectUpdate:!0,name:"crop-resizer",mixins:{apis:["pivotPoint","scrollRect"]},create:function(t){var e=t.root,i=t.props;e.ref.isActive=!1,e.ref.isCropping=!1,e.ref.indicatorA=document.createElement("div"),e.appendChild(e.ref.indicatorA),e.ref.indicatorB=document.createElement("div"),e.appendChild(e.ref.indicatorB);var n=e.query("GET_CROP_RESIZE_KEY_CODES");e.ref.hasEnabledResizeModifier=n.length>0;var r={origin:{x:null,y:null},position:{x:null,y:null},selecting:!1,enabled:!1,scrollY:0,offsetX:0,offsetY:0},o=Ur();e.ref.state=r;var a=In(),s=0,l=!1;e.ref.resizeStart=function(t){if(e.ref.isActive&&(0===a.count()&&(l=!1),zr(e.element,t.target)&&(a.push(t),kn(document.documentElement,"up",e.ref.resizeEnd),a.multiple()))){t.stopPropagation(),t.preventDefault();var i=a.active(),n=Vr(i[0]),r=Vr(i[1]);s=Ft(n,r),kn(document.documentElement,"move",e.ref.resizeMove),l=!0}},e.ref.resizeMove=function(t){if(e.ref.isActive&&l&&(t.preventDefault(),2===a.count())){a.update(t);var i=a.active(),n=Vr(i[0]),r=Vr(i[1]),o=(Ft(n,r)-s)/s;e.dispatch("CROP_IMAGE_RESIZE",{value:o})}},e.ref.resizeEnd=function(t){if(e.ref.isActive){a.pop(t);var i=0===a.count();i&&($n(document.documentElement,"move",e.ref.resizeMove),$n(document.documentElement,"up",e.ref.resizeEnd)),l&&(t.preventDefault(),i&&e.dispatch("CROP_IMAGE_RESIZE_RELEASE"))}},kn(document.documentElement,"down",e.ref.resizeStart);var c=performance.now(),h=0,u=1,d=function(t,e){var i=null,n=null;return function(){var r=arguments;if(!n)return t.apply(null,Array.from(arguments)),void(n=Ur());clearTimeout(i),i=setTimeout((function(){Ur()-n>=e&&(t.apply(null,Array.from(r)),n=Ur())}),e-(Ur()-n))}}((function(t){if(!e.ref.isCropping){var i=Math.sign(t.wheelDelta||t.deltaY),n=Ur(),r=n-c;c=n,(r>750||h!==i)&&(u=1,h=i),u+=.05*i,e.dispatch("CROP_IMAGE_RESIZE_MULTIPLY",{value:Math.max(.1,u)}),e.dispatch("CROP_IMAGE_RESIZE_RELEASE")}}),100);e.ref.wheel=function(t){if(e.ref.isActive&&zr(e.element,t.target)){if(i.scrollRect){var n=i.scrollRect,r=e.query("GET_ROOT"),o=Vr(t),a={x:o.x-r.leftScroll,y:o.y-r.topScroll};if(a.x<n.x||a.x>n.x+n.width||a.y<n.y||a.y>n.y+n.height)return}t.preventDefault(),d(t)}},document.addEventListener("wheel",e.ref.wheel,{passive:!1}),e.ref.hasEnabledResizeModifier&&(e.ref.move=function(t){if(e.ref.isActive&&!e.ref.isCropping&&(r.position.x=t.pageX-e.ref.state.offsetX,r.position.y=t.pageY-e.ref.state.scrollY-e.ref.state.offsetY,r.enabled))if(zr(e.element,t.target)){"idle"===e.element.dataset.state&&e.dispatch("RESIZER_SHOW",{position:f({},r.position)}),t.preventDefault(),e.dispatch("RESIZER_MOVE",{position:f({},r.position)});var n=i.pivotPoint,a=n.x-r.position.x,l=n.y-r.position.y,c={x:n.x+a,y:n.y+l},h=f({},r.position);if(r.selecting){var u=(Ft(c,h)-s)/s,d=performance.now();d-o>25&&(o=d,e.dispatch("CROP_IMAGE_RESIZE",{value:u}))}}else e.dispatch("RESIZER_CANCEL")},e.ref.select=function(t){if(e.ref.isActive&&zr(e.element,t.target)){var n=i.pivotPoint,o=n.x-r.position.x,a=n.y-r.position.y,l={x:n.x+o,y:n.y+a},c=r.position;s=Ft(l,c),r.selecting=!0,r.origin.x=t.pageX,r.origin.y=t.pageY,e.dispatch("CROP_IMAGE_RESIZE_GRAB")}},e.ref.confirm=function(t){e.ref.isActive&&zr(e.element,t.target)&&(r.selecting=!1,e.dispatch("CROP_IMAGE_RESIZE_RELEASE"))},e.ref.blur=function(){e.ref.isActive&&(r.selecting=!1,r.enabled=!1,document.removeEventListener("mousedown",e.ref.select),document.removeEventListener("mouseup",e.ref.confirm),e.dispatch("RESIZER_CANCEL"))},window.addEventListener("blur",e.ref.blur),document.addEventListener("mousemove",e.ref.move),e.ref.keyDown=function(t){e.ref.isActive&&n.includes(t.keyCode)&&r.position&&(r.enabled=!0,document.addEventListener("mousedown",e.ref.select),document.addEventListener("mouseup",e.ref.confirm),e.dispatch("RESIZER_SHOW",{position:f({},r.position)}))},e.ref.keyUp=function(t){e.ref.isActive&&n.includes(t.keyCode)&&(r.enabled=!1,document.removeEventListener("mousedown",e.ref.select),document.removeEventListener("mouseup",e.ref.confirm),e.dispatch("RESIZER_CANCEL"))},document.body.addEventListener("keydown",e.ref.keyDown),document.body.addEventListener("keyup",e.ref.keyUp))},destroy:function(t){var e=t.root;document.removeEventListener("touchmove",e.ref.resizeMove),document.removeEventListener("touchend",e.ref.resizeEnd),document.removeEventListener("touchstart",e.ref.resizeStart),document.removeEventListener("wheel",e.ref.wheel),document.removeEventListener("mousedown",e.ref.select),document.removeEventListener("mouseup",e.ref.confirm),e.ref.hasEnabledResizeModifier&&(document.removeEventListener("mousemove",e.ref.move),document.body.removeEventListener("keydown",e.ref.keyDown),document.body.removeEventListener("keyup",e.ref.keyUp),window.removeEventListener("blur",e.ref.blur))},read:function(t){var e=t.root;e.ref.state.scrollY=window.scrollY;var i=e.element.getBoundingClientRect();e.ref.state.offsetX=i.x,e.ref.state.offsetY=i.y},write:J({CROP_RECT_DRAG_GRAB:function(t){t.root.ref.isCropping=!0},CROP_RECT_DRAG_RELEASE:function(t){t.root.ref.isCropping=!1},SHOW_VIEW:function(t){var e=t.root,i=t.action;e.ref.isActive="crop"===i.id},RESIZER_SHOW:function(t){var e=t.root,i=t.props,n=t.action;e.element.dataset.state="multi-touch",Hr({root:e,props:i,action:n})},RESIZER_CANCEL:function(t){t.root.element.dataset.state="idle"},RESIZER_MOVE:Hr})}),jr=function(t,e){return t.style.opacity=e},qr=function(t,e){var i=Array.from(t.element.querySelectorAll(".doka--icon-crop-limit rect"));i.length&&(jr(i[0],e?.3:0),jr(i[1],e?1:0),jr(i[2],e?0:.3),jr(i[3],e?0:1))},Yr=function(t,e){var i=t.element.querySelectorAll(".doka--icon-aspect-ratio rect");if(i.length){if(!e)return jr(i[0],.2),jr(i[1],.3),void jr(i[2],.4);jr(i[0],e>1?1:.3),jr(i[1],1===e?.85:.5),jr(i[2],e<1?1:.3)}},Kr=function(t){var e,i;t>1?(i=14,e=Math.round(i/t)):(e=14,i=Math.round(e*t));var n=Math.round(.5*(23-e)),r=Math.round(.5*(23-i));return'<svg width="23" height="23" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><g fill="currentColor"><rect x="'.concat(n,'" y="').concat(r,'" width="').concat(e,'" height="').concat(i,'" rx="2.5"/></g></svg>')},Zr=Q({name:"crop",ignoreRect:!0,mixins:{apis:["viewId","stagePosition","hidden","offsetTop"]},create:function(t){var e=t.root,i=t.props;i.viewId="crop",i.hidden=!1,e.ref.isHiding=!1;var n=[];e.query("GET_CROP_ALLOW_IMAGE_TURN_LEFT")&&n.push({view:_n,name:"tool",label:e.query("GET_LABEL_BUTTON_CROP_ROTATE_LEFT"),icon:bn('<g transform="translate(3 2)" fill="currentColor" fill-rule="evenodd" class="doka--icon-turn"><rect y="9" width="12" height="12" rx="1"/><path d="M9.823 5H11a5 5 0 0 1 5 5 1 1 0 0 0 2 0 7 7 0 0 0-7-7H9.626l.747-.747A1 1 0 0 0 8.958.84L6.603 3.194a1 1 0 0 0 0 1.415l2.355 2.355a1 1 0 0 0 1.415-1.414L9.823 5z" fill-rule="nonzero" /></g>',26),action:function(){return e.dispatch("CROP_IMAGE_ROTATE_LEFT")}}),e.query("GET_CROP_ALLOW_IMAGE_TURN_RIGHT")&&n.push({view:_n,name:"tool",label:e.query("GET_LABEL_BUTTON_CROP_ROTATE_RIGHT"),icon:bn('<g transform="translate(5 2)" fill="currentColor" fill-rule="evenodd" class="doka--icon-turn"><path d="M8.177 5H7a5 5 0 0 0-5 5 1 1 0 0 1-2 0 7 7 0 0 1 7-7h1.374l-.747-.747A1 1 0 0 1 9.042.84l2.355 2.355a1 1 0 0 1 0 1.415L9.042 6.964A1 1 0 0 1 7.627 5.55l.55-.55z" fill-rule="nonzero"/><rect x="6" y="9" width="12" height="12" rx="1"/></g>',26),action:function(){return e.dispatch("CROP_IMAGE_ROTATE_RIGHT")}}),e.query("GET_CROP_ALLOW_IMAGE_FLIP_HORIZONTAL")&&n.push({view:_n,name:"tool",label:e.query("GET_LABEL_BUTTON_CROP_FLIP_HORIZONTAL"),icon:bn('<g fill="currentColor" fill-rule="evenodd"><path d="M11.93 7.007V20a1 1 0 0 1-1 1H5.78a1 1 0 0 1-.93-1.368l5.15-12.993a1 1 0 0 1 1.929.368z"/><path d="M14 7.007V20a1 1 0 0 0 1 1h5.149a1 1 0 0 0 .93-1.368l-5.15-12.993A1 1 0 0 0 14 7.007z" opacity=".6"/></g>',26),action:function(){return e.dispatch("CROP_IMAGE_FLIP_HORIZONTAL")}}),e.query("GET_CROP_ALLOW_IMAGE_FLIP_VERTICAL")&&n.push({view:_n,name:"tool",label:e.query("GET_LABEL_BUTTON_CROP_FLIP_VERTICAL"),icon:bn('<g fill="currentColor" fill-rule="evenodd"><path d="M19.993 12.143H7a1 1 0 0 1-1-1V5.994a1 1 0 0 1 1.368-.93l12.993 5.15a1 1 0 0 1-.368 1.93z"/><path d="M19.993 14a1 1 0 0 1 .368 1.93L7.368 21.078A1 1 0 0 1 6 20.148V15a1 1 0 0 1 1-1h12.993z" opacity=".6"/></g>',26),action:function(){return e.dispatch("CROP_IMAGE_FLIP_VERTICAL")}});var r=e.query("GET_CROP_ASPECT_RATIO_OPTIONS");r&&r.length&&n.push({view:gr,name:"tool",label:e.query("GET_LABEL_BUTTON_CROP_ASPECT_RATIO"),icon:bn('<g class="doka--icon-aspect-ratio" fill="currentColor" fill-rule="evenodd"><rect x="2" y="4" opacity=".3" width="10" height="18" rx="1"/><rect opacity=".5" x="4" y="8" width="14" height="14" rx="1"/><rect x="6" y="12" width="17" height="10" rx="1"/></g>',26),options:null,onSelect:function(t){t.width&&t.height?e.dispatch("RESIZE_SET_OUTPUT_SIZE",{width:t.width,height:t.height}):(e.query("GET_CROP_ASPECT_RATIO_OPTIONS").find((function(t){return t.value&&t.value.width||t.value.height}))&&e.dispatch("RESIZE_SET_OUTPUT_SIZE",{width:null,height:null}),e.dispatch("CROP_SET_ASPECT_RATIO",{value:t.aspectRatio}))},didCreateView:function(t){e.ref.aspectRatioDropdown=t}}),e.query("GET_CROP_ALLOW_TOGGLE_LIMIT")&&n.push({view:gr,name:"tool",label:e.query("GET_LABEL_BUTTON_CROP_TOGGLE_LIMIT"),icon:bn('<g class="doka--icon-crop-limit" fill="currentColor" fill-rule="evenodd">\n                    <rect x="2" y="3" width="20" height="20" rx="1"/>\n                    <rect x="7" y="8" width="10" height="10" rx="1"/>\n                    <rect x="4" y="8" width="14" height="14" rx="1"/>\n                    <rect x="12" y="4" width="10" height="10" rx="1"/>\n                </g>',26),options:[{value:!0,label:e.query("GET_LABEL_BUTTON_CROP_TOGGLE_LIMIT_ENABLE"),icon:'<svg width="23" height="23" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><g fill="currentColor"><rect x="3" y="3" width="17" height="17" rx="2.5" opacity=".3"/><rect x="7" y="7" width="9" height="9" rx="2.5"/></g></svg>'},{value:!1,label:e.query("GET_LABEL_BUTTON_CROP_TOGGLE_LIMIT_DISABLE"),icon:'<svg width="23" height="23" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false"><g fill="currentColor"><rect x="3" y="6" width="13" height="13" rx="2.5" opacity=".3"/><rect x="10" y="3" width="9" height="9" rx="2.5"/></g></svg>'}],onSelect:function(t){e.dispatch("CROP_SET_LIMIT",{value:t})},didCreateView:function(t){e.ref.cropToggleLimitDropdown=t}}),e.ref.menu=e.appendChildView(e.createChildView(fr("toolbar",["opacity"],{opacity:{type:"spring",mass:15,delay:50}}),{opacity:0,controls:n})),e.ref.menuItemsRequiredWidth=null,e.ref.subject=e.appendChildView(e.createChildView(Br,f({},i))),e.query("GET_CROP_ALLOW_ROTATE")&&(e.ref.rotator=e.appendChildView(e.createChildView(br,{rotation:0,opacity:0,translateY:20,id:i.id}))),e.ref.resizer=e.appendChildView(e.createChildView(Wr,{pivotPoint:{x:0,y:0}})),e.ref.updateControls=function(){var t,i,n=e.query("GET_IMAGE");if(t=e,i=n.height/n.width,Array.from(t.element.querySelectorAll(".doka--icon-turn rect")).forEach((function(t){i>1&&(t.setAttribute("x",t.previousElementSibling?5:4),t.setAttribute("width",9)),i<1&&(t.setAttribute("y",11),t.setAttribute("height",10))})),e.ref.cropToggleLimitDropdown&&(e.ref.isLimitedToImageBounds=e.query("GET_CROP_LIMIT_TO_IMAGE_BOUNDS"),qr(e,e.ref.isLimitedToImageBounds),e.ref.cropToggleLimitDropdown.selectedValue=e.ref.isLimitedToImageBounds),e.ref.aspectRatioDropdown){var o=e.query("GET_MIN_IMAGE_SIZE"),a=r.filter((function(t){if(!t.value.aspectRatio)return!0;if(t.value.aspectRatio<1){if(n.naturalWidth*t.value.aspectRatio<o.height)return!1}else if(n.naturalHeight/t.value.aspectRatio<o.width)return!1;return!0}));e.ref.aspectRatioDropdown.options=a.map((function(t){return f({},t,{icon:Kr(t.value.aspectRatio)})}))}},e.ref.isModal=/modal|fullscreen/.test(e.query("GET_STYLE_LAYOUT_MODE"))},read:function(t){var e=t.root,i=t.props;if(i.hidden)e.ref.menuItemsRequiredWidth=null;else{var n=e.rect;if(0!==n.element.width&&0!==n.element.height){if(null===e.ref.menuItemsRequiredWidth){var r=e.ref.menu.childViews.reduce((function(t,e){return t+e.rect.outer.width}),0);e.ref.menuItemsRequiredWidth=0===r?null:r}var o=e.ref.subject.rect.element,a=o.left,s=o.top,l=o.width,c=o.height;i.stagePosition={x:a,y:s,width:l,height:c}}}},shouldUpdateChildViews:function(t){var e=t.props,i=t.actions;return!e.hidden||e.hidden&&i&&i.length},write:J({SHOW_VIEW:function(t){var e=t.root,i=t.action,n=t.props,r=e.ref,o=r.menu,a=r.rotator,s=r.subject;n.viewId===i.id?(s.opacity=1,o.opacity=1,a&&(a.opacity=1,a.translateY=0),n.hidden=!1,e.ref.isHiding=!1,e.ref.updateControls()):(s.opacity=0,o.opacity=0,a&&(a.opacity=0,a.translateY=20),e.ref.isHiding=!0)},UNLOAD_IMAGE:function(t){var e=t.root.ref,i=e.menu,n=e.rotator;i.opacity=0,n&&(n.opacity=0,n.translateY=20)},DID_PRESENT_IMAGE:function(t){var e=t.root,i=e.ref,n=i.menu,r=i.rotator;n.opacity=1,r&&(r.opacity=1,r.translateY=0),e.ref.updateControls()}},(function(t){var e=t.root,i=t.props,n=t.timestamp,r=e.ref,o=r.resizer,a=r.subject,s=r.menu,l=r.rotator,c=r.isHiding,h=r.cropToggleLimitDropdown,u=r.aspectRatioDropdown,d=i.hidden,p=0===a.opacity&&0===s.opacity&&(!l||l&&0===l.opacity);if(!d&&c&&p&&(e.ref.isHiding=!1,i.hidden=!0),!i.hidden){var f=e.query("GET_CROP",i.id,n);if(f){if(u){var m=e.query("GET_ACTIVE_CROP_ASPECT_RATIO"),g=e.query("GET_SIZE"),v=u.selectedValue;v?(v.aspectRatio!==m&&Yr(e,m),v.aspectRatio===m&&v.width===g.width&&v.height===g.height||(u.selectedValue={aspectRatio:m,width:g.width,height:g.height})):(u.selectedValue={aspectRatio:m,width:g.width,height:g.height},Yr(e,m))}if(h&&e.ref.isLimitedToImageBounds!==f.isLimitedToImageBounds&&(e.ref.isLimitedToImageBounds=f.isLimitedToImageBounds,qr(e,f.isLimitedToImageBounds),h.selectedValue=f.isLimitedToImageBounds),o.pivotPoint={x:.5*o.rect.element.width,y:.5*o.rect.element.height},l&&(l.animate=!f.isDraft,l.rotation=f.rotation.sub,l.setAllowInteraction(e.query("IS_ACTIVE_VIEW","crop"))),s.element.dataset.layout=e.ref.menuItemsRequiredWidth>e.ref.menu.rect.element.width?"compact":"spacious",e.query("GET_CROP_RESIZE_SCROLL_RECT_ONLY")){var b=e.query("GET_STAGE"),_=b.x,y=b.y,E=e.query("GET_ROOT"),T=e.ref.isModal?E.left:0,w=e.ref.isModal?E.top:0;o.scrollRect={x:T+_+f.cropRect.x,y:w+y+f.cropRect.y+i.offsetTop,width:f.cropRect.width,height:f.cropRect.height}}}}}))}),Xr=Q({name:"size-input",mixins:{listeners:!0,apis:["id","value","placeholder","getValue","setValue","setPlaceholder","hasFocus","onChange"]},create:function(t){var e=t.root,i=t.props,n=i.id,r=i.min,o=i.max,a=i.value,s=i.placeholder,l=i.onChange,c=void 0===l?function(){}:l,h=i.onBlur,u=void 0===h?function(){}:h,d="doka--".concat(n,"-").concat(yt()),p=I("input",{type:"number",step:1,id:d,min:r,max:o,value:a,placeholder:s}),f=p.getAttribute("max").length,m=I("label",{for:d});m.textContent=i.label;var g=function(t,e,i){return ot(t)?((t=t.replace(/[^0-9]/g,"")).length>f&&(t=t.slice(0,f)),t=parseInt(t,10)):t=Math.round(t),isNaN(t)?null:Mt(t,e,i)},v=function(t){return t.length?parseInt(p.value,10):null};e.ref.handleInput=function(){p.value=g(p.value,1,o),c(v(p.value))},e.ref.handleBlur=function(){p.value=g(p.value,r,o),u(v(p.value))},p.addEventListener("input",e.ref.handleInput),p.addEventListener("blur",e.ref.handleBlur),e.appendChild(p),e.appendChild(m),e.ref.input=p,i.hasFocus=function(){return p===document.activeElement},i.getValue=function(){return v(p.value)},i.setValue=function(t){return p.value=t?g(t,1,999999):null},i.setPlaceholder=function(t){return p.placeholder=t}},destroy:function(t){var e=t.root;e.ref.input.removeEventListener("input",e.ref.handleInput),e.ref.input.removeEventListener("blur",e.ref.handleBlur)}}),Qr=Q({name:"checkable",tag:"span",mixins:{listeners:!0,apis:["id","checked","onChange","onSetValue","setValue","getValue"]},create:function(t){var e=t.root,i=t.props,n=i.id,r=i.checked,o=i.onChange,a=void 0===o?function(){}:o,s=i.onSetValue,l=void 0===s?function(){}:s,c="doka--".concat(n,"-").concat(yt()),h=I("input",{type:"checkbox",value:1,id:c});h.checked=r,e.ref.input=h;var u=I("label",{for:c});u.innerHTML=i.label,e.appendChild(h),e.appendChild(u),e.ref.handleChange=function(){l(h.checked),a(h.checked)},h.addEventListener("change",e.ref.handleChange),i.getValue=function(){return h.checked},i.setValue=function(t){h.checked=t,l(h.checked)},setTimeout((function(){l(h.checked)}),0)},destroy:function(t){var e=t.root;e.ref.input.removeEventListener("change",e.ref.handleChange)}}),Jr=null,to=Q({ignoreRect:!0,name:"resize-form",tag:"form",mixins:{styles:["opacity"],animations:{opacity:{type:"spring",mass:15,delay:150}}},create:function(t){var e=t.root;e.element.setAttribute("novalidate","novalidate"),e.element.setAttribute("action","#"),e.ref.shouldBlurKeyboard=kt()||(null===Jr&&(Jr=/Android/i.test(navigator.userAgent)),Jr);var i=e.query("GET_SIZE_MAX"),n=e.query("GET_SIZE_MIN"),r=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},r=t.axisLock,o=void 0===r?"none":r,a=t.enforceLimits,s=void 0!==a&&a,l=e.ref,c=l.inputImageWidth,h=l.inputImageHeight,u=l.buttonConfirm,d=e.query("GET_SIZE_ASPECT_RATIO_LOCK"),p=e.query("GET_CROP_RECTANGLE_ASPECT_RATIO"),f={width:c.getValue(),height:h.getValue()},m=pe(f,s?n:{width:1,height:1},s?i:{width:999999,height:999999},d?p:null,o);if(d)"width"===o?h.setValue(m.width/p):"height"===o?c.setValue(m.height*p):(c.setValue(m.width||m.height*p),h.setValue(m.height||m.width/p));else if(m.width&&!m.height){var g=Math.round(m.width/p),v=pe({width:m.width,height:g},s?n:{width:1,height:1},s?i:{width:999999,height:999999},p,o);s&&c.setValue(Math.round(v.width)),h.setPlaceholder(Math.round(v.height))}else if(m.height&&!m.width){var b=Math.round(m.height*p);c.setPlaceholder(b)}var _=e.query("GET_SIZE_INPUT"),y=_.width,E=_.height,T=P(y)?Math.round(y):null,w=P(E)?Math.round(E):null,x=c.getValue(),C=h.getValue(),R=x!==T||C!==w;return u.opacity=R?1:0,e.dispatch("KICK"),{width:c.getValue(),height:h.getValue()}},o=e;e.appendChildView(e.createChildView(eo("Image size",(function(t){var e=t.root,a=e.query("GET_SIZE"),s=e.appendChildView(e.createChildView(Xr,{id:"image-width",label:e.query("GET_LABEL_RESIZE_WIDTH"),value:P(a.width)?Math.round(a.width):null,min:n.width,max:i.width,placeholder:0,onChange:function(){return r({axisLock:"width"})},onBlur:function(){return r({enforceLimits:!1})}})),l=e.appendChildView(e.createChildView(Qr,{id:"aspect-ratio-lock",label:bn('<g fill="none" fill-rule="evenodd"><path stroke="currentColor" stroke-width="1.5" stroke-linecap="round" class="doka--aspect-ratio-lock-ring" d="M9.401 10.205v-.804a2.599 2.599 0 0 1 5.198 0V14"/><rect fill="currentColor" x="7" y="10" width="10" height="7" rx="1.5"/></g>'),checked:e.query("GET_SIZE_ASPECT_RATIO_LOCK"),onSetValue:function(t){var e=t?0:-3;l.element.querySelector(".doka--aspect-ratio-lock-ring").setAttribute("transform","translate(0 ".concat(e,")"))},onChange:function(t){e.dispatch("RESIZE_SET_OUTPUT_SIZE_ASPECT_RATIO_LOCK",{value:t}),r()}})),c=e.appendChildView(e.createChildView(Xr,{id:"image-height",label:e.query("GET_LABEL_RESIZE_HEIGHT"),value:P(a.height)?Math.round(a.height):null,min:n.height,max:i.height,placeholder:0,onChange:function(){return r({axisLock:"height"})},onBlur:function(){return r({enforceLimits:!1})}}));o.ref.aspectRatioLock=l,o.ref.inputImageWidth=s,o.ref.inputImageHeight=c})))),e.ref.buttonConfirm=e.appendChildView(e.createChildView(_n,{name:"app action-confirm icon-only",label:e.query("GET_LABEL_RESIZE_APPLY_CHANGES"),action:function(){},opacity:0,icon:bn('<polyline fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" points="20 6 9 17 4 12"></polyline>'),type:"submit"})),e.ref.confirmForm=function(t){var i=r({enforceLimits:!0});t.preventDefault();var n=e.ref,o=n.shouldBlurKeyboard,a=n.buttonConfirm;o&&(document.activeElement.blur(),a.element.focus()),a.opacity=0,e.dispatch("RESIZE_SET_OUTPUT_SIZE",i)},e.element.addEventListener("submit",e.ref.confirmForm)},destroy:function(t){var e=t.root;e.element.removeEventListener("submit",e.ref.confirmForm)},write:J({EDIT_RESET:function(t){var e=t.root,i=e.query("GET_SIZE"),n=e.ref,r=n.inputImageWidth,o=n.inputImageHeight,a=n.aspectRatioLock,s=n.buttonConfirm;r.setValue(i.width),o.setValue(i.height),a.setValue(e.query("GET_SIZE_ASPECT_RATIO_LOCK")),s.opacity=0},RESIZE_SET_OUTPUT_SIZE:function(t){var e=t.root,i=t.action,n=e.ref,r=n.inputImageWidth,o=n.inputImageHeight;r.setValue(i.width),o.setValue(i.height)},CROP_SET_ASPECT_RATIO:function(t){var e=t.root,i=t.props,n=t.action,r=t.timestamp,o=e.query("GET_CROP",i.id,r);if(o){var a=o.cropStatus,s=e.ref,l=s.inputImageWidth,c=s.inputImageHeight;null!==n.value?(l.setValue(a.image.width),l.setPlaceholder(a.crop.width),c.setValue(a.image.height),c.setPlaceholder(a.crop.height)):l.getValue()&&c.getValue()&&(c.setValue(null),c.setPlaceholder(a.crop.height))}}},(function(t){var e=t.root,i=t.props,n=t.timestamp,r=e.query("GET_CROP",i.id,n);if(r){e.opacity;var o=r.cropStatus,a=e.ref,s=a.inputImageWidth,l=a.inputImageHeight;if(!s.hasFocus()&&!l.hasFocus()){var c=e.query("GET_CROP_RECTANGLE_ASPECT_RATIO");if(null===s.getValue()&&null===l.getValue())s.setPlaceholder(o.crop.width),l.setPlaceholder(o.crop.height);else if(null===s.getValue()&&null!==o.image.height){var h=Math.round(o.image.height*c);s.setPlaceholder(h)}else if(null===l.getValue()&&null!==o.image.width){var u=Math.round(o.image.width/c);l.setPlaceholder(u)}}}}))}),eo=function(t,e){return Q({tag:"fieldset",create:function(i){var n=i.root,r=I("legend");r.textContent=t,n.element.appendChild(r),e({root:n})}})},io=Q({name:"resize",ignoreRect:!0,mixins:{apis:["viewId","stagePosition","hidden"]},create:function(t){var e=t.root,i=t.props;i.viewId="resize",i.hidden=!1,e.ref.isHiding=!1,e.ref.form=e.appendChildView(e.createChildView(to,{opacity:0,id:i.id}))},read:function(t){var e=t.root,i=t.props;if(!i.hidden){var n=e.rect;if(0!==n.element.width&&0!==n.element.height){var r=e.ref.form.rect;i.stagePosition={x:n.element.left,y:n.element.top+r.element.height,width:n.element.width,height:n.element.height-r.element.height}}}},shouldUpdateChildViews:function(t){var e=t.props,i=t.actions;return!e.hidden||e.hidden&&i&&i.length},write:J({SHOW_VIEW:function(t){var e=t.root,i=t.action,n=t.props;i.id===n.viewId?(e.ref.isHiding=!1,e.ref.form.opacity=1):(e.ref.isHiding=!0,e.ref.form.opacity=0)}},(function(t){var e=t.root,i=t.props,n=e.ref,r=n.form,o=n.isHiding,a=i.hidden;o&&0===r.opacity&&!a?i.hidden=!0:i.hidden=!1}))}),no=Q({name:"range-input",tag:"span",mixins:{listeners:!0,apis:["onUpdate","setValue","getValue","setAllowInteraction"]},create:function(t){var e=t.root,i=t.props,n=i.id,r=i.min,o=i.max,a=i.step,s=i.value,l=i.onUpdate,c=void 0===l?function(){}:l,h="doka--".concat(n,"-").concat(yt()),u=I("input",{type:"range",id:h,min:r,max:o,step:a});u.value=s,e.ref.input=u;var d=I("span");d.className="doka--range-input-inner";var p=I("label",{for:h});p.innerHTML=i.label;var f=r+.5*(o-r);e.element.dataset.centered=s===f,e.ref.handleRecenter=function(){i.setValue(f),e.ref.handleChange()};var m=I("button",{type:"button"});m.textContent="center",m.addEventListener("click",e.ref.handleRecenter),e.ref.recenter=m,d.appendChild(u),d.appendChild(m),e.appendChild(p),e.appendChild(d),e.ref.handleChange=function(){var t=i.getValue();e.element.dataset.centered=t===f,c(t)},u.addEventListener("input",e.ref.handleChange);var g=null;e.ref.dragger=Ln(d,(function(){g=u.getBoundingClientRect()}),(function(t){var i=(t.pageX-g.left)/g.width;u.value=r+i*(o-r),e.ref.handleChange()}),(function(){}),{stopPropagation:!0}),i.getValue=function(){return parseFloat(u.value)},i.setValue=function(t){return u.value=t},i.setAllowInteraction=function(t){t?e.ref.dragger.enable():e.ref.dragger.disable()}},destroy:function(t){var e=t.root;e.ref.dragger.destroy(),e.ref.recenter.removeEventListener("click",e.ref.handleRecenter),e.ref.input.removeEventListener("input",e.ref.handleChange)}}),ro={brightness:{icon:bn('<g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="7"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></g>')},contrast:{icon:bn('<g fill="none" fill-rule="evenodd"><circle stroke="currentColor" stroke-width="3" cx="12" cy="12" r="10"/><path d="M12 2v20C6.477 22 2 17.523 2 12S6.477 2 12 2z" fill="currentColor"/></g>')},exposure:{icon:bn('<g fill="none" fill-rule="evenodd"><rect stroke="currentColor" stroke-width="3" x="2" y="2" width="20" height="20" rx="4"/><path d="M20.828 3.172L3.172 20.828A3.987 3.987 0 0 1 2 18V6a4 4 0 0 1 4-4h12c1.105 0 2.105.448 2.828 1.172zM7 7H5v2h2v2h2V9h2V7H9V5H7v2zM12 15h5v2h-5z" fill="currentColor"/></g>')},saturation:{icon:bn('<g fill="none" fill-rule="evenodd"><rect stroke="currentColor" stroke-width="3" x="2" y="2" width="20" height="20" rx="4"/><path fill="currentColor" opacity=".3" d="M7 2.5h5v18.75H7z"/><path fill="currentColor" opacity=".6" d="M12 2.5h5v18.75h-5z"/><path fill="currentColor" opacity=".9" d="M17 2.5h4v18.75h-4z"/></g>')}},oo=Q({ignoreRect:!0,name:"color-form",tag:"form",mixins:{styles:["opacity"],animations:{opacity:{type:"spring",mass:15}}},create:function(t){var e=t.root;e.element.setAttribute("novalidate","novalidate");var i=e.query("GET_COLOR_VALUES");e.ref.tools=Object.keys(ro).reduce((function(t,n){var r=n,o=ro[n].icon,a=e.query("GET_LABEL_COLOR_".concat(n.toUpperCase())),s=e.query("GET_COLOR_".concat(n.toUpperCase(),"_RANGE")),l=i[n];return t[r]={view:e.appendChildView(e.createChildView(no,{id:r,label:"".concat(o,"<span>").concat(a,"</span>"),min:s[0],max:s[1],step:.01,value:l,onUpdate:function(t){return e.dispatch("COLOR_SET_COLOR_VALUE",{key:r,value:t})}}))},t}),{})},write:J({COLOR_SET_VALUE:function(t){var e=t.root,i=t.action;e.ref.tools[i.key].view.setValue(i.value)},SHOW_VIEW:function(t){var e=t.root,i=t.action;Object.keys(e.ref.tools).forEach((function(t){e.ref.tools[t].view.setAllowInteraction("color"===i.id)}))}})}),ao=null,so=null,lo=function(t,e){var i=e.brightness,n=e.exposure,r=e.contrast,o=e.saturation;if(0!==i){var a=i<0,s=a?"multiply":"overlay",l=a?0:255,c=a?Math.abs(i):1-i;t.ref.imageOverlay.style.cssText="mix-blend-mode: ".concat(s,"; background: rgba(").concat(l,",").concat(l,",").concat(l,",").concat(c,")")}return t.ref.imageOverlay.style.cssText="background:transparent",t.ref.image.style.cssText="filter: brightness(".concat(n,") contrast(").concat(r,") saturate(").concat(o,")"),e},co=Object.keys(ro),ho=function(t){return Q({ignoreRect:!0,tag:"li",name:"filter-tile",mixins:{styles:["opacity","translateY"],animations:{translateY:{type:"spring",delay:10*t},opacity:{type:"spring",delay:30*t}}},create:function(t){var e=t.root,i=t.props,n="doka--filter-".concat(i.style,"-").concat(yt()),r=I("input",{id:n,type:"radio",name:"filter"});e.appendChild(r),r.checked=i.selected,r.value=i.style,r.addEventListener("change",(function(){r.checked&&i.onSelect()}));var o=I("label",{for:n});o.textContent=i.label,e.appendChild(o);var a=i.imageData,s=Math.min(a.width,a.height),l=s,c=I("canvas");c.width=s,c.height=l;var h=c.getContext("2d");e.ref.image=c;var u=I("div");e.ref.imageOverlay=u;var d={x:.5*s-.5*a.width,y:.5*l-.5*a.height},p=I("div");p.appendChild(c),p.appendChild(u),e.appendChild(p),e.ref.imageWrapper=p,i.matrix?(ao||(ao=ci(oi)),clearTimeout(so),ao.post({transforms:[{type:"filter",data:i.matrix}],imageData:a},(function(t){h.putImageData(t,d.x,d.y),clearTimeout(so),so=setTimeout((function(){ao.terminate(),ao=null}),1e3)}),[a.data.buffer]),e.ref.activeColors=lo(e,e.query("GET_COLOR_VALUES"))):h.putImageData(a,d.x,d.y)},write:function(t){var e=t.root;if(!(e.opacity<=0)){var i=e.query("GET_COLOR_VALUES"),n=e.ref.activeColors;(!n&&i||!function(t,e){return co.findIndex((function(i){return t[i]!==e[i]}))<0}(n,i))&&(e.ref.activeColors=i,lo(e,i))}}})},uo=function(t){var e;try{e=new ImageData(t.width,t.height)}catch(i){e=document.createElement("canvas").getContext("2d").createImageData(t.width,t.height)}return e.data.set(new Uint8ClampedArray(t.data)),e},po=function(t,e){return Array.isArray(t)&&Array.isArray(e)&&t.length===e.length&&t.every((function(t,i){return t===e[i]}))},fo=Q({ignoreRect:!0,tag:"ul",name:"filter-list",mixins:{apis:["filterOpacity","hidden"]},create:function(t){var e=t.root,i=t.props;e.element.setAttribute("role","list"),e.ref.tiles=[];var n=e.query("GET_THUMB_IMAGE_DATA"),r=e.query("GET_FILTERS"),o=[];w(r,(function(t,e){o.push(f({id:t},e))})),e.ref.activeFilter=e.query("GET_FILTER"),e.ref.tiles=o.map((function(t,r){var o=t.matrix(),a=e.ref.activeFilter===t.id||po(e.ref.activeFilter,o)||0===r;return e.appendChildView(e.createChildView(ho(r),{opacity:0,translateY:-5,id:i.id,style:t.id,label:t.label,matrix:o,imageData:uo(n),selected:a,onSelect:function(){return e.dispatch("FILTER_SET_FILTER",{value:o?t.id:null})}}))}))},write:function(t){var e=t.root,i=t.props;if(!i.hidden){var n=e.query("GET_FILTER");if(n!==e.ref.activeFilter){e.ref.activeFilter=n;var r=e.query("GET_FILTERS"),o=n?ot(n)?n:Fi(n)?Object.keys(r).find((function(t){return po(r[t].matrix(),n)})):null:"original";Array.from(e.element.querySelectorAll("input")).forEach((function(t){return t.checked=t.value===o}))}e.query("IS_ACTIVE_VIEW","filter")?e.ref.tiles.forEach((function(t){t.opacity=1,t.translateY=0})):e.ref.tiles.forEach((function(t){t.opacity=0,t.translateY=-5})),i.filterOpacity=e.ref.tiles.reduce((function(t,e){return t+e.opacity}),0)/e.ref.tiles.length}}}),mo=Q({name:"filter-scroller",ignoreRect:!0,ignoreRectUpdate:!0,mixins:{styles:["opacity"],animations:{opacity:{type:"spring"}},apis:["hidden","filterOpacity"]},create:function(t){var e,i=t.root,n=t.props;i.ref.filters=i.appendChildView(i.createChildView(fo,{id:n.id})),i.element.isScrollContainer=!0,Dr()&&(i.ref.handleMouseWheel=function(t){var e=i.element.scrollLeft,n=i.ref.scrollWidth-i.rect.element.width,r=e+t.deltaX;(r<0||r>n)&&(i.element.scrollLeft=Math.min(Math.max(r,0),n),t.preventDefault())},i.element.addEventListener("mousewheel",i.ref.handleMouseWheel),i.element.dataset.dragState="end",i.ref.dragger=Ln(i.ref.filters.element,(function(){i.element.dataset.dragState="start",e=i.element.scrollLeft}),(function(t,n){i.element.scrollLeft=e-n.x,Bt({x:0,y:0},n)>0&&(i.element.dataset.dragState="dragging")}),(function(){i.element.dataset.dragState="end"}),{stopPropagation:!0}))},destroy:function(t){var e=t.root;e.ref.handleMouseWheel&&e.element.removeEventListener("mousewheel",e.ref.handleMouseWheel),e.ref.dragger&&e.ref.dragger.destroy()},read:function(t){var e=t.root;e.ref.scrollWidth=e.element.scrollWidth},write:function(t){var e=t.root,i=t.props;e.ref.filters.hidden=i.hidden,i.filterOpacity=e.ref.filters.filterOpacity}}),go=Q({name:"filter",ignoreRect:!0,mixins:{apis:["viewId","stagePosition","hidden"]},create:function(t){var e=t.root,i=t.props;i.viewId="filter",i.hidden=!1,e.ref.isHiding=!1,e.ref.filters=e.appendChildView(e.createChildView(mo,{id:i.id}))},read:function(t){var e=t.root,i=t.props;if(e.ref.filters&&!i.hidden){var n=e.rect;if(0!==n.element.width&&0!==n.element.height){var r=e.ref.filters.rect,o=0===r.element.top,a=o?n.element.top+r.element.height+r.element.marginBottom:n.element.top,s=o?n.element.height-r.element.height-r.element.marginBottom:n.element.height-r.element.height-n.element.top;i.stagePosition={x:n.element.left,y:a,width:n.element.width,height:s}}}},shouldUpdateChildViews:function(t){var e=t.props,i=t.actions;return!e.hidden||e.hidden&&i&&i.length},write:J({SHOW_VIEW:function(t){var e=t.root,i=t.action,n=t.props;e.ref.filters&&(i.id===n.viewId?(e.ref.isHiding=!1,n.hidden=!1,e.ref.filters.hidden=!1):e.ref.isHiding=!0)}},(function(t){var e=t.root,i=t.props;e.ref.filters.opacity=e.ref.isHiding||e.ref.filters.hidden?0:1,e.ref.isHiding&&e.ref.filters.filterOpacity<=0&&(e.ref.isHiding=!1,i.hidden=!0,e.ref.filters.hidden=!0)}))}),vo=Q({name:"color",ignoreRect:!0,mixins:{apis:["viewId","stagePosition","hidden"]},create:function(t){var e=t.root,i=t.props;i.viewId="color",i.hidden=!1,e.ref.isHiding=!1,e.ref.form=e.appendChildView(e.createChildView(oo,{opacity:0,id:i.id}))},read:function(t){var e=t.root,i=t.props;if(!i.hidden){var n=e.rect;if(0!==n.element.width&&0!==n.element.height){var r=e.ref.form.rect,o=r.element.height,a=0===r.element.top,s=a?n.element.top+o:n.element.top,l=a?n.element.height-o:n.element.height-o-n.element.top;i.stagePosition={x:n.element.left,y:s,width:n.element.width,height:l}}}},shouldUpdateChildViews:function(t){var e=t.props,i=t.actions;return!e.hidden||e.hidden&&i&&i.length},write:J({SHOW_VIEW:function(t){var e=t.root,i=t.action,n=t.props;i.id===n.viewId?(e.ref.isHiding=!1,e.ref.form.opacity=1,n.hidden=!1):(e.ref.isHiding=!0,e.ref.form.opacity=0)}},(function(t){var e=t.root,i=t.props;e.ref.isHiding&&0===e.ref.form.opacity&&(e.ref.isHiding=!1,i.hidden=!0)}))}),bo=function(t,e,i){var n,r=Math.max(t,e,i),o=Math.min(t,e,i),a=r-o,s=0===r?0:a/r,l=r/255;switch(r){case o:n=0;break;case t:n=e-i+a*(e<i?6:0),n/=6*a;break;case e:n=i-t+2*a,n/=6*a;break;case i:n=t-e+4*a,n/=6*a}return[n,s,l]},_o=Q({ignoreRect:!0,tag:"div",name:"markup-color",mixins:{animations:{opacity:"spring"},styles:["opacity"],apis:["onSelect","selectedValue"]},create:function(t){var e=t.root,i=t.props,n=i.colors,r=i.name,o=i.onSelect;e.ref.handleChange=function(t){o(t.target.value),t.stopPropagation()},e.element.addEventListener("change",e.ref.handleChange);var a=I("ul");if(e.ref.inputs=n.map((function(t){var e="doka--color-"+yt(),i=I("li"),n=I("input",{id:e,name:r,type:"radio",value:t[1]}),o=I("label",{for:e,title:t[0],style:"background-color: "+(t[2]||t[1])});return o.textContent=t[0],k(i)(n),k(i)(o),k(a)(i),n})),e.element.appendChild(a),e.query("GET_MARKUP_ALLOW_CUSTOM_COLOR")&&function(){try{var t=I("input",{type:"color"}),e="color"===t.type;return/^((?!chrome|android).)*safari/i.test(navigator.userAgent)?e:e&&"number"!=typeof t.selectionStart}catch(t){return!1}}()){var s=I("div",{class:"doka--color-input"}),l="doka--color-"+yt(),c=I("label",{for:l});c.textContent="Choose color";var h=I("input",{id:l,name:r,type:"color"}),u=I("span",{class:"doka--color-visualizer"}),d=I("span",{class:"doka--color-brightness"});e.ref.handleCustomColorChange=function(){var t=fe(h.value),e=bo.apply(void 0,v(t)),i=360*e[0]-90,n=.625*e[1],r=1-e[2];u.style.backgroundColor=h.value,u.style.transform="rotateZ(".concat(i,"deg) translateX(").concat(n,"em)"),d.style.opacity=r,o(h.value)};var p=!0;e.ref.handleCustomColorSelect=function(t){p?o(t.target.value):e.ref.handleCustomColorChange(),p=!1},h.addEventListener("click",e.ref.handleCustomColorSelect),h.addEventListener("input",e.ref.handleCustomColorChange),k(s)(h),k(s)(c),k(s)(u),k(s)(d),e.appendChild(s),e.ref.customInput=h}},write:function(t){var e=t.root,i=t.props;if(i.selectedValue!==e.ref.activeSelectedValue){e.ref.activeSelectedValue=i.selectedValue;var n=!1;if(e.ref.inputs.forEach((function(t){t.checked=t.value===i.selectedValue,t.checked&&(n=!0)})),!e.ref.customInput)return;e.ref.customInput.dataset.selected=e.ref.inputs.length&&!n,n||(e.ref.customInput.value=i.selectedValue,e.ref.handleCustomColorChange())}},destroy:function(t){var e=t.root;e.element.removeEventListener("change",e.ref.handleChange),e.ref.customInput&&(e.ref.customInput.removeEventListener("click",e.ref.handleCustomColorSelect),e.ref.customInput.removeEventListener("input",e.ref.handleCustomColorChange))}}),yo=function(t){var e=t.ref,i=e.colorSelect,n=e.fontFamilySelect,r=e.fontSizeSelect,o=e.shapeStyleSelect,a=e.lineStyleSelect;[n,r,o,e.lineDecorationSelect].forEach((function(t){t.element.dataset.active="false"})),[i,a].forEach((function(t){t.element.dataset.active="true"}))},Eo=["fontFamily","fontSize","fontWeight","textAlign","backgroundColor","fontColor","borderColor","borderWidth","borderStyle","lineColor","lineWidth","lineDecoration","lineJoin","lineCap"],To=function(t){return'<svg width="23" height="23" xmlns="http://www.w3.org/2000/svg" aria-hidden="true" focusable="false">'.concat(t,"</svg>")},wo=function(t){var e=0===t?"currentColor":"none",i=t;return To('<rect stroke="'.concat(0===t?"none":"currentColor",'" fill="').concat(e,'" stroke-width="').concat(i,'" x="2" y="3" width="17" height="17" rx="3"/>'))},xo=function(t){return To('<line stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" stroke-width="'.concat(t,'" x1="3" y1="12" x2="20" y2="12"/>'))},Co=Q({name:"markup-tools",ignoreRect:!0,mixins:{apis:["onUpdate"],animations:{translateY:"spring",opacity:"spring"},styles:["translateY","opacity"]},create:function(t){var e=t.root,i=t.props.onUpdate;e.ref.colorSelect=e.appendChildView(e.createChildView(_o,{onSelect:function(t){e.ref.colorSelect.selectedValue=t,i("color",t)},name:"color-select",colors:e.query("GET_MARKUP_COLOR_OPTIONS")})),e.ref.shapeStyleSelect=e.appendChildView(e.createChildView(gr,{onSelect:function(t){e.ref.shapeStyleSelect.selectedValue=t,i("shapeStyle",[t[1],t[2]])},name:"tool",label:e.query("GET_LABEL_MARKUP_SELECT_SHAPE_STYLE"),direction:"up",options:e.query("GET_MARKUP_SHAPE_STYLE_OPTIONS").map((function(t){return{value:t,label:t[0],icon:wo(t[3])}}))})),e.ref.lineStyleSelect=e.appendChildView(e.createChildView(gr,{onSelect:function(t){e.ref.lineStyleSelect.selectedValue=t,i("lineStyle",[t[1],t[2]])},name:"tool",label:e.query("GET_LABEL_MARKUP_SELECT_LINE_STYLE"),direction:"up",options:e.query("GET_MARKUP_LINE_STYLE_OPTIONS").map((function(t){return{value:t,label:t[0],icon:xo(t[3])}}))})),e.ref.lineDecorationSelect=e.appendChildView(e.createChildView(gr,{onSelect:function(t){e.ref.lineDecorationSelect.selectedValue=t,i("lineDecoration",t)},name:"tool",label:e.query("GET_LABEL_MARKUP_SELECT_LINE_DECORATION"),direction:"up",options:e.query("GET_MARKUP_LINE_DECORATION_OPTIONS").map((function(t){return{value:t[1],label:t[0]}}))})),e.ref.fontFamilySelect=e.appendChildView(e.createChildView(gr,{onSelect:function(t){e.ref.fontFamilySelect.selectedValue=t,i("fontFamily",t)},name:"tool",label:e.query("GET_LABEL_MARKUP_SELECT_FONT_FAMILY"),direction:"up",options:e.query("GET_MARKUP_FONT_FAMILY_OPTIONS").map((function(t){return{value:t[1],label:'<span style="font-family:'.concat(t[1],';font-weight:600;">').concat(t[0],"</span>")}}))})),e.ref.fontSizeSelect=e.appendChildView(e.createChildView(gr,{onSelect:function(t){e.ref.fontSizeSelect.selectedValue=t,i("fontSize",t)},name:"tool",label:e.query("GET_LABEL_MARKUP_SELECT_FONT_SIZE"),direction:"up",options:e.query("GET_MARKUP_FONT_SIZE_OPTIONS").map((function(t){return{value:t[1],label:t[0]}}))})),"draw"===e.query("GET_MARKUP_UTIL")&&yo(e)},write:J({SWITCH_MARKUP_UTIL:function(t){var e=t.root;"draw"===t.action.util&&yo(e)},MARKUP_SELECT:function(t){var e=t.root,i=t.action,n=e.ref,r=n.colorSelect,o=n.fontFamilySelect,a=n.fontSizeSelect,s=n.shapeStyleSelect,l=n.lineStyleSelect,c=n.lineDecorationSelect,h=i.id?e.query("GET_MARKUP_BY_ID",i.id):null,u=[r,o,a,s,l,c],d=[];if(h){var p=g(h,2),f=p[0],m=p[1],v=Array.isArray(m.allowEdit)?m.allowEdit:!1===m.allowEdit?[]:Eo,b=Eo.reduce((function(t,e){return t[e]=-1!==v.indexOf(e),t}),{});if(b.color=!!v.find((function(t){return/[a-z]Color/.test(t)})),"image"!==f&&b.color&&(r.selectedValue=Ro(m),d.push(r)),"text"===f&&(b.fontFamily&&(o.selectedValue=m.fontFamily,d.push(o)),b.fontSize&&(a.selectedValue=m.fontSize,d.push(a))),("rect"===f||"ellipse"===f)&&b.borderStyle){var _=e.query("GET_MARKUP_SHAPE_STYLE_OPTIONS").find((function(t){var e=m.borderWidth===t[1],i=m.borderStyle===t[2]||po(m.borderStyle,t[2]);return e&&i}));s.selectedValue=_,d.push(s)}if("line"===f||"path"===f){if(b.lineWidth){var y=e.query("GET_MARKUP_LINE_STYLE_OPTIONS").find((function(t){var e=m.lineWidth===t[1],i=m.lineStyle===t[2]||po(m.lineStyle,t[2]);return e&&i}));l.selectedValue=y,d.push(l)}"line"===f&&b.lineDecoration&&(c.selectedValue=m.lineDecoration,d.push(c))}u.forEach((function(t){t.element.dataset.active="false"})),d.forEach((function(t){t.element.dataset.active="true"}))}},MARKUP_UPDATE:function(t){var e=t.root,i=t.action,n=i.style,r=i.value;e.ref[n+"Select"]&&(e.ref[n+"Select"].selectedValue=r)}})}),Ro=function(t){var e=t.fontColor,i=t.backgroundColor,n=t.lineColor,r=t.borderColor;return e||i||n||r},Ao=Q({name:"markup",ignoreRect:!0,mixins:{apis:["viewId","stagePosition","hidden"]},create:function(t){var e=t.root,i=t.props;i.viewId="markup",i.hidden=!1,e.ref.isHiding=!1;var n=[["select",{label:e.query("GET_LABEL_MARKUP_TOOL_SELECT"),icon:bn('<g fill="none" fill-rule="evenodd"><path d="M7 13H5a1 1 0 01-1-1V5a1 1 0 011-1h7a1 1 0 011 1v2" stroke="currentColor" stroke-width="2" stroke-linecap="round"/><path d="M10.22 8.914l12.58 5.18a1 1 0 01.012 1.844l-4.444 1.904a1 1 0 00-.526.526l-1.904 4.444a1 1 0 01-1.844-.013l-5.18-12.58a1 1 0 011.305-1.305z" fill="currentColor"/></g>',26)}],["draw",{label:e.query("GET_LABEL_MARKUP_TOOL_DRAW"),icon:bn('<g fill="currentColor"><path d="M17.86 5.71a2.425 2.425 0 013.43 3.43L9.715 20.714 5 22l1.286-4.715L17.86 5.71z"/></g>',26)}],["line",{label:e.query("GET_LABEL_MARKUP_TOOL_LINE"),icon:bn('<g transform="translate(3 4.5)" fill-rule="nonzero" fill="currentColor" stroke="none"><path d="M15.414 9.414l-6.01 6.01a2 2 0 1 1-2.829-2.828L9.172 10H2a2 2 0 1 1 0-4h7.172L6.575 3.404A2 2 0 1 1 9.404.575l6.01 6.01c.362.363.586.863.586 1.415s-.224 1.052-.586 1.414z"/></g>',26)}],["text",{label:e.query("GET_LABEL_MARKUP_TOOL_TEXT"),icon:bn('<g transform="translate(5 5)" fill="currentColor" fill-rule="evenodd"><path d="M10 4v11a1 1 0 0 1-1 1H7a1 1 0 0 1-1-1V4H1a1 1 0 0 1-1-1V1a1 1 0 0 1 1-1h14a1 1 0 0 1 1 1v2a1 1 0 0 1-1 1h-5z"/></g>',26)}],["rect",{label:e.query("GET_LABEL_MARKUP_TOOL_RECT"),icon:bn('<g fill="currentColor"><rect x="5" y="5" width="16" height="16" rx="2"/></g>',26)}],["ellipse",{label:e.query("GET_LABEL_MARKUP_TOOL_ELLIPSE"),icon:bn('<g fill="currentColor"><circle cx="13" cy="13" r="9"/></g>',26)}]];e.ref.utils=I("fieldset"),e.ref.utils.className="doka--markup-utils",e.ref.utilsList=I("ul");var r="markup-utils-".concat(yt());e.ref.inputs=n.map((function(t){var i=t[0],n=t[1],o="doka--markup-tool-"+yt(),a=I("li"),s=I("input");s.id=o,s.checked=e.query("GET_MARKUP_UTIL")===i,s.setAttribute("type","radio"),s.setAttribute("name",r),s.value=i;var l=I("label");return l.setAttribute("for",o),l.className="doka--button-tool",l.innerHTML=n.icon+"<span>"+n.label+"</span>",l.title=n.label,a.appendChild(s),a.appendChild(l),e.ref.utilsList.appendChild(a),s})),e.ref.utils.appendChild(e.ref.utilsList),e.ref.utilsList.addEventListener("change",(function(t){e.dispatch("SET_MARKUP_UTIL",{value:t.target.value})})),e.query("GET_MARKUP_ALLOW_ADD_MARKUP")&&(e.ref.menu=e.appendChildView(e.createChildView(fr("toolbar",["opacity"],{opacity:{type:"spring",mass:15,delay:50}}),{opacity:0,element:e.ref.utils})));var o=e.ref.tools=e.appendChildView(e.createChildView(Co,{opacity:0,onUpdate:function(t,i){e.dispatch("MARKUP_UPDATE",{style:t,value:i})}}));e.ref.menuItemsRequiredWidth=null,"draw"===e.query("GET_MARKUP_UTIL")&&(o.opacity=1,o.translateY=0,o.element.dataset.active="true")},read:function(t){var e=t.root,i=t.props;if(i.hidden)e.ref.menuItemsRequiredWidth=null;else{var n=e.rect;if(0!==n.element.width&&0!==n.element.height){if(e.ref.menu&&null===e.ref.menuItemsRequiredWidth){var r=e.ref.menu.rect.element.width;e.ref.menuItemsRequiredWidth=0===r?null:r}var o=e.ref.menu&&e.ref.menu.rect,a=e.ref.tools.rect.element.height,s=o?o.element.height:a,l=!o||0===o.element.top,c=l?n.element.top+s:n.element.top,h=l?n.element.height-s:n.element.height-s-n.element.top;i.stagePosition={x:n.element.left+20,y:c,width:n.element.width-40,height:h-a}}}},shouldUpdateChildViews:function(t){var e=t.props,i=t.actions;return!e.hidden||e.hidden&&i&&i.length},write:J({SHOW_VIEW:function(t){var e=t.root,i=t.action,n=t.props;i.id===n.viewId?(n.hidden=!1,e.ref.isHiding=!1,e.ref.menu&&(e.ref.menu.opacity=1)):(e.ref.isHiding=!0,e.ref.menu&&(e.ref.menu.opacity=0),e.ref.tools.opacity=0,e.ref.tools.translateY=5)},MARKUP_SELECT:function(t){var e=t.root,i=t.action;e.ref.tools.opacity=i.id?1:0,e.ref.tools.translateY=i.id?0:5,e.ref.tools.element.dataset.active=i.id?"true":"false"},DID_SET_MARKUP_UTIL:function(t){var e=t.root,i=t.action,n=e.ref,r=n.inputs,o=n.tools;r.forEach((function(t){t.checked=t.value===i.value})),"draw"===i.value&&(o.opacity=1,o.translateY=0,o.element.dataset.active="true")}},(function(t){var e=t.root,i=t.props;e.ref.isHiding&&e.ref.menu&&0===e.ref.menu.opacity&&(e.ref.isHiding=!1,i.hidden=!0),i.hidden||(e.ref.menu.element.dataset.layout=e.ref.menuItemsRequiredWidth>e.rect.element.width?"compact":"spacious")}))}),So={crop:Zr,resize:io,filter:go,color:vo,markup:Ao},Io=Q({name:"view-stack",ignoreRect:!0,mixins:{apis:["offsetTop"]},create:function(t){var e=t.root;e.ref.activeView=null,e.ref.activeStagePosition=null,e.ref.shouldFocus=!1},write:J({SHOW_VIEW:function(t){var e=t.root,i=t.props,n=t.action,r=0===e.childViews.length,o=e.childViews.find((function(t){return t.viewId===n.id}));o||(o=e.appendChildView(e.createChildView(So[n.id],f({},i)))),e.ref.activeView=o,e.childViews.map((function(t){return t.element})).forEach((function(t){t.dataset.viewActive="false",t.removeAttribute("tabindex"),ji()&&(t.style.transform="")}));var a=e.ref.activeView.element;a.dataset.viewActive="true",a.setAttribute("tabindex",-1),ji()&&setTimeout((function(){a.style.transform="translateZ(0)"}),32),e.ref.shouldFocus=!r},DID_PRESENT_IMAGE:function(t){var e=t.root;e.dispatch("CHANGE_VIEW",{id:e.query("GET_UTIL")||e.query("GET_UTILS")[0]})},DID_SET_UTILS:function(t){var e=t.root;e.dispatch("CHANGE_VIEW",{id:e.query("GET_UTIL")||e.query("GET_UTILS")[0]})}},(function(t){var e=t.root,i=t.props,n=e.ref,r=n.activeView,o=n.previousStagePosition;if(r&&r.stagePosition&&(e.childViews.forEach((function(t){t.offsetTop=i.offsetTop,t.element.viewHidden!==t.hidden&&(t.element.viewHidden=t.hidden,t.element.dataset.viewHidden=t.hidden)})),function(t,e){return!t||!e||!Ht(t,e)}(r.stagePosition,o))){var a=r.stagePosition,s=a.x,l=a.y,c=a.width,h=a.height;if(0===c&&0===h)return;e.dispatch("DID_RESIZE_STAGE",{offset:{x:s,y:l},size:{width:c,height:h},animate:!0}),e.ref.previousStagePosition=r.stagePosition}})),didWriteView:function(t){var e=t.root;e.ref.shouldFocus&&(e.ref.activeView.element.focus({preventScroll:!0}),e.ref.shouldFocus=!1)}}),ko=Q({name:"content",ignoreRect:!0,mixins:{styles:["opacity"],animations:{opacity:{type:"tween",duration:250}}},create:function(t){var e=t.root,i=t.props;e.opacity=1,e.ref.viewStack=e.appendChildView(e.createChildView(Io,{id:i.id})),e.ref.image=null},write:J({DID_LOAD_IMAGE:function(t){var e=t.root,i=t.props;e.ref.image=e.appendChildView(e.createChildView(pr,{id:i.id}))}},(function(t){var e=t.root,i=e.ref,n=i.image,r=i.viewStack;if(n){var o=e.rect.element.top;r.offsetTop=o,n.offsetTop=o}}))}),$o=Q({name:"utils",create:function(t){var e=t.root,i={crop:{title:e.query("GET_LABEL_BUTTON_UTIL_CROP"),icon:bn('<g fill="none" fill-rule="evenodd" stroke-linecap="round" stroke-linejoin="round" stroke="currentColor" stroke-width="2"><path d="M23 17H9a2 2 0 0 1-2-2v-5m0-3V1"/><path d="M1 7h14a2 2 0 0 1 2 2v7m0 4v3"/></g>')},filter:{title:e.query("GET_LABEL_BUTTON_UTIL_FILTER"),icon:bn('<g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18.347 9.907a6.5 6.5 0 1 0-1.872 3.306M3.26 11.574a6.5 6.5 0 1 0 2.815-1.417"/><path d="M10.15 17.897A6.503 6.503 0 0 0 16.5 23a6.5 6.5 0 1 0-6.183-8.51"/></g>')},color:{title:e.query("GET_LABEL_BUTTON_UTIL_COLOR"),icon:bn('<g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 1v5.5m0 3.503V23M12 1v10.5m0 3.5v8M20 1v15.5m0 3.5v3M2 7h4M10 12h4M18 17h4"/></g>')},markup:{title:e.query("GET_LABEL_BUTTON_UTIL_MARKUP"),icon:bn('<g fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M17.086 2.914a2.828 2.828 0 1 1 4 4l-14.5 14.5-5.5 1.5 1.5-5.5 14.5-14.5z"/></g>')},resize:{title:e.query("GET_LABEL_BUTTON_UTIL_RESIZE"),icon:bn('<g fill="none" fill-rule="evenodd" stroke-width="2" stroke="currentColor" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="12" width="10" height="10" rx="2"/><path d="M4 11.5V4a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v14a2 2 0 0 1-2 2h-5.5"/><path d="M14 10l3.365-3.365M14 6h4v4" class="doka--icon-resize-arrow-ne"/><path d="M14 10l3.365-3.365M14 6v4h4" class="doka--icon-resize-arrow-sw"/></g>')}};e.ref.utils=Object.keys(i).map((function(t){return f({id:t},i[t])})),e.ref.utilMenuRequiredWidth=null},read:function(t){var e=t.root;if(null===e.ref.utilMenuRequiredWidth){var i=e.childViews.reduce((function(t,e){return t+e.rect.outer.width}),0);e.ref.utilMenuRequiredWidth=0===i?null:i}},write:J({DID_SET_UTILS:function(t){var e=t.root,i=v(e.query("GET_UTILS"));e.childViews.forEach((function(t){return e.removeChildView(t)})),e.element.dataset.utilCount=i.length,1===i.length&&(i.length=0),i.forEach((function(t){var i=e.ref.utils.find((function(e){return e.id===t})),n=e.appendChildView(e.createChildView(_n,{name:"tab",view:_n,label:i.title,opacity:1,icon:i.icon,id:i.id,action:function(){return e.dispatch("CHANGE_VIEW",{id:i.id})}}));e.ref["util_button_".concat(i.id)]=n}))},SHOW_VIEW:function(t){var e=t.root,i=t.action;e.childViews.forEach((function(t){t.element.dataset.active=t.id===i.id}))}},(function(t){var e=t.root,i=t.props,n=t.timestamp,r=e.query("GET_CROP",i.id,n);if(r){var o=r.cropStatus;e.ref.util_button_resize&&function(t,e){t.element.dataset.scaleDirection=null===e||e>1?"up":"down"}(e.ref.util_button_resize,o.image.width?o.image.width/o.crop.width:null),e.element.dataset.layout=e.ref.utilMenuRequiredWidth>e.rect.element.width?"compact":"spacious"}}))}),Oo=Z()&&function(){try{var t={antialias:!1,alpha:!1},e=document.createElement("canvas");return!!window.WebGLRenderingContext&&(e.getContext("webgl",t)||e.getContext("experimental-webgl",t))}catch(t){return!1}}(),Lo=Q({name:"container",create:function(t){var e=t.root,i=[];e.query("GET_ALLOW_BUTTON_RESET")&&i.push({view:_n,opacity:0,label:e.query("GET_LABEL_BUTTON_RESET"),didCreateView:function(t){return e.ref.btnReset=t},name:"app action-reset icon-only",icon:bn('<g fill="currentColor" fill-rule="nonzero"><path d="M6.036 13.418L4.49 11.872A.938.938 0 1 0 3.163 13.2l2.21 2.209a.938.938 0 0 0 1.326 0l2.209-2.21a.938.938 0 0 0-1.327-1.326l-1.545 1.546zM12 10.216a1 1 0 0 1 2 0V13a1 1 0 0 1-2 0v-2.784z"/><path d="M15.707 14.293a1 1 0 0 1-1.414 1.414l-2-2a1 1 0 0 1 1.414-1.414l2 2z"/><path d="M8.084 19.312a1 1 0 0 1 1.23-1.577 6 6 0 1 0-2.185-3.488 1 1 0 0 1-1.956.412 8 8 0 1 1 2.912 4.653z"/></g>',26),action:function(){return e.dispatch("EDIT_RESET")}}),e.query("GET_ALLOW_BUTTON_CANCEL")&&i.unshift({view:_n,label:e.query("GET_LABEL_BUTTON_CANCEL"),name:"app action-cancel icon-fallback",opacity:1,icon:bn('<g fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M18 6L6 18M6 6l12 12"/></g>'),didCreateView:function(t){e.ref.btnCancel=t},action:function(){e.dispatch("EDIT_CANCEL")}}),i.push({view:$o}),e.query("GET_ALLOW_BUTTON_CONFIRM")&&i.push({view:_n,label:e.query("GET_LABEL_BUTTON_CONFIRM"),name:"app action-confirm icon-fallback",opacity:1,icon:bn('<polyline fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round" points="20 6 9 17 4 12"></polyline>'),didCreateView:function(t){e.ref.btnConfirm=t},action:function(){e.dispatch("EDIT_CONFIRM")}}),e.ref.menu=e.appendChildView(e.createChildView(fr("menu"),{controls:i})),e.ref.menu.opacity=0,e.ref.status=e.appendChildView(e.createChildView(An)),e.ref.hasWebGL=Oo,e.ref.hasWebGL?e.dispatch("AWAIT_IMAGE"):e.dispatch("MISSING_WEBGL"),e.ref.handleFocusOut=function(t){if(t.relatedTarget&&On(e.element,t.relatedTarget)){var i=e.ref.status;"busy"===i.element.dataset.viewStatus&&i.element.focus()}},e.ref.handleFocusIn=function(t){var i=e.ref,n=i.menu,r=i.content,o=t.target;if(!n.element.contains(o)&&r&&r.element.contains(o)){if(!Array.from(e.element.querySelectorAll("[data-view-active=false]")).reduce((function(t,e){return e.contains(o)&&(t=!0),t}),!1))return;n.element.querySelector("button,input,[tabindex]").focus()}},e.element.addEventListener("focusin",e.ref.handleFocusIn),e.element.addEventListener("focusout",e.ref.handleFocusOut),e.ref.previousState=null},destroy:function(t){var e=t.root;e.element.removeEventListener("focusin",e.ref.handleFocusIn),e.element.removeEventListener("focusout",e.ref.handleFocusOut)},write:J({UNLOAD_IMAGE:function(t){var e=t.root;e.ref.content&&(e.ref.content.opacity=0,e.ref.menu.opacity=0)},DID_UNLOAD_IMAGE:function(t){var e=t.root;e.removeChildView(e.ref.content),e.ref.content=null},DID_LOAD_IMAGE:function(t){var e=t.root,i=t.props;e.ref.hasWebGL&&(e.ref.content=e.appendChildView(e.createChildView(ko,{opacity:null,id:i.id})),e.ref.menu.opacity=1)},SHOW_VIEW:function(t){var e=t.root,i=t.action;e.element.dataset.limitOverflow="resize"===i.id}},(function(t){var e=t.root,i=t.props,n=t.timestamp,r=e.query("GET_CROP",i.id,n);if(r){var o=r.cropStatus,a=o.props,s={crop:{center:{x:Dt(a.center.x,5),y:Dt(a.center.y,5)},rotation:Dt(a.rotation,5),zoom:Dt(a.zoom,5),aspectRatio:Dt(a.aspectRatio,5),flip:{horizontal:a.flip.horizontal,vertical:a.flip.vertical},scaleToFit:a.scaleToFit,width:o.currentWidth,height:o.currentHeight},preview:{scale:r.scale/Math.max(r.cropRect.width/r.previewSize.width,r.cropRect.height/r.previewSize.height)}};Mo(e.ref.previousState,s)&&(e.dispatch("DID_UPDATE",{state:f({},s)}),e.ref.previousState=s);var l=e.ref,c=l.btnReset,h=l.btnCancel,u=l.content,d=r.canReset;if(c&&(c.opacity=d?1:0),h&&e.query("GET_UTILS").length>1&&c){var p=e.query("GET_ROOT_SIZE");h.opacity=d&&p.width<=600?0:1}u&&0===u.opacity&&e.dispatch("DID_UNLOAD_IMAGE")}}))}),Mo=function(t,e){if(!t)return!0;var i=t.crop,n=e.crop;return i.width!==n.width||i.height!==n.height||i.center.x!==n.center.x||i.center.y!==n.center.y||i.rotation!==n.rotation||i.scaleToFit!==n.scaleToFit||i.zoom!==n.zoom||i.aspectRatio!==n.aspectRatio||i.flip.horizontal!==n.flip.horizontal||i.flip.vertical!==n.flip.vertical},Do=function(t){"gesturestart"!==t.type&&Gr(t.target,(function(t){return t.isScrollContainer}))||t.preventDefault()},Po=Q({name:"editor",ignoreRect:!0,mixins:{styles:["opacity"],animations:{opacity:{type:"tween",duration:350}},apis:["markedForRemoval"]},create:function(t){var e=t.root,i=t.props;i.markedForRemoval=!1,kt()&&(e.element.addEventListener("touchmove",Do,{passive:!1}),e.element.addEventListener("gesturestart",Do)),e.ref.pointerPolyfill=function(t){var e={destroy:function(){}};if("onpointerdown"in window||t.pointersPolyfilled)return e;t.pointersPolyfilled=!0;var i=0,n=[],r=function(t,e,i){var n=new UIEvent(e.type,{view:window,bubbles:!i});Object.keys(e).forEach((function(t){Object.defineProperty(n,t,{value:e[t],writable:!1})})),t.dispatchEvent(n)},o=function(t,e,o){return Array.from(e.changedTouches).map((function(a){var s=n[a.identifier],l={type:t,pageX:a.pageX,pageY:a.pageY,pointerId:a.identifier,isPrimary:s?s.isPrimary:0===i,preventDefault:function(){return e.preventDefault()}};return r(a.target,l,o),l}))},a=function(t){o("pointerdown",t).forEach((function(t){n[t.pointerId]=t,i++}))},s=function(t){o("pointermove",t)},l=function(t){o("pointerup",t).forEach((function(t){delete n[t.pointerId],i--}))},c=function(t,e,i){var n={type:t,pageX:e.pageX,pageY:e.pageY,pointerId:0,isPrimary:!0,preventDefault:function(){return e.preventDefault()}};return r(e.target,n,i),n},h=function(t){c("pointerdown",t)},u=function(t){c("pointermove",t)},d=function(t){c("pointerup",t)};return"ontouchstart"in window?(t.addEventListener("touchstart",a),t.addEventListener("touchmove",s),t.addEventListener("touchend",l)):"onmousedown"in window&&(t.addEventListener("mousedown",h),t.addEventListener("mousemove",u),t.addEventListener("mouseup",d)),e.destroy=function(){n.length=0,t.pointersPolyfilled=!1,t.removeEventListener("touchstart",a),t.removeEventListener("touchmove",s),t.removeEventListener("touchend",l),t.removeEventListener("mousedown",h),t.removeEventListener("mousemove",u),t.removeEventListener("mouseup",d)},e}("root"===e.query("GET_POINTER_EVENTS_POLYFILL_SCOPE")?e.element:document.documentElement),e.appendChildView(e.createChildView(Lo,f({},i)))},destroy:function(t){var e=t.root;e.ref.pointerPolyfill.destroy(),e.element.removeEventListener("touchmove",Do,!0),e.element.removeEventListener("gesturestart",Do)}}),No=function(t){return t.ref.isFullscreen},Bo=function(t){return/fullscreen/.test(t.query("GET_STYLE_LAYOUT_MODE"))},Fo=function(t){return/fullscreen|preview/.test(t.query("GET_STYLE_LAYOUT_MODE"))},Uo=function(t){return/modal/.test(t.query("GET_STYLE_LAYOUT_MODE"))},Go=function(t){return t.query("GET_ALLOW_AUTO_CLOSE")},zo=Fo,Ho=Fo,Vo=function(t){var e=t.ref,i=e.environment,n=e.isSingleUtil,r=e.canBeControlled;t.element.dataset.styleViewport=Yo(t.rect.element.width,t.rect.element.height)+" "+i.join(" ")+(n?" single-util":" multi-util")+(r?" flow-controls":" no-flow-controls")},Wo=function(t){var e=t.element,i=t.ref,n=i.handleFullscreenUpdate,r=i.handleEscapeKey;e.setAttribute("tabindex",-1),n(),t.ref.focusTrap=function(t){var e=function(e){if(9===e.keyCode){var i=Array.from(t.querySelectorAll("button,input,[tabindex]")).filter((function(t){return"hidden"!==t.style.visibility&&-1!==t.tabIndex})),n=i[0],r=i[i.length-1];e.shiftKey?document.activeElement===n&&(r.focus(),e.preventDefault()):document.activeElement===r&&(n.focus(),e.preventDefault())}};return t.addEventListener("keydown",e),{destroy:function(){t.removeEventListener("keydown",e)}}}(e),e.addEventListener("keydown",r),window.addEventListener("resize",n),window.innerWidth-document.documentElement.clientWidth>0&&document.body.classList.add("doka--parent"),document.body.appendChild(e);var o=document.querySelector("meta[name=viewport]");t.ref.defaultViewportContent=o?o.getAttribute("content"):null,o||((o=document.createElement("meta")).setAttribute("name","viewport"),document.head.appendChild(o)),o.setAttribute("content","width=device-width, height=device-height, initial-scale=1, maximum-scale=1, user-scalable=0"),t.opacity=1,t.element.contains(document.activeElement)||e.focus(),t.dispatch("INVALIDATE_VIEWPORT"),t.ref.isFullscreen=!0},jo=function(t){var e=t.element,i=t.ref,n=i.handleFullscreenUpdate,r=i.focusTrap,o=i.handleEscapeKey;e.removeAttribute("tabindex"),r.destroy(),e.removeEventListener("keydown",o),window.removeEventListener("resize",n),document.body.classList.remove("doka--parent");var a=document.querySelector("meta[name=viewport]");t.ref.defaultViewportContent?(a.setAttribute("content",t.ref.defaultViewportContent),t.ref.defaultViewportContent=null):a.parentNode.removeChild(a),t.ref.isFullscreen=!1},qo=Q({name:"root",ignoreRect:!0,mixins:{styles:["opacity"],animations:{opacity:{type:"tween",duration:350}}},create:function(t){var e=t.root,i=t.props;e.element.id=e.query("GET_ID")||"doka-".concat(i.id);var n=e.query("GET_CLASS_NAME");n&&e.element.classList.add(n),e.ref.environment=[],e.ref.shouldBeDestroyed=!1,e.ref.isClosing=!1,e.ref.isClosed=!1,e.ref.isFullscreen=!1,e.query("GET_ALLOW_DROP_FILES")&&(e.ref.catcher=function(t){var e,i={browseEnabled:!1},n=function(){e.files.length&&r.fire("drop",Array.from(e.files))},r=f({},Et(),{enableBrowse:function(){i.browseEnabled||((e=document.createElement("input")).style.display="none",e.setAttribute("type","file"),e.addEventListener("change",n),t.appendChild(e),t.addEventListener("click",o),i.browseEnabled=!0)},disableBrowse:function(){i.browseEnabled&&(e.removeEventListener("change",n),e.parentNode.removeChild(e),t.removeEventListener("click",o),i.browseEnabled=!1)},destroy:function(){t.removeEventListener("dragover",a),t.removeEventListener("drop",s),t.removeEventListener("click",o),e&&e.removeEventListener("change",n)}}),o=function(){return e.click()},a=function(t){return t.preventDefault()},s=function(t){t.preventDefault();var e=Array.from(t.dataTransfer.items||t.dataTransfer.files).map((function(t){return t.getAsFile&&"file"===t.kind?t.getAsFile():t}));r.fire("drop",e)};return t.addEventListener("dragover",a),t.addEventListener("drop",s),r}(e.element),e.ref.catcher.on("drop",(function(t){t.forEach((function(t){e.dispatch("REQUEST_LOAD_IMAGE",{source:t})}))}))),e.ref.touchDetector=function(){function t(){e.fire("touch-detected"),window.removeEventListener("touchstart",t,!1)}var e=f({},Et(),{destroy:function(){window.removeEventListener("touchstart",t,!1)}});return window.addEventListener("touchstart",t,!1),e}(),e.ref.touchDetector.onOnce("touch-detected",(function(){e.ref.environment.push("touch")})),e.ref.editor=e.appendChildView(e.createChildView(Po,{id:i.id})),e.query("GET_STYLES").filter((function(t){return!et(t.value)})).map((function(t){var i=t.name,n=t.value;e.element.dataset[i]=n})),e.ref.updateViewport=function(){e.dispatch("INVALIDATE_VIEWPORT")},window.addEventListener("resize",e.ref.updateViewport),window.addEventListener("scroll",e.ref.updateViewport),e.ref.isSingleUtil=1===e.query("GET_UTILS").length,e.ref.canBeControlled=e.query("GET_ALLOW_BUTTON_CONFIRM")||e.query("GET_ALLOW_BUTTON_CANCEL"),Vo(e);var r=document.createElement("div");r.style.cssText="position:fixed;height:100vh;top:0;",e.ref.measure=r,document.body.appendChild(r),e.ref.handleEscapeKey=function(t){27===t.keyCode&&e.dispatch("EDIT_CANCEL")},e.ref.initialScreenMeasureHeight=null,e.ref.handleFullscreenUpdate=function(){e.element.dataset.styleFullscreen=window.innerHeight===e.ref.initialScreenMeasureHeight},e.ref.clientRect={left:0,top:0},Uo(e)&&(e.ref.handleModalTap=function(t){t.target===e.element&&e.dispatch("EDIT_CANCEL")},e.element.addEventListener("pointerdown",e.ref.handleModalTap))},read:function(t){var e=t.root,i=e.ref.measure;i&&(e.ref.initialScreenMeasureHeight=i.offsetHeight,i.parentNode.removeChild(i),e.ref.measure=null),e.ref.clientRect=e.element.getBoundingClientRect(),e.ref.clientRect.leftScroll=e.ref.clientRect.left+(window.scrollX||window.pageXOffset),e.ref.clientRect.topScroll=e.ref.clientRect.top+(window.scrollY||window.pageYOffset)},write:J({ENTER_FULLSCREEN:function(t){var e=t.root;Wo(e)},EXIT_FULLSCREEN:function(t){var e=t.root;jo(e)},SHOW_VIEW:function(t){var e=t.root,i=t.action;e.element.dataset.view=i.id},DID_SET_STYLE_LAYOUT_MODE:function(t){var e=t.root,i=t.action;e.element.dataset.styleLayoutMode=i.value||"none",/fullscreen/.test(i.value)&&!/fullscreen/.test(i.prevValue)&&e.dispatch("ENTER_FULLSCREEN")},AWAITING_IMAGE:function(t){var e=t.root;e.ref.catcher&&e.query("GET_ALLOW_BROWSE_FILES")&&e.ref.catcher.enableBrowse()},DID_REQUEST_LOAD_IMAGE:function(t){var e=t.root;if(e.ref.catcher&&e.query("GET_ALLOW_BROWSE_FILES")&&e.ref.catcher.disableBrowse(),0===e.opacity&&(e.opacity=1),e.ref.isClosing=!1,e.ref.isClosed=!1,!Bo(e)||No(e)){var i=e.query("GET_STYLE_LAYOUT_MODE");null!==i&&"modal"!==i||e.element.parentNode||e.dispatch("SET_STYLE_LAYOUT_MODE",{value:("fullscreen "+(i||"")).trim()})}else e.dispatch("ENTER_FULLSCREEN")},DID_CANCEL:function(t){var e=t.root;zo(e)&&Go(e)&&e.dispatch("EDIT_CLOSE")},DID_CONFIRM:function(t){var e=t.root;zo(e)&&Go(e)&&e.dispatch("EDIT_CLOSE")},EDIT_CLOSE:function(t){var e=t.root;Ho(e)&&(e.opacity=e.opacity||1,e.opacity=0,e.ref.isClosed=!1,e.ref.isClosing=!0,e.query("GET_ALLOW_AUTO_DESTROY")&&(e.ref.shouldBeDestroyed=!0),No(e)&&e.dispatch("EXIT_FULLSCREEN"))},DID_SET_UTILS:function(t){var e=t.root;e.ref.isSingleUtil=1===e.query("GET_UTILS").length}},(function(t){var e=t.root;Vo(e);var i=e.query("GET_ROOT"),n=e.rect.element;i.width===n.width&&i.height===n.height&&i.y===e.ref.clientRect.top&&i.topScroll===e.ref.clientRect.topScroll||e.dispatch("UPDATE_ROOT_RECT",{rect:{x:e.ref.clientRect.left,y:e.ref.clientRect.top,left:e.ref.editor.rect.element.left,top:e.ref.editor.rect.element.top,leftScroll:e.ref.clientRect.leftScroll,topScroll:e.ref.clientRect.topScroll,width:e.rect.element.width,height:e.rect.element.height}})})),didWriteView:function(t){var e=t.root,i=e.ref,n=i.isClosed,r=i.isClosing,o=i.shouldBeDestroyed;!n&&r&&0===e.opacity&&(e.dispatch("DID_CLOSE"),e.ref.isClosed=!0,e.ref.isClosing=!1,Bo(e)&&e.element.parentNode&&document.body.removeChild(e.element),o&&e.dispatch("EDIT_DESTROY"))},destroy:function(t){var e=t.root;No(e)&&jo(e),Uo(e)&&e.element.removeEventListener("pointerdown",e.ref.handleModalTap),Bo(e)&&e.element.parentNode&&document.body.removeChild(e.element),window.removeEventListener("resize",e.ref.updateViewport),e.ref.touchDetector.destroy(),e.ref.catcher&&e.ref.catcher.destroy()}}),Yo=function(t,e){var i="";return 0===t&&0===e?"detached":(i+=e>t?"portrait":"landscape",(i+=t<=600?" x-cramped":t<=1e3?" x-comfortable":" x-spacious").trim())},Ko=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=$t(),i=T(mt(e),[Te,_t(e)],[vn,bt(e)]);i.dispatch("SET_OPTIONS",{options:t});var n=function(){document.hidden||i.dispatch("KICK")};document.addEventListener("visibilitychange",n);var r=yt();i.dispatch("SET_UID",{id:r});var o=null,a=qo(i,{id:r}),s=!1,l={_read:function(){s||a._read()},_write:function(t){var e=i.processActionQueue().filter((function(t){return!/^SET_/.test(t.type)}));s&&!e.length||(u(e),(s=a._write(t,e))&&i.processDispatchQueue(),e.find((function(t){return"EDIT_DESTROY"===t.type}))&&d())}},c=function(t){return function(e){var i={type:t};return e?(e.hasOwnProperty("error")&&(i.error=E(e.error)?f({},e.error):e.error||null),e.hasOwnProperty("output")&&(i.output=e.output),e.hasOwnProperty("image")&&(i.image=e.image),e.hasOwnProperty("source")&&(i.source=e.source),e.hasOwnProperty("state")&&(i.state=e.state),i):i}},h={DID_CONFIRM:c("confirm"),DID_CANCEL:c("cancel"),DID_REQUEST_LOAD_IMAGE:c("loadstart"),DID_LOAD_IMAGE:c("load"),DID_LOAD_IMAGE_ERROR:c("loaderror"),DID_SHOW_IMAGE:c("ready"),DID_UPDATE:c("update"),DID_CLOSE:c("close"),DID_DESTROY:c("destroy"),DID_INIT:c("init")},u=function(t){t.length&&t.forEach((function(t){if(h[t.type]){var e=h[t.type];(Array.isArray(e)?e:[e]).forEach((function(e){setTimeout((function(){!function(t){var e=f({doka:p},t);delete e.type,a&&a.element.dispatchEvent(new CustomEvent("Doka:".concat(t.type),{detail:e,bubbles:!0,cancelable:!0,composed:!0}));var n=[];t.hasOwnProperty("error")&&n.push(t.error);var r=["type","error"];Object.keys(t).filter((function(t){return!r.includes(t)})).forEach((function(e){return n.push(t[e])})),p.fire.apply(p,[t.type].concat(n));var o=i.query("GET_ON".concat(t.type.toUpperCase()));o&&o.apply(void 0,n)}(e(t.data))}),0)}))}}))},d=function(){p.fire("destroy",a.element),document.removeEventListener("visibilitychange",n),a._destroy(),i.dispatch("DID_DESTROY")},p=f({},Et(),l,vt(i,e),{setOptions:function(t){return i.dispatch("SET_OPTIONS",{options:t})},setData:function(t){i.dispatch("SET_DATA",t)},getData:function(t){return new Promise((function(e,n){i.dispatch("GET_DATA",f({},t,{success:e,failure:n}))}))},open:function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{};return new Promise((function(n,r){t&&i.dispatch("REQUEST_LOAD_IMAGE",{source:t,options:e,success:n,failure:r,resolveOnConfirm:!!e&&e.resolveOnConfirm})}))},edit:function(t,e){return p.open(t,f({},e,{resolveOnConfirm:!0}))},save:function(t){return new Promise((function(e,n){i.dispatch("GET_DATA",f({},t,{success:e,failure:n}))}))},clear:function(){return i.dispatch("REQUEST_REMOVE_IMAGE")},close:function(){return i.dispatch("EDIT_CLOSE")},interact:function(t,e){"scale"===t&&i.dispatch("CROP_IMAGE_RESIZE_SET",{value:e})},interactEnd:function(t){"scale"===t&&i.dispatch("CROP_IMAGE_RESIZE_RELEASE")},destroy:d,insertBefore:function(t){_(a.element,t)},insertAfter:function(t){y(a.element,t)},appendTo:function(t){t.appendChild(a.element)},replaceElement:function(t){_(a.element,t),t.parentNode.removeChild(t),o=t},restoreElement:function(){o&&(y(o,a.element),a.element.parentNode.removeChild(a.element),o=null)},isAttachedTo:function(t){return!!a&&(a.element===t||o===t)},element:{get:function(){return a?a.element:null}}});return i.dispatch("DID_INIT"),x(p)},Zo=function(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},e=$t(),i={};return w(e,(function(t,e){ot(e)||(i[t]=e[0])})),Ko(f({},i,t))},Xo=function(t){return function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"-";return t.replace(new RegExp("".concat(e,"."),"g"),(function(t){return t.charAt(1).toUpperCase()}))}(t.replace(/^data-/,""))},Qo=function t(e,i){w(i,(function(i,n){w(e,(function(t,r){var o=new RegExp(i);if(o.test(t)&&(delete e[t],!1!==n))if(ot(n))e[n]=r;else{var a=n.group;E(n)&&!e[a]&&(e[a]={}),e[a][function(t){return t.charAt(0).toLowerCase()+t.slice(1)}(t.replace(o,""))]=r}})),n.mapping&&t(e[n.group],n.mapping)}))},Jo=function(t){var e=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},i=[];w(t.attributes,(function(e){return i.push(t.attributes[e])}));var n=i.filter((function(t){return t.name})).reduce((function(e,i){var n=C(t,i.name);return e[Xo(i.name)]=n===i.name||n,e}),{});return Qo(n,e),n},ta=function(t){var e=f({},arguments.length>1&&void 0!==arguments[1]?arguments[1]:{}),i=Jo(t,{"^class$":"className"});Object.keys(i).forEach((function(t){E(i[t])?(E(e[t])||(e[t]={}),Object.assign(e[t],i[t])):e[t]=i[t]})),"CANVAS"!==t.nodeName&&"IMG"!==t.nodeName||(e.src=t.dataset.dokaSrc?t.dataset.dokaSrc:t);var n=Zo(e);return n.replaceElement(t),n},ea=function(){for(var t=arguments.length,e=new Array(t),i=0;i<t;i++)e[i]=arguments[i];return b(e[0])?ta.apply(void 0,e):Zo.apply(void 0,v(e.filter((function(t){return t}))))},ia=["fire","_read","_write"],na=function(t){var e={};return function(t,e,i){Object.getOwnPropertyNames(t).filter((function(t){return!i.includes(t)})).forEach((function(i){return Object.defineProperty(e,i,Object.getOwnPropertyDescriptor(t,i))}))}(t,e,ia),e},ra=function(){var t=Z()&&!("[object OperaMini]"===Object.prototype.toString.call(window.operamini))&&"visibilityState"in document&&"Promise"in window&&"slice"in Blob.prototype&&"URL"in window&&"createObjectURL"in window.URL&&"performance"in window;return function(){return t}}(),oa={apps:[]},aa=function(){},sa={},la=aa,ca=aa,ha=aa,ua=aa,da=aa,pa=aa;if(ra()){!function(t,e){var i=arguments.length>2&&void 0!==arguments[2]?arguments[2]:60,n="__framePainter";if(window[n])return window[n].readers.push(t),void window[n].writers.push(e);window[n]={readers:[t],writers:[e]};var r=window[n],o=1e3/i,a=null,s=null,l=null,c=null,h=function(){document.hidden?(l=function(){return window.setTimeout((function(){return u(performance.now())}),o)},c=function(){return window.clearTimeout(s)}):(l=function(){return window.requestAnimationFrame(u)},c=function(){return window.cancelAnimationFrame(s)})};document.addEventListener("visibilitychange",(function(){c&&c(),h(),u(performance.now())}));var u=function t(e){s=l(t),a||(a=e);var i=e-a;i<=o||(a=e-i%o,r.readers.forEach((function(t){return t()})),r.writers.forEach((function(t){return t(e)})))};h(),u(performance.now())}((function(){oa.apps.forEach((function(t){return t._read()}))}),(function(t){oa.apps.forEach((function(e){return e._write(t)}))}));var fa=function t(){document.dispatchEvent(new CustomEvent("doka:loaded",{detail:{supported:ra,create:la,destroy:ca,parse:ha,find:ua,setOptions:pa}})),document.removeEventListener("DOMContentLoaded",t)};"loading"!==document.readyState?setTimeout((function(){return fa()}),0):document.addEventListener("DOMContentLoaded",fa);sa={},w($t(),(function(t,e){sa[t]=e[1]})),la=function(){var t=ea.apply(void 0,arguments);return t.on("destroy",ca),oa.apps.push(t),na(t)},ca=function(t){var e=oa.apps.findIndex((function(e){return e.isAttachedTo(t)}));return e>=0&&(oa.apps.splice(e,1)[0].restoreElement(),!0)},ha=function(t){return Array.from(t.querySelectorAll(".".concat("doka"))).filter((function(t){return!oa.apps.find((function(e){return e.isAttachedTo(t)}))})).map((function(t){return la(t)}))},ua=function(t){var e=oa.apps.find((function(e){return e.isAttachedTo(t)}));return e?na(e):null},da=function(){var t={};return w($t(),(function(e,i){t[e]=i[0]})),t},pa=function(t){return E(t)&&(oa.apps.forEach((function(e){e.setOptions(t)})),w(t,(function(t,e){Lt[t]&&Ot(t,e)}))),da()}}i(41173);function ma(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}var ga=i(77049),va=i.n(ga),ba=i(66330),_a=i.n(ba),ya=i(14857),Ea=i.n(ya),Ta=(i(20864),i(10864)),wa=i.n(Ta);i(44959),i(67803);function xa(t,e,i,n,r,o,a){try{var s=t[o](a),l=s.value}catch(c){return void i(c)}s.done?e(l):Promise.resolve(l).then(n,r)}function Ca(t){return function(){var e=this,i=arguments;return new Promise((function(n,r){var o=t.apply(e,i);function a(t){xa(o,n,r,a,s,"next",t)}function s(t){xa(o,n,r,a,s,"throw",t)}a(void 0)}))}}function Ra(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Aa(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},n=Object.keys(i);"function"===typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(i).filter((function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable})))),n.forEach((function(e){Ra(t,e,i[e])}))}return t}var Sa={restrictions:{maxNumberOfFiles:1,allowedFileTypes:h.allowedImageTypes},allowMultipleUploads:!1},Ia=va()(Aa({},Sa,{store:Ea()(),autoProceed:!0}));Ia.use(_a(),{getUploadParameters:function(t){return Ca(o().mark((function e(){var i,n;return o().wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return i=Ia.getState().signedUrlDataWithToken,n=Ia.getState().getSignedUrl,e.abrupt("return",n(c,Aa({},i,{file_name:t.name})));case 3:case"end":return e.stop()}}),e)})))()}}),Ia.use(wa(),{id:"ThumbnailGenerator",thumbnailHeight:120,waitForThumbnailsBeforeUpload:!1}),Ia.on("thumbnail:generated",(function(t){Ia.getState().storePreview(String(t.preview))})),Ia.on("upload-success",(function(t,e){Ia.getState().storeLocation(e.body.location)})),Ia.on("dashboard:modal-open",(function(){console.log("Modal is open"),Ia.reset()}));!function(t,e,i){var n=function(){var t=a[0];t&&t()},r=function(t){a.push((function(){o.edit(t.data).then((function(e){a.shift(),n(),e&&i.addFile(function(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},n=Object.keys(i);"function"===typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(i).filter((function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable})))),n.forEach((function(e){ma(t,e,i[e])}))}return t}({},t,{data:e.file,handledByDoka:!0}))}))})),1===a.length&&n()},o=t.create(e),a=[]}(n,{cropAspectRatio:"16:9"},Ia);var ka=c,$a=i(14623),Oa=i.n($a);i(84712),i(74498);function La(t,e,i,n,r,o,a){try{var s=t[o](a),l=s.value}catch(c){return void i(c)}s.done?e(l):Promise.resolve(l).then(n,r)}function Ma(t){return function(){var e=this,i=arguments;return new Promise((function(n,r){var o=t.apply(e,i);function a(t){La(o,n,r,a,s,"next",t)}function s(t){La(o,n,r,a,s,"throw",t)}a(void 0)}))}}function Da(t,e,i){return e in t?Object.defineProperty(t,e,{value:i,enumerable:!0,configurable:!0,writable:!0}):t[e]=i,t}function Pa(t){for(var e=1;e<arguments.length;e++){var i=null!=arguments[e]?arguments[e]:{},n=Object.keys(i);"function"===typeof Object.getOwnPropertySymbols&&(n=n.concat(Object.getOwnPropertySymbols(i).filter((function(t){return Object.getOwnPropertyDescriptor(i,t).enumerable})))),n.forEach((function(e){Da(t,e,i[e])}))}return t}var Na=ka,Ba=la({cropAspectRatioOptions:[{label:"Free",value:null},{label:"Portrait",value:1.5},{label:"Square",value:"1:1"},{label:"Landscape",value:.75},{label:"Timeline Photo",value:{width:800,height:400}}]});var Fa=["undo","redo","html","format","bold","italic","underline","lists","table","image","link"],Ua=["table","fontsize","fontcolor","video","fullscreen","inlinestyle"];function Ga(t){var e=t.editor,i=t.handleEditor,n=t.signedUrlId,r=t.signedUrlData,c=t.imageUploadMethods,h=t.buttons,u=void 0===h?Fa:h,d=t.plugins,p=void 0===d?Ua:d,f=t.editImage,m=void 0!==f&&f,g=t.editImageOpts,v=t.redactorCallbackEvents,b=t.redactorAdditionalOptions,_=void 0===b?{}:b,y=t.urlToken,E=t.handleEditorOnKeyUp,T=(0,l.useState)(!1),w=T[0],x=T[1],C=function(t){i(t)},R=function(t){var e,i;E&&E(null!==(i=null===t||void 0===t||null===(e=t.target)||void 0===e?void 0:e.innerHTML)&&void 0!==i?i:"")};return(0,l.useEffect)((function(){var t,e,i;!w&&n&&(m&&g&&(i=g,Ba.setOptions(i)),t={changed:C,keyup:R},v&&(t=v),e=Pa({buttons:u,plugins:p,callbacks:t},_),u.includes("image")&&r&&c&&y&&(e=Pa({},e,{callbacks:{changed:C,image:{delete:function(t){return!0}}},imageUpload:function(){var t=Ma(o().mark((function t(e,i,n,a){var s,l,h,u,d,p;return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:return t.prev=0,s="",i.length>0&&(s=i[0].name),Da(l={action:r.action},r.uploadKey,r.uploadValue),Da(l,"file_name",s),h=l,u=c.getSignedUrl,d=c.uploadImage,t.next=8,u(Na,Pa({},h,{token:y}));case 8:if(!(p=t.sent)){t.next=17;break}if(!m){t.next=14;break}Ba.edit(i[0]).then(function(){var t=Ma(o().mark((function t(e){return o().wrap((function(t){for(;;)switch(t.prev=t.next){case 0:if(!e){t.next=3;break}return t.next=3,d(Pa({},p,{data:e.file}));case 3:case"end":return t.stop()}}),t)})));return function(e){return t.apply(this,arguments)}}()).catch((function(t){console.log(t,"@texteditor/dokaImageEditfailed")})),t.next=16;break;case 14:return t.next=16,d(Pa({},p,{data:i[0]}));case 16:a.complete(p.url.split("?")[0]);case 17:t.next=23;break;case 19:t.prev=19,t.t0=t.catch(0),console.log(t.t0,"@common/texteditor"),a.complete(t.t0);case 23:case"end":return t.stop()}}),t,null,[[0,19]])})));return function(e,i,n,r){return t.apply(this,arguments)}}()})),Oa()("[data-redactor]",e),w||x(!0))}),[w,n]),(0,a.jsx)(s.xu,{children:(0,a.jsx)("textarea",{onChange:C,value:e||"","data-redactor":!0})})}},14623:function(module){"use strict";function _instanceof(t,e){return null!=e&&"undefined"!==typeof Symbol&&e[Symbol.hasInstance]?e[Symbol.hasInstance](t):t instanceof e}if(void 0===CodeMirror)var CodeMirror=void 0;if(void 0===jQuery)var jQuery=void 0;!function(){var Ajax={settings:{},post:function(t){return new AjaxRequest("post",t)},get:function(t){return new AjaxRequest("get",t)},request:function(t,e){return new AjaxRequest(t,e)}},AjaxRequest=function(t,e){var i={method:t,url:"",before:function(){},success:function(){},error:function(){},data:!1,async:!0,headers:{}};this.p=this.extend(i,e),this.p=this.extend(this.p,Ajax.settings),this.p.method=this.p.method.toUpperCase(),this.prepareData(),this.xhr=new XMLHttpRequest,this.xhr.open(this.p.method,this.p.url,this.p.async),this.setHeaders(),!1!==("function"!=typeof this.p.before||this.p.before(this.xhr))&&this.send()};AjaxRequest.prototype={extend:function(t,e){if(e)for(var i in e)t[i]=e[i];return t},prepareData:function(){-1===["POST","PUT"].indexOf(this.p.method)||this.isFormData()||(this.p.headers["Content-Type"]="application/x-www-form-urlencoded"),"object"!=typeof this.p.data||this.isFormData()||(this.p.data=this.toParams(this.p.data)),"GET"===this.p.method&&(this.p.url=this.p.data?this.p.url+"?"+this.p.data:this.p.url)},setHeaders:function(){for(var t in this.xhr.setRequestHeader("X-Requested-With",this.p.headers["X-Requested-With"]||"XMLHttpRequest"),this.p.headers)this.xhr.setRequestHeader(t,this.p.headers[t])},isFormData:function(){return void 0!==window.FormData&&_instanceof(this.p.data,window.FormData)},isComplete:function(){return!(this.xhr.status<200||this.xhr.status>=300&&304!==this.xhr.status)},send:function(){this.p.async?(this.xhr.onload=this.loaded.bind(this),this.xhr.send(this.p.data)):(this.xhr.send(this.p.data),this.loaded.call(this))},loaded:function(){if(this.isComplete()){var t=this.xhr.response;t=this.parseJson(t)||t,"function"==typeof this.p.success&&this.p.success(t,this.xhr)}else"function"==typeof this.p.error&&this.p.error(this.xhr.statusText)},parseJson:function(t){try{var e=JSON.parse(t);if(e&&"object"==typeof e)return e}catch(i){}return!1},toParams:function(t){return Object.keys(t).map((function(e){return encodeURIComponent(e)+"="+encodeURIComponent(t[e])})).join("&")}};var DomCache=[0],DomExpando="data"+(new Date).getTime(),DomHClass="is-hidden",DomHMClass="is-hidden-mobile",Dom=function(t,e){return this.parse(t,e)};Dom.ready=function(t){"loading"!==document.readyState?t():document.addEventListener("DOMContentLoaded",t)},Dom.prototype={get sdom(){return!0},get length(){return this.nodes.length},parse:function(t,e){var i;if(t){if(t.sdom)return this.nodes=t.nodes,t;i="string"!=typeof t?t.nodeType&&11===t.nodeType?t.childNodes:t.nodeType||t===window?[t]:t:/^\s*<(\w+|!)[^>]*>/.test(t)?this.create(t):this._query(t,e)}else i=[];this.nodes=this._slice(i)},create:function(t){if(/^<(\w+)\s*\/?>(?:<\/\1>|)$/.test(t))return[document.createElement(RegExp.$1)];var e=[],i=document.createElement("div"),n=i.childNodes;i.innerHTML=t;for(var r=0,o=n.length;r<o;r++)e.push(n[r]);return e},add:function(t){this.nodes=this.nodes.concat(this._toArray(t))},get:function(t){return this.nodes[t||0]||!1},getAll:function(){return this.nodes},eq:function(t){return new Dom(this.nodes[t])},first:function(){return new Dom(this.nodes[0])},last:function(){return new Dom(this.nodes[this.nodes.length-1])},contents:function(){return this.get().childNodes},each:function(t){for(var e=this.nodes.length,i=0;i<e;i++)t.call(this,this.nodes[i].sdom?this.nodes[i].get():this.nodes[i],i);return this},is:function(t){return this.filter(t).length>0},filter:function(t){var e;return void 0===t?this:(e="function"==typeof t?t:function(e){return _instanceof(t,Node)?t===e:t&&t.sdom?-1!==t.nodes.indexOf(e):(e.matches=e.matches||e.msMatchesSelector||e.webkitMatchesSelector,1===e.nodeType&&e.matches(t||"*"))},new Dom(this.nodes.filter(e)))},not:function(t){return this.filter((function(e){return!new Dom(e).is(t||!0)}))},find:function(t){var e=[];return this.each((function(i){for(var n=this._query(t||"*",i),r=0;r<n.length;r++)e.push(n[r])})),new Dom(e)},children:function(t){var e=[];return this.each((function(t){if(t.children)for(var i=t.children,n=0;n<i.length;n++)e.push(i[n])})),new Dom(e).filter(t)},parent:function(t){var e=[];return this.each((function(t){t.parentNode&&e.push(t.parentNode)})),new Dom(e).filter(t)},parents:function(t,e){e=this._getContext(e);var i=[];return this.each((function(n){for(var r=n.parentNode;r&&r!==e;)t?new Dom(r).is(t)&&i.push(r):i.push(r),r=r.parentNode})),new Dom(i)},closest:function(t,e){e=this._getContext(e),t=t.sdom?t.get():t;var i=[],n=t&&t.nodeType;return this.each((function(r){do{if(n&&r===t||new Dom(r).is(t))return i.push(r)}while((r=r.parentNode)&&r!==e)})),new Dom(i)},next:function(t){return this._getSibling(t,"nextSibling")},nextElement:function(t){return this._getSibling(t,"nextElementSibling")},prev:function(t){return this._getSibling(t,"previousSibling")},prevElement:function(t){return this._getSibling(t,"previousElementSibling")},css:function(t,e){if(void 0===e&&"object"!=typeof t){var i=this.get();return"width"===t||"height"===t?i.style?this._getHeightOrWidth(t,i,!1)+"px":void 0:i.style?getComputedStyle(i,null)[t]:void 0}return this.each((function(i){var n={};for(var r in"object"==typeof t?n=t:n[t]=e,n)i.style&&(i.style[r]=n[r])}))},attr:function(t,e,i){if(i=i?"data-":"",void 0===e&&"object"!=typeof t){var n=this.get();return n&&3!==n.nodeType?"checked"===t?n.checked:this._getBooleanFromStr(n.getAttribute(i+t)):void 0}return this.each((function(n){var r={};for(var o in"object"==typeof t?r=t:r[t]=e,r)3!==n.nodeType&&("checked"===o?n.checked=r[o]:n.setAttribute(i+o,r[o]))}))},data:function(t,e){if(void 0===t){var i=/^data-(.+)$/,n=this.get().attributes,r={},o=function(t){return t[1].toUpperCase()};for(var a in n)if(n[a]&&i.test(n[a].nodeName)){var s=n[a].nodeName.match(i)[1],l=n[a].value;s=s.replace(/-([a-z])/g,o),l=this._isObjectString(l)?this._toObject(l):this._isNumber(l)?parseFloat(l):this._getBooleanFromStr(l),r[s]=l}return r}return this.attr(t,e,!0)},val:function(t){if(void 0===t){var e=this.get();return e.type&&"checkbox"===e.type?e.checked:e.value}return this.each((function(e){e.value=t}))},removeAttr:function(t){return this.each((function(e){t.split(" ").forEach((function(t){3!==e.nodeType&&e.removeAttribute(t)}))}))},removeData:function(t){return this.each((function(e){t.split(" ").forEach((function(t){3!==e.nodeType&&e.removeAttribute("data-"+t)}))}))},dataset:function(t,e){return this.each((function(i){DomCache[this.dataindex(i)][t]=e}))},dataget:function(t){return DomCache[this.dataindex(this.get())][t]},dataindex:function(t){var e=t[DomExpando],i=DomCache.length;return e||(e=t[DomExpando]=i,DomCache[e]={}),e},addClass:function(t){return this._eachClass(t,"add")},removeClass:function(t){return this._eachClass(t,"remove")},toggleClass:function(t){return this._eachClass(t,"toggle")},hasClass:function(t){return this.nodes.some((function(e){return!!e.classList&&e.classList.contains(t)}))},empty:function(){return this.each((function(t){t.innerHTML=""}))},html:function(t){return void 0===t?this.get().innerHTML||"":this.empty().append(t)},text:function(t){return void 0===t?this.get().textContent||"":this.each((function(e){e.textContent=t}))},after:function(t){return this._inject(t,(function(t,e){if("string"==typeof t)e.insertAdjacentHTML("afterend",t);else if(null!==e.parentNode)for(var i=_instanceof(t,Node)?[t]:this._toArray(t).reverse(),n=0;n<i.length;n++)e.parentNode.insertBefore(i[n],e.nextSibling);return e}))},before:function(t){return this._inject(t,(function(t,e){if("string"==typeof t)e.insertAdjacentHTML("beforebegin",t);else for(var i=_instanceof(t,Node)?[t]:this._toArray(t),n=0;n<i.length;n++)e.parentNode.insertBefore(i[n],e);return e}))},append:function(t){return this._inject(t,(function(t,e){if("string"==typeof t||"number"==typeof t)e.insertAdjacentHTML("beforeend",t);else for(var i=_instanceof(t,Node)?[t]:this._toArray(t),n=0;n<i.length;n++)e.appendChild(i[n]);return e}))},prepend:function(t){return this._inject(t,(function(t,e){if("string"==typeof t||"number"==typeof t)e.insertAdjacentHTML("afterbegin",t);else for(var i=_instanceof(t,Node)?[t]:this._toArray(t).reverse(),n=0;n<i.length;n++)e.insertBefore(i[n],e.firstChild);return e}))},wrap:function(t){return this._inject(t,(function(t,e){var i="string"==typeof t||"number"==typeof t?this.create(t)[0]:_instanceof(t,Node)?t:this._toArray(t)[0];return e.parentNode&&e.parentNode.insertBefore(i,e),i.appendChild(e),new Dom(i)}))},unwrap:function(){return this.each((function(t){var e=new Dom(t);return e.replaceWith(e.contents())}))},replaceWith:function(t){return this._inject(t,(function(t,e){for(var i=document.createDocumentFragment(),n="string"==typeof t||"number"==typeof t?this.create(t):_instanceof(t,Node)?[t]:this._toArray(t),r=0;r<n.length;r++)i.appendChild(n[r]);var o=i.childNodes[0];return e.parentNode&&e.parentNode.replaceChild(i,e),o}))},remove:function(){return this.each((function(t){t.parentNode&&t.parentNode.removeChild(t)}))},clone:function(t){var e=[];return this.each((function(i){var n=this._clone(i);t&&(n=this._cloneEvents(i,n)),e.push(n)})),new Dom(e)},show:function(){return this.each(function(t){if(t.style&&this._hasDisplayNone(t)){var e,i=t.getAttribute("domTargetShow"),n=!!t.classList&&t.classList.contains(DomHClass),r=!!t.classList&&t.classList.contains(DomHMClass);n?(e=DomHClass,t.classList.remove(DomHClass)):r?(e=DomHMClass,t.classList.remove(DomHMClass)):t.style.display=i||"block",e&&t.setAttribute("domTargetHide",e),t.removeAttribute("domTargetShow")}}.bind(this))},hide:function(){return this.each((function(t){if(t.style&&!this._hasDisplayNone(t)){var e=t.style.display,i=t.getAttribute("domTargetHide");i===DomHClass?t.classList.add(DomHClass):i===DomHMClass?t.classList.add(DomHMClass):("block"!==e&&t.setAttribute("domTargetShow",e),t.style.display="none"),t.removeAttribute("domTargetHide")}}))},scrollTop:function(t){var e=this.get(),i=e===window,n=9===e.nodeType,r=n?document.scrollingElement||document.body.parentNode||document.body||document.documentElement:e;if(void 0===t)return n?void 0!==window.pageYOffset?window.pageYOffset:document.documentElement.scrollTop?document.documentElement.scrollTop:document.body.scrollTop?document.body.scrollTop:0:i?window.pageYOffset:r.scrollTop;i?window.scrollTo(0,t):r.scrollTop=t},offset:function(){return this._getDim("Offset")},position:function(){return this._getDim("Position")},width:function(t,e){return this._getSize("width","Width",t,e)},height:function(t,e){return this._getSize("height","Height",t,e)},outerWidth:function(){return this._getInnerOrOuter("width","outer")},outerHeight:function(){return this._getInnerOrOuter("height","outer")},innerWidth:function(){return this._getInnerOrOuter("width","inner")},innerHeight:function(){return this._getInnerOrOuter("height","inner")},click:function(){return this._triggerEvent("click")},focus:function(){return this._triggerEvent("focus")},trigger:function(t){return this.each((function(e){for(var i=t.split(" "),n=0;n<i.length;n++){var r;try{r=new window.CustomEvent(i[n],{bubbles:!0,cancelable:!0})}catch(t){(r=document.createEvent("CustomEvent")).initCustomEvent(i[n],!0,!0)}e.dispatchEvent(r)}}))},on:function(t,e,i){return this.each((function(n){for(var r=t.split(" "),o=0;o<r.length;o++){var a=this._getEventName(r[o]),s=this._getEventNamespace(r[o]);e=i?this._getOneHandler(e,t):e,n.addEventListener(a,e),n._e=n._e||{},n._e[s]=n._e[s]||{},n._e[s][a]=n._e[s][a]||[],n._e[s][a].push(e)}}))},one:function(t,e){return this.on(t,e,!0)},off:function(t,e){var i=function(t,e,i){return t===i},n=function(t,e,i,n){return e===n},r=function(t,e,i,n){return t===i&&e===n},o=function(){return!0};return void 0===t?this.each((function(t){this._offEvent(t,!1,!1,e,o)})):this.each((function(o){for(var a=t.split(" "),s=0;s<a.length;s++){var l=this._getEventName(a[s]),c=this._getEventNamespace(a[s]);"_events"===c?this._offEvent(o,l,c,e,i):l||"_events"===c?this._offEvent(o,l,c,e,r):this._offEvent(o,l,c,e,n)}}))},serialize:function(t){for(var e={},i=this.get().elements,n=0;n<i.length;n++){var r=i[n];if((!/(checkbox|radio)/.test(r.type)||r.checked)&&r.name&&!r.disabled&&"file"!==r.type){if("select-multiple"===r.type)for(var o=0;o<r.options.length;o++){var a=r.options[o];a.selected&&(e[r.name]=a.value)}e[r.name]=this._isNumber(r.value)?parseFloat(r.value):this._getBooleanFromStr(r.value)}}return t?e:this._toParams(e)},ajax:function(t,e){if(void 0!==AjaxRequest){var i=this.attr("method")||"post",n={url:this.attr("action"),data:this.serialize(),success:t,error:e};return new AjaxRequest(i,n)}},_queryContext:function(t,e){return 3!==(e=this._getContext(e)).nodeType&&"function"==typeof e.querySelectorAll?e.querySelectorAll(t):[]},_query:function(t,e){if(e)return this._queryContext(t,e);if(/^[.#]?[\w-]*$/.test(t)){if("#"===t[0]){var i=document.getElementById(t.slice(1));return i?[i]:[]}return"."===t[0]?document.getElementsByClassName(t.slice(1)):document.getElementsByTagName(t)}return document.querySelectorAll(t)},_getContext:function(t){return(t="string"==typeof t?document.querySelector(t):t)&&t.sdom?t.get():t||document},_inject:function(t,e){for(var i=this.nodes.length,n=[];i--;){var r="function"==typeof t?t.call(this,this.nodes[i]):t,o=0===i?r:this._clone(r),a=e.call(this,o,this.nodes[i]);a&&(a.sdom?n.push(a.get()):n.push(a))}return new Dom(n)},_cloneEvents:function(t,e){var i=t._e;if(i)for(var n in e._e=i,i._events)for(var r=0;r<i._events[n].length;r++)e.addEventListener(n,i._events[n][r]);return e},_clone:function(t){if(void 0!==t)return"string"==typeof t?t:_instanceof(t,Node)||t.nodeType?t.cloneNode(!0):"length"in t?[].map.call(this._toArray(t),(function(t){return t.cloneNode(!0)})):void 0},_slice:function(t){return t&&0!==t.length?t.length?[].slice.call(t.nodes||t):[t]:[]},_eachClass:function(t,e){return this.each((function(i){t&&t.split(" ").forEach((function(t){i.classList&&i.classList[e](t)}))}))},_triggerEvent:function(t){var e=this.get();return e&&3!==e.nodeType&&e[t](),this},_getOneHandler:function(t,e){var i=this;return function(){t.apply(this,arguments),i.off(e)}},_getEventNamespace:function(t){var e=t.split("."),i=e[1]?e[1]:"_events";return e[2]?i+e[2]:i},_getEventName:function(t){return t.split(".")[0]},_offEvent:function(t,e,i,n,r){for(var o in t._e)for(var a in t._e[o])if(r(a,o,e,i))for(var s=t._e[o][a],l=0;l<s.length;l++)void 0!==n&&s[l].toString()!==n.toString()||(t.removeEventListener(a,s[l]),t._e[o][a].splice(l,1),0===t._e[o][a].length&&delete t._e[o][a],0===Object.keys(t._e[o]).length&&delete t._e[o])},_getInnerOrOuter:function(t,e){return this[t](void 0,e)},_getDocSize:function(t,e){var i=t.body,n=t.documentElement;return Math.max(i["scroll"+e],i["offset"+e],n["client"+e],n["scroll"+e],n["offset"+e])},_getSize:function(t,e,i,n){if(void 0===i){var r=this.get();return i=3===r.nodeType?0:9===r.nodeType?this._getDocSize(r,e):r===window?window["inner"+e]:this._getHeightOrWidth(t,r,n||"normal"),Math.round(i)}return this.each(function(e){i=parseFloat(i),i+=this._adjustResultHeightOrWidth(t,e,n||"normal"),new Dom(e).css(t,i+"px")}.bind(this))},_getHeightOrWidth:function(t,e,i){if(!e)return 0;var n=t.charAt(0).toUpperCase()+t.slice(1),r=0,o=getComputedStyle(e,null),a=new Dom(e),s=a.parents().filter((function(t){return 1===t.nodeType&&"none"===getComputedStyle(t,null).display&&t}));if("none"===o.display&&s.add(e),0!==s.length){var l="visibility: hidden !important; display: block !important;",c=[];s.each((function(t){var e=new Dom(t),i=e.attr("style");null!==i&&c.push(i),e.attr("style",null!==i?i+";"+l:l)})),r=a.get()["offset"+n]-this._adjustResultHeightOrWidth(t,e,i),s.each((function(t,e){var i=new Dom(t);void 0===c[e]?i.removeAttr("style"):i.attr("style",c[e])}))}else r=e["offset"+n]-this._adjustResultHeightOrWidth(t,e,i);return r},_adjustResultHeightOrWidth:function(t,e,i){if(!e||!1===i)return 0;var n=0,r=getComputedStyle(e,null),o="border-box"===r.boxSizing;return"height"===t?(("inner"===i||"normal"===i&&o)&&(n+=(parseFloat(r.borderTopWidth)||0)+(parseFloat(r.borderBottomWidth)||0)),"outer"===i&&(n-=(parseFloat(r.marginTop)||0)+(parseFloat(r.marginBottom)||0))):(("inner"===i||"normal"===i&&o)&&(n+=(parseFloat(r.borderLeftWidth)||0)+(parseFloat(r.borderRightWidth)||0)),"outer"===i&&(n-=(parseFloat(r.marginLeft)||0)+(parseFloat(r.marginRight)||0))),n},_getDim:function(t){var e=this.get();return 3===e.nodeType?{top:0,left:0}:this["_get"+t](e)},_getPosition:function(t){return{top:t.offsetTop,left:t.offsetLeft}},_getOffset:function(t){var e=t.getBoundingClientRect(),i=t.ownerDocument,n=i.documentElement,r=i.defaultView;return{top:e.top+r.pageYOffset-n.clientTop,left:e.left+r.pageXOffset-n.clientLeft}},_getSibling:function(t,e){var i,n=(t=t&&t.sdom?t.get():t)&&t.nodeType;return this.each((function(r){for(;r=r[e];)if(n&&r===t||new Dom(r).is(t))return void(i=r)})),new Dom(i)},_toArray:function(t){if(_instanceof(t,NodeList)){for(var e=[],i=0;i<t.length;i++)e[i]=t[i];return e}return void 0===t?[]:t.sdom?t.nodes:t},_toParams:function(t){var e="";for(var i in t)e+="&"+this._encodeUri(i)+"="+this._encodeUri(t[i]);return e.replace(/^&/,"")},_toObject:function(t){return new Function("return "+t)()},_encodeUri:function(t){return encodeURIComponent(t).replace(/!/g,"%21").replace(/'/g,"%27").replace(/\(/g,"%28").replace(/\)/g,"%29").replace(/\*/g,"%2A").replace(/%20/g,"+")},_isNumber:function(t){return!isNaN(t)&&!isNaN(parseFloat(t))},_isObjectString:function(t){return-1!==t.search(/^{/)},_getBooleanFromStr:function(t){return"true"===t||"false"!==t&&t},_hasDisplayNone:function(t){return"none"===t.style.display||"none"===(t.currentStyle?t.currentStyle.display:getComputedStyle(t,null).display)}};var uuid=0,$R=function(t,e){return RedactorApp(t,e,[].slice.call(arguments,2))};$R.app=[],$R.version="3.4.10",$R.options={},$R.modules={},$R.services={},$R.classes={},$R.plugins={},$R.mixins={},$R.modals={},$R.lang={},$R.dom=function(t,e){return new Dom(t,e)},$R.ajax=Ajax,$R.Dom=Dom,$R.keycodes={BACKSPACE:8,DELETE:46,UP:38,DOWN:40,ENTER:13,SPACE:32,ESC:27,TAB:9,CTRL:17,META:91,SHIFT:16,ALT:18,RIGHT:39,LEFT:37},$R.env={plugin:"plugins",module:"modules",service:"services",class:"classes",mixin:"mixins"},void 0!==jQuery&&(jQuery.fn.redactor=function(t){return RedactorApp(this.toArray(),t,[].slice.call(arguments,1))});var RedactorApp=function(t,e,i){for(var n,r=Array.isArray(t)?t:t&&t.nodeType?[t]:document.querySelectorAll(t),o="string"==typeof e||"function"==typeof e,a=[],s=0;s<r.length;s++){var l=r[s],c=$R.dom(l);if((n=c.dataget("redactor"))||o||(n=new App(l,e,uuid),c.dataset("redactor",n),$R.app[uuid]=n,uuid++),n&&o){var h,u="destroy"===e;"function"==typeof(e=u?"stop":e)?h=e.apply(n,i):(i.unshift(e),h=n.api.apply(n,i)),void 0!==h&&a.push(h),u&&c.dataset("redactor",!1)}}return 0===a.length||1===a.length?0===a.length?n:a[0]:a};$R.add=function(t,e,i){if(void 0!==$R.env[t])if(i.translations&&($R.lang=$R.extend(!0,{},$R.lang,i.translations)),i.modals&&($R.modals=$R.extend(!0,{},$R.modals,i.modals)),"mixin"===t)$R[$R.env[t]][e]=i;else{var n=function(){};if(n.prototype=i,i.mixins)for(var r=0;r<i.mixins.length;r++)$R.inherit(n,$R.mixins[i.mixins[r]]);$R[$R.env[t]][e]=n}},$R.addLang=function(t,e){void 0===$R.lang[t]&&($R.lang[t]={}),$R.lang[t]=$R.extend($R.lang[t],e)},$R.create=function(t){var e=t.split("."),i=[].slice.call(arguments,1),n="classes";void 0!==$R.env[e[0]]&&(n=$R.env[e[0]],t=e.slice(1).join("."));var r=new $R[n][t];if(r.init){var o=r.init.apply(r,i);return o||r}return r},$R.inherit=function(t,e){var i=function(){};i.prototype=e;var n=new i;for(var r in t.prototype)t.prototype.__lookupGetter__(r)?n.__defineGetter__(r,t.prototype.__lookupGetter__(r)):n[r]=t.prototype[r];return t.prototype=n,t.prototype.super=e,t},$R.error=function(t){throw t},$R.extend=function(){var t={},e=!1,i=0,n=arguments.length;"[object Boolean]"===Object.prototype.toString.call(arguments[0])&&(e=arguments[0],i++);for(var r=function(i){for(var n in i)Object.prototype.hasOwnProperty.call(i,n)&&(e&&"[object Object]"===Object.prototype.toString.call(i[n])?t[n]=$R.extend(!0,t[n],i[n]):t[n]=i[n])};i<n;i++)r(arguments[i]);return t},$R.opts={animation:!0,lang:"en",direction:"ltr",spellcheck:!0,structure:!1,scrollTarget:!1,styles:!0,stylesClass:"redactor-styles",placeholder:!1,source:!0,showSource:!1,inline:!1,breakline:!1,markup:"p",enterKey:!0,clickToEdit:!1,clickToSave:!1,clickToCancel:!1,focus:!1,focusEnd:!1,minHeight:!1,maxHeight:!1,maxWidth:!1,plugins:[],callbacks:{},preClass:!1,preSpaces:4,tabindex:!1,tabAsSpaces:!1,tabKey:!0,autosave:!1,autosaveName:!1,autosaveData:!1,autosaveMethod:"post",toolbar:!0,toolbarFixed:!0,toolbarFixedTarget:document,toolbarFixedTopOffset:0,toolbarExternal:!1,toolbarContext:!0,air:!1,formatting:["p","blockquote","pre","h1","h2","h3","h4","h5","h6"],formattingAdd:!1,formattingHide:!1,buttons:["html","format","bold","italic","deleted","lists","image","file","link"],buttonsTextLabeled:!1,buttonsAdd:[],buttonsAddFirst:[],buttonsAddAfter:!1,buttonsAddBefore:!1,buttonsHide:[],buttonsHideOnMobile:[],imageUpload:!1,imageUploadParam:"file",imageData:!1,imageEditable:!0,imageCaption:!0,imageLink:!0,imagePosition:!1,imageResizable:!1,imageFloatMargin:"10px",imageFigure:!0,imageObserve:!0,imageSrcData:!1,fileUpload:!1,fileUploadParam:"file",fileData:!1,fileAttachment:!1,uploadData:!1,dragUpload:!0,multipleUpload:!0,clipboardUpload:!0,uploadBase64:!1,linkTarget:!1,linkTitle:!1,linkNewTab:!0,linkNofollow:!1,linkSize:30,linkValidation:!0,cleanOnEnter:!0,cleanInlineOnEnter:!1,paragraphize:!0,removeScript:!0,removeNewLines:!1,removeComments:!0,replaceTags:{b:"strong",i:"em",strike:"del"},pastePlainText:!1,pasteLinkTarget:!1,pasteImages:!0,pasteLinks:!0,pasteClean:!0,pasteKeepStyle:[],pasteKeepClass:[],pasteKeepAttrs:["td","th"],pasteBlockTags:["pre","h1","h2","h3","h4","h5","h6","table","tbody","thead","tfoot","th","tr","td","ul","ol","li","blockquote","p","figure","figcaption"],pasteInlineTags:["a","img","br","strong","ins","code","del","span","samp","kbd","sup","sub","mark","var","cite","small","b","u","em","i","abbr"],activeButtons:{b:"bold",strong:"bold",i:"italic",em:"italic",del:"deleted",strike:"deleted",u:"underline"},activeButtonsAdd:{},activeButtonsObservers:{},autoparse:!0,autoparseStart:!0,autoparsePaste:!0,autoparseLinks:!0,autoparseImages:!0,autoparseVideo:!0,autoparseHttps:!1,shortcodes:{"p.":{format:"p"},"quote.":{format:"blockquote"},"pre.":{format:"pre"},"h1.":{format:"h1"},"h2.":{format:"h2"},"h3.":{format:"h3"},"h4.":{format:"h4"},"h5.":{format:"h5"},"h6.":{format:"h6"},"*.":{format:"ul"}},shortcodesAdd:!1,shortcuts:{"ctrl+shift+m, meta+shift+m":{api:"module.inline.clearformat"},"ctrl+b, meta+b":{api:"module.inline.format",args:"b"},"ctrl+i, meta+i":{api:"module.inline.format",args:"i"},"ctrl+u, meta+u":{api:"module.inline.format",args:"u"},"ctrl+h, meta+h":{api:"module.inline.format",args:"sup"},"ctrl+l, meta+l":{api:"module.inline.format",args:"sub"},"ctrl+k, meta+k":{api:"module.link.open"},"ctrl+alt+0, meta+alt+0":{api:"module.block.format",args:"p"},"ctrl+alt+1, meta+alt+1":{api:"module.block.format",args:"h1"},"ctrl+alt+2, meta+alt+2":{api:"module.block.format",args:"h2"},"ctrl+alt+3, meta+alt+3":{api:"module.block.format",args:"h3"},"ctrl+alt+4, meta+alt+4":{api:"module.block.format",args:"h4"},"ctrl+alt+5, meta+alt+5":{api:"module.block.format",args:"h5"},"ctrl+alt+6, meta+alt+6":{api:"module.block.format",args:"h6"},"ctrl+shift+7, meta+shift+7":{api:"module.list.toggle",args:"ol"},"ctrl+shift+8, meta+shift+8":{api:"module.list.toggle",args:"ul"}},shortcutsAdd:!1,grammarly:!0,notranslate:!1,bufferLimit:100,emptyHtml:"<p></p>",markerChar:"\ufeff",imageTypes:["image/png","image/jpeg","image/gif"],imageAttrs:["alt","title","src","class","width","height","srcset"],inlineTags:["a","span","strong","strike","b","u","em","i","code","del","ins","samp","kbd","sup","sub","mark","var","cite","small","abbr"],blockTags:["pre","ul","ol","li","p","h1","h2","h3","h4","h5","h6","dl","dt","dd","div","table","tbody","thead","tfoot","tr","th","td","blockquote","output","figcaption","figure","address","section","header","footer","aside","article","iframe"],regex:{youtube:/https?:\/\/(?:[0-9A-Z-]+\.)?(?:youtu\.be\/|youtube\.com\S*[^\w-\s])([\w-]{11})(?=[^\w-]|$)(?![?=&+%\w.-]*(?:['"][^<>]*>|<\/a>))[?=&+%\w.-]*/gi,vimeo:/(http|https)?:\/\/(?:www.|player.)?vimeo.com\/(?:channels\/(?:\w+\/)?|groups\/(?:[^\/]*)\/videos\/|album\/(?:\d+)\/video\/|video\/|)(\d+)(?:\/[a-zA-Z0-9_-]+)?/gi,imageurl:/((https?|www)[^\s]+\.)(jpe?g|png|gif)(\?[^\s-]+)?/gi,url:/https?:\/\/(www\.)?[-a-zA-Z0-9@:%._+~#=]{1,256}\.[a-zA-Z0-9()]{1,6}\b([-a-zA-Z\u00F0-\u02AF0-9()!@:%_+.~#?&\/\/=]*)/gi,aurl1:/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim,aurl2:/(^|[^\/])(www\.[\S]+(\b|$))/gim},input:!0,zindex:!1,modes:{inline:{pastePlainText:!0,pasteImages:!1,enterKey:!1,toolbar:!1,autoparse:!1,source:!1,showSource:!1,styles:!1,air:!1},original:{styles:!1}}},$R.lang.en={format:"Format",image:"Image",file:"File",link:"Link",bold:"Bold",italic:"Italic",deleted:"Strikethrough",underline:"Underline",superscript:"Superscript",subscript:"Subscript","bold-abbr":"B","italic-abbr":"I","deleted-abbr":"S","underline-abbr":"U","superscript-abbr":"Sup","subscript-abbr":"Sub",lists:"Lists","link-insert":"Insert Link","link-edit":"Edit Link","link-in-new-tab":"Open link in new tab",unlink:"Unlink",cancel:"Cancel",close:"Close",insert:"Insert",save:"Save",delete:"Delete",text:"Text",edit:"Edit",title:"Alt",paragraph:"Normal text",quote:"Quote",code:"Code",heading1:"Heading 1",heading2:"Heading 2",heading3:"Heading 3",heading4:"Heading 4",heading5:"Heading 5",heading6:"Heading 6",filename:"Name",optional:"optional",unorderedlist:"Unordered List",orderedlist:"Ordered List",outdent:"Outdent",indent:"Indent",horizontalrule:"Line",upload:"Upload","upload-label":"Drop files here or click to upload","accessibility-help-label":"Rich text editor",caption:"Caption",bulletslist:"Bullets",numberslist:"Numbers","image-position":"Position",none:"None",left:"Left",right:"Right",center:"Center",undo:"Undo",redo:"Redo"},$R.buttons={html:{title:"HTML",icon:!0,api:"module.source.toggle"},undo:{title:"## undo ##",icon:!0,api:"module.buffer.undo"},redo:{title:"## redo ##",icon:!0,api:"module.buffer.redo"},format:{title:"## format ##",icon:!0,dropdown:{p:{title:"## paragraph ##",api:"module.block.format",args:{tag:"p"}},blockquote:{title:"## quote ##",api:"module.block.format",args:{tag:"blockquote"}},pre:{title:"## code ##",api:"module.block.format",args:{tag:"pre"}},h1:{title:"## heading1 ##",api:"module.block.format",args:{tag:"h1"}},h2:{title:"## heading2 ##",api:"module.block.format",args:{tag:"h2"}},h3:{title:"## heading3 ##",api:"module.block.format",args:{tag:"h3"}},h4:{title:"## heading4 ##",api:"module.block.format",args:{tag:"h4"}},h5:{title:"## heading5 ##",api:"module.block.format",args:{tag:"h5"}},h6:{title:"## heading6 ##",api:"module.block.format",args:{tag:"h6"}}}},bold:{title:"## bold-abbr ##",icon:!0,tooltip:"## bold ##",api:"module.inline.format",args:{tag:"b"}},italic:{title:"## italic-abbr ##",icon:!0,tooltip:"## italic ##",api:"module.inline.format",args:{tag:"i"}},deleted:{title:"## deleted-abbr ##",icon:!0,tooltip:"## deleted ##",api:"module.inline.format",args:{tag:"del"}},underline:{title:"## underline-abbr ##",icon:!0,tooltip:"## underline ##",api:"module.inline.format",args:{tag:"u"}},sup:{title:"## superscript-abbr ##",icon:!0,tooltip:"## superscript ##",api:"module.inline.format",args:{tag:"sup"}},sub:{title:"## subscript-abbr ##",icon:!0,tooltip:"## subscript ##",api:"module.inline.format",args:{tag:"sub"}},lists:{title:"## lists ##",icon:!0,observe:"list",dropdown:{observe:"list",unorderedlist:{title:"&bull; ## unorderedlist ##",api:"module.list.toggle",args:"ul"},orderedlist:{title:"1. ## orderedlist ##",api:"module.list.toggle",args:"ol"},outdent:{title:"< ## outdent ##",api:"module.list.outdent"},indent:{title:"> ## indent ##",api:"module.list.indent"}}},ul:{title:"&bull; ## bulletslist ##",icon:!0,api:"module.list.toggle",observe:"list",args:"ul"},ol:{title:"1. ## numberslist ##",icon:!0,api:"module.list.toggle",observe:"list",args:"ol"},outdent:{title:"## outdent ##",icon:!0,api:"module.list.outdent",observe:"list"},indent:{title:"## indent ##",icon:!0,api:"module.list.indent",observe:"list"},image:{title:"## image ##",icon:!0,api:"module.image.open"},file:{title:"## file ##",icon:!0,api:"module.file.open"},link:{title:"## link ##",icon:!0,observe:"link",dropdown:{observe:"link",link:{title:"## link-insert ##",api:"module.link.open"},unlink:{title:"## unlink ##",api:"module.link.unlink"}}},line:{title:"## horizontalrule ##",icon:!0,api:"module.line.insert"}};var App=function(t,e,i){this.module={},this.plugin={},this.instances={},this.started=!1,this.stopped=!1,this.uuid=i,this.rootElement=t,this.rootOpts=e,this.dragInside=!1,this.dragComponentInside=!1,this.keycodes=$R.keycodes,this.namespace="redactor",this.$win=$R.dom(window),this.$doc=$R.dom(document),this.$body=$R.dom("body"),this.editorReadOnly=!1,this.opts=$R.create("service.options",e,t),this.lang=$R.create("service.lang",this),this.buildServices(),this.buildModules(),this.buildPlugins(),this.start()};App.prototype={start:function(){this.stopped=!1,this.broadcast("start"),this.broadcast("startcode"),this.opts.clickToEdit?this.broadcast("startclicktoedit"):(this.broadcast("enable"),this.opts.showSource&&this.broadcast("startcodeshow"),this.broadcast("enablefocus")),this.broadcast("started"),this.started=!0},stop:function(){this.started=!1,this.stopped=!0,this.broadcast("stop"),this.broadcast("disable"),this.broadcast("stopped")},isStarted:function(){return this.started},isStopped:function(){return this.stopped},buildServices:function(){var t=["options","lang"],e=["uuid","keycodes","opts","lang","$win","$doc","$body"],i=[];for(var n in $R.services)-1===t.indexOf(n)&&(this[n]=$R.create("service."+n,this),i.push(n),e.push(n));for(var r=0;r<i.length;r++)for(var o=i[r],a=0;a<e.length;a++){var s=e[a];o!==s&&(this[o][s]=this[s])}},buildModules:function(){for(var t in $R.modules)this.module[t]=$R.create("module."+t,this),this.instances[t]=this.module[t]},buildPlugins:function(){for(var t=this.opts.plugins,e=0;e<t.length;e++){var i=t[e];void 0!==$R.plugins[i]&&(this.plugin[i]=$R.create("plugin."+i,this),this.instances[i]=this.plugin[i])}},isDragInside:function(){return this.dragInside},setDragInside:function(t){this.dragInside=t},isDragComponentInside:function(){return this.dragComponentInside},setDragComponentInside:function(t){this.dragComponentInside=t},getDragComponentInside:function(){return this.dragComponentInside},isReadOnly:function(){return this.editorReadOnly},enableReadOnly:function(){this.editorReadOnly=!0,this.broadcast("enablereadonly"),this.component.clearActive(),this.toolbar.disableButtons()},disableReadOnly:function(){this.editorReadOnly=!1,this.broadcast("disablereadonly"),this.toolbar.enableButtons()},callMessageHandler:function(t,e,i){var n,r=e.split(".");if(1===r.length)"function"==typeof t["on"+e]&&(n=t["on"+e].apply(t,i));else{r[0]="on"+r[0];var o=this.utils.checkProperty(t,r);"function"==typeof o&&(n=o.apply(t,i))}return n},broadcast:function(t){var e,i=[].slice.call(arguments,1);for(var n in this.instances){var r=this.callMessageHandler(this.instances[n],t,i);void 0!==r&&(e=r)}var o=this.callback.trigger(t,i);return void 0!==e?e:o},on:function(t,e){this.callback.add(t,e)},off:function(t,e){this.callback.remove(t,e)},api:function(t){if((this.isStarted()||"start"===t)&&(!this.isReadOnly()||"disableReadOnly"===t)){this.broadcast("state");var e=[].slice.call(arguments,1),i=t.split("."),n=1===i.length,r="on"===i[0]||"off"===i[0],o=!r&&2===i.length,a="plugin"===i[0],s="module"===i[0];if(n){if("function"==typeof this[i[0]])return this.callInstanceMethod(this,i[0],e)}else{if(r)return"on"===i[0]?this.on(i[1],e[0]):this.off(i[1],e[0]||void 0);if(o){if(this.isInstanceExists(this,i[0]))return this.callInstanceMethod(this[i[0]],i[1],e);$R.error(new Error('Service "'+i[0]+'" not found'))}else if(a){if(this.isInstanceExists(this.plugin,i[1]))return this.callInstanceMethod(this.plugin[i[1]],i[2],e);$R.error(new Error('Plugin "'+i[1]+'" not found'))}else if(s){if(this.isInstanceExists(this.module,i[1]))return this.callInstanceMethod(this.module[i[1]],i[2],e);$R.error(new Error('Module "'+i[1]+'" not found'))}}}},isInstanceExists:function(t,e){return void 0!==t[e]},callInstanceMethod:function(t,e,i){if("function"==typeof t[e])return t[e].apply(t,i)}},$R.add("mixin","formatter",{buildArgs:function(t){this.args={class:t.class||!1,style:t.style||!1,attr:t.attr||!1},this.args.class||this.args.style||this.args.attr||(this.args=!1)},applyArgs:function(t,e){return this.args?this[this.type](this.args,!1,t,e):this._clearAll(t,e)},clearClass:function(t,e){this.selection.save();var i=e?$R.dom(e):this.getElements(t,!0);return i.removeAttr("class"),e=this._unwrapSpanWithoutAttr(i.getAll()),this.selection.restore(),e},clearStyle:function(t,e){this.selection.save();var i=e?$R.dom(e):this.getElements(t,!0);return i.removeAttr("style"),e=this._unwrapSpanWithoutAttr(i.getAll()),this.selection.restore(),e},clearAttr:function(t,e){this.selection.save();var i=e?$R.dom(e):this.getElements(t,!0);return this._removeAllAttr(i),e=this._unwrapSpanWithoutAttr(i.getAll()),this.selection.restore(),e},set:function(t,e,i,n){!1!==n&&this.selection.save();var r=i?$R.dom(i):this.getElements(e);return t.class&&(r.removeAttr("class"),r.addClass(t.class)),t.style&&(r.removeAttr("style"),r.css(t.style),r.each((function(t){var e=$R.dom(t);e.attr("data-redactor-style-cache",e.attr("style"))}))),t.attr&&(this._removeAllAttr(r),r.attr(t.attr)),!1!==n&&this.selection.restore(),r.getAll()},toggle:function(t,e,i,n){!1!==n&&this.selection.save();var r,o=i?$R.dom(i):this.getElements(e);return t.class&&(o.toggleClass(t.class),o.each((function(t){""===t.className&&t.removeAttribute("class")}))),t.style&&(r=t.style,o.each(function(t){var e=$R.dom(t);for(var i in r){var n=r[i],o=e.css(i);o=this.utils.isRgb(o)?this.utils.rgb2hex(o):o.replace(/"/g,""),n=this.utils.isRgb(n)?this.utils.rgb2hex(n):n.replace(/"/g,""),o=this.utils.hex2long(o),("string"==typeof(n=this.utils.hex2long(n))?n.toLowerCase():n)===("string"==typeof o?o.toLowerCase():o)?e.css(i,""):e.css(i,n)}this._convertStyleQuotes(e),this.utils.removeEmptyAttr(t,"style")?e.removeAttr("data-redactor-style-cache"):e.attr("data-redactor-style-cache",e.attr("style"))}.bind(this))),t.attr&&(r=t.attr,o.each((function(t){var e=$R.dom(t);for(var i in r)e.attr(i)?e.removeAttr(i):e.attr(i,r[i])}))),!1!==n&&this.selection.restore(),o.getAll()},add:function(t,e,i,n){!1!==n&&this.selection.save();var r=i?$R.dom(i):this.getElements(e);if(t.class&&r.addClass(t.class),t.style){var o=t.style;r.each(function(t){var e=$R.dom(t);e.css(o),e.attr("data-redactor-style-cache",e.attr("style")),this._convertStyleQuotes(e)}.bind(this))}return t.attr&&r.attr(t.attr),!1!==n&&this.selection.restore(),r.getAll()},remove:function(t,e,i,n){!1!==n&&this.selection.save();var r=i?$R.dom(i):this.getElements(e);if(t.class&&(r.removeClass(t.class),r.each((function(t){""===t.className&&t.removeAttribute("class")}))),t.style){var o=t.style;r.each(function(t){var e=$R.dom(t);e.css(o,""),this.utils.removeEmptyAttr(t,"style")?e.removeAttr("data-redactor-style-cache"):e.attr("data-redactor-style-cache",e.attr("style"))}.bind(this))}return t.attr&&r.removeAttr(t.attr),i=this._unwrapSpanWithoutAttr(r.getAll()),!1!==n&&this.selection.restore(),i},_removeAllAttr:function(t){t.each((function(t){for(var e=t.attributes.length;e-- >0;){var i=t.attributes[e],n=i.name;"style"!==n&&"class"!==n&&t.removeAttributeNode(i)}}))},_convertStyleQuotes:function(t){var e=t.attr("style");e&&t.attr("style",e.replace(/"/g,"'"))},_clearAll:function(t,e){!1!==e&&this.selection.save();for(var i=0;i<t.length;i++)for(var n=t[i];n.attributes.length>0;)n.removeAttribute(n.attributes[0].name);return t=this._unwrapSpanWithoutAttr(t),!1!==e&&this.selection.restore(),t},_unwrapSpanWithoutAttr:function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i];n.attributes.length<=0&&3!==n.nodeType&&"SPAN"===n.tagName?$R.dom(n).unwrap():e.push(n)}return e}}),$R.add("mixin","dom",$R.Dom.prototype),$R.add("mixin","component",{get cmnt(){return!0}}),$R.add("service","options",{init:function(t,e){var i=$R.dom(e),n=$R.extend({},$R.opts,e?i.data():{},$R.options);return $R.extend(!0,n,t)}}),$R.add("service","lang",{init:function(t){this.app=t,this.opts=t.opts,this.vars=this._build(this.opts.lang)},rebuild:function(t){this.opts.lang=t,this.vars=this._build(t)},extend:function(t){this.vars=$R.extend(this.vars,t)},parse:function(t){if(void 0===t)return"";var e=t.match(/## (.*?) ##/g);if(e)for(var i=0;i<e.length;i++){var n=e[i].replace(/^##\s/g,"").replace(/\s##$/g,"");t=t.replace(e[i],this.get(n))}return t},get:function(t){var e="";return void 0!==this.vars[t]?e=this.vars[t]:"en"!==this.opts.lang&&void 0!==$R.lang.en[t]&&(e=$R.lang.en[t]),e},_build:function(t){var e=$R.lang.en;return"en"!==t&&(e=void 0!==$R.lang[t]?$R.lang[t]:e),e}}),$R.add("service","callback",{init:function(t){this.app=t,this.opts=t.opts,this.callbacks={},this.opts.callbacks&&this._set(this.opts.callbacks,"")},stop:function(){this.callbacks={}},add:function(t,e){this.callbacks[t]||(this.callbacks[t]=[]),this.callbacks[t].push(e)},remove:function(t,e){if(void 0===e)delete this.callbacks[t];else{for(var i=0;i<this.callbacks[t].length;i++)this.callbacks[t].splice(i,1);0===Object.keys(this.callbacks[t]).length&&delete this.callbacks[t]}},trigger:function(t,e){var i=this._loop(t,e,this.callbacks);return void 0===i&&e&&!1!==e[0]?e[0]:i},_set:function(t,e){for(var i in t){var n=""===e?i:e+"."+i;"object"==typeof t[i]?this._set(t[i],n):(this.callbacks[n]=[],this.callbacks[n].push(t[i]))}},_loop:function(t,e,i){var n;for(var r in i)if(t===r)for(var o=0;o<i[r].length;o++)n=i[r][o].apply(this.app,e);return n}}),$R.add("service","animate",{init:function(t){this.animationOpt=t.opts.animation},start:function(t,e,i,n){var r={duration:!1,iterate:!1,delay:!1,timing:!1,prefix:"redactor-"};return r="function"==typeof i?r:$R.extend(r,i),n="function"==typeof i?i:n,new $R.AnimatePlay(t,e,r,n,this.animationOpt)},stop:function(t){this.$el=$R.dom(t),this.$el.removeClass("redactor-animated");var e=this.$el.attr("redactor-animate-effect");this.$el.removeClass(e),this.$el.removeAttr("redactor-animate-effect");var i=this.$el.attr("redactor-animate-hide");i&&this.$el.addClass(i).removeAttr("redactor-animate-hide"),this.$el.off("animationend webkitAnimationEnd")}}),$R.AnimatePlay=function(t,e,i,n,r){return this.hidableEffects=["fadeOut","flipOut","slideUp","zoomOut","slideOutUp","slideOutRight","slideOutLeft"],this.prefixes=["","-webkit-"],this.$el=$R.dom(t),this.$body=$R.dom("body"),this.callback=n,this.animation=r?e:this.buildAnimationOff(e),this.defaults=i,"slideUp"===this.animation&&this.$el.height(this.$el.height()),this.isInanimate()?this.inanimate():this.animate()},$R.AnimatePlay.prototype={buildAnimationOff:function(t){return this.isHidable(t)?"hide":"show"},buildHideClass:function(){return"redactor-animate-hide"},isInanimate:function(){return"show"===this.animation||"hide"===this.animation},isAnimated:function(){return this.$el.hasClass("redactor-animated")},isHidable:function(t){return-1!==this.hidableEffects.indexOf(t)},inanimate:function(){var t;return this.defaults.timing="linear","show"===this.animation?(t=this.buildHideClass(),this.$el.attr("redactor-animate-hide",t),this.$el.removeClass(t)):(t=this.$el.attr("redactor-animate-hide"),this.$el.addClass(t).removeAttr("redactor-animate-hide")),"function"==typeof this.callback&&this.callback(this),this},animate:function(){var t=this.defaults.delay?this.defaults.delay:0;return setTimeout(function(){if(this.$body.addClass("no-scroll-x"),this.$el.addClass("redactor-animated"),!this.$el.attr("redactor-animate-hide")){var t=this.buildHideClass();this.$el.attr("redactor-animate-hide",t),this.$el.removeClass(t)}this.$el.addClass(this.defaults.prefix+this.animation),this.$el.attr("redactor-animate-effect",this.defaults.prefix+this.animation),this.set(this.defaults.duration+"s",this.defaults.iterate,this.defaults.timing),this.complete()}.bind(this),1e3*t),this},set:function(t,e,i){for(var n=this.prefixes.length;n--;)!1===t&&""!==t||this.$el.css(this.prefixes[n]+"animation-duration",t),!1===e&&""!==e||this.$el.css(this.prefixes[n]+"animation-iteration-count",e),!1===i&&""!==i||this.$el.css(this.prefixes[n]+"animation-timing-function",i)},clean:function(){this.$body.removeClass("no-scroll-x"),this.$el.removeClass("redactor-animated"),this.$el.removeClass(this.defaults.prefix+this.animation),this.$el.removeAttr("redactor-animate-effect"),this.set("","","")},complete:function(){this.$el.one("animationend webkitAnimationEnd",function(){if(this.$el.hasClass(this.defaults.prefix+this.animation)&&this.clean(),this.isHidable(this.animation)){var t=this.$el.attr("redactor-animate-hide");this.$el.addClass(t).removeAttr("redactor-animate-hide")}"slideUp"===this.animation&&this.$el.height(""),"function"==typeof this.callback&&this.callback(this.$el)}.bind(this))}},$R.add("service","caret",{init:function(t){this.app=t},setStart:function(t){this._setCaret("Start",t)},setEnd:function(t){this._setCaret("End",t)},setBefore:function(t){this._setCaret("Before",t)},setAfter:function(t){this._setCaret("After",t)},isStart:function(t){return this._isStartOrEnd(t,"First")},isEnd:function(t){return this._isStartOrEnd(t,"Last")},setAtEnd:function(t){var e=this.inspector.parse(t).getTag(),i=document.createRange();if(this._isInPage(t)){if("a"===e){var n=this.utils.createInvisibleChar();$R.dom(t).after(n),i.selectNodeContents(n),i.collapse(!0)}else i.selectNodeContents(t),i.collapse(!1);this.selection.setRange(i)}},setAtStart:function(t){var e=document.createRange(),i=this.inspector.parse(t);if(this._isInPage(t)){if(e.setStart(t,0),e.collapse(!0),i.isInline()||this.utils.isEmpty(t)){var n=this.utils.createInvisibleChar();e.insertNode(n),e.selectNodeContents(n),e.collapse(!1)}this.selection.setRange(e)}},setAtBefore:function(t){var e=this.inspector.parse(t),i=document.createRange();if(this._isInPage(t)){if(i.setStartBefore(t),i.collapse(!0),e.isInline()){var n=this.utils.createInvisibleChar();t.parentNode.insertBefore(n,t),i.selectNodeContents(n),i.collapse(!1)}this.selection.setRange(i)}},setAtAfter:function(t){var e=document.createRange();if(this._isInPage(t)){e.setStartAfter(t),e.collapse(!0);var i=this.utils.createInvisibleChar();e.insertNode(i),e.selectNodeContents(i),e.collapse(!1),this.selection.setRange(e)}},setAtPrev:function(t){var e=t.previousSibling;e&&(e=3===e.nodeType&&this._isEmptyTextNode(e)?e.previousElementSibling:e)&&this.setEnd(e)},setAtNext:function(t){var e=t.nextSibling;e&&(e=3===e.nodeType&&this._isEmptyTextNode(e)?e.nextElementSibling:e)&&this.setStart(e)},_setCaret:function(t,e){var i=this.inspector.parse(e),n=i.getNode();n&&(this.component.clearActive(),this["_set"+t](n,i,i.getTag()))},_setStart:function(t,e,i){if(e.isText())return this.editor.focus(),this.setAtStart(t);if("ul"===i||"ol"===i){t=e.findFirstNode("li");var n=this.utils.getFirstElement(t),r=this.inspector.parse(n);if(n&&r.isComponent())return this.setStart(r.getComponent())}else if("dl"===i)t=e.findFirstNode("dt");else{if("br"===i||"hr"===i)return this.setBefore(t);if("td"===i||"th"===i){var o=e.getFirstElement(t);if(o)return this.setStart(o)}else{if("table"===i||"tr"===i)return this.setStart(e.findFirstNode("th, td"));if(e.isComponentType("code")&&!e.isFigcaption()){var a=e.findLastNode("pre, code");return this.editor.focus(),this.setAtStart(a)}if("figure"===i&&e.isComponentType("table")){var s=e.getTable(),l=this.inspector.parse(s);return this.setStart(l.findFirstNode("th, td"))}if(!e.isComponentType("table")&&e.isComponent()&&!e.isFigcaption())return this.component.setActive(t)}}this.editor.focus(),this._setInline(t,"Start")||this.setAtStart(t)},_setEnd:function(t,e,i){if(e.isText())return this.editor.focus(),this.setAtEnd(t);if("ul"===i||"ol"===i){t=e.findLastNode("li");var n=this.utils.getLastElement(t),r=this.inspector.parse(n);if(n&&r.isComponent())return this.setEnd(r.getComponent())}else if("dl"===i)t=e.findLastNode("dd");else{if("br"===i||"hr"===i)return this.setAfter(t);if("td"===i||"th"===i){var o=e.getLastElement();if(o)return this.setEnd(o)}else{if("table"===i||"tr"===i)return this.setEnd(e.findLastNode("th, td"));if(e.isComponentType("code")&&!e.isFigcaption()){var a=e.findLastNode("pre, code");return this.editor.focus(),this.setAtEnd(a)}if("figure"===i&&e.isComponentType("table")){var s=e.getTable(),l=this.inspector.parse(s);return this.setEnd(l.findLastNode("th, td"))}if(!e.isComponentType("table")&&e.isComponent()&&!e.isFigcaption())return this.component.setActive(t)}}if(this.editor.focus(),!this._setInline(t,"End")){if(this.utils.isEmpty(t))return this.setStart(t);this.setAtEnd(t)}},_setBefore:function(t,e,i){return 3===t.nodeType||e.isInline()?this.setAtBefore(t):e.isFirstTableCell()?this.setAtPrev(e.getComponent()):"td"===i||"th"===i?this.setAtPrev(t):e.isFirstListItem()?this.setAtPrev(e.getList()):e.isFigcaption()?this.setStart(e.getComponent()):!e.isComponentType("table")&&e.isComponent()?this.setAtPrev(e.getComponent()):e.isBlock()?this.setAtPrev(t):(this.editor.focus(),void this.setAtBefore(t))},_setAfter:function(t,e,i){return 3===t.nodeType||e.isInline()?this.setAtAfter(t):e.isLastTableCell()?this.setAtNext(e.getComponent()):"td"===i||"th"===i?this.setAtNext(t):e.isFirstListItem()?this.setAtNext(e.getList()):!e.isComponentType("table")&&e.isComponent()?this.setAtNext(e.getComponent()):e.isBlock()?this.setAtNext(t):(this.editor.focus(),void this.setAtAfter(t))},_setInline:function(t,e){var i=this._hasInlineChild(t,"Start"===e?"first":"last");if(i)return"Start"===e?this.setStart(i):this.setEnd(i),!0},_isStartOrEnd:function(t,e){var i=this.utils.getNode(t);if(!i)return!1;var n=this.inspector.parse(i);if((i=this._getStartEndNode(i,n,e))&&3!==i.nodeType&&"LI"!==i.tagName){var r=3===i.nodeType?i.textContent:i.innerHTML;if(""===(r=this.utils.trimSpaces(r)))return!0}if(!n.isFigcaption()&&n.isComponent()&&!n.isComponentEditable())return!0;var o=this.offset.get(i,!0);return!!o&&("First"===e?0===o.start:o.end===this.offset.size(i,!0))},_isInPage:function(t){return!(!t||!t.nodeType)&&t!==document.body&&document.body.contains(t)},_hasInlineChild:function(t,e){var i=this.inspector.parse(t),n="first"===e?i.getFirstNode():i.getLastNode(),r=$R.dom(n);if(n&&3!==n.nodeType&&this.inspector.isInlineTag(n.tagName)&&!r.hasClass("redactor-component")&&!r.hasClass("non-editable"))return n},_isEmptyTextNode:function(t){var e=t.textContent.trim().replace(/\n/,"");return""===this.utils.removeInvisibleChars(e)},_getStartEndNode:function(t,e,i){return e.isFigcaption()?t=e.getFigcaption():e.isTable()?t=e["find"+i+"Node"]("th, td"):e.isList()?t=e["find"+i+"Node"]("li"):e.isComponentType("code")&&(t=e.findLastNode("pre, code")),t}});var containsNode=function(t){return document.getSelection().containsNode(t,!0)},containsNodePolyfill=function(t){var e=document.getSelection(),i=e.anchorNode.parentNode,n=e.focusNode.parentNode,r=e.getRangeAt(0).getBoundingClientRect(),o=t.getBoundingClientRect();return!!$R.dom(i).closest(t).length||!!$R.dom(n).closest(t).length||r.top<o.top&&r.height>o.height};"containsNode"in Selection.prototype||(containsNode=containsNodePolyfill),$R.add("service","selection",{init:function(t){this.app=t},is:function(){var t=this.get();if(t){var e=t.anchorNode;return 0!==$R.dom(e).closest(".redactor-in-"+this.uuid).length||e===this.editor.getElement().get()}return!1},isCollapsed:function(){var t=this.get(),e=this.getRange();return!(!t||!t.isCollapsed)||!(!e||0!==e.toString().length)},isBackwards:function(){var t=!1,e=this.get();if(e&&!e.isCollapsed){var i=document.createRange();i.setStart(e.anchorNode,e.anchorOffset),i.setEnd(e.focusNode,e.focusOffset),t=i.collapsed,i.detach()}return t},isIn:function(t){var e=$R.dom(t).get(),i=this.getCurrent();return!(!i||!e)&&e.contains(i)},isText:function(){var t=this.get();if(t){var e=t.anchorNode,i=this.getBlock(e),n=this.getBlocks();if(i&&this.inspector.isTableCellTag(i.tagName)||!1===i&&0===n.length)return!0}return!1},isAll:function(t){var e=this.utils.getNode(t);if(!e)return!1;var i=this.editor.isEditor(e),n=this.inspector.parse(e);if(!n.isFigcaption()&&this.component.isNonEditable(e)&&this.component.isActive(e))return!0;if(i){var r=this.editor.getElement().html().replace(/<p><\/p>$/i,"");if(this.getHtml(!1).length!==r.length)return!1}if(i&&this.editor.isEmpty()||this.isCollapsed())return!1;var o=this.offset.get(e,!0),a=this.offset.size(e,!0);return!i&&n.isComponentType("code")&&(a=this.getText().trim().length),!(!o||0!==o.start||o.end!==a)},hasNonEditable:function(){var t=this.getHtml(),e=$R.dom("<div>").html(t);return!this.isCollapsed()&&0!==e.find(".non-editable").length},setRange:function(t){var e=window.getSelection();e.removeAllRanges(),e.addRange(t)},setAll:function(t){var e=this.utils.getNode(t);if(e){var i=this.inspector.parse(e);if(this.component.clearActive(),this.editor.focus(),this.editor.saveScroll(),this.editor.disableNonEditables(),e&&"TABLE"===e.tagName){var n=i.findFirstNode("td, th"),r=i.findLastNode("td, th");$R.dom(n).prepend(this.marker.build("start")),$R.dom(r).append(this.marker.build("end")),this.restoreMarkers()}else if(!i.isFigcaption()&&this.component.isNonEditable(e))this.component.setActive(e);else{i.isComponentType("code")&&(e=i.getComponentCodeElement()).focus();var o=document.createRange();o.selectNodeContents(e),this.setRange(o)}this.editor.enableNonEditables(),this.editor.restoreScroll()}},get:function(){var t=window.getSelection();return t.rangeCount>0?t:null},getRange:function(){var t=this.get();return t&&t.getRangeAt(0)?t.getRangeAt(0):null},getTextBeforeCaret:function(t){t=void 0===t?1:t;var e=this.editor.getElement().get(),i=this.getRange(),n=!1;return i&&((i=i.cloneRange()).collapse(!0),i.setStart(e,0),n=i.toString().slice(-t)),n},getTextAfterCaret:function(t){t=void 0===t?1:t;var e=this.editor.getElement().get(),i=this.getRange(),n=!1;if(i){var r=i.cloneRange();r.selectNodeContents(e),r.setStart(i.endContainer,i.endOffset),n=r.toString().slice(0,t)}return n},getPosition:function(){var t=this.getRange(),e={top:0,left:0,width:0,height:0};if(window.getSelection&&t.getBoundingClientRect){var i=(t=t.cloneRange()).startOffset-1;t.setStart(t.startContainer,i<0?0:i);var n=t.getBoundingClientRect();e={top:n.top,left:n.left,width:n.right-n.left,height:n.bottom-n.top}}return e},getCurrent:function(){var t=!1,e=this.get(),i=this.component.getActive();return i?t=i:e&&this.is()&&(t=e.anchorNode!==this.editor.getElement().get()&&e.anchorNode),t},getParent:function(){var t=!1,e=this.getCurrent();if(e){var i=e.parentNode;t=i!==this.editor.getElement().get()&&i}return t},getElement:function(t){for(var e=t||this.getCurrent();e;){var i=this.inspector.parse(e);if(i.isElement()&&i.isInEditor())return e;e=e.parentNode}return!1},getInline:function(t){for(var e=t||this.getCurrent(),i=!1;e;)this._isInlineNode(e)&&(i=e),e=e.parentNode;return i},getInlineFirst:function(t){for(var e=t||this.getCurrent();e;){if(this._isInlineNode(e))return e;e=e.parentNode}return!1},getInlineAll:function(t){for(var e=t||this.getCurrent(),i=[];e;)this._isInlineNode(e)&&i.push(e),e=e.parentNode;return i},getBlock:function(t){for(var e=t||this.getCurrent();e;){var i=this.inspector.parse(e);if(this.inspector.isBlockTag(e.tagName)&&i.isInEditor(e))return e;e=e.parentNode}return!1},getInlinesAllSelected:function(t){if(this.isAll())return[];var e=this.getInlines({all:!0,inside:!0}),i=this.getText().replace(/[-[\]\/{}()*+?.\\^$|]/g,"\\$&"),n=[];if(""===i)n=e;else if(e.length>1)for(var r=0;r<e.length;r++)this._isTextSelected(e[r],i)&&n.push(e[r]);else 1===e.length&&this._isTextSelected(e[0],i)&&(n=e);return t&&t.tags?this._filterNodesByTags(n,t.tags):n},getInlines:function(t){for(var e=this.getNodes(),i=[],n=0;n<e.length;n++){var r;if(t&&t.all)for(r=e[n];r;)this._isInlineNode(r)&&!this._isInNodesArray(i,r)&&i.push(r),r=r.parentNode;else(r=this.getInline(e[n]))&&!this._isInNodesArray(i,r)&&i.push(r)}return i=t&&t.tags?this._filterNodesByTags(i,t.tags):i,t&&t.inside?this._filterInlinesInside(i,t):i},getBlocks:function(t){var e=this.getNodes(),i=this.getBlock();e=0===e.length&&i?[i]:e;for(var n=[],r=0;r<e.length;r++){var o=this.getBlock(e[r]);$R.dom(o).hasClass("non-editable")||o&&!this._isInNodesArray(n,o)&&n.push(o)}return n=t&&t.tags?this._filterNodesByTags(n,t.tags):n,t&&t.first?this._filterBlocksFirst(n,t):n},getElements:function(t){var e=this.getNodes({textnodes:!1}),i=this.getBlock();e=0===e.length&&i?[i]:e;for(var n=[],r=0;r<e.length;r++)this._isInNodesArray(n,e[r])||n.push(e[r]);return t&&t.tags?this._filterNodesByTags(n,t.tags):n},getNodes:function(t){var e=[],i=this.component.getActive();if(i)e=this._getNodesComponent(i);else if(this.isCollapsed()){var n=this.getCurrent();e=n?[n]:[]}else this.is()&&!i&&(e=this._getRangeSelectedNodes());return e=this._filterServicesNodes(e),e=this._filterEditor(e),e=t&&t.tags?this._filterNodesByTags(e,t.tags):e,e=t&&t.textnodes?this._filterNodesTexts(e,t):e,t&&!t.textnodes?this._filterNodesElements(e):e},getText:function(){var t=this.get();return t?this.utils.removeInvisibleChars(t.toString()):""},getHtml:function(t){var e="",i=this.get();if(i){for(var n=document.createElement("div"),r=i.rangeCount,o=0;o<r;++o)n.appendChild(i.getRangeAt(o).cloneContents());e=n.innerHTML,e=(e=!1!==t?this.cleaner.output(e):e).replace(/<p><\/p>$/i,"")}return e},clear:function(){this.component.clearActive(),this.get().removeAllRanges()},collapseToStart:function(){var t=this.get();t&&!t.isCollapsed&&t.collapseToStart()},collapseToEnd:function(){var t=this.get();t&&!t.isCollapsed&&t.collapseToEnd()},saveActiveComponent:function(){var t=this.component.getActive();return!!t&&(this.savedComponent=t,!0)},restoreActiveComponent:function(){return!!this.savedComponent&&(this.component.setActive(this.savedComponent),!0)},save:function(){this._clearSaved();var t=this.getElement();!t||-1===["TD","TH","P","DIV","PRE","H1","H2","H3","H4","H5","H6","LI","BLOCKQUOTE"].indexOf(t.tagName)||""!==t.innerHTML&&"<br>"!==t.innerHTML?this.saveActiveComponent()||(this.saved=this.offset.get()):this.savedElement=t},restore:function(){(this.saved||this.savedComponent||this.savedElement)&&(this.editor.saveScroll(),this.savedElement?this.caret.setStart(this.savedElement):this.restoreActiveComponent()||this.offset.set(this.saved),this._clearSaved(),this.editor.restoreScroll())},saveMarkers:function(){this._clearSaved(),this.saveActiveComponent()||this.marker.insert()},restoreMarkers:function(){this.editor.saveScroll(),this.restoreActiveComponent()||this.marker.restore(),this._clearSaved(),this.editor.restoreScroll()},_getNextNode:function(t){if(t.hasChildNodes())return t.firstChild;for(;t&&!t.nextSibling;)t=t.parentNode;return t?t.nextSibling:null},_getNodesComponent:function(t){var e=this.getCurrent(),i=this.inspector.parse(e);return i.isFigcaption()?[i.getFigcaption()]:[t]},_getRangeSelectedNodes:function(){var t=[],e=this.getRange(),i=e.startContainer,n=e.startContainer,r=e.endContainer,o=this.editor.getElement();if(n===o.get()&&this.isAll())t=this.utils.getChildNodes(o);else if(i===r)t=[i];else{for(;i&&i!==r;)t.push(i=this._getNextNode(i));for(i=e.startContainer;i&&i!==e.commonAncestorContainer;)t.unshift(i),i=i.parentNode}return t},_isInNodesArray:function(t,e){return-1!==t.indexOf(e)},_filterEditor:function(t){for(var e=[],i=0;i<t.length;i++)this.inspector.parse(t[i]).isInEditor()&&e.push(t[i]);return e},_filterServicesNodes:function(t){for(var e=[],i=0;i<t.length;i++){var n=$R.dom(t[i]),r=!1;t[i]&&3===t[i].nodeType&&this.utils.isEmpty(t[i])&&(r=!0),(n.hasClass("redactor-script-tag")||n.hasClass("redactor-component-caret")||n.hasClass("redactor-selection-marker")||n.hasClass("non-editable"))&&(r=!0),r||e.push(t[i])}return e},_filterNodesTexts:function(t,e){for(var i=[],n=0;n<t.length;n++)(3===t[n].nodeType||e.keepbr&&"BR"===t[n].tagName)&&(this.getInline(t[n])&&e&&!1===e.inline||i.push(t[n]));return i},_filterNodesElements:function(t){for(var e=[],i=0;i<t.length;i++)3!==t[i].nodeType&&e.push(t[i]);return e},_filterNodesByTags:function(t,e,i){for(var n=[],r=0;r<t.length;r++)if(i&&3===t[r].nodeType)n.push(t[r]);else if(3!==t[r].nodeType){var o=t[r].tagName.toLowerCase();-1!==e.indexOf(o.toLowerCase())&&n.push(t[r])}return n},_filterBlocksFirst:function(t){for(var e=[],i=0;i<t.length;i++){var n=$R.dom(t[i]),r=n.parent().get(),o=n.parent().hasClass("redactor-in"),a=r&&("TD"===r.tagName||"TH"===r.tagName);(o||a)&&e.push(t[i])}return e},_filterInlinesInside:function(t){for(var e=[],i=0;i<t.length;i++)containsNode(t[i],!0)&&e.push(t[i]);return e},_isTextSelected:function(t,e){var i=9!==t.nodeType?this.utils.removeInvisibleChars(t.textContent):"";return e===i||-1!==i.search(e)||-1!==e.search(new RegExp("^"+this.utils.escapeRegExp(i)+"$"))},_isInlineNode:function(t){var e=this.inspector.parse(t);return this.inspector.isInlineTag(t.tagName)&&e.isInEditor()},_clearSaved:function(){this.saved=!1,this.savedComponent=!1,this.savedElement=!1}}),$R.add("service","element",{init:function(t){this.app=t,this.rootElement=t.rootElement,this.$element={},this.type="inline"},start:function(){this._build(),this._buildType()},isType:function(t){return t===this.type},getType:function(){return this.type},getElement:function(){return this.$element},_build:function(){this.$element=$R.dom(this.rootElement)},_buildType:function(){var t=this.$element.get().tagName;this.type="TEXTAREA"===t?"textarea":this.type,this.type="DIV"===t?"div":this.type,this.type=this.opts.inline?"inline":this.type}}),$R.add("service","editor",{init:function(t){this.app=t,this.scrolltop=!1,this.pasting=!1},start:function(){this._build()},focus:function(){this.isFocus()||this._isContenteditableFocus()||(this.saveScroll(),this.$editor.focus(),this.restoreScroll())},startFocus:function(){this.caret.setStart(this.getFirstNode())},endFocus:function(){this.caret.setEnd(this.getLastNode())},isPasting:function(){return this.pasting},enablePasting:function(){this.pasting=!0},disablePasting:function(){this.pasting=!1},saveScroll:function(){this.scrolltop=this._getScrollTarget().scrollTop(),this.opts.maxHeight&&(this.scrolltopin=this.$editor.scrollTop())},restoreScroll:function(){!1!==this.scrolltop&&(this._getScrollTarget().scrollTop(this.scrolltop),this.scrolltop=!1),this.scrolltopin&&(this.$editor.scrollTop(this.scrolltopin),this.scrolltopin=!1)},disableNonEditables:function(){this.$noneditables=this.$editor.find("[contenteditable=false]"),this.$noneditables.attr("contenteditable",!0)},enableNonEditables:function(){this.$noneditables&&setTimeout(function(){this.$noneditables.attr("contenteditable",!1)}.bind(this),1)},getFirstNode:function(){return this.$editor.contents()[0]},getLastNode:function(){var t=this.$editor.contents();return t[t.length-1]},isSourceMode:function(){return this.source.getElement().hasClass("redactor-source-open")},isEditor:function(t){return $R.dom(t).get()===this.$editor.get()},isEmpty:function(t){return this.utils.isEmptyHtml(this.$editor.html(),!1,t)},isFocus:function(){var t=$R.dom(document.activeElement);return 0!==this.$editor.find(".redactor-component-active").length||0!==t.closest(".redactor-in-"+this.uuid).length},setEmpty:function(){this.$editor.html(this.opts.emptyHtml)},getElement:function(){return this.$editor},_build:function(){var t=this.element.getElement(),e=this.element.isType("textarea")?"<div>":t.get();this.$editor=$R.dom(e)},_getScrollTarget:function(){var t=this.$doc;return this.opts.toolbarFixedTarget!==document?$R.dom(this.opts.toolbarFixedTarget):this.opts.scrollTarget?$R.dom(this.opts.scrollTarget):t},_isContenteditableFocus:function(){var t=this.selection.getBlock();return 0!==(t?$R.dom(t).closest("[contenteditable=true]").not(".redactor-in"):[]).length}}),$R.add("service","container",{init:function(t){this.app=t},start:function(){this._build()},getElement:function(){return this.$container},_build:function(){var t=this.element.isType("inline")?"<span>":"<div>";this.$container=$R.dom(t)}}),$R.add("service","source",{init:function(t){this.app=t,this.$source={},this.content=""},start:function(){this._build(),this._buildName(),this._buildStartedContent()},getElement:function(){return this.$source},getCode:function(){return this.$source.val()},getName:function(){return this.$source.attr("name")},getStartedContent:function(){return this.content},setCode:function(t){return this.insertion.set(t,!0,!1)},isNameGenerated:function(){return this.name},rebuildStartedContent:function(){this._buildStartedContent()},_build:function(){var t=this.element.getElement(),e=this.element.isType("textarea")?t.get():"<textarea>";this.$source=$R.dom(e)},_buildName:function(){var t=this.element.getElement();this.name=t.attr("name"),this.$source.attr("name",this.name?this.name:"content-"+this.uuid)},_buildStartedContent:function(){var t=this.element.getElement(),e=this.element.isType("textarea")?t.val():t.html();this.content=e.trim()}}),$R.add("service","statusbar",{init:function(t){this.app=t,this.$statusbar={},this.items=[]},start:function(){this.$statusbar=$R.dom("<ul>"),this.$statusbar.attr("dir",this.opts.direction)},add:function(t,e){return this.update(t,e)},update:function(t,e){var i;return void 0!==this.items[t]?i=this.items[t]:(i=$R.dom("<li>"),this.$statusbar.append(i),this.items[t]=i),i.html(e)},get:function(t){return!!this.items[t]&&this.items[t]},remove:function(t){this.items[t]&&(this.items[t].remove(),delete this.items[t])},getItems:function(){return this.items},removeItems:function(){this.items={},this.$statusbar.html("")},getElement:function(){return this.$statusbar}}),$R.add("service","toolbar",{init:function(t){this.app=t,this.buttons=[],this.dropdownOpened=!1,this.buttonsObservers={}},start:function(){this.is()&&(this.opts.activeButtons=this.opts.activeButtonsAdd?this._extendActiveButtons():this.opts.activeButtons,this.create())},stopObservers:function(){this.buttonsObservers={}},create:function(){this.$wrapper=$R.dom("<div>"),this.$toolbar=$R.dom("<div>")},observe:function(){if(this.is()){var t,e;for(var i in this.setButtonsInactive(),this.buttonsObservers)e=this.buttonsObservers[i],t=this.getButton(i),this.app.broadcast("button."+e+".observe",t);var n=this.opts.activeButtons,r=this.selection.getInlinesAllSelected(),o=this.selection.getInline(),a=this.selection.getInlineAll();this.selection.isCollapsed()&&(o&&r.push(o),0!==a.length&&(r=r.concat(a)));var s=this._inlinesToTags(r);for(var l in n)-1!==s.indexOf(l)&&(t=this.getButton(n[l]))&&t.setActive()}},is:function(){return!(!this.opts.toolbar||this.detector.isMobile()&&this.opts.air)},isAir:function(){return!!this.is()&&this.$toolbar.hasClass("redactor-air")},isFixed:function(){return!!this.is()&&this.$toolbar.hasClass("redactor-toolbar-fixed")},isContextBar:function(){return this.$body.find("#redactor-context-toolbar-"+this.uuid).hasClass("open")},isTarget:function(){return this.opts.toolbarFixedTarget!==document},getElement:function(){return this.$toolbar},getWrapper:function(){return this.$wrapper},getDropdown:function(){return this.dropdownOpened},getTargetElement:function(){return $R.dom(this.opts.toolbarFixedTarget)},getButton:function(t){var e=this._findButton(".re-"+t);return 0!==e.length&&e.dataget("data-button-instance")},getButtons:function(){var t=[];return this._findButtons().each((function(e){var i=$R.dom(e);t.push(i.dataget("data-button-instance"))})),t},getButtonsKeys:function(){var t=[];return this._findButtons().each((function(e){var i=$R.dom(e);t.push(i.attr("data-re-name"))})),t},addButton:function(t,e,i,n,r){i=i||"end";var o=$R.create("toolbar.button",this.app,t,e);if(e.observe&&(this.opts.activeButtonsObservers[t]={observe:e.observe,button:o}),this.is())if("first"===i)this.$toolbar.prepend(o);else if("after"===i)n.after(o);else if("before"===i)n.before(o);else{var a=this.opts.buttons.indexOf(t);if(!0!==r&&-1!==a)if(0===a)this.$toolbar.prepend(o);else{var s=this._findButtons().eq(a-1);s.length>0?s.after(o):this.$toolbar.append(o)}else this.$toolbar.append(o)}return o},addButtonFirst:function(t,e){return this.addButton(t,e,"first")},addButtonAfter:function(t,e,i){var n=this.getButton(t);return n?this.addButton(e,i,"after",n):this.addButton(e,i)},addButtonBefore:function(t,e,i){var n=this.getButton(t);return n?this.addButton(e,i,"before",n):this.addButton(e,i)},addButtonObserver:function(t,e){this.buttonsObservers[t]=e},setButtons:function(t){this.buttons=t},setDropdown:function(t){this.dropdownOpened=t},setButtonsInactive:function(){for(var t=this.getButtons(),e=0;e<t.length;e++)t[e].setInactive()},setButtonsActive:function(){for(var t=this.getButtons(),e=0;e<t.length;e++)t[e].setActive()},disableButtons:function(){for(var t=this.getButtons(),e=0;e<t.length;e++)t[e].disable()},enableButtons:function(){for(var t=this.getButtons(),e=0;e<t.length;e++)t[e].enable()},_findButton:function(t){return this.is()?this.$toolbar.find(t):$R.dom()},_findButtons:function(){return this.is()?this.$toolbar.find(".re-button"):$R.dom()},_extendActiveButtons:function(){return $R.extend({},this.opts.activeButtons,this.opts.activeButtonsAdd)},_inlinesToTags:function(t){for(var e=[],i=0;i<t.length;i++)e.push(t[i].tagName.toLowerCase());return e}}),$R.add("class","toolbar.button",{mixins:["dom"],init:function(t,e,i){this.app=t,this.opts=t.opts,this.lang=t.lang,this.$body=t.$body,this.toolbar=t.toolbar,this.detector=t.detector,this.obj=i,this.name=e,this.dropdown=!1,this.tooltip=!1,this._init()},isActive:function(){return this.hasClass("redactor-button-active")},isDisabled:function(){return this.hasClass("redactor-button-disabled")},hasIcon:function(){return this.obj.icon&&!this.opts.buttonsTextLabeled},setDropdown:function(t){this.obj.dropdown=t,this.obj.message=!1,this.dropdown=$R.create("toolbar.dropdown",this.app,this.name,this.obj.dropdown),this.attr("data-dropdown",!0)},setMessage:function(t,e){this.obj.message=t,this.obj.args=e,this.obj.dropdown=!1},setApi:function(t,e){this.obj.api=t,this.obj.args=e,this.obj.dropdown=!1},setTitle:function(t){this.obj.title=this.lang.parse(t),this.obj.tooltip=this.obj.title,this.attr({alt:this.obj.tooltip,"aria-label":this.obj.tooltip}),this.attr("data-re-icon")||this.html(this.obj.title)},setTooltip:function(t){this.obj.tooltip=this.lang.parse(t),this.attr({alt:this.obj.tooltip,"aria-label":this.obj.tooltip})},setIcon:function(t){this.opts.buttonsTextLabeled||(this.obj.icon=!0,this.$icon=$R.dom(t),this.html(""),this.append(this.$icon),this.attr("data-re-icon",!0),this.addClass("re-button-icon"),this.setTooltip(this.obj.title),this._buildTooltip())},setActive:function(){this.addClass("redactor-button-active")},setInactive:function(){this.removeClass("redactor-button-active")},hideTooltip:function(){this.$body.find(".re-button-tooltip").remove()},getDropdown:function(){return this.dropdown},disable:function(){this.addClass("redactor-button-disabled")},enable:function(){this.removeClass("redactor-button-disabled")},toggle:function(t){t&&t.preventDefault(),this.isDisabled()||(this.obj.dropdown?this.dropdown.toggle(t):this.obj.api?this.app.api(this.obj.api,this.obj.args,this.name):this.obj.message&&this.app.broadcast(this.obj.message,this.obj.args,this.name),this.hideTooltip())},_init:function(){this._parseTitle(),this._parseTooltip(),this._build(),this._buildCallback(),this._buildAttributes(),this._buildObserver(),this.hasIcon()?(this._buildIcon(),this._buildTooltip()):this.html(this.obj.title)},_parseTooltip:function(){this.obj.tooltip=this.obj.tooltip?this.lang.parse(this.obj.tooltip):this.obj.title},_parseTitle:function(){this.obj.title=this.lang.parse(this.obj.title)},_build:function(){this.parse("<a>"),this.addClass("re-button re-"+this.name),this.attr("data-re-name",this.name),this.dataset("data-button-instance",this),this.obj.dropdown&&this.setDropdown(this.obj.dropdown)},_buildCallback:function(){this.on("click",this.toggle.bind(this))},_buildAttributes:function(){var t={href:"#",alt:this.obj.tooltip,rel:this.name,role:"button","aria-label":this.obj.tooltip,tabindex:"-1"};this.attr(t)},_buildObserver:function(){void 0!==this.obj.observe&&this.toolbar.addButtonObserver(this.name,this.obj.observe)},_buildIcon:function(){var t=this.obj.icon,e=/(<([^>]+)>)/gi.test(t);this.$icon=e?$R.dom(t):$R.dom("<i>"),e||this.$icon.addClass("re-icon-"+this.name),this.append(this.$icon),this.attr("data-re-icon",!0),this.addClass("re-button-icon")},_buildTooltip:function(){this.detector.isDesktop()&&(this.tooltip=$R.create("toolbar.button.tooltip",this.app,this))}}),$R.add("class","toolbar.button.tooltip",{mixins:["dom"],init:function(t,e){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.$body=t.$body,this.toolbar=t.toolbar,this.$button=e,this.created=!1,this._init()},open:function(){if(!this.$button.hasClass("redactor-button-disabled")&&!this.$button.hasClass("redactor-button-active")){this.created=!0,this.parse("<span>"),this.addClass("re-button-tooltip re-button-tooltip-"+this.uuid),this.$body.append(this),this.html(this.$button.attr("alt"));var t=this.$button.offset(),e=this.$button.height(),i=this.$button.width();this.css({top:t.top+e+4+"px",left:t.left+i/2-this.width()/2+"px",position:"absolute"}),this.show()}},close:function(){this.created&&!this.$button.hasClass("redactor-button-disabled")&&(this.remove(),this.created=!1)},_init:function(){this.$button.on("mouseover",this.open.bind(this)),this.$button.on("mouseout",this.close.bind(this))}}),$R.add("class","toolbar.dropdown",{mixins:["dom"],init:function(t,e,i){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.$win=t.$win,this.$doc=t.$doc,this.$body=t.$body,this.animate=t.animate,this.toolbar=t.toolbar,this.name=e,this.started=!1,this.items="format"===e?$R.extend({},!0,i):i,this.$items=[]},toggle:function(t){this.started||this._build(),this.isOpened()&&this.isActive()?this.close(!1):this.open(t)},isOpened:function(){var t=this.$body.find(".redactor-dropdown-"+this.uuid+".open");return 0!==t.length&&t.attr("data-re-name")===this.name},isActive:function(){return 0!==this.$body.find("#redactor-dropdown-"+this.uuid+"-"+this.name+".open").length},getName:function(){return this.attr("data-re-name")},getItem:function(t){return this.$items[t]},getItemsByClass:function(t){var e=[];for(var i in this.$items){var n=this.$items[i];"object"==typeof n&&n.attr("data-re-name")&&n.hasClass(t)&&e.push(n)}return e},open:function(t){this._closeAll(),this.$btn=this.toolbar.getButton(this.name),this.app.broadcast("dropdown.open",t,this,this.$btn),this.toolbar.setDropdown(this),this.show(),this.removeClass("redactor-animate-hide"),this.addClass("open"),this._observe(),this.$btn.hideTooltip(),this.$btn.setActive(),this.$doc.on("keyup.redactor.dropdown-"+this.uuid,this._handleKeyboard.bind(this)),this.$doc.on("click.redactor.dropdown-"+this.uuid,this.close.bind(this)),this.updatePosition(),this.app.broadcast("dropdown.opened",t,this,this.$btn)},close:function(t,e){if(t){var i=$R.dom(t.target);if(this._isButton(t)||i.hasClass("redactor-dropdown-not-close")||i.hasClass("redactor-dropdown-item-disabled"))return void t.preventDefault()}this.app.broadcast("dropdown.close",this,this.$btn),this.toolbar.setDropdown(!1),this.$btn.setInactive(),!1===e?this._close():this.animate.start(this,"fadeOut",this._close.bind(this))},updatePosition:function(){this.toolbar.isFixed(),this.toolbar.isTarget();var t=this.$btn.height(),e=this.$btn.width(),i=this.$btn.offset(),n=i.left+0,r=parseFloat(this.css("width")),o=n-(this.$win.width()<n+r?r-e:0),a=i.top+t+2;o=o<0?4:o,this.css({maxHeight:"",position:"absolute",top:a+"px",left:o+"px"});var s=this.$win.height()-(a-this.$doc.scrollTop())-10;this.css("max-height",s+"px")},_build:function(){this.parse("<div>"),this.attr("dir",this.opts.direction),this.attr("id","redactor-dropdown-"+this.uuid+"-"+this.name),this.attr("data-re-name",this.name),this.addClass("redactor-dropdown redactor-dropdown-"+this.uuid+" redactor-dropdown-"+this.name),this.dataset("data-dropdown-instance",this),this.items.sdom||"string"==typeof this.items?this._buildDom():this._buildItems(),this.$body.append(this),this.started=!0},_buildDom:function(){this.html("").append($R.dom(this.items))},_buildItems:function(){for(var t in this.items="format"===this.name?this._buildFormattingItems():this.items,this.items){var e=this.items[t];if("observe"===t)this.attr("data-observe",this.items[t]);else{var i=$R.create("toolbar.dropdown.item",this.app,t,e,this);this.$items[t]=i,this.append(i)}}},_buildFormattingItems:function(){for(var t in this.items)-1===this.opts.formatting.indexOf(t)&&delete this.items[t];if(this.opts.formattingHide)for(var t in this.items)-1!==this.opts.formattingHide.indexOf(t)&&delete this.items[t];if(this.opts.formattingAdd)for(var t in this.opts.formattingAdd)this.items[t]=this.opts.formattingAdd[t];return this.items},_handleKeyboard:function(t){27===t.which&&this.close()},_isButton:function(t){return $R.dom(t.target).closest(".re-button").get()===this.$btn.get()},_close:function(){this.$btn.setInactive(),this.$doc.off(".redactor.dropdown-"+this.uuid),this.removeClass("open"),this.addClass("redactor-animate-hide"),this.app.broadcast("dropdown.closed",this,this.$btn)},_closeAll:function(){this.$body.find(".redactor-dropdown-"+this.uuid+".open").each((function(t){$R.dom(t).dataget("data-dropdown-instance")._close()}))},_observe:function(){var t=this.attr("data-observe");t&&this.app.broadcast("dropdown."+t+".observe",this)}}),$R.add("class","toolbar.dropdown.item",{mixins:["dom"],init:function(t,e,i,n){this.app=t,this.lang=t.lang,this.dropdown=n,this.name=e,this.obj=i,this._init()},setTitle:function(t){this.$span.html(t)},getTitle:function(){return this.$span.html()},enable:function(){this.removeClass("redactor-dropdown-item-disabled")},disable:function(){this.addClass("redactor-dropdown-item-disabled")},toggle:function(t){t&&t.preventDefault(),this.hasClass("redactor-dropdown-item-disabled")||(this.obj.message?this.app.broadcast(this.obj.message,this.obj.args,this.name):this.obj.api&&this.app.api(this.obj.api,this.obj.args,this.name))},_init:function(){this.parse("<a>"),this.attr("href","#"),this.addClass("redactor-dropdown-item-"+this.name),this.obj.classname&&this.addClass(this.obj.classname),this.attr("data-re-name",this.name),this.on("click",this.toggle.bind(this)),this.$span=$R.dom("<span>"),this.append(this.$span),this.setTitle(this.lang.parse(this.obj.title))}}),$R.add("service","cleaner",{init:function(t){this.app=t,this.opts=t.opts,this.storedComponents=[],this.storedComments=[],this.storedImages=[],this.storedLinks=[],this.deniedTags=["font","html","head","link","title","body","meta","applet"],this.convertRules={},this.unconvertRules={},this.reComments=/<!--[\s\S]*?-->\n?/g,this.reSpacedEmpty=/^(||\s||<br\s?\/?>||&nbsp;)$/i,this.reScriptTag=/<script(.*?[^>]?)>([\w\W]*?)<\/script>/gi},addConvertRules:function(t,e){this.convertRules[t]=e},addUnconvertRules:function(t,e){this.unconvertRules[t]=e},input:function(t,e,i){var n=[];t=this.storeComments(t,n),t=this.encodeCode(t);var r=this.utils.buildWrapper(t);r.find("a, b, i, strong, em, img, svg, details, audio").removeAttr("onload onerror ontoggle onwheel onmouseover oncopy"),r.find("a, iframe, embed").each((function(t){var e=$R.dom(t),i=e.attr("href"),n=e.attr("src");i&&-1!==i.trim().search(/^data|javascript:/i)&&e.attr("href",""),n&&-1!==n.trim().search(/^data|javascript:/i)&&e.attr("src","")}));var o=["alt","title","src","class","width","height","srcset","style","usemap"];return r.find("img").each(function(t){if(t.attributes.length>0)for(var e=t.attributes,i=e.length-1;i>=0;i--){var n=-1===e[i].name.search(/^data-/)&&-1===o.indexOf(e[i].name),r="src"===e[i].name&&-1!==e[i].value.search(/^data|javascript:/i);this.opts.imageSrcData&&(r=!1),(n||r)&&t.removeAttribute(e[i].name)}}.bind(this)),t=(t=(t=this.utils.getWrapperHtml(r)).replace(/\$/g,"&#36;")).replace(/&amp;/g,"&"),t=$R.create("cleaner.figure",this.app).convert(t,this.convertRules),t=this.storeComponents(t),t=this.replaceTags(t,this.opts.replaceTags),t=this._setSpanAttr(t),t=this._setStyleCache(t),t=this.removeTags(t,this.deniedTags),t=this.opts.removeScript?this._removeScriptTag(t):this._replaceScriptTag(t),t=this.opts.removeComments?this.removeComments(t):t,t=this._isSpacedEmpty(t)?this.opts.emptyHtml:t,t=this.restoreComponents(t),t=this._cleanWrapped(t),t=this.restoreComments(t,n),e?this.paragraphize(t):t},output:function(t,e){return t=this.removeInvisibleSpaces(t),this.opts.breakline&&(t=(t=t.replace(/<\/(span|strong|b|i|em)><br\s?\/?><\/div>/gi,"</$1></div>")).replace(/<br\s?\/?><\/(span|strong|b|i|em)><\/div>/gi,"</$1></div>")),t=t.replace(/&#36;/g,"$"),this._isSpacedEmpty(t)||this._isParagraphEmpty(t)?"":(t=this.removeServiceTagsAndAttrs(t,e),t=this.storeComponents(t),t=this.removeSpanWithoutAttributes(t),t=this.removeFirstBlockBreaklineInHtml(t),t=this.opts.removeScript?t:this._unreplaceScriptTag(t),t=this.opts.preClass?this._setPreClass(t):t,t=this.opts.linkNofollow?this._setLinkNofollow(t):t,t=this.opts.removeNewLines?this.cleanNewLines(t):t,t=this.restoreComponents(t),t=$R.create("cleaner.figure",this.app).unconvert(t,this.unconvertRules),t=this.removeEmptyAttributes(t,["style","class","rel","alt","title"]),t=this.cleanSpacesInPre(t),t=(t=this.tidy(t)).replace(/&amp;/g,"&"),this.opts.breakline&&(t=(t=t.replace(/<br\s?\/?>/gi,"<br>\n")).replace(/<br\s?\/?>\n+/gi,"<br>\n")),t=""===t.replace(/\n/g,"")?"":t)},paste:function(t){t=(t=this.storeComponents(t)).replace(/<!--[\s\S]*?-->/g,"");var e=this.deniedTags.concat(["iframe"]);t=(t=(t=(t=this.removeTags(t,e)).replace(new RegExp("<!doctype([\\s\\S]+?)>","gi"),"")).replace(new RegExp("<style([\\s\\S]+?)</style>","gi"),"")).replace(new RegExp("</p><br /><p","gi"),"</p><p");var i=this._isHtmlMsWord(t);if(t=i?t:this._cleanGDocs(t),t=i?this._cleanMsWord(t):t,!this.opts.pasteClean)return this.restoreComponents(t);if(this.opts.pastePlainText)return t=this.restoreComponents(t),this.pastePlainText(t);(r=this.utils.buildWrapper(t)).find("*").removeAttr("style"),r.find("[data-redactor-tag]").each(function(t){var e=$R.dom(t);e.removeAttr("data-redactor-tag"),this.utils.isEmptyHtml(e.html())?e.html("<br>").unwrap():t.lastChild&&"BR"===t.lastChild.tagName?e.unwrap():e.append("<br>").unwrap()}.bind(this)),t=(t=(t=this.utils.getWrapperHtml(r)).replace(/<br\s?\/?>$/,"")).replace(/<br\s?\/?><\/(td|th)>/,"</$1>");var n=this.opts.pasteBlockTags.concat(this.opts.pasteInlineTags);t=this.removeTagsExcept(t,n),t=this.opts.pasteLinks?t:this.removeTags(t,["a"]),t=this.opts.pasteImages?t:this.removeTags(t,["img"]);var r,o=(r=this.utils.buildWrapper(t)).find("*"),a=0!==this.opts.pasteKeepStyle.length?","+this.opts.pasteKeepStyle.join(","):"";o.not("[data-redactor-style-cache]"+a).removeAttr("style");var s=0!==this.opts.pasteKeepClass.length?","+this.opts.pasteKeepClass.join(","):"";o.not("[data-redactor-style-cache], span.redactor-component"+s).removeAttr("class");var l=0!==this.opts.pasteKeepAttrs.length?","+this.opts.pasteKeepAttrs.join(","):"";o.not("img, a, span.redactor-component, [data-redactor-style-cache]"+l).each((function(t){for(var e=t.attributes,i=e.length-1;i>=0;i--)"class"!==t.attributes[i].name&&"dir"!==t.attributes[i].name&&t.removeAttribute(e[i].name)})),this.opts.pasteLinks&&!1!==this.opts.pasteLinkTarget&&r.find("a").attr("target",this.opts.pasteLinkTarget),r.find("[data-redactor-style-cache]").each((function(t){var e=t.getAttribute("data-redactor-style-cache");t.setAttribute("style",e)}));var c=this.opts.imageAttrs;return r.find("img").each((function(t){if(t.attributes.length>0)for(var e=t.attributes,i=e.length-1;i>=0;i--)-1===c.indexOf(e[i].name)&&t.removeAttribute(e[i].name)})),r.find("span").each((function(t){0===t.attributes.length&&$R.dom(t).unwrap()})),r.find(this.opts.inlineTags.join(",")).each(function(t){0===t.attributes.length&&this.utils.isEmptyHtml(t.innerHTML)&&$R.dom(t).unwrap()}.bind(this)),r.find("ul, ol").each((function(t){var e=t.previousSibling;if(e&&"LI"===e.tagName){var i=$R.dom(e);i.find("p").unwrap(),i.append(t)}})),t=(t=(t=(t=(t=this.utils.getWrapperHtml(r)).replace(/<li><p>/gi,"<li>")).replace(/<\/p><\/li>/gi,"</li>")).replace(/^<li/gi,"<ul><li")).replace(/<\/li>$/gi,"</li></ul>"),this.opts.breakline&&(t=t.replace(/\n/g,"<br>")),t=(t=t.replace(/<p>&nbsp;<\/p>/gi,"<p></p>")).replace(/<p><br\s?\/?><\/p>/gi,"<p></p>"),i&&(t=(t=t.replace(/<p><\/p>/gi,"")).replace(/<p>\s<\/p>/gi,"")),this.restoreComponents(t)},pastePlainText:function(t){return t=this.opts.pasteLinks?this.storeLinks(t):t,t=this.opts.pasteImages?this.storeImages(t):t,t=this.getPlainText(t),t=this._replaceNlToBr(t),t=this.opts.pasteLinks?this.restoreLinks(t):t,this.opts.pasteImages?this.restoreImages(t):t},tidy:function(t){return t},paragraphize:function(t){return $R.create("cleaner.paragraphize",this.app).convert(t)},storeComments:function(t,e){var i=t.match(new RegExp("\x3c!--([\\w\\W]*?)--\x3e","gi"));if(null!==i)for(var n=0;n<i.length;n++)t=t.replace(i[n],"#####xstarthtmlcommentzz"+n+"xendhtmlcommentzz#####"),e.push(i[n]);return t},restoreComments:function(t,e){for(var i=0;i<e.length;i++)t=t.replace("#####xstarthtmlcommentzz"+i+"xendhtmlcommentzz#####",e[i]);return t},getFlatText:function(t){var e=$R.dom("<div>");return t.nodeType||t.dom?e.append(t):(t=(t=t.toString()).trim(),e.html(t)),void 0===(t=e.get().textContent||e.get().innerText||"")?"":t},getPlainText:function(t){t=(t=(t=(t=(t=(t=t.replace(/<!--[\s\S]*?-->/gi,"")).replace(/<style[\s\S]*?style>/gi,"")).replace(/<p><\/p>/g,"")).replace(/<\/div>|<\/li>|<\/td>/gi,"\n")).replace(/<\/p>/gi,"\n\n")).replace(/<\/H[1-6]>/gi,"\n\n");var e=document.createElement("div");return e.innerHTML=t,(t=e.textContent||e.innerText).trim()},replaceTags:function(t,e){if(e){var i=this,n=Object.keys(e),r=this.utils.buildWrapper(t);r.find(n.join(",")).each((function(t){i.utils.replaceToTag(t,e[t.tagName.toLowerCase()])})),t=this.utils.getWrapperHtml(r)}return t},replaceNbspToSpaces:function(t){return t.replace("&nbsp;"," ")},replaceBlocksToBr:function(t){return(t=(t=t.replace(/<div[^>]*><\/div>/gi,"")).replace(/<td[^>]*><\/td>/gi,"")).replace(/<\/div>|<\/li>|<\/td>|<\/p>|<\/H[1-6]>/gi,"<br>")},cleanNewLines:function(t){return t.replace(/\r?\n/g,"")},cleanSpacesInPre:function(t){return t.replace("&nbsp;&nbsp;&nbsp;&nbsp;","    ")},removeInvisibleSpaces:function(t){return(t=this.utils.removeInvisibleChars(t)).replace(/&#65279;/gi,"")},removeNl:function(t){return(t=t.replace(/\n/g," ")).replace(/\s+/g,"s")},removeBrAtEnd:function(t){return(t=t.replace(/<br\s?\/?>$/gi," ")).replace(/<br\s?\/?><li/gi,"<li")},removeTags:function(t,e){var i=e?/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi:/(<([^>]+)>)/gi,n=e?function(t,i){return-1===e.indexOf(i.toLowerCase())?t:""}:"";return t.replace(i,n)},removeTagsExcept:function(t,e){return void 0===e?t.replace(/(<([^>]+)>)/gi,""):t.replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,(function(t,i){return-1===e.indexOf(i.toLowerCase())?"":t}))},removeComments:function(t){return t.replace(this.reComments,"")},removeServiceTagsAndAttrs:function(t,e){var i=this.utils.buildWrapper(t),n=this;return!1!==e&&i.find(".redactor-selection-marker").each((function(t){var e=$R.dom(t);return""===n.utils.removeInvisibleChars(e.text())?e.remove():e.unwrap()})),i.find("[data-redactor-style-cache]").removeAttr("data-redactor-style-cache"),this.utils.getWrapperHtml(i)},removeSpanWithoutAttributes:function(t){var e=this.utils.buildWrapper(t);return e.find("span").removeAttr("data-redactor-span data-redactor-style-cache").each((function(t){0===t.attributes.length&&$R.dom(t).unwrap()})),this.utils.getWrapperHtml(e)},removeFirstBlockBreaklineInHtml:function(t){return t.replace(new RegExp("</li><br\\s?/?>","gi"),"</li>")},removeEmptyAttributes:function(t,e){for(var i=this.utils.buildWrapper(t),n=0;n<e.length;n++)i.find("["+e[n]+'=""]').removeAttr(e[n]);return this.utils.getWrapperHtml(i)},encodeHtml:function(t){return t=(t=(t=(t=(t=(t=t.replace(/<br\s?\/?>/g,"\n")).replace(/&nbsp;/g," ")).replace(/\u201d/g,'"')).replace(/\u201c/g,'"')).replace(/\u2018/g,"'")).replace(/\u2019/g,"'"),t=(t=this.encodeEntities(t)).replace(/\$/g,"&#36;"),this.opts.preSpaces&&(t=t.replace(/\t/g,new Array(this.opts.preSpaces+1).join(" "))),t},encodeCode:function(t){return t=(t=(t=(t=(t=(t=(t=(t=this.encodeAttrSings(t)).replace(/>([^<]+)>/gi,">$1&gt;")).replace(/<([^<]+)>/gi,"xtagstartz$1xtagendz")).replace(/</gi,"&lt;")).replace(/xtagstartzpre(.*?)xtagendz/g,"<pre$1>")).replace(/xtagstartzcode(.*?)xtagendz/g,"<code$1>")).replace(/xtagstartz\/codextagendz/g,"</code>")).replace(/xtagstartz\/prextagendz/g,"</pre>"),t=(t=(t=this._encodeCode(t)).replace(/xtagstartz(.*?)xtagendz/g,"<$1>")).replace(/xtagstartz\/(.*?)xtagendz/g,"</$1>"),this.decodeAttrSings(t)},_encodeCode:function(t){var e=this.utils.buildWrapper(t);return e.find("pre code, pre, code").each(this._encodeNode.bind(this)),this.utils.getWrapperHtml(e)},_encodeNode:function(t){var e=t.firstChild,i=t.innerHTML;if("PRE"!==t.tagName||!e||"CODE"!==e.tagName){i=(i=i.replace(/xtagstartz/g,"<")).replace(/xtagendz/g,">");var n=this.decodeEntities(i);t.textContent=this._encodeNodeHtml(n)}},_encodeNodeHtml:function(t){return t=t.replace(/&nbsp;/g," ").replace(/<br\s?\/?>/g,"\n"),this.opts.preSpaces?t.replace(/\t/g,new Array(this.opts.preSpaces+1).join(" ")):t},encodeAttrSings:function(t){var e=t.match(/="(.*?)"/g);if(null!==e)for(var i=0;i<e.length;i++)if(-1===e[i].search(/^"</)&&-1===e[i].search(/>"$/)){var n=e[i].replace(">","xmoresignz");n=n.replace("<","xlesssignz"),t=t.replace(e[i],n)}return t},encodeEntities:function(t){return(t=this.decodeEntities(t)).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;")},encodePhpCode:function(t){return(t=(t=t.replace("<?php","&lt;?php")).replace("<?","&lt;?")).replace("?>","?&gt;")},decodeAttrSings:function(t){return(t=t.replace(/xmoresignz/gi,">")).replace(/xlesssignz/gi,"<")},decodeEntities:function(t){return String(t).replace(/&lt;/g,"<").replace(/&gt;/g,">").replace(/&quot;/g,'"').replace(/&amp;/g,"&")},storeComponents:function(t){var e=this.utils.getElementsFromHtml(t,"figure","table");return this._storeMatched(t,e,"Components","figure")},restoreComponents:function(t){return this._restoreMatched(t,"Components","figure")},storeLinks:function(t){var e=this.utils.getElementsFromHtml(t,"a");return this._storeMatched(t,e,"Links","a")},storeImages:function(t){var e=this.utils.getElementsFromHtml(t,"img");return this._storeMatched(t,e,"Images","img")},restoreLinks:function(t){return this._restoreMatched(t,"Links","a")},restoreImages:function(t){return this._restoreMatched(t,"Images","img")},_cleanWrapped:function(t){return t.replace(new RegExp("<p><figure([\\w\\W]*?)</figure></p>","gi"),"<figure$1</figure>")},_cleanGDocs:function(t){return(t=(t=(t=(t=(t=(t=(t=(t=t.replace(/<b\sid="internal-source-marker(.*?)">([\w\W]*?)<\/b>/gi,"$2")).replace(/<b(.*?)id="docs-internal-guid(.*?)">([\w\W]*?)<\/b>/gi,"$3")).replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?bold|font-weight:\s?bold;\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$2</i></b>")).replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?600|font-weight:\s?600;\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$2</i></b>")).replace(/<span[^>]*(font-style:\s?italic;\s?font-weight:\s?700|font-weight:\s?700;\s?font-style:\s?italic)[^>]*>([\w\W]*?)<\/span>/gi,"<b><i>$2</i></b>")).replace(/<span[^>]*font-style:\s?italic[^>]*>([\w\W]*?)<\/span>/gi,"<i>$1</i>")).replace(/<span[^>]*font-weight:\s?bold[^>]*>([\w\W]*?)<\/span>/gi,"<b>$1</b>")).replace(/<span[^>]*font-weight:\s?700[^>]*>([\w\W]*?)<\/span>/gi,"<b>$1</b>")).replace(/<span[^>]*font-weight:\s?600[^>]*>([\w\W]*?)<\/span>/gi,"<b>$1</b>")},_cleanMsWord:function(t){t=(t=(t=(t=(t=t.replace(/<!--[\s\S]+?-->/gi,"")).replace(/<(!|script[^>]*>.*?<\/script(?=[>\s])|\/?(\?xml(:\w+)?|img|meta|link|style|\w:\w+)(?=[\s\/>]))[^>]*>/gi,"")).replace(/<(\/?)s>/gi,"<$1strike>")).replace(/&nbsp;/gi," ")).replace(/<span\s+style\s*=\s*"\s*mso-spacerun\s*:\s*yes\s*;?\s*"\s*>([\s\u00a0]*)<\/span>/gi,(function(t,e){return e.length>0?e.replace(/./," ").slice(Math.floor(e.length/2)).split("").join("\xa0"):""}));var e=this.utils.buildWrapper(t);e.find(".MsoFootnoteText").each((function(t){var e=$R.dom(t),i=e.parent();0!==i.length&&-1!==i.attr("style").search(/mso-element:footnote/)&&e.find("a").attr("id","_"+i.attr("id"))})),e.find(".MsoFootnoteReference").each((function(t){var e=$R.dom(t).parent();0!==e.length&&"A"===e.get().tagName&&e.attr("id",e.attr("name"))})),e.find("p").each((function(t){var e=$R.dom(t),i=e.attr("style"),n=/mso-list:\w+ \w+([0-9]+)/.exec(i);n&&e.attr("data-listLevel",parseInt(n[1],10))})),this._parseWordLists(e),e.find("[align]").removeAttr("align"),e.find("[name]").removeAttr("name"),e.find("span").each((function(t){var e=$R.dom(t),i=e.attr("style");/mso-list:Ignore/.exec(i)?e.remove():e.unwrap()})),e.find("[style]").removeAttr("style"),e.find("[class^='Mso']").removeAttr("class"),e.find("a").filter((function(t){return!t.hasAttribute("href")})).unwrap();for(var i="",n=(t=(t=(t=(t=(t=this.utils.getWrapperHtml(e)).replace(/<p[^>]*><\/p>/gi,"")).replace(/<li>\xb7/gi,"<li>")).trim()).replace(/\/(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)>\s+<(p|ul|ol|h1|h2|h3|h4|h5|h6|blockquote)/gi,"/$1>\n<$2")).split(/\n/),r=0;r<n.length;r++){var o=""!==n[r]&&-1===n[r].search(/>$/)?" ":"\n";i+=n[r]+o}return i},_parseWordLists:function(t){var e=0,i=null,n=null,r=null;t.find("p").each((function(t){var o=$R.dom(t),a=o.attr("data-listLevel");if(null===a&&o.hasClass("MsoListParagraphCxSpMiddle")&&(a=1),null!==a){var s=o.text(),l=/^\s*\w+\./.test(s)?"<ol></ol>":"<ul></ul>";if(o.hasClass("MsoListParagraphCxSpFirst")||o.hasClass("MsoNormal")?(n=$R.dom(l),o.before(n)):a>e&&0!==e&&(r=$R.dom(l),i.append(r),n=r),a<e)for(var c=e-a+1,h=0;h<c;h++)n=n.parent();o.find("span").first().unwrap(),i=$R.dom("<li>"+o.html().trim()+"</li>"),null===n&&(o.before(l),n=o.prev()),n.append(i),o.remove(),e=a}else n=null,e=0}))},_isSpacedEmpty:function(t){return-1!==t.search(this.reSpacedEmpty)},_isParagraphEmpty:function(t){return-1!==t.search(/^<p><\/p>$/i)},_isHtmlMsWord:function(t){return t.match(/class="?Mso|style="[^"]*\bmso-|style='[^'']*\bmso-|w:WordDocument/i)},_setSpanAttr:function(t){var e=this.utils.buildWrapper(t);return e.find("span").attr("data-redactor-span",!0),this.utils.getWrapperHtml(e)},_setStyleCache:function(t){var e=this.utils.buildWrapper(t);return e.find("[style]").each((function(t){var e=$R.dom(t);e.attr("data-redactor-style-cache",e.attr("style"))})),this.utils.getWrapperHtml(e)},_setPreClass:function(t){var e=this.utils.buildWrapper(t);return e.find("pre").addClass(this.opts.preClass),this.utils.getWrapperHtml(e)},_setLinkNofollow:function(t){var e=this.utils.buildWrapper(t);return e.find("a").attr("rel","nofollow"),this.utils.getWrapperHtml(e)},_replaceScriptTag:function(t){return t.replace(this.reScriptTag,'<script class="redactor-script-tag" $1>$2<\/script>')},_unreplaceScriptTag:function(t){return t.replace(/<script class="redactor-script-tag"(.*?[^>]?)>([\w\W]*?)<\/script>/gi,"<script$1>$2<\/script>")},_replaceNlToBr:function(t){return t.replace(/\n/g,"<br />")},_removeScriptTag:function(t){return t.replace(this.reScriptTag,"")},_storeMatched:function(t,e,i,n){if(this["stored"+i]=[],e)for(var r=0;r<e.length;r++)this["stored"+i][r]=e[r],t=t.replace(e[r],"####"+n+r+"####");return t},_restoreMatched:function(t,e,i){if(this["stored"+e])for(var n=0;n<this["stored"+e].length;n++)t=t.replace("####"+i+n+"####",this["stored"+e][n]);return t}}),$R.add("class","cleaner.figure",{init:function(t){this.app=t,this.opts=t.opts,this.utils=t.utils,this.detector=t.detector},convert:function(t,e){var i=this.utils.buildWrapper(t);return i.find("img").each(this._convertImage.bind(this)),i.find("hr").each(this._convertLine.bind(this)),i.find("iframe").each(this._convertIframe.bind(this)),i.find("table").each(this._convertTable.bind(this)),i.find("form").each(this._convertForm.bind(this)),i.find("figure pre").each(this._convertCode.bind(this)),i.find("[data-redactor-type=variable]").addClass("redactor-component"),i.find("figure").not(".redactor-component, .redactor-figure-code").each(this._convertWidget.bind(this)),i.find("figure pre").each(this._setContenteditableCode.bind(this)),i.find(".redactor-component, .non-editable").attr("contenteditable",!1),this.detector.isIe()&&i.find("[data-redactor-type=table]").removeAttr("contenteditable"),i.find("figcaption, td, th").attr("contenteditable",!0),i.find(".redactor-component, figcaption").attr("tabindex","-1"),this._acceptExtraRules(i,e),this.utils.getWrapperHtml(i)},unconvert:function(t,e){t=(t=t.replace(/<\/([^>]+)><div data-redactor-tag/g,"</$1>\n<div data-redactor-tag")).replace(/<\/([^>]+)><p/g,"</$1>\n<p");var i=this.utils.buildWrapper(t);return i.find("th, td, figcaption, figure, pre, code, .redactor-component").removeAttr("contenteditable tabindex"),i.find("figure").removeClass("redactor-component redactor-component-active redactor-uploaded-figure"),i.find("[data-redactor-type=variable]").removeClass("redactor-component redactor-component-active"),i.find("figure[data-redactor-type=line]").unwrap(),i.find("figure[data-redactor-type=widget]").each(this._unconvertWidget.bind(this)),i.find("figure[data-redactor-type=form]").each(this._unconvertForm.bind(this)),i.find("figure[data-redactor-type=table]").each(this._unconvertTable.bind(this)),i.find("figure[data-redactor-type=image]").removeAttr("rel").each(this._unconvertImages.bind(this)),i.find("img").removeAttr("data-redactor-type").removeClass("redactor-component"),i.find(".non-editable").removeAttr("contenteditable"),i.find("figure").each(this._removeTypes.bind(this)),i.find("span.redactor-component-caret").remove(),i=this._unconvertBreakTag(i),this._acceptExtraRules(i,e),(t=(t=this.utils.getWrapperHtml(i)).replace(/<br\s?\/?>$/,"")).replace(/<br\s?\/?><\/(td|th)>/,"</$1>")},_convertImage:function(t){var e=$R.dom(t);if(!this._isNonEditable(e)){this.opts.imageObserve&&!e.attr("data-image")&&e.attr("data-image",this.utils.getRandomId());var i=e.closest("a"),n=e.closest("figure");if(0===n.children().not("a, img, br, figcaption").length){if(0===n.length){var r=0!==i.length?i.closest("p"):e.closest("p");!1===this.opts.imageFigure&&0!==r.length?(n=this.utils.replaceToTag(r,"figure")).addClass("redactor-replace-figure"):(0!==r.length&&r.unwrap(),n=0!==i.length?i.wrap("<figure>"):e.wrap("<figure>"))}else n.hasClass("redactor-uploaded-figure")?n.removeClass("redactor-uploaded-figure"):n.addClass("redactor-keep-figure");this._setFigure(n,"image")}}},_convertTable:function(t){if(!this._isNonEditable(t)){var e=this._wrapFigure(t);this._setFigure(e,"table")}},_convertLine:function(t){if(!this._isNonEditable(t)){var e=this._wrapFigure(t);this._setFigure(e,"line")}},_convertForm:function(t){if(!this._isNonEditable(t)){var e=this.utils.replaceToTag(t,"figure");this._setFigure(e,"form")}},_convertIframe:function(t){if(!this._isNonEditable(t)&&0===$R.dom(t).closest(".redactor-component").length){var e=t.getAttribute("src"),i=e&&(e.match(this.opts.regex.youtube)||e.match(this.opts.regex.vimeo)),n=this._wrapFigure(t);i&&this._setFigure(n,"video")}},_convertCode:function(t){if(!this._isNonEditable(t)){var e=this._wrapFigure(t);this._setFigure(e,"code")}},_convertWidget:function(t){if(!this._isNonEditable(t)){var e=$R.dom(t);e.addClass("redactor-component"),e.attr("data-redactor-type","widget"),e.attr("data-widget-code",encodeURI(t.innerHTML.trim()))}},_unconvertBreakTag:function(t){return t.find("[data-redactor-tag]").each(function(t){var e=$R.dom(t);if(e.removeAttr("data-redactor-tag"),0===t.attributes.length)if(t.lastChild&&"BR"===t.lastChild.tagName)e.unwrap();else{var i=e.nextElement();0!==i.length&&i.attr("data-redactor-tag")&&t.appendChild(document.createElement("br")),e.unwrap()}else t.lastChild&&"BR"===t.lastChild.tagName&&$R.dom(t.lastChild).remove()}.bind(this)),t},_unconvertForm:function(t){this.utils.replaceToTag(t,"form")},_unconvertTable:function(t){$R.dom(t).unwrap()},_unconvertWidget:function(t){var e=$R.dom(t);e.html(decodeURI(e.attr("data-widget-code"))),e.removeAttr("data-widget-code")},_unconvertImages:function(t){var e=$R.dom(t);e.removeClass("redactor-component");var i=0!==e.closest("li").length,n=0!==e.closest("table").length,r=0!==e.find("figcaption").length,o=e.attr("style"),a=!(null===o||""===o),s=""!==e.attr("class");(i||n&&!r&&!a&&!s)&&e.unwrap()},_removeTypes:function(t){var e=$R.dom(t),i=e.attr("data-redactor-type");i&&-1!==["image","widget","line","video","code","form","table"].indexOf(i)&&e.removeAttr("data-redactor-type"),e.hasClass("redactor-keep-figure")?e.removeClass("redactor-keep-figure"):"image"===i&&!1===this.opts.imageFigure&&(0!==e.find("figcaption").length||(e.hasClass("redactor-replace-figure")?(e.removeClass("redactor-replace-figure"),this.utils.replaceToTag(e,"p")):this.utils.replaceToTag(e,"p"))),e.removeClass("redactor-replace-figure")},_wrapFigure:function(t){var e=$R.dom(t),i=e.closest("figure");return 0===i.length?e.wrap("<figure>"):i},_setFigure:function(t,e){t.addClass("redactor-component"),t.attr("data-redactor-type",e)},_setContenteditableCode:function(t){if(!this._isNonEditable(t)){var e=$R.dom(t),i=e.children("code").first();(0!==i.length?i:e).attr("contenteditable",!0).attr("tabindex","-1")}},_acceptExtraRules:function(t,e){for(var i in e)"function"==typeof e[i]&&e[i](t)},_isNonEditable:function(t){return 0!==$R.dom(t).closest(".non-editable").length}}),$R.add("class","cleaner.paragraphize",{init:function(t){this.app=t,this.opts=t.opts,this.utils=t.utils,this.cleaner=t.cleaner,this.element=t.element,this.stored=[],this.remStart="#####replace",this.remEnd="#####",this.paragraphizeTags=["table","div","pre","form","ul","ol","h1","h2","h3","h4","h5","h6","dl","blockquote","figcaption","address","section","header","footer","aside","article","object","style","script","iframe","select","input","textarea","button","option","map","area","math","hr","fieldset","legend","hgroup","nav","figure","details","menu","summary","p"]},convert:function(t){var e=this._isConverted(t);return e=!0===e?this._convert(t):e,this._convertTable(e)},_convert:function(t,e){var i=this.opts.breakline||e?"sdivtag":this.opts.markup,n=e?"tbr":"br";t=this._storeTags(t);var r=[];t=(t=this.cleaner.storeComments(t,r)).trim(),t=this._trimLinks(t);var o=this.opts.inlineTags.join("|");t=(t=(t=(t=(t=t.replace(new RegExp("<("+o+")(.*?[^>]?)>\n</("+o+")>","gi"),"<$1$2></$3>")).replace(/xparagraphmarkerz(?:\r\n|\r|\n)$/g,"")).replace(/xparagraphmarkerz$/g,"")).replace(/xparagraphmarkerz(?:\r\n|\r|\n)/g,"\n")).replace(/xparagraphmarkerz/g,"\n");for(var a="",s=(t=this.opts.breakline?(t=(t=t.replace(/<br\s?\/?>(?:\r\n|\r|\n)/gi,"xbreakmarkerz\n")).replace(/<br\s?\/?>/gi,"xbreakmarkerz\n")).replace(/xbreakmarkerz\n<\//gi,"xbreakmarkerz</"):t.replace(/[\n]+/g,"\n")).split("\n"),l=0;l<s.length;l++)a+="<"+i+">"+s[l]+"</"+i+">\n";return t=(t=(t=(t=a.replace(/\n$/,"")).replace(new RegExp("<"+i+">\\s+#####","gi"),"#####")).replace(new RegExp("<"+i+">#####","gi"),"#####")).replace(new RegExp("#####</"+i+">","gi"),"#####"),t=this.opts.breakline?t.replace(/xbreakmarkerz/gi,"<br>"):t,t=this._restoreTags(t),t=this.cleaner.restoreComments(t,r),this.opts.breakline&&(t=t.replace(new RegExp("<"+i+"></"+i+">","gi"),"<"+i+"><br></"+i+">")),(t=(t=t.replace(new RegExp("<sdivtag>","gi"),'<div data-redactor-tag="'+n+'">')).replace(new RegExp("sdivtag","gi"),"div")).replace(/<\/([^>]+)><div data-redactor-tag/g,"</$1>\n<div data-redactor-tag")},_convertTable:function(t){var e=this.utils.buildWrapper(t);return e.find("td, th").each(this._convertCell.bind(this)),this.utils.getWrapperHtml(e)},_convertCell:function(t){var e=$R.dom(t);this.stored=[];var i=this._convert(e.html(),!0);e.html(i)},_storeTags:function(t){var e=this,i=this.utils.buildWrapper(t);return i.find(this.paragraphizeTags.join(", ")).each((function(t,i){var n=document.createTextNode(e.remStart+i+e.remEnd+"xparagraphmarkerz");e.stored.push(t.outerHTML),t.parentNode.replaceChild(n,t)})),this.utils.getWrapperHtml(i)},_restoreTags:function(t){for(var e=0;e<this.stored.length;e++)this.stored[e]=this.stored[e].replace(/\$/g,"&#36;"),t=t.replace(this.remStart+e+this.remEnd,this.stored[e]);return t},_trimLinks:function(t){var e=this.utils.buildWrapper(t);return e.find("a").each(this._trimLink.bind(this)),this.utils.getWrapperHtml(e)},_trimLink:function(t){var e=$R.dom(t);e.html(e.html().trim())},_isConverted:function(t){return this._isDisabled(t)?t:!this._isEmptyHtml(t)||this.opts.emptyHtml},_isDisabled:function(){return!1===this.opts.paragraphize||this.element.isType("inline")},_isEmptyHtml:function(t){return""===t||"<p></p>"===t||"<div></div>"===t}}),$R.add("service","detector",{init:function(t){this.app=t,this.userAgent=navigator.userAgent.toLowerCase()},isWebkit:function(){return/webkit/.test(this.userAgent)},isFirefox:function(){return this.userAgent.indexOf("firefox")>-1},isIe:function(t){return document.documentMode||/Edge/.test(navigator.userAgent)?"edge":((e=RegExp("msie"+(isNaN(t)?"":"\\s"+t),"i").test(navigator.userAgent))||(e=!!navigator.userAgent.match(/Trident.*rv[ :]*11\./)),e);var e},isMobile:function(){return/(iPhone|iPod|Android)/.test(navigator.userAgent)},isDesktop:function(){return!/(iPhone|iPod|iPad|Android)/.test(navigator.userAgent)},isIpad:function(){return/iPad/.test(navigator.userAgent)}}),$R.add("service","offset",{init:function(t){this.app=t},get:function(t,e){var i={start:0,end:0},n=this.utils.getNode(t);if(!n)return!1;var r=this.editor.isEditor(n),o=!!r||this.selection.isIn(n),a=this.selection.getRange();if(r||o){if(this.selection.is()&&o){var s=$R.dom(a.startContainer).hasClass("redactor-component")?a.startOffset:0,l=a.cloneRange();l.selectNodeContents(n),l.setEnd(a.startContainer,a.startOffset);var c=this._getString(a,e);i.start=this._getString(l,e).length-s,i.end=i.start+c.length+s}}else i=!1;return i},set:function(t,e){if(!this._setComponentOffset(e)){this.component.clearActive();var i=this.utils.getNode(e);if(i){var n=this.size(i),r=0,o=document.createRange();t.end=t.end>n?n:t.end,o.setStart(i,0),o.collapse(!0);for(var a=[i],s=!1,l=!1;!l&&(i=a.pop());)if(3===i.nodeType){var c=r+i.length;!s&&!this._isFigcaptionNext(i)&&t.start>=r&&t.start<=c&&(o.setStart(i,t.start-r),s=!0),s&&t.end>=r&&t.end<=c&&(o.setEnd(i,t.end-r),l=!0),r=c}else for(var h=i.childNodes.length;h--;)a.push(i.childNodes[h]);this.selection.setRange(o)}}},size:function(t,e){var i=this.utils.getNode(t);if(i){var n=document.createRange().cloneRange();return n.selectNodeContents(i),this._getString(n,e).length}return 0},_getString:function(t,e){var i=t.toString();return i=this.editor.isEmpty()?i.replace(/\uFEFF/g,""):i,e?i.trim():i},_setComponentOffset:function(t){return!!this.component.isNonEditable(t)&&this.component.setActive(t)},_isFigcaptionNext:function(t){var e=t.nextSibling;return""===t.nodeValue.trim()&&e&&"FIGCAPTION"===e.tagName}}),$R.add("service","inspector",{init:function(t){this.app=t},parse:function(t){return $R.create("inspector.parser",this.app,this,t)},isText:function(t){if("string"==typeof t&&!/^\s*<(\w+|!)[^>]*>/.test(t))return!0;var e=$R.dom(t).get();return e&&3===e.nodeType},isInlineTag:function(t,e){var i=this._extendTags(this.opts.inlineTags,e);return this._isTag(t)&&-1!==i.indexOf(t.toLowerCase())},isBlockTag:function(t,e){var i=this._extendTags(this.opts.blockTags,e);return this._isTag(t)&&-1!==i.indexOf(t.toLowerCase())},isTableCellTag:function(t){return-1!==["td","th"].indexOf(t.toLowerCase())},isHeadingTag:function(t){return-1!==["h1","h2","h3","h4","h5","h6"].indexOf(t.toLowerCase())},_isTag:function(t){return void 0!==t&&t},_extendTags:function(t,e){if(t=t.concat(t),e)for(var i=0;i<e.length;i++)t.push(e[i]);return t}}),$R.add("class","inspector.parser",{init:function(t,e,i){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.utils=t.utils,this.editor=t.editor,this.selection=t.selection,this.inspector=e;var n=this.editor.getElement();this.el=i,this.$el=$R.dom(this.el,n),this.node=this.$el.get(),this.node&&8===this.node.nodeType&&(this.node=!1),this.$component=this.$el.closest(".redactor-component",n)},isEditor:function(){return this.node===this.editor.getElement().get()},isInEditor:function(){return 0!==this.$el.parents(".redactor-in-"+this.uuid).length},isComponent:function(){return 0!==this.$component.length},isComponentType:function(t){return this.getComponentType()===t},isComponentActive:function(){return this.isComponent()&&this.$component.hasClass("redactor-component-active")},isComponentEditable:function(){var t=this.getComponentType();return this.isComponent()&&-1!==["code","table"].indexOf(t)},isFigcaption:function(){return this.getFigcaption()},isPre:function(){return this.getPre()},isCode:function(){var t=this.$el.closest("code"),e=t.parent("pre");return 0!==t.length&&0===e.length},isList:function(){return this.getList()},isFirstListItem:function(){return this._getLastOrFirstListItem("first")},isLastListItem:function(){return this._getLastOrFirstListItem("last")},isFirstTableCell:function(){return this._getLastOrFirstTableCell("first")},isLastTableCell:function(){return this._getLastOrFirstTableCell("last")},isTable:function(){return this.isComponentType("table")||this.getTable()},isHeading:function(){return this.getHeading()},isBlockquote:function(){return this.getBlockquote()},isDl:function(){return this.getDl()},isParagraph:function(){return this.getParagraph()},isLink:function(){return this.getLink()},isFile:function(){return this.getFile()},isText:function(){return this.inspector.isText(this.el)},isInline:function(){var t=this.opts.inlineTags;return!!this.isElement()&&-1!==t.indexOf(this.node.tagName.toLowerCase())},isBlock:function(){var t=this.opts.blockTags;return!!this.isElement()&&-1!==t.indexOf(this.node.tagName.toLowerCase())},isElement:function(){return this.node&&this.node.nodeType&&3!==this.node.nodeType},hasParent:function(t){return 0!==this.$el.closest(t.join(",")).length},getNode:function(){return this.node},getTag:function(){return!!this.isElement()&&this.node.tagName.toLowerCase()},getComponent:function(){return!!this.isComponent()&&this.$component.get()},getComponentType:function(){return!!this.isComponent()&&this.$component.attr("data-redactor-type")},getFirstNode:function(){return this.utils.getFirstNode(this.node)},getLastNode:function(){return this.utils.getLastNode(this.node)},getFirstElement:function(){return this.utils.getFirstElement(this.node)},getLastElement:function(){return this.utils.getLastElement(this.node)},getFigcaption:function(){return this._getClosestNode("figcaption")},getPre:function(){return this._getClosestNode("pre")},getCode:function(){return this._getClosestNode("code")},getList:function(){return this._getClosestNode("ul, ol")},getParentList:function(){return this._getClosestUpNode("ul, ol")},getListItem:function(){return this._getClosestNode("li")},getTable:function(){return this.getComponentType("table")?this.$component.find("table").get():this._getClosestNode("table")},getTableCell:function(){var t=this.$el.closest("td, th");return 0!==t.length&&t.get()},getComponentCodeElement:function(){return!!this.isComponentType("code")&&this.$component.find("pre code, pre").last().get()},getImageElement:function(){return!!this.isComponentType("image")&&this.$component.find("img").get()},getParagraph:function(){return this._getClosestNode("p")},getHeading:function(){return this._getClosestNode("h1, h2, h3, h4, h5, h6")},getDl:function(){return this._getClosestNode("dl")},getBlockquote:function(){return this._getClosestNode("blockquote")},getLink:function(){var t=this.isComponent()&&!this.isFigcaption();if(this.isComponentType("table")||!t){var e=this._getClosestElement("a");return!(!e||e.attr("data-file"))&&e.get()}return!1},getFile:function(){var t=this.isComponent();if(this.isComponentType("table")||!t){var e=this._getClosestElement("a");return!(!e||!e.attr("data-file"))&&e.get()}return!1},findFirstNode:function(t){return this.$el.find(t).first().get()},findLastNode:function(t){return this.$el.find(t).last().get()},_getLastOrFirstListItem:function(t){var e=this.getList(),i=this.getTag();if(e&&"li"===i){var n=$R.dom(e).find("li")[t]().get();if(n&&this.node===n)return!0}return!1},_getLastOrFirstTableCell:function(t){var e=this.getTable(),i=this.getTag();if(e&&("td"===i||"th"===i)){var n=$R.dom(e).find("td, th")[t]().get();if(n&&this.node===n)return!0}return!1},_getClosestUpNode:function(t){var e=this.editor.getElement(),i=this.$el.parents(t,e).last();return 0!==i.length&&i.get()},_getClosestNode:function(t){var e=this.editor.getElement(),i=this.$el.closest(t,e);return 0!==i.length&&i.get()},_getClosestElement:function(t){var e=this.editor.getElement(),i=this.$el.closest(t,e);return 0!==i.length&&i}}),$R.add("service","marker",{init:function(t){this.app=t},build:function(t,e){var i=document.createElement("span");return i.id="selection-marker-"+this._getPos(t),i.className="redactor-selection-marker",i.innerHTML=this.opts.markerChar,e?i.outerHTML:i},buildHtml:function(t){return this.build(t,!0)},insert:function(t){this.remove();var e="both"!==t&&("start"===t||this.selection.isCollapsed());this.selection.is()||this.editor.focus();var i=this.selection.getRange();if(i){var n=this.build("start"),r=this.build("end"),o=i.cloneRange();return e||(o.collapse(!1),o.insertNode(r)),o.setStart(i.startContainer,i.startOffset),o.collapse(!0),o.insertNode(n),i.setStartAfter(n),e||i.setEndBefore(r),this.selection.setRange(i),n}},find:function(t,e){var i=this.editor.getElement(),n=(e||i).find("span#selection-marker-"+this._getPos(t));return 0!==n.length&&n.get()},restore:function(){var t=this.find("start"),e=this.find("end"),i=this.selection.getRange();if(i&&this.selection.is()||(this.editor.focus(),i=document.createRange()),t){var n=!!e&&e.previousSibling,r=t.nextSibling;r=(!r||3!==r.nodeType||""!==r.textContent.replace(/[\n\t]/g,""))&&r,e?r&&"selection-marker-end"===r.id?this._restoreInject(i,t):n&&r?(i.selectNodeContents(n),i.collapse(!1),i.setStart(r,0)):n&&!r?(i.selectNodeContents(n),i.collapse(!1),i.setStartAfter(t)):(i.setStartAfter(t),i.setEndBefore(e)):r?(i.selectNodeContents(r),i.collapse(!0)):this._restoreInject(i,t),this.selection.setRange(i),t&&t.parentNode.removeChild(t),e&&e.parentNode.removeChild(e)}},remove:function(){var t=this.find("start"),e=this.find("end");t&&t.parentNode.removeChild(t),e&&e.parentNode.removeChild(e)},_getPos:function(t){return void 0===t?"start":t},_restoreInject:function(t,e){var i=this.utils.createInvisibleChar();$R.dom(e).after(i),t.selectNodeContents(i),t.collapse(!1)}}),$R.add("service","component",{init:function(t){this.app=t,this.activeClass="redactor-component-active"},create:function(t,e){return $R.create(t+".component",this.app,e)},build:function(t){var e,i=$R.dom(t).attr("data-redactor-type");return i&&(e=this.create(i,t)),e||t},remove:function(t,e){var i=$R.dom(t).closest(".redactor-component"),n=i.attr("data-redactor-type"),r=i.parent(),o=this.inspector.parse(r),a=this.utils.findSiblings(i,"prev"),s=this.utils.findSiblings(i,"next");if(!1!==this.app.broadcast(n+".delete",i)){if(i.remove(),this.app.broadcast(n+".deleted",i),this.app.broadcast("contextbar.close"),this.app.broadcast("imageresizer.stop"),!1!==e){var l=o.getTableCell();l&&this.utils.isEmptyHtml(l.innerHTML)?this.caret.setStart(l):s?this.caret.setStart(s):a?this.caret.setEnd(a):this.editor.startFocus()}this.editor.isEmpty()&&(this.editor.setEmpty(),this.editor.startFocus(),this.app.broadcast("empty"))}},isNonEditable:function(t){var e=this.inspector.parse(t);return e.isComponent()&&!e.isComponentEditable()},isActive:function(t){if(t){var e=this.inspector.parse(t);return $R.dom(e.getComponent()).hasClass(this.activeClass)}return 0!==this._find().length},getActive:function(t){var e=this._find();return 0!==e.length&&(t?e:e.get())},setActive:function(t){this.clearActive(),this.editor.focus();var e=this.inspector.parse(t),i=e.getComponent(),n=$R.dom(i);if(!e.isFigcaption()){var r=n.find(".redactor-component-caret");0===r.length&&(r=this._buildCaret(),n.prepend(r)),this.caret.setAtStart(r.get())}n.addClass(this.activeClass)},clearActive:function(){var t=this._find();t.removeClass(this.activeClass),t.find(".redactor-component-caret").remove(),this.app.broadcast("imageresizer.stop")},setOnEvent:function(t,e){this.clearActive();var i=this.inspector.parse(t.target);i.isFigcaption()||i.isComponentEditable()||i.isComponent()&&(this.setActive(t.target),!0!==e&&t.preventDefault())},executeScripts:function executeScripts(scripts){var _this=this,_loop=function(i){if(""!==scripts[i].src){var src=scripts[i].src;_this.$doc.find('head script[src="'+src+'"]').remove();var $script=$R.dom("<script>");$script.attr("src",src),$script.attr("async defer"),$script.get().onload=function(){-1!==src.search("instagram")&&window.instgrm.Embeds.process(),_this.executeScripts(scripts.slice(i+1))}.bind(_this);var head=document.getElementsByTagName("head")[0];return head&&head.appendChild($script.get()),"break"}try{eval(scripts[i].innerHTML)}catch(t){}};if(void 0===scripts){var $editor=this.editor.getElement(),scripts=$editor.find("[data-redactor-type]").find("script").getAll();this.executeScripts.call(this,scripts)}else for(var i=0;i<scripts.length;i++){var _ret=_loop(i);if("break"===_ret)break}},_find:function(){return this.editor.getElement().find("."+this.activeClass)},_buildCaret:function(){var t=$R.dom("<span>");return t.addClass("redactor-component-caret"),t.attr("contenteditable",!0),t}}),$R.add("service","insertion",{init:function(t){this.app=t},set:function(t,e,i){return null===t&&(t=""),t=!1!==e?this.cleaner.input(t):t,t=!1!==e?this.cleaner.paragraphize(t):t,this.editor.getElement().html(t),!1!==i&&this.editor.endFocus(),t},insertNode:function(t,e){this.editor.focus();var i=this.utils.isFragment(t)?t:this.utils.createFragment(t);return this._collapseSelection(),this._insertFragment(i),this._setCaret(e,i),this._sendNodes(i.nodes)},insertBreakLine:function(){return this.insertNode(document.createElement("br"),"after")},insertNewline:function(){return this.insertNode(document.createTextNode("\n"),"after")},insertText:function(t){return this.insertHtml(this.cleaner.getFlatText(t))},insertChar:function(t){return this.insertNode(t,"after")},insertRaw:function(t){return this.insertHtml(t,!1)},insertToEnd:function(t,e){if(t){3===t.nodeType&&-1!==t.nodeValue.search(/^\n/)&&(t=t.previousElementSibling);var i=$R.dom(t);if(i.attr("data-redactor-type")===e){var n=this.opts.breakline?"<br>":"<p>",r=$R.dom(n);i.after(r),this.caret.setStart(r)}}},insertPoint:function(t){var e,i=this.marker.build("start"),n=!1,r=t.clientX,o=t.clientY;if(document.caretPositionFromPoint){var a=document.caretPositionFromPoint(r,o),s=document.getSelection();this.inspector.parse(a.offsetNode).isInEditor()&&((e=s.getRangeAt(0)).setStart(a.offsetNode,a.offset),e.collapse(!0),e.insertNode(i),n=!0)}else document.caretRangeFromPoint&&(e=document.caretRangeFromPoint(r,o),this.inspector.parse(e.startContainer).isInEditor()&&(e.insertNode(i),n=!0));return n},insertToPoint:function(t,e,i,n){if(!0!==i&&!this.insertPoint(t)){var r=this.editor.getLastNode();$R.dom(r).after(this.marker.build("start"))}return this.component.clearActive(),this.selection.restoreMarkers(),this.insertHtml(e,n)},insertToOffset:function(t,e){return this.offset.set({start:t,end:t}),this.insertHtml(e)},insertHtml:function(t,e){if(this.opts.input){var i=this.utils.parseHtml(t);if(this.selection.isAll())return this._insertToAllSelected(i);if(!this.selection.is()){var n=$R.dom("<p>");this.editor.getElement().append(n),this.caret.setStart(n)}var r=this.selection.isCollapsed(),o=this.selection.isText(),a=this.selection.getCurrent(),s=this.selection.getBlock(),l=this.inspector.parse(a);this._collapseSelection(),i=this._getCleanedInput(i,l,e);var c,h,u=this._isFigure(i.html),d=this._isComponentSpan(i.html),p=this.inspector.isText(i.html);if(this.editor.isEmpty())return this._insertToEmptyEditor(i.html);if(l.isComponent()&&!l.isComponentEditable())return this._insertToWidget(a,l,i.html);if(d)return this.insertNode(i.nodes,"end");if(u&&!o&&!l.isList())return l.isInline()?this._insertToInline(a,i):(c=this.utils.createFragment(i.html),this.utils.splitNode(a,c),this.caret.setEnd(c.last),this._sendNodes(c.nodes));if(l.isCode())return this._insertToCode(i,a,e);if(l.isPre())return this._insertToPre(i,e);if(l.isHeading()||l.isFigcaption())return i.html=!1!==e?this.cleaner.removeTagsExcept(i.html,["a"]):i.html,i.html=!1!==e?this.cleaner.replaceNbspToSpaces(i.html):i.html,c=this.utils.createFragment(i.html),this.insertNode(c,"end");if(this.opts.breakline&&s&&"DIV"===s.tagName){if(this._isPlainHtml(i.html))return this.insertNode(i.nodes,"end");i.html=!1!==e?this.cleaner.paragraphize(i.html):i.html,c=this.utils.createFragment(i.html);var f=this.selection.getRange();return f&&!this.selection.isCollapsed()&&f.deleteContents(),this.utils.splitNode(a,c),this.caret.setEnd(c.last),this._sendNodes(c.nodes)}if(p)return!o&&"br"!==this.opts.markup&&this._hasBlocksAndImages(i.nodes)?(i.html=!1!==e?this.cleaner.paragraphize(i.html):i.html,c=this.utils.createFragment(i.html),this.utils.splitNode(a,c),this.caret.setEnd(c.last),this._sendNodes(c.nodes)):(i.html=!1!==e?i.html.replace(/\n/g,"<br>"):i.html,c=this.utils.createFragment(i.html),this.insertNode(c.nodes,"end"));if(!r&&!u)return this._isPlainHtml(i.html)?this.insertNode(i.nodes,"end"):(i.html=!1!==e?this.cleaner.paragraphize(i.html):i.html,c=this.utils.createFragment(i.html),this.insertNode(c,"end"));if(l.isInline()&&!this._isPlainHtml(i.html))return this._insertToInline(a,i);if(l.isBlockquote()||l.isDl())return(h=this.opts.inlineTags).concat(["br"]),i.html=!1!==e?this.cleaner.replaceBlocksToBr(i.html):i.html,i.html=!1!==e?this.cleaner.removeTagsExcept(i.html,h):i.html,c=this.utils.createFragment(i.html),this.insertNode(c,"end");if(l.isParagraph())return this._isPlainHtml(i.html)?this.insertNode(i.nodes,"end"):(i.html=!1!==e?this.cleaner.paragraphize(i.html):i.html,c=this.utils.createFragment(i.html),this.utils.splitNode(a,c),this.caret.setEnd(c.last),this._sendNodes(c.nodes));if(l.isList()&&(h=(h=this.opts.inlineTags).concat(["br","li","ul","ol","img"]),i.html=!1!==e?this.cleaner.replaceBlocksToBr(i.html):i.html,i.html=!1!==e?this.cleaner.removeTagsExcept(i.html,h):i.html,i.html=!1!==e?this.cleaner.removeBrAtEnd(i.html):i.html,c=this.utils.createFragment(i.html),i.nodes=c.nodes,this._containsTags(i.html,["ul","ol","li"]))){var m=this.selection.getElement(a);if(m&&"LI"===m.tagName&&this.caret.isStart(m)){i.nodes=$R.dom(c.nodes).unwrap("ul, ol").getAll(),$R.dom(m).before(i.nodes);var g=i.nodes[i.nodes.length-1];return this.caret.setEnd(g),this._sendNodes(i.nodes)}return this._isPlainHtml(i.html)?this.insertNode(c,"end"):(c=this._buildList(i,m,c),this.utils.splitNode(a,c,!0),this.caret.setEnd(c.last),this._sendNodes(c.nodes))}return this.insertNode(i.nodes,"end")}},_insertToAllSelected:function(t){var e=this.set(t.html),i=this.utils.parseHtml(e);return this._sendNodes(i.nodes)},_insertToEmptyEditor:function(t){t=this.cleaner.paragraphize(t);var e=this.utils.createFragment(t),i=this.editor.getElement();return i.html(""),i.append(e.frag),this.caret.setEnd(e.last),this._sendNodes(e.nodes)},_insertToInline:function(t,e){var i=this.utils.createFragment(e.html);return this.utils.splitNode(t,i,!1,!0),this.caret.setEnd(i.last),this._sendNodes(i.nodes)},_insertToCode:function(t,e,i){t.html=!1!==i?this.cleaner.encodeHtml(t.html):t.html,t.html=!1!==i?this.cleaner.removeNl(t.html):t.html;var n=this.utils.createFragment(t.html),r=this.insertNode(n,"end");return this.utils.normalizeTextNodes(e),r},_insertToPre:function(t,e){t.html=!1!==e?this.cleaner.encodeHtml(t.html):t.html;var i=this.utils.createFragment(t.html);return this.insertNode(i,"end")},_insertToWidget:function(t,e,i){i=this._isComponentSpan(i)?i:this.cleaner.paragraphize(i);var n=this.utils.createFragment(i),r=e.getComponent(),o=$R.dom(r);return o.after(n.frag),o.remove(),this.caret.setEnd(n.last),this._sendNodes(n.nodes)},_insertFragment:function(t){var e=this.selection.getRange();if(e){if(this.selection.isCollapsed()){var i=e.startContainer;3!==i.nodeType&&"BR"===i.tagName&&(this.caret.setAfter(i),i.parentNode.removeChild(i))}else e.deleteContents();e.insertNode(t.frag)}},_sendNodes:function(t){for(var e=0;e<t.length;e++){var i=t[e],n=3!==i.nodeType&&"function"==typeof i.getAttribute&&i.getAttribute("data-redactor-type");n&&this.app.broadcast(n+".inserted",this.component.build(i))}return this.detector.isIe()&&this.editor.getElement().find("[data-redactor-type=table]").attr("contenteditable",!0),this.app.broadcast("inserted",t),this.component.executeScripts(),t},_setCaret:function(t,e){var i=this._isLastInline(e);t?(t=i&&"end"===t?"after":t,this.caret["set"+this.utils.ucfirst(t)](e.last)):!1!==t&&i&&this.caret.setAfter(e.last)},_isLastInline:function(t){return!!t.last&&this.inspector.parse(t.last).isInline()},_getCleanedInput:function(t,e,i){var n=e.isCode()||e.isPre();return t.html=t.html.replace(/&nbsp;/g," "),t.html=n||!1===i?t.html:this.cleaner.input(t.html),n||!1===i?t:this.utils.parseHtml(t.html)},_getContainer:function(t){return $R.dom(this.utils.createTmpContainer(t))},_buildList:function(t,e,i){var n=t.nodes[0];if(n&&3!==n.nodeType&&"li"===n.tagName){var r=$R.dom(e).get().tagName.toLowerCase(),o=$R.dom("<"+r+" />");return o.append(i.nodes),this.utils.createFragment(o.get().outerHTML)}return i},_containsTags:function(t,e){return 0!==this._getContainer(t).find(e.join(",")).length},_collapseSelection:function(){},_hasFigureOrTable:function(t){return 0!==this._getContainer(t).find("figure, table").length},_hasBlocks:function(t){return 0!==this._getContainer(t).find(this.opts.blockTags.join(",")).length},_hasBlocksAndImages:function(t){return 0!==this._getContainer(t).find(this.opts.blockTags.join(",")+",img").length},_isPlainHtml:function(t){return 0===this._getContainer(t).find(this.opts.blockTags.join(",")+", img").length},_isFigure:function(t){if(this._isHtmlString(t))return 0!==$R.dom(t).closest("figure").length},_isComponentSpan:function(t){if(this._isHtmlString(t))return 0!==$R.dom(t).closest("span.redactor-component").length},_isHtmlString:function(t){return!("string"==typeof t&&!/^\s*<(\w+|!)[^>]*>/.test(t))}}),$R.add("service","block",{init:function(t){this.app=t,this.tags=["p","div","blockquote","pre","h1","h2","h3","h4","h5","h6"]},format:function(t){return this.params={args:!1},this.params.type=t.type?t.type:"set",this.params.tag="string"==typeof t?t:t.tag||this.opts.markup,this.params.tag=this.params.tag.toLowerCase(),this.params.args={class:t.class||!1,style:t.style||!1,attr:t.attr||!1},t.class||t.style||t.attr||(this.params.args=!1),this._format()},add:function(t,e,i){return this._apply("add",t,e,!0,i)},set:function(t,e){return this._apply("set",t,e)},toggle:function(t,e){return this._apply("toggle",t,e)},remove:function(t,e){return this._apply("remove",t,e)},clearFormat:function(t){return this._clear(t,"all")},clearStyle:function(t){return this._clear(t,"style")},clearClass:function(t){return this._clear(t,"class")},clearAttr:function(t){return this._clear(t,"attr")},_format:function(){var t=[];this.collapsed=this.selection.isCollapsed(),this.selection.save(),this.selection.getBlock();var e=this._getBlocks(),i=this._isToggleFormatType(e)?"toggle":"set",n=this._getReplacedTag(i);return t=this._replaceBlocks(e,n),t=this._buildNodes(t),this._restoreSelection(t),t},_clear:function(t,e,i,n){!1!==i&&this.selection.save();var r=this._getElements(t,n);return"all"===e?this._removeAllAttr(r,!1):"style"===e?(r.removeAttr("style"),r.removeAttr("data-redactor-style-cache")):"class"===e?r.removeAttr("class"):"attr"===e&&this._removeAllAttr(r),n=r.getAll(),!1!==i&&this._restoreSelection(n),n},_getElements:function(t,e){return e?$R.dom(e):$R.dom(this._getBlocks(t))},_getBlocks:function(t){for(var e=this.selection.getBlocks({tags:t||this.tags}),i=[],n=0;n<e.length;n++)("DIV"!==e[n].tagName||e[n].getAttribute("data-redactor-tag"))&&i.push(e[n]);return i},_getReplacedTag:function(t){return this.opts.breakline?"toggle"===t||"p"===this.params.tag?"div":this.params.tag:"toggle"===t?this.opts.markup:this.params.tag},_isStandardParagraph:function(){return!this.opts.breakline&&"p"===this.opts.markup},_isStandardDiv:function(){return!this.opts.breakline&&"div"===this.opts.markup},_isBreaklineBlock:function(t){return t&&"DIV"===t.tagName&&"br"===t.getAttribute("data-redactor-tag")},_isToggleFormatType:function(t){for(var e=0,i=t.length,n=0;n<i;n++)t[n]&&this.params.tag===t[n].tagName.toLowerCase()&&e++;return e===i},_isCurrentBlockOneAndEmpty:function(t){return this.collapsed&&1===t.length&&this.utils.isEmpty(t[0])},_buildNodes:function(t){return t.length>0&&(t=this._applyArgs(t,!1),t=this._combinePre(t),t=this._cleanBlocks(t)),t},_replaceBlocks:function(t,e){for(var i=[],n=0;n<t.length;n++){var r=this.utils.replaceToTag(t[n],e);i.push(r.get())}return i},_combinePre:function(t){for(var e=[],i=0;i<t.length;i++){var n=t[i].nextElementSibling;if(n&&"PRE"===t[i].tagName&&"PRE"===n.tagName){var r=$R.dom(t[i]),o=$R.dom(n),a=document.createTextNode("\n");r.append(a),r.append(o),o.unwrap("pre")}e.push(t[i])}return e},_cleanBlocks:function(t){for(var e=["h1","h2","h3","h4","h5","h6"],i=this.opts.inlineTags,n=0;n<t.length;n++){var r=t[n].tagName.toLowerCase(),o=$R.dom(t[n]);-1!==e.indexOf(r)?o.find("span").not(".redactor-component, .non-editable, .redactor-selection-marker").unwrap():"pre"===r&&o.find(i.join(",")).not(".redactor-selection-marker").unwrap(),!1===this.params.args&&"p"===this.params.tag&&o.removeAttr("class"),this.opts.breakline&&"div"===r?o.attr("data-redactor-tag","br"):o.removeAttr("data-redactor-tag"),this.utils.normalizeTextNodes(t[n])}return t},_cleanEmptyClass:function(t){t.each((function(t){""===t.className&&t.removeAttribute("class")}))},_cleanEmptyStyle:function(t){this.utils.removeEmptyAttr(t.get(),"style")?t.removeAttr("data-redactor-style-cache"):t.attr("data-redactor-style-cache",t.attr("style"))},_apply:function(t,e,i,n,r){!1!==n&&this.selection.save();var o=this._getElements(i,r);if(e.class&&("set"===t?(o.removeAttr("class"),o.addClass(e.class)):"add"===t?o.addClass(e.class):"toggle"===t?o.toggleClass(e.class):"remove"===t&&o.removeClass(e.class),this._cleanEmptyClass(o)),e.attr&&("set"===t?(this._removeAllAttr(o),o.attr(e.attr)):"add"===t?o.attr(e.attr):"toggle"===t?(a=e.attr,o.each((function(t){var e=$R.dom(t);for(var i in a)e.attr(i)?e.removeAttr(i):e.attr(i,a[i])}))):"remove"===t&&o.removeAttr(e.attr)),e.style)if("set"===t)o.removeAttr("style"),o.css(e.style),o.each((function(t){var e=$R.dom(t);e.attr("data-redactor-style-cache",e.attr("style"))}));else if("add"===t){var a=e.style;o.each(function(t){var e=$R.dom(t);e.css(a),e.attr("data-redactor-style-cache",e.attr("style")),this._convertStyleQuotes(e)}.bind(this))}else if("toggle"===t)a=e.style,o.each(function(t){var e=$R.dom(t);for(var i in a){var n=a[i],r=e.css(i);r=this.utils.isRgb(r)?this.utils.rgb2hex(r):r.replace(/"/g,""),n=this.utils.isRgb(n)?this.utils.rgb2hex(n):n.replace(/"/g,""),r=this.utils.hex2long(r),("string"==typeof(n=this.utils.hex2long(n))?n.toLowerCase():n)===("string"==typeof r?r.toLowerCase():r)?e.css(i,""):e.css(i,n)}this._convertStyleQuotes(e),this._cleanEmptyStyle(e)}.bind(this));else if("remove"===t){var s=e.style;o.each(function(t){var e=$R.dom(t);e.css(s,""),this._cleanEmptyStyle(e)}.bind(this))}return r=o.getAll(),!1!==n&&this._restoreSelection(r),r},_applyArgs:function(t){return this.params.args?this._apply(this.params.type,this.params.args,!1,!1,t):this._clear(!1,"all",!1,t)},_removeAllAttr:function(t,e){t.each((function(t){var i=["data-redactor-tag","data-redactor-style-cache"];!1===e&&(i.push("style"),i.push("class"));for(var n=t.attributes.length;n-- >0;){var r=t.attributes[n],o=r.name;-1===i.indexOf(o)&&t.removeAttributeNode(r)}}))},_restoreSelection:function(t){this._isCurrentBlockOneAndEmpty(t)?this.caret.setStart(t[0]):setTimeout(function(){this.selection.restore()}.bind(this),1)},_convertStyleQuotes:function(t){var e=t.attr("style");e&&t.attr("style",e.replace(/"/g,"'"))}}),$R.add("service","inline",{mixins:["formatter"],init:function(t){this.app=t,this.count=0},format:function(t){if(!this._isFormat())return[];this.type=t.type?t.type:"set",this.tag="string"==typeof t?t:t.tag,this.tag=this.tag.toLowerCase(),this.tag=this.arrangeTag(this.tag),"string"==typeof t?this.args=!1:this.buildArgs(t),this.detector.isIe()||this.editor.disableNonEditables();var e=this.selection.isCollapsed()?this.formatCollapsed():this.formatUncollapsed();return this.detector.isIe()||this.editor.enableNonEditables(),e},_isFormat:function(){var t=this.selection.getCurrent(),e=this.inspector.parse(t),i=e.isComponent()&&!e.isComponentType("table")&&!e.isFigcaption();return!(!1!==t||!this.selection.isAll())||!(!t||e.isPre()||e.isCode()||i)},arrangeTag:function(t){var e=this.opts.replaceTags;for(var i in e)t===i&&(t=e[i]);return t},formatCollapsed:function(){var t,e,i,n,r=[],o=this.selection.getInlineFirst(),a=this.selection.getInlines({all:!0}),s=$R.dom(o);if(o){var l=this.inspector.parse(o);if(this.utils.isEmptyHtml(o.innerHTML))if(o.tagName.toLowerCase()===this.tag)if(this.hasSameArgs(o)){this.caret.setAfter(o),s.remove();var c=this.selection.getElement();this.utils.normalizeTextNodes(c)}else"span"===this.tag?(r=this.applyArgs([o],!1),this.caret.setStart(o)):r=this.insertInline(r);else l.hasParent([this.tag])?(e=(t=s.closest(this.tag)).get(),this.hasSameArgs(e)?(t.unwrap(),this.caret.setStart(o)):r=this.insertInline(r)):r=this.insertInline(r);else if(o.tagName.toLowerCase()===this.tag)this.hasSameArgs(o)?(n=this.utils.extractHtmlFromCaret(o),i=$R.dom("<"+this.tag+" />"),i=this.utils.cloneAttributes(o,i),s.after(i.append(n)),""===i.html().trim()&&i.remove(),this.caret.setAfter(o)):r=this.insertInline(r);else if(l.hasParent([this.tag]))if(e=(t=s.closest(this.tag)).get(),this.hasSameArgs(e)){var h,u;n=this.utils.extractHtmlFromCaret(e,e),i=$R.dom("<"+this.tag+" />"),i=this.utils.cloneAttributes(e,i);var d=0;a=a.reverse();for(var p=0;p<a.length;p++)a[p]!==e&&(u=$R.dom("<"+a[p].tagName.toLowerCase()+">"),0===d?h=u:h.append(u),d++);t.after(i.append(n)),t.after(h),this.caret.setStart(u)}else r=this.insertInline(r);else r=this.insertInline(r)}else r=this.insertInline(r);return r},insertInline:function(t){var e=document.createElement(this.tag);return t=this.insertion.insertNode(e,"start"),this.applyArgs(t,!1)},hasSameArgs:function(t){if(0===t.attributes.length&&!1===this.args)return!0;var e=!0;if(this.args){var i=0;for(var n in this.args){var r=$R.dom(t),o=this.args[n],a=this.utils.toParams(o),s=r.attr(n);if(o)if("style"===n){a=a.trim().replace(/;$/,"");for(var l=this.utils.styleToObj(r.attr("style")),c=a.split(";"),h=0,u=0;u<c.length;u++){var d=c[u].split(":"),p=d[0].trim(),f=d[1].trim();if(-1!==p.search(/color/)){var m=r.css(p);!m||m!==f&&this.utils.rgb2hex(m)!==f||h++}else r.css(p)===f&&h++}h===c.length&&Object.keys(l).length===c.length&&i++}else s===a&&i++;else s&&""!==s||i++}e=i===Object.keys(this.args).length}return e},formatUncollapsed:function(){var t=this.selection.getInlines({all:!0,inside:!0});this.detector.isIe()?this.selection.saveMarkers():this.selection.save(),this._convertTags("u"),this._convertTags("del"),this._convertToStrike(t),this.detector.isIe()?this.selection.restoreMarkers():this.selection.restore(),document.execCommand("strikethrough"),this._clearDecoration(),this.selection.save();var e=this._revertToInlines();e=this.applyArgs(e,!1);for(var i=0;i<e.length;i++){var n=e[i],r=n.tagName.toLowerCase(),o=n.attributes.length;r===this.tag&&0===o&&this.args&&($R.dom(n).unwrap(),e.splice(i,1))}return this.selection.restore(),this._clearEmptyStyle(),this._normalizeBlocks(e)},_convertTags:function(t){this.tag!==t&&this.editor.getElement().find(t).each(function(e){this.utils.replaceToTag(e,"span").addClass("redactor-convertable-"+t)}.bind(this))},_revertTags:function(t){this.editor.getElement().find("span.redactor-convertable-"+t).each(function(e){var i=this.utils.replaceToTag(e,t);i.removeClass("redactor-convertable-"+t),this.utils.removeEmptyAttr(i,"class")&&i.removeAttr("class")}.bind(this))},_convertToStrike:function(t){for(var e=this.selection.getText().replace(/[-[\]\/{}()*+?.\\^$|]/g,"\\$&"),i=0;i<t.length;i++){var n=this.arrangeTag(t[i].tagName.toLowerCase()),r=t[i],o=$R.dom(r),a=this.hasSameArgs(r);n===this.tag&&("span"===this.tag&&this._isTextSelected(r,e)?o.addClass("redactor-convertable-apply"):a&&"a"!==this.tag?this._replaceToStrike(o):"span"===this.tag?o.addClass("redactor-unconvertable-apply"):a||o.addClass("redactor-convertable-apply"))}},_replaceToStrike:function(t){t.replaceWith((function(){return $R.dom("<strike>").append(t.contents())}))},_revertToInlines:function(){var t=[],e=this.editor.getElement();return"u"!==this.tag&&e.find("u").unwrap(),e.find(".redactor-convertable-u").each((function(e){t.push(e)})),e.find(".redactor-convertable-apply").each(function(e){var i=$R.dom(e);i.find("strike").unwrap(),this._forceRemoveClass(i,"redactor-convertable-apply"),t.push(e)}.bind(this)),e.find("span.redactor-unconvertable-apply").each(function(t){var e=$R.dom(t);this._forceRemoveClass(e,"redactor-unconvertable-apply")}.bind(this)),e.find("strike").each(function(e){var i=this.utils.replaceToTag(e,this.tag);t.push(i.get())}.bind(this)),this._revertTags("u"),this._revertTags("del"),t},_normalizeBlocks:function(t){var e=this.opts.inlineTags,i=this.selection.getBlocks();if(i)for(var n=0;n<i.length;n++)"PRE"===i[n].tagName&&$R.dom(i[n]).find(e.join(",")).not(".redactor-selection-marker").each(function(e){-1!==t.indexOf(e)&&(t=this.utils.removeFromArrayByValue(t,e)),$R.dom(e).unwrap()}.bind(this));return t},_clearDecoration:function(){this.editor.getElement().find(this.opts.inlineTags.join(",")).each((function(t){if("line-through"===t.style.textDecoration||"line-through"===t.style.textDecorationLine){var e=$R.dom(t);e.css("textDecorationLine",""),e.css("textDecoration",""),e.wrap("<strike>")}}))},_clearEmptyStyle:function(){for(var t=this.getInlines(),e=0;e<t.length;e++){this._clearEmptyStyleAttr(t[e]);var i=t[e].childNodes;if(i)for(var n=0;n<i.length;n++)this._clearEmptyStyleAttr(i[n])}},_clearEmptyStyleAttr:function(t){3!==t.nodeType&&this.utils.removeEmptyAttr(t,"style")&&(t.removeAttribute("style"),t.removeAttribute("data-redactor-style-cache"))},_forceRemoveClass:function(t,e){t.removeClass(e),this.utils.removeEmptyAttr(t,"class")&&t.removeAttr("class")},_isTextSelected:function(t,e){var i=this.utils.removeInvisibleChars(t.textContent);return e===i||-1!==e.search(new RegExp("^"+this.utils.escapeRegExp(i)+"$"))},getInlines:function(t){return t?this.selection.getInlines({tags:t,all:!0}):this.selection.getInlines({all:!0})},getElements:function(t){return $R.dom(this.getInlines(t))},clearFormat:function(){this.selection.save();for(var t=this.selection.getInlines({all:!0}),e=0;e<t.length;e++){var i=$R.dom(t[e]);this.selection.getInline(t[e])&&i.unwrap()}this.selection.restore()}}),$R.add("service","autoparser",{init:function(t){this.app=t,this.cleaner=this.app.cleaner},observe:function(){var t=this.editor.getElement().find(".redactor-autoparser-object").each((function(t){var e=$R.dom(t);e.removeClass("redactor-autoparser-object"),""===e.attr("class")&&e.removeAttr("class")}));t.length>0&&t.each(function(t){var e,i=!1,n=t.tagName;"A"===n?e="link":"IMG"===n?e="image":"IFRAME"===n&&(e="video"),e&&(i=$R.create(e+".component",this.app,t),this.app.broadcast(e+".inserted",i),this.app.broadcast("autoparse",e,i))}.bind(this))},format:function(t,e){this._isKey(e)&&this._format(e===this.keycodes.ENTER)},parse:function(t){var e=["figure","form","pre","iframe","code","a","img"],i=[],n=0,r=[];t=this.cleaner.storeComments(t,r),t=(t=(t=this.cleaner.encodeCode(t)).replace(/\$/g,"&#36;")).replace(/&amp;/g,"&");for(var o=0;o<e.length;o++){var a="img"===e[o]?"<"+e[o]+"[^>]*>":"<"+e[o]+"([\\w\\W]*?)</"+e[o]+">";if(null!==(p=t.match(new RegExp(a,"gi"))))for(var s=0;s<p.length;s++)t=t.replace(p[s],"#####replaceparse"+n+"#####"),i.push(p[s]),n++}if(this.opts.autoparseImages&&t.match(this.opts.regex.imageurl)){var l=t.match(this.opts.regex.imageurl);for(o=0;o<l.length;o++)t=t.replace(l[o],'<img class="redactor-autoparser-object" src="'+l[o]+'">')}if(this.opts.autoparseVideo&&(t.match(this.opts.regex.youtube)||t.match(this.opts.regex.vimeo))){var c,h,u=this.opts.autoparseHttps?"https:":"";t.match(this.opts.regex.youtube)?(c=u+"//www.youtube.com/embed/$1",h=this.opts.regex.youtube):t.match(this.opts.regex.vimeo)&&(c=u+"//player.vimeo.com/video/$2",h=this.opts.regex.vimeo);var d=this.component.create("video",'<iframe width="500" height="281" src="'+c+'" frameborder="0" allowfullscreen></iframe>');t=t.replace(h,d.get().outerHTML)}for(o=0;o<e.length;o++){var p;if(a="img"===e[o]?"<"+e[o]+"[^>]*>":"<"+e[o]+"([\\w\\W]*?)</"+e[o]+">",null!==(p=t.match(new RegExp(a,"gi"))))for(s=0;s<p.length;s++)t=t.replace(p[s],"#####replaceparse"+n+"#####"),i.push(p[s]),n++}return this.opts.autoparseLinks&&t.match(this.opts.regex.url)&&(t=this._formatLinks(t)),t=this._restoreReplaced(i,t),t=this._restoreReplaced(i,t),this.cleaner.restoreComments(t,r)},_isKey:function(t){return t===this.keycodes.ENTER||t===this.keycodes.SPACE},_format:function(t){var e=this.selection.getParent(),i=$R.dom(e);if((!e||0===i.closest("figure, pre, code, img, a, iframe").length)&&this.selection.isCollapsed()){var n=this.utils.createInvisibleChar();this.selection.getRange().insertNode(n);var r=this.selection.getCurrent(),o=this.inspector.parse(r),a=$R.dom(r);if(n.parentNode.removeChild(n),r&&3===r.nodeType){var s,l=r.textContent;if(this.opts.autoparseImages&&l.match(this._convertToRegExp(this.opts.regex.imageurl))){var c=o.isList(),h=l.match(this.opts.regex.imageurl),u=c?void 0:"<figure><img></figure>",d=this.component.create("image",u);d.setSrc(h[0]),d.addClass("redactor-autoparser-object"),l=l.replace(h[0],d.get().outerHTML),s="image"}else if(this.opts.autoparseVideo&&(l.match(this._convertToRegExp(this.opts.regex.youtube))||l.match(this._convertToRegExp(this.opts.regex.vimeo)))){var p,f;l.match(this.opts.regex.youtube)?(p="//www.youtube.com/embed/$1",f=this.opts.regex.youtube):l.match(this.opts.regex.vimeo)&&(p="//player.vimeo.com/video/$2",f=this.opts.regex.vimeo);var m=this.component.create("video",'<iframe width="500" height="281" src="'+p+'" frameborder="0" allowfullscreen></iframe>');m.addClass("redactor-autoparser-object"),l=l.replace(f,m.get().outerHTML),s="video"}else this.opts.autoparseLinks&&l.match(this._convertToRegExp(this.opts.regex.url))&&(l=this._formatLinks(l,t),s="link");if(s){t?(this.selection.save(),a.replaceWith(l),this.selection.restore()):a.replaceWith(l);var g=this.editor.getElement().find(".redactor-autoparser-object").removeClass("redactor-autoparser-object");if(g="link"===s?$R.create("link.component",this.app,g):g,"link"===s)t||this.caret.setAfter(g),this.app.broadcast("link.inserted",g);else{this.caret.setAfter(g);var v=g.clone();g.remove(),g=this.insertion.insertHtml(v),g=this.component.build(g)}this.app.broadcast("autoparse",s,g)}}}},_formatLinks:function(t){var e=!1!==this.opts.pasteLinkTarget?' target="'+this.opts.pasteLinkTarget+'"':"",i=' class="redactor-autoparser-object"',n=this;return(t=t.replace(this.opts.regex.aurl1,(function(t){return'<a href="'+t+'"'+e+i+">"+n._subLinkText(t)+"</a>"}))).replace(this.opts.regex.aurl2,(function(t,r,o){return r+'<a href="http://'+o+'"'+e+i+">"+n._subLinkText(o)+"</a>"}))},_subLinkText:function(t){return-1===(t=t.length>this.opts.linkSize?t.substring(0,this.opts.linkSize)+"...":t).search("%")?decodeURIComponent(t):t},_restoreReplaced:function(t,e){for(var i=0;i<t.length;i++)e=e.replace("#####replaceparse"+i+"#####",t[i]);return e},_convertToRegExp:function(t){return new RegExp(String(t).replace(/^\//,"").replace(/\/ig$/,"").replace(/\/gi$/,"")+"$","gi")}}),$R.add("service","storage",{init:function(t){this.app=t,this.data=[]},observeImages:function(){this.opts.imageObserve&&this.editor.getElement().find("[data-image]").each(this._addImage.bind(this))},observeFiles:function(){this.editor.getElement().find("[data-file]").each(this._addFile.bind(this))},setStatus:function(t,e){this.data[t].status=e},getChanges:function(){var t=this.editor.getElement();for(var e in this.data){var i=this.data[e],n=t.find("[data-"+i.type+'="'+i.id+'"]');this.setStatus(i.id,0!==n.length)}return this.data},add:function(t,e){var i=$R.dom(e),n=i.attr("data-"+t);this.data[n]={type:t,status:!0,node:i.get(),id:i.attr("data-"+t)}},_addImage:function(t){this.add("image",t)},_addFile:function(t){this.add("file",t)}}),$R.add("service","utils",{init:function(t){this.app=t},isEmpty:function(t){var e=!1;return(t=$R.dom(t).get())&&(e=3===t.nodeType?""===t.textContent.trim().replace(/\n/,""):""===t.innerHTML),e},isEmptyHtml:function(t,e,i){return t=(t=(t=(t=(t=(t=this.removeInvisibleChars(t)).replace(/&nbsp;/gi,"")).replace(/<\/?br\s?\/?>/g,e?"br":"")).replace(/\s/g,"")).replace(/^<p>[^\W\w\D\d]*?<\/p>$/i,"")).replace(/^<div>[^\W\w\D\d]*?<\/div>$/i,""),i&&(t=(t=t.replace(/<ul(.*?[^>])>$/i,"ul")).replace(/<ol(.*?[^>])>$/i,"ol")),""===(t=(t=(t=(t=(t=t.replace(/<hr(.*?[^>])>$/i,"hr")).replace(/<iframe(.*?[^>])>$/i,"iframe")).replace(/<source(.*?[^>])>$/i,"source")).replace(/<[^\/>][^>]*><\/[^>]+>/gi,"")).replace(/<[^\/>][^>]*><\/[^>]+>/gi,"")).trim()},trimSpaces:function(t){return this.removeInvisibleChars(t.trim())},createInvisibleChar:function(){return document.createTextNode(this.opts.markerChar)},searchInvisibleChars:function(t){return t.search(/^\uFEFF$/g)},removeInvisibleChars:function(t){return t.replace(/\uFEFF/g,"")},trimInvisibleChars:function(t){if(this.selection.isCollapsed()){var e=this.selection.getCurrent(),i="left"===t?this.selection.getTextBeforeCaret():this.selection.getTextAfterCaret();if(e&&3===e.nodeType&&0===this.searchInvisibleChars(i))if("left"===t)$R.dom(e).replaceWith(e.textContent.trim());else{var n=this.offset.get();this.offset.set({start:n.start+1,end:n.end+1})}}},buildWrapper:function(t){return $R.dom("<div>").html(t)},getWrapperHtml:function(t){var e=t.html();return t.remove(),e},createTmpContainer:function(t){var e=$R.dom("<div>");return"string"==typeof t?e.html(t):e.append($R.dom(t).clone(!0)),e.get()},createFragment:function(t){for(var e,i,n,r=this.createTmpContainer(t),o=document.createDocumentFragment(),a=[],s=0;e=r.firstChild;){s++;var l=o.appendChild(e);1===s&&(i=l),a.push(l),n=l}return{frag:o,first:i,last:n,nodes:a}},isFragment:function(t){return"object"==typeof t&&t.frag},parseHtml:function(t){var e=this.createTmpContainer(t);return{html:e.innerHTML,nodes:e.childNodes}},splitNode:function(t,e,i,n){var r;e=this.isFragment(e)?e.frag:e,r=n?this.inspector.isInlineTag(t.tagName)?t:this.selection.getInline(t):this.inspector.isBlockTag(t.tagName)?t:this.selection.getBlock(t);var o=$R.dom(r);if(!n&&this.isEmptyHtml(r.innerHTML,!0))return o.after(e),o.remove(),e;var a=o.get().tagName.toLowerCase(),s=this.caret.isEnd(r),l=this.caret.isStart(r);if(!s&&!l){var c=this.extractHtmlFromCaret(n),h=$R.dom("<"+a+" />");h=this.cloneAttributes(r,h),o.after(h.append(c))}if(l)return o.before(e);if(i)return o.append(e);e=o.after(e);var u=o.html();return""===(u=(u=this.removeInvisibleChars(u)).replace(/&nbsp;/gi,""))&&o.remove(),e},extractHtmlFromCaret:function(t,e){var i=this.selection.getRange();if(i&&(e=e||(t?this.selection.getInline():this.selection.getBlock()))){var n=i.cloneRange();return n.selectNodeContents(e),n.setStart(i.endContainer,i.endOffset),n.extractContents()}},createMarkup:function(t){var e=document.createElement(this.opts.markup);this.opts.breakline&&e.setAttribute("data-redactor-tag","br"),$R.dom(t).after(e),this.caret.setStart(e)},createMarkupBefore:function(t){var e=document.createElement(this.opts.markup);this.opts.breakline&&e.setAttribute("data-redactor-tag","br"),$R.dom(t).before(e),this.caret.setEnd(e)},getNode:function(t){var e=$R.dom(t).get(),i=this.editor.getElement().get();return void 0===t?i:e||!1},findSiblings:function(t,e){for(t=$R.dom(t).get(),e="next"===e?"nextSibling":"previousSibling";t=t[e];)if((3!==t.nodeType||""!==t.textContent.trim())&&"BR"!==t.tagName)return t;return!1},getElementsFromHtml:function(t,e,i){var n=document.createElement("div");n.innerHTML=t;var r=n.querySelectorAll(e);return function(t,e){if("number"==typeof this.length&&"function"==typeof t){var i=[];if("object"==typeof this)for(var n=0;n<this.length;n++){if(!(n in this))return;i[n]=t.call(e||this,this[n],n,this)}return i}}.call(r,(function(t){var e=t.getAttribute("data-redactor-type");if(!i||!e||e!==i)return t.outerHTML}))},getChildNodes:function(t,e,i){var n=(t=t&&t.nodeType&&11===t.nodeType?t:$R.dom(t).get()).childNodes,r=[];if(n)for(var o=0;o<n.length;o++)if(!(!0===i&&3===n[o].nodeType||3===n[o].nodeType&&this.isEmpty(n[o])||(r.push(n[o]),!1===e))){var a=this.getChildNodes(n[o],i);a.length>0&&(r=r.concat(a))}return r},getChildElements:function(t){return this.getChildNodes(t,!0,!0)},getFirstNode:function(t){return this._getFirst(this.getChildNodes(t,!1))},getLastNode:function(t){return this._getLast(this.getChildNodes(t,!1))},getFirstElement:function(t){return this._getFirst(this.getChildNodes(t,!1,!0))},getLastElement:function(t){return this._getLast(this.getChildNodes(t,!1,!0))},replaceToTag:function(t,e){return $R.dom(t).replaceWith((function(t){var i=$R.dom("<"+e+">").append($R.dom(t).contents());if(t.attributes)for(var n=t.attributes,r=0;r<n.length;r++)i.attr(n[r].nodeName,n[r].value);return i}))},ucfirst:function(t){return t.charAt(0).toUpperCase()+t.slice(1)},removeFromArrayByValue:function(t,e){for(var i,n=arguments,r=n.length;r>1&&t.length;)for(e=n[--r];-1!==(i=t.indexOf(e));)t.splice(i,1);return t},removeEmptyAttr:function(t,e){var i=$R.dom(t);return void 0===i.attr(e)||null===i.attr(e)||""===i.attr(e)&&(i.removeAttr(e),!0)},cloneAttributes:function(t,e){t=$R.dom(t).get(),e=$R.dom(e);for(var i=t.attributes,n=i.length;n--;){var r=i[n];e.attr(r.name,r.value)}return e},toParams:function(t){if("object"!=typeof t)return t;var e=Object.keys(t);if(!e.length)return"";for(var i="",n=0;n<e.length;n++){var r=e[n];i+=r+":"+t[r]+";"}return i},styleToObj:function(t){var e={};if(t)for(var i=t.replace(/;$/,"").split(";"),n=0;n<i.length;n++){var r=i[n].split(":");e[r[0].trim()]=r[1].trim()}return e},checkProperty:function(t){for(var e=arguments[1]&&Array.isArray(arguments[1])?arguments[1]:[].slice.call(arguments,1),i=0;i<e.length;i++){if(!t||void 0===t[e[i]])return!1;t=t[e[i]]}return t},extendData:function(t,e){for(var i in e)"elements"===i?$R.dom(e[i]).each(function(e){var i=$R.dom(e);if("FORM"===e.tagName){var n=i.serialize(!0);for(var r in n)t=this._setData(t,r,n[r])}else{var o=i.attr("name")?i.attr("name"):i.attr("id");t=this._setData(t,o,i.val())}}.bind(this)):t=this._setData(t,i,e[i]);return t},_setData:function(t,e,i){return _instanceof(t,FormData)?t.append(e,i):t[e]=i,t},normalizeTextNodes:function(t){(t=$R.dom(t).get())&&t.normalize()},isRgb:function(t){return 0===t.search(/^rgb/i)},rgb2hex:function(t){return(t=t.match(/^rgba?[\s+]?\([\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?,[\s+]?(\d+)[\s+]?/i))&&4===t.length?"#"+("0"+parseInt(t[1],10).toString(16)).slice(-2)+("0"+parseInt(t[2],10).toString(16)).slice(-2)+("0"+parseInt(t[3],10).toString(16)).slice(-2):""},hex2long:function(t){return-1!==t.search(/^#/)&&4===t.length&&(t="#"+t[1]+t[1]+t[2]+t[2]+t[3]+t[3]),t},escapeRegExp:function(t){return t.replace(/[-\/\\^$*~+?.()|[\]{}]/g,"\\$&")},getRandomId:function(){for(var t="",e="abcdefghijklmnopqrstuvwxyz0123456789",i=0;i<12;i++)t+=e.charAt(Math.floor(Math.random()*e.length));return t},_getFirst:function(t){return 0!==t.length&&t[0]},_getLast:function(t){return 0!==t.length&&t[t.length-1]}}),$R.add("service","progress",{init:function(t){this.app=t,this.$box=null,this.$bar=null},show:function(){this._is()||this._build(),this.$box.show()},hide:function(){this._is()&&this.animate.start(this.$box,"fadeOut",this._destroy.bind(this))},update:function(t){this.show(),this.$bar.css("width",t+"%")},_is:function(){return null!==this.$box},_build:function(){this.$bar=$R.dom("<span />"),this.$box=$R.dom('<div id="redactor-progress" />'),this.$box.append(this.$bar),this.$body.append(this.$box)},_destroy:function(){this._is()&&this.$box.remove(),this.$box=null,this.$bar=null}}),$R.add("module","starter",{init:function(t){this.app=t,this.opts=t.opts,this.plugin=t.plugin,this.module=t.module},onstart:function(){this._startStop("start",this.app,["element","container","source","editor","statusbar","toolbar"]),this._startStop("start",this.module,["element","container","source","editor","statusbar","contextbar","input"])},onstop:function(){this._startStop("stop",this.module,["observer","element","container","source","editor","contextbar"])},onenable:function(){var t=this.opts.plugins;this._startStop("start",this.module,["observer","toolbar"]),this._startStop("start",this.plugin,t)},ondisable:function(){var t=this.opts.plugins;this._startStop("stop",this.module,["observer","toolbar"]),this._startStop("stop",this.plugin,t)},_startStop:function(t,e,i){for(var n=0;n<i.length;n++)void 0!==e[i[n]]&&this.app.callInstanceMethod(e[i[n]],t)}}),$R.add("module","element",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.namespace=t.namespace,this.element=t.element,this.rootOpts=$R.extend({},!0,$R.options,t.rootOpts)},start:function(){this._build(),this._buildModes(),this._buildMarkup()},stop:function(){this.element.getElement().removeData(this.namespace+"-uuid")},_build:function(){this.element.getElement().data(this.namespace+"-uuid",this.uuid)},_buildModes:function(){var t=this.element.getType();"inline"===t&&this._redefineOptions(this.opts.modes.inline),"div"===t&&this._redefineOptions(this.opts.modes.original),"inline"!==t&&(this._isRootOption("styles")&&this.rootOpts.styles&&(this.opts.styles=!0),this._isRootOption("source")&&!this.rootOpts.source&&(this.opts.showSource=!1))},_buildMarkup:function(){"inline"===this.element.getType()?this.opts.emptyHtml="":this.opts.breakline?(this.opts.markup="div",this.opts.emptyHtml='<div data-redactor-tag="br">'+this.opts.markerChar+"</div>"):this.opts.emptyHtml="<"+this.opts.markup+"></"+this.opts.markup+">"},_redefineOptions:function(t){for(var e in t)this.opts[e]=t[e]},_isRootOption:function(){return void 0!==this.rootOpts.styles}}),$R.add("module","editor",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.editor=t.editor,this.source=t.source,this.element=t.element,this.component=t.component,this.container=t.container,this.inspector=t.inspector,this.autoparser=t.autoparser,this.placeholder=!1,this.events=!1},onenable:function(){this.enable()},ondisable:function(){this.disable()},onenablefocus:function(){this._enableFocus()},oncontextmenu:function(t){this.component.setOnEvent(t,!0)},onclick:function(t){this.component.setOnEvent(t)},onkeyup:function(t){this.inspector.parse(t.target).isComponent()||this.component.clearActive()},onenablereadonly:function(){this._enableReadOnly()},ondisablereadonly:function(){this._disableReadOnly()},onautoparseobserve:function(){this.autoparser.observe()},onplaceholder:{build:function(){this._buildPlaceholder()},toggle:function(){this._togglePlacehodler()}},start:function(){this._build(),this._buildEvents(),this._buildOptions(),this._buildAccesibility()},stop:function(){var t=this.editor.getElement(),e=this.container.getElement(),i=["redactor-in","redactor-in-"+this.uuid,"redactor-structure","redactor-placeholder","notranslate"];""!==this.opts.stylesClass&&i.push(this.opts.stylesClass),t.removeAttr("spellcheck"),t.removeAttr("dir"),t.removeAttr("contenteditable"),t.removeAttr("placeholder"),t.removeAttr("data-gramm_editor"),t.removeClass(i.join(" ")),e.removeClass(["redactor-focus","redactor-blur","redactor-over","redactor-styles-on","redactor-styles-off","redactor-toolbar-on","redactor-text-labeled-on","redactor-source-view"].join(" ")),this._destroyEvents(),0===t.get().classList.length&&t.removeAttr("class")},enable:function(){var t=this.editor.getElement(),e=this.container.getElement();t.addClass("redactor-in redactor-in-"+this.uuid),t.attr({contenteditable:!0}),this.opts.structure&&t.addClass("redactor-structure"),!this.opts.toolbar||this.opts.air||this.opts.toolbarExternal||e.addClass("redactor-toolbar-on"),this._disableBrowsersEditing()},disable:function(){var t=this.editor.getElement(),e=this.container.getElement();t.removeClass("redactor-in redactor-in-"+this.uuid),t.removeClass("redactor-structure"),t.removeAttr("contenteditable"),e.addClass("redactor-toolbar-on")},_build:function(){var t=this.editor.getElement(),e=this.element.getElement(),i=this.container.getElement();i.addClass("redactor-blur"),this.opts.grammarly||t.attr("data-gramm_editor",!1),this.opts.notranslate&&t.addClass("notranslate"),this.opts.styles?(t.addClass(this.opts.stylesClass),i.addClass("redactor-styles-on")):i.addClass("redactor-styles-off"),this.opts.buttonsTextLabeled&&i.addClass("redactor-text-labeled-on"),this.element.isType("textarea")&&e.before(t)},_buildEvents:function(){this.events=$R.create("editor.events",this.app)},_buildOptions:function(){var t=this.editor.getElement();t.attr("dir",this.opts.direction),this.opts.spellcheck||t.attr("spellcheck",!1),this.opts.tabindex&&t.attr("tabindex",this.opts.tabindex),this.opts.minHeight&&t.css("min-height",this.opts.minHeight),this.opts.maxHeight&&t.css("max-height",this.opts.maxHeight),this.opts.maxWidth&&t.css({"max-width":this.opts.maxWidth,margin:"auto"})},_buildAccesibility:function(){this.editor.getElement().attr({"aria-labelledby":"redactor-voice-"+this.uuid,role:"presentation"})},_buildPlaceholder:function(){this.placeholder=$R.create("editor.placeholder",this.app)},_enableFocus:function(){this.opts.showSource?this._enableFocusSource():this._enableFocusEditor()},_enableFocusSource:function(){var t=this.source.getElement();this.opts.focus?(t.focus(),t.get().setSelectionRange(0,0)):this.opts.focusEnd&&t.focus()},_enableFocusEditor:function(){this.opts.focus?setTimeout(this.editor.startFocus.bind(this.editor),100):this.opts.focusEnd&&setTimeout(this.editor.endFocus.bind(this.editor),100)},_togglePlacehodler:function(){this.placeholder&&this.placeholder.toggle()},_disableBrowsersEditing:function(){try{document.execCommand("enableObjectResizing",!1,!1),document.execCommand("enableInlineTableEditing",!1,!1),document.execCommand("AutoUrlDetect",!1,!1);var t=this.editor.getElement().get();t.addEventListener?t.addEventListener("mscontrolselect",(function(t){t.preventDefault()})):t.attachEvent("oncontrolselect",(function(t){t.returnValue=!1}))}catch(e){}},_destroyEvents:function(){this.events&&this.events.destroy()},_enableReadOnly:function(){var t=this.editor.getElement();this._getEditables(t).removeAttr("contenteditable"),t.removeAttr("contenteditable"),t.addClass("redactor-read-only"),this.events&&this.events.destroy()},_disableReadOnly:function(){var t=this.editor.getElement();this._getEditables(t).attr({contenteditable:!0}),t.removeClass("redactor-read-only"),t.attr({contenteditable:!0}),this._buildEvents()},_getEditables:function(t){return t.find("figcaption, td, th")}}),$R.add("class","editor.placeholder",{init:function(t){this.app=t,this.opts=t.opts,this.editor=t.editor,this.element=t.element,this.build()},build:function(){var t=this.element.getElement(),e=this.editor.getElement();if(!1!==this.opts.placeholder||t.attr("placeholder")){var i=!1!==this.opts.placeholder?this.opts.placeholder:t.attr("placeholder");e.attr("placeholder",i),this.toggle()}},toggle:function(){return this.editor.isEmpty(!0)?this.show():this.hide()},show:function(){this.editor.getElement().addClass("redactor-placeholder")},hide:function(){this.editor.getElement().removeClass("redactor-placeholder")}}),$R.add("class","editor.events",{init:function(t){this.app=t,this.opts=t.opts,this.$doc=t.$doc,this.uuid=t.uuid,this.source=t.source,this.editor=t.editor,this.cleaner=t.cleaner,this.container=t.container,this.insertion=t.insertion,this.inspector=t.inspector,this.selection=t.selection,this.component=t.component,this.blurNamespace=".redactor-blur."+this.uuid,this.eventsList=["paste","click","contextmenu","keydown","keyup","mouseup","touchstart","cut","copy","dragenter","dragstart","drop","dragover","dragleave"],this._init()},destroy:function(){this.editor.getElement().off(".redactor-focus"),this.$doc.off("keyup"+this.blurNamespace+" mousedown"+this.blurNamespace),this._loop("off")},focus:function(t){var e=this.container.getElement();this.editor.isPasting()||e.hasClass("redactor-focus")||(e.addClass("redactor-focus"),e.removeClass("redactor-blur"),this.app.broadcast("observe",t),this.app.broadcast("focus",t),this.isFocused=!0,this.isBlured=!1)},blur:function(t){var e=this.container.getElement(),i=$R.dom(t.target),n=[".redactor-in-"+this.uuid,".redactor-toolbar",".redactor-dropdown",".redactor-context-toolbar",".redactor-modal-box","#redactor-image-resizer"];this.app.broadcast("originalblur",t),this.app.stopBlur||this.app.isStarted()&&!this.editor.isPasting()&&0===i.closest(n.join(",")).length&&(this.isBlured||e.hasClass("redactor-blur")||(e.removeClass("redactor-focus"),e.addClass("redactor-blur"),this.app.broadcast("blur",t),this.isFocused=!1,this.isBlured=!0))},cut:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e);this.app.broadcast("state",t),this.component.isNonEditable(e)&&(this._passSelectionToClipboard(t,i,!0),t.preventDefault())},copy:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e);this.app.broadcast("state",t),this.component.isNonEditable(e)&&(this._passSelectionToClipboard(t,i,!1),t.preventDefault())},drop:function(t){if((t=t.originalEvent||t).stopPropagation(),this._removeOverClass(),!1!==this.opts.dragUpload){if(this.app.isDragComponentInside()){var e=$R.dom(this.app.getDragComponentInside()),i=e.clone(!0);return this.insertion.insertToPoint(t,i),e.remove(),this.app.setDragComponentInside(!1),this.app.broadcast("state",t),this.app.broadcast("drop",t),this.app.broadcast("image.observe",t),void t.preventDefault()}if(this.app.isDragInside()&&this.opts.input){this.insertion.insertPoint(t);var n=t.dataTransfer.getData("text/html"),r=this.selection.getRange();if(r){var o=this.selection.getBlocks();r.deleteContents();for(var a=0;a<o.length;a++)""===o[a].innerHTML&&$R.dom(o[a]).remove()}return $R.create("input.paste",this.app,t,!0,n,!0),this.app.broadcast("state",t),this.app.broadcast("drop",t),this.app.setDragInside(!1),void t.preventDefault()}this.app.broadcast("state",t),this.app.broadcast("paste",t,t.dataTransfer),this.app.broadcast("drop",t)}else t.preventDefault()},dragenter:function(t){t.preventDefault()},dragstart:function(t){this.app.setDragComponentInside(!1),this.app.setDragInside(!1);var e=this.inspector.parse(t.target);!e.isComponent()||e.isComponentEditable()||e.isFigcaption()?this.selection.is()&&!this.selection.isCollapsed()&&(this.app.setDragInside(!0),this._setDragData(t)):this.app.setDragComponentInside(e.getComponent()),this.app.broadcast("dragstart",t)},dragover:function(t){this.app.broadcast("dragover",t)},dragleave:function(t){this.app.broadcast("dragleave",t)},paste:function(t){this.app.broadcast("paste",t)},contextmenu:function(t){},click:function(t){if(3===t.detail){t.preventDefault();var e=this.selection.getBlock();if(e){var i=document.createRange();i.selectNodeContents(e),this.selection.setRange(i)}}var n=$R.dom(t.target);if(n.hasClass("redactor-in")){var r=n.offset().top,o=parseFloat(n.css("padding-bottom"));r+n.height()-2*o<t.pageY?this.app.broadcast("bottomclick",t):n.hasClass("redactor-placeholder")&&this.editor.startFocus(this.editor)}this.app.broadcast("state",t),this.app.broadcast("click",t)},keydown:function(t){if(this.app.broadcast("state",t),!1===this.app.broadcast("keydown",t))return t.preventDefault()},keyup:function(t){this.app.broadcast("keyup",t)},mouseup:function(t){this.app.broadcast("observe",t),this.app.broadcast("state",t)},touchstart:function(t){this.app.broadcast("observe",t),this.app.broadcast("state",t)},_init:function(){this.editor.getElement().on("focus.redactor-focus click.redactor-focus",this.focus.bind(this)),this.$doc.on("keyup"+this.blurNamespace+" mousedown"+this.blurNamespace,this.blur.bind(this)),this._loop("on")},_removeOverClass:function(){this.editor.getElement().removeClass("over")},_loop:function(t){for(var e=this.editor.getElement(),i=0;i<this.eventsList.length;i++){var n=this.eventsList[i]+".redactor-events",r=this.eventsList[i];e[t](n,this[r].bind(this))}},_passAllToClipboard:function(t){var e=t.clipboardData,i=this.source.getCode();e.setData("text/html",i),e.setData("text/plain",i.toString().replace(/\n$/,""))},_passSelectionToClipboard:function(t,e,i){var n=t.clipboardData,r=e.getComponent(),o=$R.dom(r).clone();o.find(".redactor-component-caret").remove(),o.removeClass("redactor-component-active"),o.removeAttr("contenteditable"),o.removeAttr("tabindex");var a=o.get().outerHTML;i&&this.component.remove(r),n.setData("text/html",a),n.setData("text/plain",a.toString().replace(/\n$/,""))},_setDragData:function(t){var e=(t=t.originalEvent||t).dataTransfer;e.effectAllowed="move",e.setData("text/Html",this.selection.getHtml())}}),$R.add("module","container",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.lang=t.lang,this.element=t.element,this.container=t.container},start:function(){this._build(),this._buildAccesibility()},stop:function(){var t=this.element.getElement(),e=this.container.getElement();e.after(t),e.remove(),t.show()},_build:function(){var t=this.element.getElement(),e=this.container.getElement();e.addClass("redactor-box"),e.attr("dir",this.opts.direction),this.element.isType("inline")&&e.addClass("redactor-inline"),t.after(e),e.append(t)},_buildAccesibility:function(){var t=this.container.getElement(),e=$R.dom("<span />");e.addClass("redactor-voice-label"),e.attr({id:"redactor-voice-"+this.uuid,"aria-hidden":!1}),e.html(this.lang.get("accessibility-help-label")),t.prepend(e)}}),$R.add("module","source",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.utils=t.utils,this.element=t.element,this.source=t.source,this.editor=t.editor,this.toolbar=t.toolbar,this.cleaner=t.cleaner,this.component=t.component,this.container=t.container,this.autoparser=t.autoparser,this.selection=t.selection,this.syncedHtml=""},onstartcode:function(){var t=this.source.getStartedContent(),e=this.editor.getElement(),i=this.source.getElement();this.opts.autoparse&&this.opts.autoparseStart&&(t=this.autoparser.parse(t));var n=this.cleaner.input(t,!0,!0),r=this.cleaner.output(n);e.html(n),i.val(r),this.syncedHtml=r,this.app.broadcast("placeholder.build"),this.app.broadcast("autoparseobserve"),this.component.executeScripts()},onstartcodeshow:function(){this.show()},ontrytosync:function(){this.sync()},onhardsync:function(){var t=this.editor.getElement().html();t=this.app.broadcast("syncBefore",t),t=this.cleaner.output(t),this._syncing(t)},start:function(){this._build(),this._buildClasses()},stop:function(){var t=this.element.getElement(),e=this.source.getElement();t.removeClass("redactor-source redactor-source-open"),e.off("input.redactor-source"),e.removeAttr("data-gramm_editor"),0===e.get().classList.length&&e.removeAttr("class"),this.source.isNameGenerated()||t.removeAttr("name"),this.element.isType("textarea")||e.remove()},getCode:function(){return this.source.getCode()},toggle:function(){if(this.opts.source)return this.source.getElement().hasClass("redactor-source-open")?this.hide():this.show()},show:function(){if(this.opts.source){var t=this.editor.getElement(),e=this.source.getElement(),i=this.container.getElement(),n=e.val();this.app.isStarted()&&(n=this.app.broadcast("source.open",n));var r=t.height();if(t.hide(),e.height(r),e.val(n.trim()),e.show(),e.addClass("redactor-source-open"),e.on("input.redactor-source-events",this._onChangedSource.bind(this)),e.on("keydown.redactor-source-events",this._onTabKey.bind(this)),e.on("focus.redactor-source-events",this._onFocus.bind(this)),this.opts.source.hasOwnProperty("codemirror")){var o="object"==typeof this.opts.source.codemirror?this.opts.source.codemirror:{},a=void 0!==this.opts.source.codemirrorSrc?this.opts.source.codemirrorSrc:CodeMirror;this.codemirror=a.fromTextArea(e.get(),o),this.codemirror.setSize(null,r),this.codemirror.on("change",(function(t,e){t.save()})),this.codemirror.on("change",this._onChangedSource.bind(this))}else i.addClass("redactor-source-view");setTimeout(function(){this._disableButtons(),this._setActiveSourceButton()}.bind(this),100),this.app.isStarted()&&this.app.broadcast("source.opened")}},hide:function(){if(this.opts.source){var t=this.editor.getElement(),e=this.source.getElement(),i=this.container.getElement(),n=e.val();this.opts.source.hasOwnProperty("codemirror")&&(n=this.codemirror.getValue(),this.codemirror.toTextArea()),n=this.cleaner.input(n,!0),n=this.utils.isEmptyHtml(n)?this.opts.emptyHtml:n,n=this.app.broadcast("source.close",n),this._enableButtons(),this._setInactiveSourceButton(),e.hide(),e.removeClass("redactor-source-open"),e.off(".redactor-source-events"),t.show(),t.html(n),i.removeClass("redactor-source-view"),setTimeout(function(){this.editor.startFocus(),this.component.executeScripts()}.bind(this),0),this.app.broadcast("source.closed")}},sync:function(){var t=this,e=this.editor.getElement().html();e=this.app.broadcast("syncBefore",e),e=this.cleaner.output(e),this._isSync(e)&&(this.timeout&&clearTimeout(this.timeout),this.timeout=setTimeout((function(){t._syncing(e)}),200))},_build:function(){var t=this.source.getElement(),e=this.element.getElement();t.hide(),this.opts.grammarly||t.attr("data-gramm_editor",!1),this.element.isType("textarea")||e.after(t)},_buildClasses:function(){this.source.getElement().addClass("redactor-source")},_syncing:function(t){t=this.app.broadcast("syncing",t),this.source.getElement().val(t),this.app.broadcast("synced",t),this.app.broadcast("changed",t)},_isSync:function(t){return this.syncedHtml!==t&&(this.syncedHtml=t,!0)},_onChangedSource:function(){var t=this.source.getElement().val();this.app.broadcast("changed",t),this.app.broadcast("source.changed",t)},_onTabKey:function(t){if(9!==t.keyCode)return!0;t.preventDefault();var e=this.source.getElement(),i=e.get(),n=i.selectionStart;e.val(e.val().substring(0,n)+"    "+e.val().substring(i.selectionEnd)),i.selectionStart=i.selectionEnd=n+4},_onFocus:function(){this.app.broadcast("sourcefocus")},_disableButtons:function(){this.toolbar.disableButtons()},_enableButtons:function(){this.toolbar.enableButtons()},_setActiveSourceButton:function(){var t=this.toolbar.getButton("html");t.enable(),t.setActive()},_setInactiveSourceButton:function(){this.toolbar.getButton("html").setInactive()}}),$R.add("module","observer",{init:function(t){this.app=t,this.editor=t.editor,this.observerUnit=!1},start:function(){if(window.MutationObserver){var t=this.editor.getElement().get();this.observerUnit=this._build(t),this.observerUnit.observe(t,{attributes:!0,subtree:!0,childList:!0,characterData:!0,characterDataOldValue:!0})}},stop:function(){this.observerUnit&&this.observerUnit.disconnect()},_build:function(t){var e=this;return new MutationObserver((function(i){e._observe(i[i.length-1],t)}))},_observe:function(t,e){this.app.isReadOnly()||"attributes"===t.type&&t.target===e||(this.app.broadcast("observe"),this.app.broadcast("trytosync"),this.app.broadcast("placeholder.toggle"))}}),$R.add("module","clicktoedit",{init:function(t){this.app=t,this.opts=t.opts,this.source=t.source,this.editor=t.editor,this.container=t.container,this.selection=t.selection},onstartclicktoedit:function(){this.start()},onenablereadonly:function(){this.opts.clickToEdit&&(this._isEnabled()||this.stop())},ondisablereadonly:function(){this.opts.clickToEdit&&(this._isEnabled()||this.start())},onstop:function(){this.stop()},start:function(){this._build()},stop:function(){this.buttonSave&&this.buttonSave.stop(),this.buttonCancel&&this.buttonCancel.stop(),this._destroy(),this.app.broadcast("disable")},enable:function(){this.app.broadcast("clickStart");var t=this.editor.isEmpty();t||this.selection.saveMarkers(),this._setFocus(),this._destroy(),this.app.broadcast("enable"),this.buttonSave.enable(),this.buttonCancel.enable(),t||this.selection.restoreMarkers(),t&&this.editor.focus(),this.container.getElement().addClass("redactor-clicktoedit-enabled"),this.source.rebuildStartedContent(),this.app.broadcast("startcode"),this.app.broadcast("image.observe")},save:function(t){t&&t.preventDefault();var e=this.source.getCode();this.app.broadcast("disable"),this.app.broadcast("clickSave",e),this.app.broadcast("clickStop"),this.app.broadcast("toolbar.removeexternal"),this._build()},cancel:function(t){t&&t.preventDefault();var e=this.saved;this.editor.getElement().html(e),this.saved="",this.app.broadcast("disable"),this.app.broadcast("clickCancel",e),this.app.broadcast("clickStop"),this.app.broadcast("toolbar.removeexternal"),this._build()},_build:function(){this.buttonSave=$R.create("clicktoedit.button","save",this.app,this),this.buttonCancel=$R.create("clicktoedit.button","cancel",this.app,this),this.buttonSave.stop(),this.buttonCancel.stop();var t=this.editor.getElement(),e=this.container.getElement();t.on("click.redactor-click-to-edit mouseup.redactor-click-to-edit",this.enable.bind(this)),e.addClass("redactor-over"),e.removeClass("redactor-clicktoedit-enabled")},_isEnabled:function(){return this.container.getElement().hasClass("redactor-clicktoedit-enabled")},_destroy:function(){var t=this.editor.getElement(),e=this.container.getElement();t.off(".redactor-click-to-edit"),e.removeClass("redactor-over redactor-clicktoedit-enabled")},_setFocus:function(){this.saved=this.source.getCode(),this.buttonSave.start(),this.buttonCancel.start()}}),$R.add("class","clicktoedit.button",{init:function(t,e,i){this.app=e,this.opts=e.opts,this.toolbar=e.toolbar,this.context=i,this.type=t,this.name="save"===t?"clickToSave":"clickToCancel",this.objected=!1,this.enabled=!1,this.namespace=".redactor-click-to-edit",this._build()},enable:function(){if(this.objected){var t=this.opts[this.name];t.api="module.clicktoedit."+this.type,this.toolbar.addButton(this.type,t),this.enabled=!0}},start:function(){this.objected||(this.$button.off(this.namespace),this.$button.show(),this.$button.on("click"+this.namespace,this.context[this.type].bind(this.context)))},stop:function(){!this.objected&&this.enabled&&this.$button.hide()},_build:function(){this.objected="object"==typeof this.opts[this.name],this.objected||(this.$button=$R.dom(this.opts[this.name]),this.enabled=!0)}}),$R.add("module","statusbar",{init:function(t){this.app=t,this.opts=t.opts,this.element=t.element,this.statusbar=t.statusbar,this.container=t.container},start:function(){if(!this.element.isType("inline")){var t=this.statusbar.getElement(),e=this.container.getElement();t.addClass("redactor-statusbar"),e.append(t)}}}),$R.add("module","contextbar",{init:function(t){this.app=t,this.opts=t.opts,this.uuid=t.uuid,this.$win=t.$win,this.$doc=t.$doc,this.$body=t.$body,this.editor=t.editor,this.toolbar=t.toolbar,this.detector=t.detector,this.$target=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$body},onstop:function(){this.stop()},onenablereadonly:function(){this.stop()},ondisablereadonly:function(){this.start()},oncontextbar:{close:function(){this.close()}},start:function(){if(this.opts.toolbarContext){var t=this.editor.getElement();this._build(),t.on("click.redactor-context mouseup.redactor-context",this.open.bind(this)),this.opts.scrollTarget?$R.dom(this.opts.scrollTarget).on("scroll.redactor-context",this.close.bind(this)):!1!==this.opts.maxHeight&&t.on("scroll.redactor-context",this.close.bind(this))}},stop:function(){this.editor.getElement().off(".redactor-context"),this.$doc.off(".redactor-context"),this.$win.off(".redactor-context"),this.$contextbar&&this.$contextbar.remove(),this.opts.scrollTarget&&$R.dom(this.opts.scrollTarget).off(".redactor-context")},is:function(){return this.$contextbar&&this.$contextbar.hasClass("open")},set:function(t,e,i,n){for(var r in this.$contextbar.html(""),this.$el=$R.dom(e),i){var o=$R.create("contextbar.button",this.app,i[r]);""!==o.html()&&this.$contextbar.append(o)}var a=this._buildPosition(t,this.$el,n);this.$contextbar.css(a),this.$contextbar.show(),this.$contextbar.addClass("open"),this.$doc.on("click.redactor-context mouseup.redactor-context",this.close.bind(this)),this.$win.on("resize.redactor-context",this.close.bind(this))},open:function(t){setTimeout(function(){this.app.broadcast("contextbar",t,this)}.bind(this),0)},close:function(t){if(this.$contextbar){if(t){var e=$R.dom(t.target);if(this.$el&&0!==e.closest(this.$el).length)return}this.$contextbar.hide(),this.$contextbar.removeClass("open"),this.$doc.off(".redactor.context")}},_build:function(){this.$contextbar=$R.dom("<div>"),this.$contextbar.attr("id","redactor-context-toolbar-"+this.uuid),this.$contextbar.attr("dir",this.opts.direction),this.$contextbar.addClass("redactor-context-toolbar"),this.$contextbar.hide(),this.$target.append(this.$contextbar)},_buildPosition:function(t,e,i){var n,r,o=this.toolbar.isTarget(),a=o?e.position():e.offset(),s=e.width(),l=e.height(),c=this.$contextbar.width(),h=this.$contextbar.height(),u=o?this.$target.scrollTop()+this.$doc.scrollTop():this.$doc.scrollTop(),d=this.$target.offset(),p=o?d.left:0,f=o?d.top:0;return i?"top"===i?(n=a.top-h,r=a.left+s/2-c/2):"bottom"===i&&(n=a.top+l,r=a.left+s/2-c/2):(n=t.clientY+u-h,r=t.clientX-c/2),r<0&&(r=0),{top:n-f+"px",left:r-p+"px"}}}),$R.add("class","contextbar.button",{mixins:["dom"],init:function(t,e){this.app=t,this.obj=e,this._init()},_init:function(){if(this.parse("<a>"),"string"!=typeof this.obj.title){var t=this.obj.title.attr("href");this.attr("href",t),-1===t.search(/^#/)&&this.attr("target","_blank"),this.text(this.obj.html||t)}else this.attr("href","#"),this._buildTitle(),this._buildMessage()},_buildTitle:function(){this.html(this.obj.title)},_buildMessage:function(){void 0===this.obj.message&&void 0===this.obj.api||this.on("click",this._toggle.bind(this))},_toggle:function(t){t.preventDefault(),this.obj.message?this.app.broadcast(this.obj.message,this.obj.args):this.obj.api&&this.app.api(this.obj.api,this.obj.args)}}),$R.add("module","toolbar",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.utils=t.utils,this.toolbar=t.toolbar,this.detector=t.detector,this.buttons=[],this.toolbarModule=!1},onsource:{open:function(){!this.toolbar.isAir()&&this.toolbar.isFixed()&&this.toolbarModule.resetPosition()},opened:function(){this.toolbar.isAir()&&this.toolbarModule&&this.toolbarModule.createSourceHelper(),setTimeout(function(){$R.dom(".re-button-tooltip-"+this.uuid).remove()}.bind(this),100)},close:function(){this.toolbar.isAir()&&this.toolbarModule&&this.toolbarModule.destroySourceHelper()},closed:function(){this.toolbar.is()&&this.opts.air&&this.toolbarModule.openSelected()}},ontoolbar:{removeexternal:function(){!this.opts.air&&this.opts.toolbarExternal&&this.opts.clickToEdit&&$R.dom(this.opts.toolbarExternal).html("")}},onobserve:function(){this.toolbar.is()&&this.toolbar.observe()},onfocus:function(){this._setExternalOnFocus()},onsourcefocus:function(){this._setExternalOnFocus()},onempty:function(){this.toolbar.isFixed()&&this.toolbarModule.resetPosition()},onenablereadonly:function(){this.toolbar.isAir()&&this.toolbarModule.close()},start:function(){this.toolbar.is()&&(this._buildButtons(),this._initToolbar(),this._initButtons())},stop:function(){this.toolbarModule&&this.toolbarModule.stop(),$R.dom(".re-button-tooltip-"+this.uuid).remove(),$R.dom(".redactor-dropdown-"+this.uuid).remove()},_buildButtons:function(){this.buttons=this.opts.buttons.concat(),this._buildImageButton(),this._buildFileButton(),this._buildSourceButton(),this._buildAdditionalButtons(),this._buildHiddenButtons()},_buildImageButton:function(){this.opts.imageUpload||this.opts.imageManagerJson||this.utils.removeFromArrayByValue(this.buttons,"image")},_buildFileButton:function(){this.opts.fileUpload||this.utils.removeFromArrayByValue(this.buttons,"file")},_buildSourceButton:function(){this.opts.source||this.utils.removeFromArrayByValue(this.buttons,"html")},_buildAdditionalButtons:function(){var t,e;if(0!==this.opts.buttonsAdd.length&&(this.opts.buttonsAdd=this._removeExistButtons(this.opts.buttonsAdd),this.buttons=this.buttons.concat(this.opts.buttonsAdd)),0!==this.opts.buttonsAddFirst.length&&(this.opts.buttonsAddFirst=this._removeExistButtons(this.opts.buttonsAddFirst),this.buttons.unshift(this.opts.buttonsAddFirst)),!1!==this.opts.buttonsAddAfter){t=this.buttons.indexOf(this.opts.buttonsAddAfter.after)+1,e=this.opts.buttonsAddAfter.buttons;for(var i=0;i<e.length;i++)this.buttons.splice(t+i,0,e[i])}if(!1!==this.opts.buttonsAddBefore)for(t=this.buttons.indexOf(this.opts.buttonsAddBefore.before)+1,e=this.opts.buttonsAddBefore.buttons,i=0;i<e.length;i++)this.buttons.splice(t-(1-i),0,e[i])},_buildHiddenButtons:function(){if(0!==this.opts.buttonsHide.length)for(var t=this.opts.buttonsHide,e=0;e<t.length;e++)this.utils.removeFromArrayByValue(this.buttons,t[e]);if(this.detector.isMobile()&&0!==this.opts.buttonsHideOnMobile.length)for(t=this.opts.buttonsHideOnMobile,e=0;e<t.length;e++)this.utils.removeFromArrayByValue(this.buttons,t[e])},_removeExistButtons:function(t){for(var e=0;e<t.length;e++)-1!==this.opts.buttons.indexOf(t[e])&&this.utils.removeFromArrayByValue(t,t[e]);return t},_setExternalOnFocus:function(){!this.opts.air&&this.opts.toolbarExternal&&this.toolbarModule.setExternal()},_initToolbar:function(){this.toolbarModule=this.opts.air?$R.create("toolbar.air",this.app):$R.create("toolbar.standard",this.app)},_initButtons:function(){this.toolbar.setButtons(this.buttons);for(var t=0;t<this.buttons.length;t++){var e=this.buttons[t];$R.buttons[e]&&this.toolbar.addButton(e,$R.extend(!0,{},$R.buttons[e]),!1,!1,!0)}}}),$R.add("class","toolbar.air",{init:function(t){this.app=t,this.uuid=t.uuid,this.$doc=t.$doc,this.$win=t.$win,this.utils=t.utils,this.editor=t.editor,this.animate=t.animate,this.toolbar=t.toolbar,this.container=t.container,this.inspector=t.inspector,this.selection=t.selection,this.clicks=0,this._init()},stop:function(){this.toolbar.getWrapper().remove(),this.editor.getElement().off(".redactor-air-trigger-"+this.uuid),this.$doc.off(".redactor-air-"+this.uuid),this.$doc.off(".redactor-air-trigger-"+this.uuid),this.toolbar.stopObservers()},createSourceHelper:function(){this.$airHelper=$R.dom("<span>"),this.$airHelper.addClass("redactor-air-helper"),this.$airHelper.html('<i class="re-icon-html"></i>'),this.$airHelper.on("click",function(t){t.preventDefault(),this.app.api("module.source.hide")}.bind(this)),this.container.getElement().append(this.$airHelper)},destroySourceHelper:function(){this.$airHelper&&this.$airHelper.remove()},openSelected:function(){setTimeout(function(){this._isSelection()&&this._open(!1)}.bind(this),0)},close:function(){this.$doc.off(".redactor-air-"+this.uuid);var t=this.toolbar.getElement();t.removeClass("open"),t.hide()},_init:function(){this.toolbar.create();var t=this.toolbar.getWrapper(),e=this.toolbar.getElement(),i=this.editor.getElement(),n=this.container.getElement();t.addClass("redactor-toolbar-wrapper-air"),e.addClass("redactor-air"),e.hide(),t.append(e),n.prepend(t),this.openSelected(),this.$doc.on("mouseup.redactor-air-trigger-"+this.uuid,this._open.bind(this)),i.on("keyup.redactor-air-trigger-"+this.uuid,this._openCmd.bind(this))},_isSelection:function(){return this.selection.is()&&!this.selection.isCollapsed()},_isOpened:function(){return this.toolbar.getElement().hasClass("open")},_open:function(t){var e=!!t&&t.target,i=!!t&&$R.dom(t.target),n=this.inspector.parse(e),r=n.isComponent()&&!n.isComponentType("table"),o=n.isFigcaption(),a=i&&0!==i.closest(".redactor-modal").length,s=t&&0!==i.closest(".re-button").length;if(!(t&&0!==i.closest(".redactor-dropdown").length||s||a||o||r||this.toolbar.isContextBar())&&this._isSelection()){var l=this.selection.getPosition();setTimeout(function(){this.app.isReadOnly()||this._isSelection()&&this._doOpen(l)}.bind(this),1)}},_openCmd:function(){if(this.selection.isAll()){var t=this.toolbar.getElement(),e=this.selection.getPosition();e.top=e.top<20?0:e.top-t.height(),e.height=0,this._doOpen(e)}},_doOpen:function(t){var e=this.toolbar.getWrapper(),i=this.toolbar.getElement(),n=this.container.getElement().offset(),r=0,o=this.$win.width(),a=i.width();o<t.left+a&&(r=a-this.selection.getPosition().width),e.css({left:t.left-n.left-r+"px",top:t.top-n.top+t.height+this.$doc.scrollTop()+"px"}),this.app.broadcast("airOpen"),i.addClass("open"),i.show(),this.$doc.on("click.redactor-air-"+this.uuid,this._close.bind(this)),this.$doc.on("keydown.redactor-air-"+this.uuid,this._close.bind(this)),this.app.broadcast("airOpened")},_close:function(t){var e=!!t&&$R.dom(t.target),i=t&&0!==e.closest("[data-dropdown], .redactor-dropdown-not-close").length;(!i&&t&&0!==e.closest(".re-button").length||!i&&this._isOpened())&&(this.app.broadcast("airClose"),this.close(),this.app.broadcast("airClosed"))}}),$R.add("class","toolbar.fixed",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.$doc=t.$doc,this.$win=t.$win,this.editor=t.editor,this.toolbar=t.toolbar,this.detector=t.detector,this.container=t.container,this._init()},stop:function(){this.$fixedTarget.off(".redactor-toolbar-"+this.uuid),this.$win.off(".redactor-toolbar-"+this.uuid)},reset:function(){var t=this.toolbar.getElement();this.toolbar.getWrapper().css("height",""),t.removeClass("redactor-toolbar-fixed"),t.css({position:"",top:"",left:"",width:""});var e=this.toolbar.getDropdown();e&&e.updatePosition()},_init:function(){this.$fixedTarget=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$win,this._doFixed(),this.toolbar.isTarget()&&(this.$win.on("scroll.redactor-toolbar-"+this.uuid,this._doFixed.bind(this)),this.$win.on("resize.redactor-toolbar-"+this.uuid,this._doFixed.bind(this))),this.$fixedTarget.on("scroll.redactor-toolbar-"+this.uuid,this._doFixed.bind(this)),this.$fixedTarget.on("resize.redactor-toolbar-"+this.uuid,this._doFixed.bind(this))},_doFixed:function(){var t=this.editor.getElement(),e=this.container.getElement(),i=this.toolbar.getElement(),n=this.toolbar.getWrapper();if(!this.editor.isSourceMode()&&0===e.parents().filter((function(t){return"none"===getComputedStyle(t,null).display&&t})).length){var r=t.height()<100,o=this.editor.isEmpty();if(r||o)this.reset();else if(!this.editor.isSourceMode()){var a=i.height(),s=(this.toolbar.isTarget()?e.position():e.offset()).top,l=s+e.height()-60,c=this.$fixedTarget.scrollTop()+this.opts.toolbarFixedTopOffset,h=this.toolbar.isTarget()?this.$fixedTarget.offset().top-this.$win.scrollTop():0;if(this.toolbar.isTarget()&&"fixed"===this.$fixedTarget.css("position")){var u=this.$fixedTarget.hasClass("modal")&&this.$fixedTarget.hasClass("fade")?e.closest(".modal-dialog").position().top:0;h=this.$fixedTarget.scrollTop()-u}if(c>s&&c<l){var d=this.detector.isDesktop()?"fixed":"absolute";h=this.detector.isDesktop()?h:c-s,this.detector.isMobile()&&(this.fixedScrollTimeout&&clearTimeout(this.fixedScrollTimeout),i.hide(),this.fixedScrollTimeout=setTimeout((function(){i.show()}),250)),n.height(a),i.addClass("redactor-toolbar-fixed"),e.hasClass("redactor-box-fullscreen")?i.css({position:d,top:"0px",width:e.width()+"px"}):i.css({position:d,top:h+this.opts.toolbarFixedTopOffset+"px",width:e.width()+"px"});var p=this.toolbar.getDropdown();p&&p.updatePosition(),this.app.broadcast("toolbar.fixed")}else this.reset(),this.app.broadcast("toolbar.unfixed")}}}}),$R.add("class","toolbar.standard",{init:function(t){this.app=t,this.opts=t.opts,this.uuid=t.uuid,this.$body=t.$body,this.toolbar=t.toolbar,this.container=t.container,this.isExternalMultiple=!1,this.toolbarFixed=!1,this._init()},stop:function(){this.toolbar.getWrapper().remove(),this.toolbarFixed&&this.toolbarFixed.stop(),this.opts.toolbarExternal&&this._findToolbars(),this.toolbar.stopObservers(),this.$body.find(".re-button-tooltip-"+this.uuid).remove()},setExternal:function(){this._findToolbars(),this.isExternalMultiple&&(this.$toolbars.hide(),this.$external.find(".redactor-toolbar-external-"+this.uuid).show())},resetPosition:function(){this.toolbarFixed&&this.toolbarFixed.reset()},_init:function(){this._build(),this.opts.toolbarExternal?this._buildExternal():(this._buildFixed(),this.toolbar.getElement().show())},_build:function(){this.toolbar.create();var t=this.toolbar.getWrapper(),e=this.toolbar.getElement();t.addClass("redactor-toolbar-wrapper"),e.addClass("redactor-toolbar"),e.hide(),t.append(e),this.opts.toolbarExternal||this.container.getElement().prepend(t)},_buildExternal:function(){this._initExternal(),this._findToolbars(),this.isExternalMultiple?this._hideToolbarsExceptFirst():this.toolbar.getElement().show()},_buildFixed:function(){this.opts.toolbarFixed&&(this.toolbarFixed=$R.create("toolbar.fixed",this.app))},_initExternal:function(){var t=this.toolbar.getElement(),e=this.toolbar.getElement();t.addClass("redactor-toolbar-external redactor-toolbar-external-"+this.uuid),this.$external=$R.dom(this.opts.toolbarExternal),this.$external.append(e)},_findToolbars:function(){this.$toolbars=this.$external.find(".redactor-toolbar-external"),this.isExternalMultiple=this.$toolbars.length>1},_hideToolbarsExceptFirst:function(){this.$toolbars.hide(),this.$toolbars.first().show()}}),$R.add("module","line",{init:function(t){this.app=t,this.lang=t.lang,this.component=t.component,this.inspector=t.inspector,this.insertion=t.insertion},oncontextbar:function(t,e){var i=this.inspector.parse(t.target);if(i.isComponentType("line")){var n=i.getComponent(),r={remove:{title:this.lang.get("delete"),api:"module.line.remove",args:n}};e.set(t,n,r,"bottom")}},insert:function(){var t=this.component.create("line");this.insertion.insertRaw(t)},remove:function(t){this.component.remove(t)}}),$R.add("class","line.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},_init:function(t){var e,i;if(void 0!==t){var n=$R.dom(t),r=n.get();"HR"===r.tagName?i=r:"FIGURE"===r.tagName&&(e=r,i=n.find("hr").get())}this._buildWrapper(e),this._buildElement(i),this._initWrapper()},_buildElement:function(t){t?this.$element=$R.dom(t):(this.$element=$R.dom("<hr>"),this.append(this.$element))},_buildWrapper:function(t){t=t||"<figure>",this.parse(t)},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"line",tabindex:"-1",contenteditable:!1})}}),$R.add("module","link",{modals:{link:'<form action="">                  <div class="form-item">                      <label for="modal-link-url">URL <span class="req">*</span></label>                      <input type="text" id="modal-link-url" name="url">                  </div>                  <div class="form-item">                      <label for="modal-link-text">## text ##</label>                      <input type="text" id="modal-link-text" name="text">                  </div>                  <div class="form-item form-item-title">                      <label for="modal-link-title">## title ##</label>                      <input type="text" id="modal-link-title" name="title">                  </div>                  <div class="form-item form-item-target">                      <label class="checkbox">                          <input type="checkbox" name="target"> ## link-in-new-tab ##                      </label>                  </div>              </form>'},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.caret=t.caret,this.utils=t.utils,this.inline=t.inline,this.editor=t.editor,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection,this.isCurrentLink=!1,this.currentText=!1},onmodal:{link:{open:function(t,e){this._setFormData(e,t)},opened:function(t,e){this._setFormFocus(e)},update:function(t,e){var i=e.getData();this._validateData(e,i)&&this._update(i)},insert:function(t,e){var i=e.getData();this._validateData(e,i)&&this._insert(i)},unlink:function(){this._unlink()}}},onbutton:{link:{observe:function(t){this._observeButton(t)}}},ondropdown:{link:{observe:function(t){this._observeUnlink(t),this._observeEdit(t)}}},oncontextbar:function(t,e){var i=this._getCurrent(),n=this.inspector.parse(i);if(n.isLink()||n.isFile()){var r=n.isFile()?n.getFile():n.getLink(),o=$R.dom(r),a=$R.dom("<a>"),s=o.attr("href");a.text(this._truncateText(s)),a.attr("href",s),a.attr("target","_blank");var l={link:{title:a,html:this._truncateText(s)},edit:{title:this.lang.get("edit"),api:"module.link.open"},unlink:{title:this.lang.get("unlink"),api:"module.link.unlink"}};e.set(t,r,l,"bottom")}},open:function(){this.$link=this._buildCurrent(),this.app.api("module.modal.build",this._getModalData())},insert:function(t){this._insert(t)},update:function(t){this._update(t)},unlink:function(){this._unlink()},_observeButton:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e);i.isPre()||i.isCode()?t.disable():t.enable()},_observeUnlink:function(t){var e=t.getItem("unlink");0===this._getLinks().length?e.disable():e.enable()},_observeEdit:function(t){var e=this._getCurrent(),i=t.getItem("link"),n=this.inspector.parse(e),r=n.isLink()||n.isFile()?this.lang.get("link-edit"):this.lang.get("link-insert");i.setTitle(r)},_unlink:function(){this.app.api("module.modal.close");var t=[],e=this._getLinks();this.selection.save();for(var i=0;i<e.length;i++){var n=$R.create("link.component",this.app,e[i]);t.push(this.selection.getElement(e[i])),n.unwrap(),this.app.broadcast("link.deleted",n)}for(this.selection.restore(),i=0;i<t.length;i++){var r=t[i]?t[i]:this.editor.getElement();this.utils.normalizeTextNodes(r)}this._resetCurrent()},_update:function(t){this.app.api("module.modal.close");var e=this._getLinks();this._setLinkData(e,t,"updated"),this._resetCurrent(),this.app.broadcast("link.changed",e)},_insert:function(t){this.app.api("module.modal.close");var e=this._getLinks();this._insertSingle(e,t)||(this._removeInSelection(e),this._insertMultiple(t)),this._resetCurrent()},_removeInSelection:function(t){this.selection.save();for(var e=0;e<t.length;e++){var i=$R.create("link.component",this.app,t[e]),n=i.clone();i.unwrap(),this.app.broadcast("link.deleted",n)}this.selection.restore()},_insertMultiple:function(t){var e=this.selection.getRange();e&&this._isCurrentTextChanged(t)&&this._deleteContents(e);var i=this.inline.format({tag:"a"});this._setLinkData(i,t,"inserted")},_insertSingle:function(t,e){var i=this.selection.getInline();if(1===t.length&&(t[0].textContext===this.selection.getText()||i&&"A"===i.tagName)){var n=$R.create("link.component",this.app,t[0]);return n.setData(e),this.caret.setAfter(n),this.app.broadcast("link.inserted",n),!0}return!1},_setLinkData:function(t,e,i){e.text=""===e.text.trim()?this._truncateText(e.url):e.text;var n=!this.currentText||this.currentText!==e.text;this.selection.save();for(var r=0;r<t.length;r++){var o=$R.create("link.component",this.app,t[r]),a={};e.text&&n&&(a.text=e.text),e.url&&(a.url=e.url),void 0!==e.title&&(a.title=e.title),void 0!==e.target&&(a.target=e.target),o.setData(a),this.app.broadcast("link."+i,o)}setTimeout(this.selection.restore.bind(this.selection),0)},_deleteContents:function(t){var e=this.selection.getHtml(),i=this.utils.parseHtml(e).nodes[0];if(i&&3!==i.nodeType){var n=i.tagName.toLowerCase(),r=document.createElement(n);this.insertion.insertNode(r,"start")}else t.deleteContents()},_getModalData:function(){var t;return t=this._isLink()?{update:{title:this.lang.get("save")},unlink:{title:this.lang.get("unlink"),type:"danger"},cancel:{title:this.lang.get("cancel")}}:{insert:{title:this.lang.get("insert")},cancel:{title:this.lang.get("cancel")}},{name:"link",title:this._isLink()?this.lang.get("link-edit"):this.lang.get("link-insert"),handle:this._isLink()?"update":"insert",commands:t}},_isLink:function(){return this.currentLink},_isCurrentTextChanged:function(t){return this.currentText&&this.currentText!==t.text},_buildCurrent:function(){var t,e=this._getCurrent(),i=this.inspector.parse(e);if(i.isLink()||i.isFile())this.currentLink=!0,t=i.isFile()?i.getFile():i.getLink(),t=$R.create("link.component",this.app,t);else{this.currentLink=!1,t=$R.create("link.component",this.app);var n={text:this.selection.getText()};t.setData(n)}return t},_getCurrent:function(){return this.selection.getInlinesAllSelected({tags:["a"]})[0]},_getLinks:function(){for(var t=this.selection.getInlines({all:!0,tags:["a"]}),e=[],i=0;i<t.length;i++){var n=this.inspector.parse(t[i]);(n.isLink()||n.isFile())&&e.push(t[i])}return e},_resetCurrent:function(){this.isCurrentLink=!1,this.currentText=!1},_truncateText:function(t){return t&&t.length>this.opts.linkSize?t.substring(0,this.opts.linkSize)+"...":t},_validateData:function(t,e){return""!==e.url.trim()||t.setError("url")},_setFormFocus:function(t){t.getField("url").focus()},_setFormData:function(t,e){var i=this.$link.getData(),n={url:i.url,text:i.text,title:i.title,target:this.opts.linkTarget||i.target};this.opts.linkNewTab||e.find(".form-item-target").hide(),this.opts.linkTitle||e.find(".form-item-title").hide(),t.setData(n),this.currentText=t.getField("text").val()}}),$R.add("class","link.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,this.opts=t.opts,this.reUrl=/^(?:(?:(?:https?|ftp):)?\/\/)?(?:\S+(?::\S*)?@)?(?:(?!(?:10|127)(?:\.\d{1,3}){3})(?!(?:169\.254|192\.168)(?:\.\d{1,3}){2})(?!172\.(?:1[6-9]|2\d|3[0-1])(?:\.\d{1,3}){2})(?:[1-9]\d?|1\d\d|2[01]\d|22[0-3])(?:\.(?:1?\d{1,2}|2[0-4]\d|25[0-5])){2}(?:\.(?:[1-9]\d?|1\d\d|2[0-4]\d|25[0-4]))|(?:(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)(?:\.(?:[a-z\u00a1-\uffff0-9]-*)*[a-z\u00a1-\uffff0-9]+)*(?:\.(?:[a-z\u00a1-\uffff]{2,})))(?::\d{2,5})?(?:[\/?#]\S*)?$/i,e&&void 0!==e.cmnt?e:this._init(e)},setData:function(t){for(var e in t)this._set(e,t[e])},getData:function(){for(var t=["url","text","target","title"],e={},i=0;i<t.length;i++)e[t[i]]=this._get(t[i]);return e},_init:function(t){var e=$R.dom(t);void 0===t?this.parse("<a>"):this.parse(e)},_set:function(t,e){this["_set_"+t](e)},_get:function(t){return this["_get_"+t]()},_get_target:function(){return!!this.attr("target")&&this.attr("target")},_get_url:function(){return this.attr("href")},_get_title:function(){return this.attr("title")},_get_text:function(){return this._getContext().text()},_getContext:function(){return this._findDeepestChild(this).element},_set_target:function(t){!1===t?this.removeAttr("target"):t&&this.attr("target",!0===t?"_blank":t)},_set_text:function(t){this._getContext().html(t)},_set_title:function(t){t&&""!==t?this.attr("title",t):this.removeAttr("title")},_set_url:function(t){this.opts.linkValidation&&(t=this._cleanUrl(t),this._isMailto(t)?t="mailto:"+t.replace("mailto:",""):this._isUrl(t)&&-1===t.search(/^(ftp|https?)/i)&&(t="http://"+t.replace(/(ftp|https?):\/\//i,""))),this.attr("href",t)},_isMailto:function(t){return-1!==t.search("@")&&!1===/(ftp|https?):\/\//i.test(t)},_isUrl:function(t){return this.reUrl.test(t)},_cleanUrl:function(t){return(t=t.replace(/</g,"&lt;").replace(/>/g,"&gt;").replace(/"/g,"&quot;").replace(/'/g,"&#039;")).trim().replace(/[^\W\w\D\d+&\'@#\/%?=~_|!:,.;\(\)]/gi,"")},_findDeepestChild:function(t){var e={depth:0,element:t};return t.children().each(function(i){var n=$R.dom(i);if(i.outerHTML===t.html()){var r=this._findDeepestChild(n);r.depth+1>e.depth&&(e={depth:1+r.depth,element:r.element})}}.bind(this)),e}}),$R.add("module","modal",{init:function(t){this.app=t,this.uuid=t.uuid,this.lang=t.lang,this.$doc=t.$doc,this.$win=t.$win,this.$body=t.$body,this.utils=t.utils,this.editor=t.editor,this.animate=t.animate,this.detector=t.detector,this.selection=t.selection,this.$box=!1,this.$modal=!1,this.selectionMarkers=!1,this.defaults={name:!1,url:!1,title:!1,width:"600px",height:!1,handle:!1,commands:!1}},build:function(t){this._open(t)},close:function(){this._close()},onstop:function(){this.$body.find("#redactor-modal-"+this.uuid).remove(),this.$body.find("#redactor-overlay-"+this.uuid).remove()},stop:function(){this.$box&&(this.$box.remove(),this.$box=!1,this.$modal=!1),this.$overlay&&this.$overlay.remove(),this.$doc.off(".redactor.modal"),this.$win.off(".redactor.modal")},resize:function(){this.$modal.setWidth(this.p.width),this.$modal.updatePosition()},_isOpened:function(){return this.$modal&&this.$modal.hasClass("open")},_open:function(t){this._buildDefaults(t),this.p.url?this._openUrl():this._openTemplate()},_openUrl:function(){$R.ajax.post({url:this.p.url,success:this._doOpen.bind(this)})},_openTemplate:function(){if(void 0!==$R.modals[this.p.name]){var t=this.lang.parse($R.modals[this.p.name]);this._doOpen(t)}},_doOpen:function(t){this.stop(),this.selection.isCollapsed()?(this.selection.save(),this.selectionMarkers=!1):(this.selection.saveMarkers(),this.selectionMarkers=!0),this.detector.isDesktop()||document.activeElement.blur(),this._createModal(t),this._buildModalBox(),this._buildOverlay(),this._buildModal(),this._buildModalForm(),this._buildModalCommands(),this._broadcast("open"),this.$modal.updatePosition(),this._buildModalTabs(),this.animate.start(this.$box,"fadeIn",this._opened.bind(this)),this.animate.start(this.$overlay,"fadeIn")},_opened:function(){this.$modal.addClass("open"),this.$box.on("mousedown.redactor.modal",this._close.bind(this)),this.$doc.on("keyup.redactor.modal",this._handleEscape.bind(this)),this.$win.on("resize.redactor.modal",this.resize.bind(this)),this.$modal.getBody().find("input[type=text],input[type=url],input[type=email]").on("keydown.redactor.modal",this._handleEnter.bind(this)),window.jQuery&&window.jQuery(document).off("focusin.modal"),this._broadcast("opened")},_close:function(t){if(this.$box&&this._isOpened()){if(t){if(!this._needToClose(t.target))return;t.stopPropagation(),t.preventDefault()}this.selectionMarkers?this.selection.restoreMarkers():this.selection.restore(),this.selectionMarkers=!1,this._broadcast("close"),this.animate.start(this.$box,"fadeOut",this._closed.bind(this)),this.animate.start(this.$overlay,"fadeOut")}},_closed:function(){this.$modal.removeClass("open"),this.$box.off(".redactor.modal"),this.$doc.off(".redactor.modal"),this.$win.off(".redactor.modal"),this._broadcast("closed")},_createModal:function(t){this.$modal=$R.create("modal.element",this.app,t)},_broadcast:function(t){this.app.broadcast("modal."+t,this.$modal,this.$modalForm),this.app.broadcast("modal."+this.p.name+"."+t,this.$modal,this.$modalForm)},_buildDefaults:function(t){this.p=$R.extend({},this.defaults,t)},_buildModalBox:function(){this.$box=$R.dom("<div>"),this.$box.attr("id","redactor-modal-"+this.uuid),this.$box.addClass("redactor-modal-box redactor-animate-hide"),this.$box.html(""),this.$body.append(this.$box)},_buildOverlay:function(){this.$overlay=$R.dom("#redactor-overlay-"+this.uuid),0===this.$overlay.length&&(this.$overlay=$R.dom("<div>"),this.$overlay.attr("id","redactor-overlay-"+this.uuid),this.$overlay.addClass("redactor-overlay redactor-animate-hide"),this.$body.prepend(this.$overlay))},_buildModal:function(){this.$box.append(this.$modal),this.$modal.setTitle(this.p.title),this.$modal.setHeight(this.p.height),this.$modal.setWidth(this.p.width)},_buildModalCommands:function(){if(this.p.commands){var t=this.p.commands,e=this.$modal.getFooter();for(var i in t){var n=$R.dom("<button>");n.html(t[i].title),n.attr("data-command",i),"cancel"===i&&(n.attr("data-action","close"),n.addClass("redactor-button-unstyled")),void 0!==t[i].type&&"danger"===t[i].type&&n.addClass("redactor-button-danger"),n.on("click",this._handleCommand.bind(this)),e.append(n)}}},_buildModalTabs:function(){var t=this.$modal.getBody(),e=t.find(".redactor-modal-tab"),i=t.find(".redactor-modal-tabs");e.length>1&&((i=0===i.length?$R.dom("<div>"):i.html("")).addClass("redactor-modal-tabs"),e.each(function(t,e){var n=$R.dom(t),r=$R.dom("<a>");r.attr("href","#"),r.attr("rel",e),r.text(n.attr("data-title")),r.on("click",this._showTab.bind(this)),0===e&&r.addClass("active"),i.append(r)}.bind(this)),t.prepend(i)),1===e.length&&e.show()},_buildModalForm:function(){this.$modalForm=$R.create("modal.form",this.app,this.$modal.getForm())},_showTab:function(t){t.preventDefault();var e=$R.dom(t.target),i=e.attr("rel"),n=this.$modal.getBody(),r=n.find(".redactor-modal-tab");r.hide(),r.eq(i).show(),n.find(".redactor-modal-tabs a").removeClass("active"),e.addClass("active")},_needToClose:function(t){var e=$R.dom(t);return!("close"!==e.attr("data-action")&&!this.$modal.isCloseNode(t)&&0!==e.closest(".redactor-modal").length)},_handleCommand:function(t){var e=$R.dom(t.target).closest("button").attr("data-command");"cancel"!==e&&t.preventDefault(),this._broadcast(e)},_handleEnter:function(t){13===t.which&&this.p.handle&&(t.preventDefault(),this._broadcast(this.p.handle))},_handleEscape:function(t){27===t.which&&this._close()}}),$R.add("class","modal.element",{mixins:["dom"],init:function(t,e){this.app=t,this.opts=t.opts,this.$win=t.$win,this._init(e)},getForm:function(){return this.find("form")},getHeader:function(){return this.$modalHeader},getBody:function(){return this.$modalBody},getFooter:function(){return this.$modalFooter},setTitle:function(t){t&&this.$modalHeader.html(t)},setWidth:function(t){t=parseInt(t)>=this.$win.width()?"96%":t,this.css("max-width",t)},setHeight:function(t){!1!==t&&this.$modalBody.css("height",t)},updatePosition:function(){var t=this.width();this.css({left:"50%","margin-left":"-"+t/2+"px"});var e=this.$win.height(),i=this.height(),n=e/2-i/2;i<e&&0!==n&&this.css("margin-top",n+"px")},isCloseNode:function(t){return t===this.$modalClose.get()},_init:function(t){this._build(),this._buildClose(),this._buildHeader(),this._buildBody(),this._buildFooter(),this._buildTemplate(t)},_build:function(){this.parse("<div>"),this.addClass("redactor-modal"),this.attr("dir",this.opts.direction)},_buildClose:function(){this.$modalClose=$R.dom("<span>"),this.$modalClose.addClass("redactor-close"),this.append(this.$modalClose)},_buildHeader:function(){this.$modalHeader=$R.dom("<div>"),this.$modalHeader.addClass("redactor-modal-header"),this.append(this.$modalHeader)},_buildBody:function(){this.$modalBody=$R.dom("<div>"),this.$modalBody.addClass("redactor-modal-body"),this.append(this.$modalBody)},_buildFooter:function(){this.$modalFooter=$R.dom("<div>"),this.$modalFooter.addClass("redactor-modal-footer"),this.append(this.$modalFooter)},_buildTemplate:function(t){this.$modalBody.html(t)}}),$R.add("class","modal.form",{mixins:["dom"],init:function(t,e){this.app=t,this.build(e)},build:function(t){this.parse(t)},getData:function(){var t={};return this.find("[name]").each((function(e){var i=$R.dom(e);t[i.attr("name")]=i.val()})),t},setData:function(t){this.find("[name]").each((function(e){var i=$R.dom(e),n=i.attr("name");t.hasOwnProperty(n)&&(e.type&&"checkbox"===e.type?e.checked=t[n]:i.val(t[n]))}))},getField:function(t){return this.find("[name="+t+"]")},setError:function(t){var e=this.getField(t);return e.addClass("error"),e.one(this._getFieldEventName(e.get()),this._clearError),!1},_clearError:function(){return $R.dom(this).removeClass("error")},_getFieldEventName:function(t){return"SELECT"===t.tagName||"checkbox"===t.type||"radio"===t.type?"change":"keyup"}}),$R.add("module","block",{init:function(t){this.app=t,this.block=t.block},format:function(t){var e=this.block.format(t);this.app.broadcast("format","block",e)},clearformat:function(){this.block.clearFormat()},clearstyle:function(){this.block.clearStyle()},clearclass:function(){this.block.clearClass()},clearattr:function(){this.block.clearAttr()},add:function(t,e){this.block.add(t,e)},toggle:function(t,e){this.block.toggle(t,e)},set:function(t,e){this.block.set(t,e)},remove:function(t,e){this.block.remove(t,e)}}),$R.add("module","inline",{init:function(t){this.app=t,this.inline=t.inline},format:function(t){var e=this.inline.format(t);this.app.broadcast("format","inline",e)},clearformat:function(){this.inline.clearFormat()},clearstyle:function(){this.inline.clearStyle()},clearclass:function(){this.inline.clearClass()},clearattr:function(){this.inline.clearAttr()},add:function(t,e){this.inline.add(t,e)},toggle:function(t,e){this.inline.toggle(t,e)},set:function(t,e){this.inline.set(t,e)},remove:function(t,e){this.inline.remove(t,e)}}),$R.add("module","autosave",{init:function(t){this.app=t,this.opts=t.opts,this.utils=t.utils,this.source=t.source},onsynced:function(){this.opts.autosave&&this._send()},_send:function(){var t=this.opts.autosaveName?this.opts.autosaveName:this.source.getName(),e={};e[t]=this.source.getCode(),e=this.utils.extendData(e,this.opts.autosaveData),$R.ajax.request(this.opts.autosaveMethod,{url:this.opts.autosave,data:e,success:function(i){this._complete(i,t,e)}.bind(this)})},_complete:function(t,e,i){var n=t&&t.error?"autosaveError":"autosave";this.app.broadcast(n,e,i,t)}}),$R.add("module","input",{init:function(t){this.app=t,this.opts=t.opts,this.utils=t.utils,this.editor=t.editor,this.keycodes=t.keycodes,this.element=t.element,this.selection=t.selection,this.insertion=t.insertion,this.inspector=t.inspector,this.autoparser=t.autoparser,this.lastShiftKey=!1},onpaste:function(t,e){if(this.opts.input)return $R.create("input.paste",this.app,t,e)},onkeydown:function(t){if(this.opts.input){var e=t.which;if(!$R.create("input.shortcut",this.app,t).is()){if((t.ctrlKey||t.metaKey)&&!t.altKey&&65===e)return t.preventDefault(),this._selectAll();var i=[this.keycodes.ENTER,this.keycodes.SPACE,this.keycodes.BACKSPACE,this.keycodes.DELETE],n=[this.keycodes.UP,this.keycodes.DOWN,this.keycodes.LEFT,this.keycodes.RIGHT],r=-1!==i.indexOf(e),o=-1!==n.indexOf(e),a=(t.ctrlKey||t.metaKey)&&88===e,s=!t.ctrlKey&&!t.metaKey&&(e>=48&&e<=57||e>=65&&e<=90);if(this.selection.isAll()&&o&&(a||!t.ctrlKey&&!t.metaKey&&!t.altKey&&!t.shiftKey)){if(a)return this.editor.disableNonEditables(),void this.app.broadcast("empty");if(this._isArrowKey(e))return!0;if(r&&t.preventDefault(),this.element.isType("inline")?(this.editor.getElement().html(""),this.editor.startFocus()):this.insertion.set(this.opts.emptyHtml),r)return;this.app.broadcast("empty")}if(this.opts.autoparse&&this.autoparser.format(t,e),!s||!this.selection.hasNonEditable())return e===this.keycodes.ENTER?$R.create("input.enter",this.app,t,e):t.metaKey&&219===e?(t.preventDefault(),void this.app.api("module.list.outdent")):e===this.keycodes.TAB||t.metaKey&&221===e?$R.create("input.tab",this.app,t,e):e===this.keycodes.SPACE?$R.create("input.space",this.app,t,e,this.lastShiftKey):this._isDeleteKey(e)?$R.create("input.delete",this.app,t,e):this._isArrowKey(e)?$R.create("input.arrow",this.app,t,e):void 0;t.preventDefault()}}},onkeyup:function(t){if(this.opts.input){var e=t.which;if(this.lastShiftKey=t.shiftKey,this.app.broadcast("contextbar.close"),!$R.create("input.shortcode",this.app,t,e).is()){if(e===this.keycodes.BACKSPACE){var i=this.editor.getElement(),n=this.utils.trimSpaces(i.html());if(""===(n=(n=n.replace(/<br\s?\/?>/g,"")).replace(/<div><\/div>/,"")))return t.preventDefault(),this.editor.setEmpty(),void this.editor.startFocus()}this.editor.isEmpty()&&this.app.broadcast("empty")}}},start:function(){this.opts.shortcutsAdd&&(this.opts.shortcuts=$R.extend({},!0,this.opts.shortcuts,this.opts.shortcutsAdd))},_selectAll:function(){var t,e=this.selection.getCurrent(),i=this.inspector.parse(e);return i.isComponentType("table")?(t=i.getTable(),void this.selection.setAll(t)):i.isComponentType("code")?(t=i.getComponentCodeElement(),void this.selection.setAll(t)):void this.selection.setAll()},_isArrowKey:function(t){return-1!==[this.keycodes.UP,this.keycodes.DOWN,this.keycodes.RIGHT,this.keycodes.LEFT].indexOf(t)},_isDeleteKey:function(t){return t===this.keycodes.BACKSPACE||t===this.keycodes.DELETE}}),$R.add("class","input.arrow",{init:function(t,e,i){this.app=t,this.opts=t.opts,this.utils=t.utils,this.caret=t.caret,this.offset=t.offset,this.marker=t.marker,this.editor=t.editor,this.keycodes=t.keycodes,this.component=t.component,this.inspector=t.inspector,this.selection=t.selection,this.key=i,this._init(e)},_init:function(t){if(!this._isRightLeftKey()||!this._isExitVariable(t)){if(this._isRightDownKey()){if(this._isExitOnDownRight(t))return;if(this._selectComponent(t,"End","next"))return}if(this._isLeftUpKey()){if(this._isExitOnUpLeft(t))return;if(this._selectComponent(t,"Start","prev"))return}this.key===this.keycodes.LEFT?this.utils.trimInvisibleChars("left"):this.key===this.keycodes.RIGHT&&this.utils.trimInvisibleChars("right")}},_isRightDownKey:function(){return-1!==[this.keycodes.DOWN,this.keycodes.RIGHT].indexOf(this.key)},_isLeftUpKey:function(){return-1!==[this.keycodes.UP,this.keycodes.LEFT].indexOf(this.key)},_isRightLeftKey:function(){return-1!==[this.keycodes.RIGHT,this.keycodes.LEFT].indexOf(this.key)},_isExitVariable:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e),n=i.getComponent();if(i.isComponentType("variable")&&i.isComponentActive()){t.preventDefault();var r=this.key===this.keycodes.LEFT?"setBefore":"setAfter";this.caret[r](n)}},_isExitOnUpLeft:function(t){var e=this.selection.getCurrent(),i=this.selection.getBlock(e),n=this.inspector.parse(e),r=i.previousElementSibling,o=this.caret.isStart(i);if(o&&r&&"TABLE"===r.tagName)return t.preventDefault(),this.caret.setEnd(r),!0;if(n.isFigcaption()){i=n.getFigcaption(),o=this.caret.isStart(i);var a=$R.dom(i).closest(".redactor-component");if(o&&0!==a.length)return t.preventDefault(),this.caret.setEnd(a),!0}else{if(n.isTable()&&o)return t.preventDefault(),this.caret.setEnd(i.previousElementSibling),!0;if(!n.isComponentEditable()&&n.isComponent()&&!n.isComponentType("variable")){var s=n.getComponent();if(!s.previousElementSibling)return t.preventDefault(),this.component.clearActive(),this._exitPrevElement(t,n.getComponent());if(s.previousElementSibling)return t.preventDefault(),this.component.clearActive(),this.caret.setEnd(s.previousElementSibling),!0}}},_isExitOnDownRight:function(t){var e,i,n=this.editor.getElement(),r=this.selection.getCurrent(),o=this.inspector.parse(r),a=this.caret.isEnd();if(o.isTable()){if(e=o.getTable(),(i=this.caret.isEnd(e))||a)return this._exitNextElement(t,o.getComponent())}else if(o.isFigcaption()){if(e=o.getFigcaption(),(i=this.caret.isEnd(e))||a)return this._exitNextElement(t,o.getComponent())}else if(o.isComponentType("code")){var s=o.getComponent(),l=$R.dom(o.getComponentCodeElement()).closest("pre");i=this.caret.isEnd(e);var c=l&&l.get().nextElementSibling;if(i&&!c)return this._exitNextElement(t,s)}else if(o.isPre()||o.isBlockquote()||o.isDl()){if(a){if(o.isPre())return this._exitNextElement(t,o.getPre());if(o.isBlockquote())return this._exitNextElement(t,o.getBlockquote());if(o.isDl())return this._exitNextElement(t,o.getDl())}}else if(o.isList()){var h=$R.dom(r).parents("ul, ol",n).last();if((i=this.caret.isEnd(h))||a)return this._exitNextElement(t,h.get())}else if(o.isComponent()&&!o.isComponentType("variable")&&"span"!==o.getTag())return this.component.clearActive(),this._exitNextElement(t,o.getComponent())},_exitPrevElement:function(t,e){return t.preventDefault(),e.previousElementSibling?this.caret.setEnd(e.previousElementSibling):this.utils.createMarkupBefore(e),!0},_exitNextElement:function(t,e){return t.preventDefault(),e.nextElementSibling?this.caret.setStart(e.nextElementSibling):this.utils.createMarkup(e),!0},_selectComponent:function(t,e,i){var n=this.selection.getCurrent(),r=this.selection.getBlock(n),o=this.utils.findSiblings(n,i),a=this.utils.findSiblings(r,i);o&&this.caret["is"+e](n)?this._selectComponentItem(t,o,e):a&&this.caret["is"+e](r)&&this._selectComponentItem(t,a,e)},_selectComponentItem:function(t,e,i){if(this.component.isNonEditable(e))return t.preventDefault(),this.caret["set"+i](e),!0}}),$R.add("class","input.delete",{init:function(t,e,i){this.app=t,this.opts=t.opts,this.caret=t.caret,this.utils=t.utils,this.editor=t.editor,this.marker=t.marker,this.keycodes=t.keycodes,this.component=t.component,this.inspector=t.inspector,this.selection=t.selection,this.insertion=t.insertion,this.key=i,this._init(e)},_init:function(t){if(!this._removeActiveComponent(t)&&!this._removeAllSelectedTable(t)){if(this.key===this.keycodes.BACKSPACE){var e=this.editor.getElement();if(this.utils.trimSpaces(e.html())===this.opts.emptyHtml)return void t.preventDefault()}if(this._detectVariableOrNonEditable()||this.selection.hasNonEditable())t.preventDefault();else{if(this.selection.isAll())return t.preventDefault(),void this.insertion.set(this.opts.emptyHtml);this.selection.isCollapsed()&&(this.key===this.keycodes.BACKSPACE?this._traverseBackspace(t):this.key===this.keycodes.DELETE&&this._traverseDelete(t)),this.key===this.keycodes.BACKSPACE&&this.utils.trimInvisibleChars("left"),this._removeUnwantedStyles(),this._removeEmptySpans(),this._removeSpanTagsInHeadings(),this._removeInlineTagsInPre()}}},_detectVariableOrNonEditable:function(){var t,e=this.selection.getBlock(),i=this.caret.isStart(e),n=this.caret.isEnd(e);if(this.key===this.keycodes.BACKSPACE&&i){if(t=e.previousSibling,this._isNonEditable(t))return!0}else if(this.key===this.keycodes.DELETE&&n&&(t=e.nextSibling,this._isNonEditable(t)))return!0;var r=this.selection.getCurrent(),o=this.caret.isStart(r),a=this.caret.isEnd(r),s=""===this.selection.getTextBeforeCaret().trim(),l=""===this.selection.getTextAfterCaret().trim();if(this.key===this.keycodes.BACKSPACE&&o&&!s){if(t=r.previousSibling,this._isVariable(t))return this.caret.setEnd(t),!0;if(this._isNonEditable(t))return!0}else if(this.key===this.keycodes.DELETE&&a&&!l){if(t=r.nextSibling,this._isVariable(t))return this.caret.setStart(t),!0;if(this._isNonEditable(t))return!0}},_isVariable:function(t){return 0!==$R.dom(t).closest('[data-redactor-type="variable"]').length},_isNonEditable:function(t){return 0!==$R.dom(t).closest(".non-editable").length},_getBlock:function(){var t=this.editor.getElement(),e=this.selection.getBlock(),i=this.inspector.parse(e);return e=i.isList()?$R.dom(e).parents("ul, ol",t).last().get():e,e=i.isDl()?i.getDl():e,i.isTable()?i.getTable():e},_traverseDelete:function(t){var e,i,n,r=this.selection.getCurrent(),o=this.inspector.parse(r);if(o.isFigcaption()){if(e=o.getFigcaption(),i=this.caret.isEnd(e))return void t.preventDefault()}else if(o.isComponentType("code")&&(e=o.getComponent(),i=this.caret.isEnd(e)))return void t.preventDefault();e=this._getBlock();var a=this.utils.findSiblings(e,"next");if(a){i=this.caret.isEnd(e);var s=this.inspector.parse(a),l="P"===a.tagName||"DIV"===a.tagName;if(i&&s.isComponentType("table"))return t.preventDefault(),void this.caret.setStart(a);if(i&&s.isComponentEditable())return t.preventDefault(),void this.component.remove(a,!1);if(i&&s.isComponent())return t.preventDefault(),this.caret.setStart(a),void(this.utils.isEmptyHtml(e.innerHTML)&&$R.dom(e).remove());if(i&&s.isList()){var c=$R.dom(e);if(n=$R.dom(a),o.isList())return t.preventDefault(),c.append(n),void n.unwrap();var h=n.children("li").first(),u=h.find("ul, ol");if(0!==u.length)return t.preventDefault(),n.prepend(u),u.unwrap(),c.append(h),void h.unwrap()}else if(i&&!o.isList()&&!o.isTable()&&l&&!this.utils.isEmptyHtml(e.innerHTML)){t.preventDefault();var d=$R.dom(e);return n=$R.dom(a),d.append(n),void n.unwrap()}}},_traverseBackspace:function(t){var e,i,n,r,o=this.selection.getCurrent(),a=this.inspector.parse(o);if(a.isFigcaption()){if(e=a.getFigcaption(),i=this.caret.isStart(e))return void t.preventDefault()}else if(a.isComponentType("code")&&(e=a.getComponent(),(i=this.caret.isStart(e))&&e.previousElementSibling))return t.preventDefault(),this.caret.setEnd(e.previousElementSibling),!0;e=this._getBlock();var s=this.utils.findSiblings(e,"prev");if(s){i=this.caret.isStart(e);var l=this.inspector.parse(s),c="P"===s.tagName||"DIV"===s.tagName;if(i&&l.isComponentType("code"))return t.preventDefault(),void this.component.remove(s,!1);if(i&&l.isComponentType("table"))return t.preventDefault(),void this.caret.setEnd(s);if(i&&l.isComponent())return t.preventDefault(),this.caret.setStart(s),void(this.utils.isEmptyHtml(e.innerHTML)&&$R.dom(e).remove());if(i&&a.isList())if(t.preventDefault(),r=$R.dom(e),n=$R.dom(s),l.isList())r.children("li").first().prepend(this.marker.build("start")),n.append(r),r.unwrap(),this.selection.restoreMarkers();else{var h=r.children("li").first(),u=h.get(),d=h.find("ul, ol"),p=this.utils.replaceToTag(u,this.opts.markup);this.opts.breakline&&p.attr("data-redactor-tag","br"),r.before(p),this.caret.setStart(p),0!==d.length&&(r.prepend(d),d.unwrap())}else if(i&&c){if(t.preventDefault(),this.utils.isEmpty(s))return void(n=$R.dom(s)).remove();var f=this.utils.createInvisibleChar(),m=$R.dom(e);return n=$R.dom(s),this.caret.setEnd(n),m.prepend(f),n.append(m.contents()),void m.remove()}}else setTimeout(this._replaceBlock.bind(this),1)},_replaceBlock:function(){var t=this.selection.getBlock(),e=$R.dom(t);if("p"===this.opts.markup&&t&&this._isNeedToReplaceBlock(t)){var i=document.createElement(this.opts.markup);e.replaceWith(i),this.caret.setStart(i)}this.opts.breakline&&t&&"DIV"===t.tagName&&e.attr("data-redactor-tag","br")},_isNeedToReplaceBlock:function(t){return"DIV"===t.tagName&&this.utils.isEmptyHtml(t.innerHTML)},_removeActiveComponent:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e),n=i.getComponent();if(i.isComponent()&&this.component.isActive(n))return t.preventDefault(),this.component.remove(n),!0},_removeAllSelectedTable:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e).getTable();if(i&&this.selection.isAll(i))return t.preventDefault(),this.component.remove(i),!0},_removeUnwantedStyles:function(){var t=this.editor.getElement();setTimeout((function(){t.find("*[style]").not("img, figure, figcaption, iframe, [data-redactor-style-cache], [data-redactor-span]").removeAttr("style")}),0)},_removeEmptySpans:function(){var t=this.editor.getElement();setTimeout((function(){t.find("span").each((function(t){0===t.attributes.length&&$R.dom(t).replaceWith(t.childNodes)}))}),0)},_removeSpanTagsInHeadings:function(){var t=this.editor.getElement();setTimeout((function(){t.find("h1, h2, h3, h4, h5, h6").each((function(t){var e=$R.dom(t);0===e.closest("figure").length&&e.find("span").not(".redactor-component, .non-editable, .redactor-selection-marker, [data-redactor-style-cache], [data-redactor-span]").unwrap()}))}),1)},_removeInlineTagsInPre:function(){var t=this.editor.getElement(),e=this.opts.inlineTags;setTimeout((function(){t.find("pre").each((function(t){var i=$R.dom(t);0===i.closest("figure").length&&i.find(e.join(",")).not("code, .redactor-selection-marker").unwrap()}))}),1)}}),$R.add("class","input.enter",{init:function(t,e){this.app=t,this.opts=t.opts,this.utils=t.utils,this.caret=t.caret,this.editor=t.editor,this.keycodes=t.keycodes,this.detector=t.detector,this.insertion=t.insertion,this.selection=t.selection,this.inspector=t.inspector,this._init(e)},_init:function(t){return this.opts.enterKey?!1===this.app.broadcast("enter",t)?t.preventDefault():this.selection.hasNonEditable()?void t.preventDefault():t.ctrlKey||t.shiftKey?this._insertBreak(t):void(this._isExit(t)||this._traverse(t)):this._disable(t)},_disable:function(t){t.preventDefault();var e=this.selection.getRange();e&&!e.collapsed&&e.deleteContents()},_insertBreak:function(t){t.preventDefault();var e=this.selection.getCurrent(),i=this.selection.getBlock(),n=this.inspector.parse(e);if(n.isHeading()&&this.caret.isStart(i)){var r=$R.dom(i),o=r.clone().html("");r.before(o),this.caret.setStart(r)}else{if(n.isComponent()&&!n.isComponentEditable()||n.isCode())return;n.isPre()?this.insertion.insertNewline():this.insertion.insertBreakLine()}},_isExit:function(t){var e=this.editor.getElement(),i=this.selection.getBlock(),n=this.inspector.parse(i),r=this.caret.isEnd(i),o=this.selection.getCurrent(),a=o.previousSibling;if(n.isBlockquote()){var s=r&&this._isExitableBlock(i,"P"),l=r&&this._isExitableDblBreak(a);if(s||l)return this._exitFromElement(t,l?a:i,n.getBlockquote())}else if(!n.isComponentType("code")&&n.isPre()){if(r){var c=i.innerHTML;if(null!==(c=this.utils.removeInvisibleChars(c)).match(/(\n\n\n)$/))return $R.dom(a.previousSibling.previousSibling).remove(),this._exitFromElement(t,a,i)}}else if(n.isDl()){if(r&&this._isExitableBlock(i,"DT"))return this._exitFromElement(t,i,n.getDl())}else if(n.isList()){var h=$R.dom(o).parents("ul, ol",e).last();if((r=this.caret.isEnd(h))&&this._isExitableBlock(i,"LI"))return this._exitFromElement(t,i,h)}else if(n.isComponent()&&n.isComponentActive()&&!n.isFigcaption()&&!n.isComponentEditable())return this._exitFromElement(t,!1,n.getComponent())},_isExitableDblBreak:function(t){var e=!!t&&t.nextSibling;if(e){var i=this.utils.removeInvisibleChars(e.textContent);return 3===e.nodeType&&""===i.trim()}},_isExitableBlock:function(t,e){return t&&t.tagName===e&&this.utils.isEmptyHtml(t.innerHTML)},_exitFromElement:function(t,e,i){return t.preventDefault(),e&&$R.dom(e).remove(),this.utils.createMarkup(i),!0},_exitNextElement:function(t,e){return t.preventDefault(),e.nextSibling?this.caret.setStart(e.nextSibling):this.utils.createMarkup(e),!0},_traverse:function(t){var e=this.selection.getCurrent(),i=this.selection.isText(),n=this.selection.getBlock(),r=this.inspector.parse(e),o=!!n&&n.tagName.toLowerCase(),a=$R.dom(e).closest("[data-redactor-type=variable]");if(0!==a.length&&this.caret.setAfter(a),r.isPre())return t.preventDefault(),this.insertion.insertNewline();if(r.isBlockquote())return(n=this.selection.getBlock(e))&&"BLOCKQUOTE"===n.tagName?(t.preventDefault(),this.insertion.insertBreakLine()):void 0;if(r.isFigcaption()){n=r.getFigcaption();var s=this.caret.isEnd(n),l=this.caret.isEnd();return s||l?this._exitNextElement(t,r.getComponent()):void t.preventDefault()}if(r.isDl())return t.preventDefault(),this._traverseDl(e);if(this.opts.breakline&&"div"===o)setTimeout(this._replaceBlock.bind(this),1);else{if(i)return t.preventDefault(),this.insertion.insertBreakLine();if(!r.isList()){var c=this.detector.isDesktop()?50:1;setTimeout(this._replaceBlock.bind(this),c)}}},_traverseDl:function(t){var e=this.selection.getBlock(t),i=this.inspector.parse(e).getTag(),n=$R.dom(e),r=n.get().nextSibling||!1,o=$R.dom(r),a=r&&o.is("dd"),s=r&&o.is("dt"),l=this.caret.isEnd(e);if("dt"===i&&!a&&l){var c=document.createElement("dd");return n.after(c),void this.caret.setStart(c)}if("dd"===i&&!s&&l){var h=document.createElement("dt");return n.after(h),void this.caret.setStart(h)}return this.insertion.insertBreakLine()},_replaceBlock:function(){var t=this.selection.getBlock(),e=$R.dom(t);if("p"===this.opts.markup&&t&&this._isNeedToReplaceBlock(t)){var i=document.createElement(this.opts.markup);e.replaceWith(i),this.caret.setStart(i)}else if(t)if(this.utils.isEmptyHtml(t.innerHTML))this._clearBlock(e,t);else{var n=this.utils.getFirstNode(t);n&&"BR"===n.tagName&&($R.dom(n).remove(),this.caret.setStart(t))}t&&this._isNeedToCleanBlockStyle(t)&&this.opts.cleanOnEnter&&e.removeAttr("class style"),this.opts.breakline&&t&&t.tagName},_clearBlock:function(t,e){"DIV"===e.tagName&&t.find("br").remove(),(this.opts.cleanInlineOnEnter||"<br>"===e.innerHTML)&&t.html(""),this.caret.setStart(e)},_isNeedToReplaceBlock:function(t){return"DIV"===t.tagName&&this.utils.isEmptyHtml(t.innerHTML)},_isNeedToCleanBlockStyle:function(t){return"P"===t.tagName&&this.utils.isEmptyHtml(t.innerHTML)}}),$R.add("class","input.paste",{init:function(t,e,i,n,r){this.app=t,this.opts=t.opts,this.editor=t.editor,this.cleaner=t.cleaner,this.container=t.container,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection,this.autoparser=t.autoparser,this.pasteHtml=n,this.pointInserted=r,this.dataTransfer=i,this._init(e)},_init:function(t){var e,i=this.dataTransfer||t.clipboardData,n=this.selection.getCurrent(),r=this.inspector.parse(n);if(this.dropPasted=this.dataTransfer,this.isRawCode=r.isPre()||r.isCode(),this.editor.enablePasting(),this.editor.saveScroll(),this.dropPasted||this.selection.saveMarkers(),this.isRawCode||!i)return e=this.isRawCode||i||!window.clipboardData?i.getData("text/plain"):window.clipboardData.getData("text"),t.preventDefault(),void this._insert(t,e);if(this.pasteHtml)t.preventDefault(),this._insert(t,this.pasteHtml);else{var o=i.getData("URL"),a=this._isPlainText(i)?this.cleaner.encodeEntities(i.getData("text/plain")):i.getData("text/html");if(a=o&&""!==o?o:a,null!==i.files&&i.files.length>0&&""===a){for(var s=[],l=0;l<i.files.length;l++){var c=i.files[l]||i.items[l].getAsFile();c&&s.push(c)}if(s.length>0)return t.preventDefault(),void this._insertFiles(t,s)}t.preventDefault(),this._insert(t,a)}},_isPlainText:function(t){var e=t.getData("text/plain"),i=t.getData("text/html");if(!e||!i)return null!==e;var n=document.createElement("div");return n.innerHTML=i,n.textContent===e?!n.querySelector(":not(meta)"):void 0},_restoreSelection:function(){this.editor.restoreScroll(),this.editor.disablePasting(),this.dropPasted||this.selection.restoreMarkers()},_insert:function(t,e){var i=this.app.broadcast("pasteBefore",e);if(e=(e=void 0===i?e:i).trim(),e=(e=this.isRawCode?e:this.cleaner.paste(e)).trim(),e=this.isRawCode?this.cleaner.encodePhpCode(e):e,e=void 0===(i=this.app.broadcast("pasting",e))?e:i,this._restoreSelection(),this.opts.input){this.app.broadcast("state",!1);var n=[];if(this.isRawCode){e=e.replace("&lt;?php","<?php");var r=document.createTextNode(e);n=this.insertion.insertNode(r,"after"),this.app.broadcast("pasted",n)}else this.opts.autoparse&&this.opts.autoparsePaste&&(e=this.autoparser.parse(e)),n=this.dropPasted?this.insertion.insertToPoint(t,e,this.pointInserted):this.insertion.insertHtml(e),this.app.broadcast("pasted",n),this.app.broadcast("autoparseobserve")}},_insertFiles:function(t,e){this._restoreSelection();var i=-1!==this.opts.imageTypes.indexOf(e[0].type),n=void 0===this.dropPasted;i?this.app.broadcast("dropimage",t,e,n):this.app.broadcast("dropfile",t,e,n)}}),$R.add("class","input.shortcode",{init:function(t,e,i){this.app=t,this.opts=t.opts,this.utils=t.utils,this.marker=t.marker,this.keycodes=t.keycodes,this.selection=t.selection,this.worked=!1,i===this.keycodes.SPACE&&this._init()},is:function(){return this.worked},_init:function(){var t=this.selection.getCurrent();if(t&&3===t.nodeType){var e=this.utils.removeInvisibleChars(t.textContent),i=this.opts.shortcodes;for(var n in i){var r=new RegExp("^"+this.utils.escapeRegExp(n));if(null!==e.match(r)&&void 0!==i[n].format)return this._format(i[n].format,t,r)}}},_format:function(t,e,i){var n=(e=this.marker.insert("start").previousSibling).textContent;n=(n=this.utils.trimSpaces(n)).replace(i,""),e.textContent=n;var r="ul"===t||"ol"===t?"module.list.toggle":"module.block.format";this.app.api(r,t),this.selection.restoreMarkers(),this.worked=!0}}),$R.add("class","input.shortcut",{init:function(t,e){this.app=t,this.opts=t.opts,this.worked=!1,this.hotkeys={8:"backspace",9:"tab",10:"return",13:"return",16:"shift",17:"ctrl",18:"alt",19:"pause",20:"capslock",27:"esc",32:"space",33:"pageup",34:"pagedown",35:"end",36:"home",37:"left",38:"up",39:"right",40:"down",45:"insert",46:"del",59:";",61:"=",96:"0",97:"1",98:"2",99:"3",100:"4",101:"5",102:"6",103:"7",104:"8",105:"9",106:"*",107:"+",109:"-",110:".",111:"/",112:"f1",113:"f2",114:"f3",115:"f4",116:"f5",117:"f6",118:"f7",119:"f8",120:"f9",121:"f10",122:"f11",123:"f12",144:"numlock",145:"scroll",173:"-",186:";",187:"=",188:",",189:"-",190:".",191:"/",192:"`",219:"[",220:"\\",221:"]",222:"'"},this.hotkeysShiftNums={"`":"~",1:"!",2:"@",3:"#",4:"$",5:"%",6:"^",7:"&",8:"*",9:"(",0:")","-":"_","=":"+",";":": ","'":'"',",":"<",".":">","/":"?","\\":"|"},this._init(e)},is:function(){return this.worked},_init:function(t){if(!1!==this.opts.shortcuts)for(var e in this.opts.shortcuts)this._build(t,e,this.opts.shortcuts[e]);else!t.ctrlKey&&!t.metaKey||66!==t.which&&73!==t.which||t.preventDefault()},_build:function(t,e,i){for(var n=e.split(","),r=n.length,o=0;o<r;o++)"string"==typeof n[o]&&this._handler(t,n[o].trim(),i)},_handler:function(t,e,i){e=e.toLowerCase().split(" ");for(var n=this.hotkeys[t.keyCode],r=String.fromCharCode(t.which).toLowerCase(),o="",a={},s=["meta","ctrl","alt","shift"],l=0;l<s.length;l++){var c=s[l];t[c+"Key"]&&n!==c&&(o+=c+"+")}n&&(a[o+n]=!0),r&&(a[o+r]=!0,a[o+this.hotkeysShiftNums[r]]=!0,"shift+"===o&&(a[this.hotkeysShiftNums[r]]=!0));var h=e.length;for(l=0;l<h;l++)if(a[e[l]])return t.preventDefault(),this.worked=!0,void(i.message?(this.app.broadcast(i.message,i.args),this.app.broadcast("buffer.trigger")):i.api&&(this.app.api(i.api,i.args),this.app.broadcast("buffer.trigger")))}}),$R.add("class","input.space",{init:function(t,e,i,n){this.app=t,this.keycodes=t.keycodes,this.insertion=t.insertion,this.selection=t.selection,this.key=i,this.lastShiftKey=n,this._init(e)},_init:function(t){if(!this.selection.hasNonEditable())return this.lastShiftKey||this.key!==this.keycodes.SPACE||!t.ctrlKey&&!t.shiftKey||t.metaKey?void 0:(t.preventDefault(),void this.insertion.insertChar("&nbsp;"));t.preventDefault()}}),$R.add("class","input.tab",{init:function(t,e){this.app=t,this.opts=t.opts,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection,this._init(e)},_init:function(t){if(this.opts.tabKey){if(!1===this.app.broadcast("tab",t))return t.preventDefault();this._traverse(t)}},_traverse:function(t){var e=this.selection.getCurrent(),i=this.inspector.parse(e);return!i.isComponent()&&t.shiftKey?this._insertHardTab(t,4):i.isList()?(t.preventDefault(),this.app.api("module.list.indent")):i.isPre()||i.isComponentType("code")&&!i.isFigcaption()?this._tabCode(t):!1!==this.opts.tabAsSpaces?this._insertHardTab(t,this.opts.tabAsSpaces):void 0},_insertHardTab:function(t,e){t.preventDefault();var i=document.createTextNode(Array(e+1).join("\xa0"));return this.insertion.insertNode(i,"end")},_tabCode:function(t){t.preventDefault();var e=this.opts.preSpaces?document.createTextNode(Array(this.opts.preSpaces+1).join("\xa0")):document.createTextNode("\t");return this.insertion.insertNode(e,"end")}}),$R.add("module","upload",{init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.utils=t.utils,this.editor=t.editor,this.progress=t.progress,this.defaults={event:!1,element:!1,name:!1,files:!1,url:!1,data:!1,paramName:!1}},build:function(t){this.p=$R.extend(this.defaults,t),this.$el=$R.dom(this.p.element),"INPUT"===this.$el.get().tagName?this._buildInput():this._buildBox()},send:function(t){this.p=$R.extend(this.defaults,t),this.$uploadbox=this.editor.getElement(),this._send(this.p.event,this.p.files)},complete:function(t,e){this._complete(t,e)},_buildInput:function(){this.box=!1,this.prefix="",this.$uploadbox=$R.dom('<div class="upload-redactor-box" />'),this.$el.hide(),this.$el.after(this.$uploadbox),this.opts.multipleUpload?this.$el.attr("multiple","multiple"):this.$el.removeAttr("multiple"),"file"!==this.p.name&&this.$el.attr("accept","image/*"),this._buildPlaceholder(),this._buildEvents()},_buildBox:function(){this.box=!0,this.prefix="box-",this.$uploadbox=this.$el,this.$uploadbox.attr("ondragstart","return false;"),this.$uploadbox.on("drop.redactor.upload",this._onDropBox.bind(this)),this.$uploadbox.on("dragover.redactor.upload",this._onDragOver.bind(this)),this.$uploadbox.on("dragleave.redactor.upload",this._onDragLeave.bind(this))},_buildPlaceholder:function(){this.$placeholder=$R.dom('<div class="upload-redactor-placeholder" />'),this.$placeholder.html(this.lang.get("upload-label")),this.$uploadbox.append(this.$placeholder)},_buildEvents:function(){this.$el.on("change.redactor.upload",this._onChange.bind(this)),this.$uploadbox.on("click.redactor.upload",this._onClick.bind(this)),this.$uploadbox.on("drop.redactor.upload",this._onDrop.bind(this)),this.$uploadbox.on("dragover.redactor.upload",this._onDragOver.bind(this)),this.$uploadbox.on("dragleave.redactor.upload",this._onDragLeave.bind(this))},_onClick:function(t){t.preventDefault(),this.$el.click()},_onChange:function(t){this._send(t,this.$el.get().files)},_onDrop:function(t){t.preventDefault(),this._clear(),this._setStatusDrop(),this._send(t)},_onDragOver:function(t){return t.preventDefault(),this._setStatusHover(),!1},_onDragLeave:function(t){return t.preventDefault(),this._removeStatusHover(),!1},_onDropBox:function(t){t.preventDefault(),this._clear(),this._setStatusDrop(),this._send(t)},_removeStatusHover:function(){this.$uploadbox.removeClass("upload-redactor-"+this.prefix+"hover")},_setStatusDrop:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"drop")},_setStatusHover:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"hover")},_setStatusError:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"error")},_setStatusSuccess:function(){this.$uploadbox.addClass("upload-redactor-"+this.prefix+"success")},_clear:function(){for(var t=["drop","hover","error","success"],e=0;e<t.length;e++)this.$uploadbox.removeClass("upload-redactor-"+this.prefix+t[e]);this.$uploadbox.removeAttr("ondragstart")},_send:function(t,e){t=t.originalEvent||t,e=e||t.dataTransfer.files;var i=new FormData,n=this._getUploadParam();i=this._buildData(n,e,i),i=this.utils.extendData(i,this.p.data),!1!==this.app.broadcast("upload.start",t,i,e)&&this._sendData(i,e,t)},_sendData:function(t,e,i){if(this.progress.show(),"function"==typeof this.p.url){var n=this.p.url(t,e,i,this);_instanceof(n,Promise)||this._complete(n,i)}else $R.ajax.post({url:this.p.url,data:t,before:function(t){return this.app.broadcast("upload.beforeSend",t)}.bind(this),success:function(t){this._complete(t,i)}.bind(this)})},_getUploadParam:function(){return this.p.paramName?this.p.paramName:"file"},_buildData:function(t,e,i){if(1===e.length)i.append(t+"[]",e[0]);else if(e.length>1&&!1!==this.opts.multipleUpload)for(var n=0;n<e.length;n++)i.append(t+"[]",e[n]);return i},_complete:function(t,e){this._clear(),this.progress.hide(),t&&t.error?(this._setStatusError(),this.app.broadcast("upload."+this.p.name+".error",t,e),this.app.broadcast("upload.error",t)):(this._setStatusSuccess(),this.app.broadcast("upload."+this.p.name+".complete",t,e),this.app.broadcast("upload.complete",t),setTimeout(this._clear.bind(this),500))}}),$R.add("class","code.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},_init:function(t){var e;if(void 0!==t){var i=$R.dom(t).closest("figure");0!==i.length?this.parse(i):(this.parse("<figure>"),this.append(t)),e=this.find("pre code, pre").last()}else e=$R.dom("<pre>"),this.parse("<figure>"),this.append(e);this._initElement(e),this._initWrapper()},_initElement:function(t){t.attr({tabindex:"-1",contenteditable:!0})},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"code",tabindex:"-1",contenteditable:!1})}}),$R.add("module","form",{init:function(t){this.app=t,this.lang=t.lang,this.component=t.component,this.inspector=t.inspector},onform:{remove:function(t){this._remove(t)}},oncontextbar:function(t,e){var i=this.inspector.parse(t.target);if(i.isComponentType("form")){var n=i.getComponent(),r={remove:{title:this.lang.get("delete"),api:"module.form.remove",args:n}};e.set(t,n,r,"top")}},_remove:function(t){this.component.remove(t)}}),$R.add("class","form.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,this.utils=t.utils,e&&void 0!==e.cmnt?e:this._init(e)},_init:function(t){if(void 0!==t)if(0!==$R.dom(t).closest("form").length){var e=this.utils.replaceToTag(t,"figure");this.parse(e)}else this.parse("<figure>"),this.append(t);else this.parse("<figure>");this._initWrapper()},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"form",tabindex:"-1",contenteditable:!1})}}),$R.add("module","image",{modals:{image:'<div class="redactor-modal-tab redactor-modal-tab-upload" data-title="## upload ##"><form action="">                  <input type="file" name="file">              </form></div>',imageedit:'<div class="redactor-modal-group">                  <div id="redactor-modal-image-preview" class="redactor-modal-side"></div>                  <form action="" class="redactor-modal-area">                      <div class="form-item">                          <label for="modal-image-title"> ## title ##</label>                          <input type="text" id="modal-image-title" name="title" />                      </div>                      <div class="form-item form-item-caption">                          <label for="modal-image-caption">## caption ##</label>                          <input type="text" id="modal-image-caption" name="caption" aria-label="## caption ##" />                      </div>                      <div class="form-item form-item-align">                          <label>## image-position ##</label>                          <select name="align" aria-label="## image-position ##">                              <option value="none">## none ##</option>                              <option value="left">## left ##</option>                              <option value="center">## center ##</option>                              <option value="right">## right ##</option>                          </select>                      </div>                      <div class="form-item form-item-link">                          <label for="modal-image-url">## link ##</label>                          <input type="text" id="modal-image-url" name="url" aria-label="## link ##" />                      </div>                      <div class="form-item form-item-link">                          <label class="checkbox"><input type="checkbox" name="target" aria-label="## link-in-new-tab ##"> ## link-in-new-tab ##</label>                      </div>                  </form>              </div>'},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.caret=t.caret,this.utils=t.utils,this.editor=t.editor,this.storage=t.storage,this.component=t.component,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection,this.justResized=!1},oninsert:function(){this._observeImages()},onstarted:function(){this.storage.observeImages(),this.opts.imageResizable&&(this.resizer=$R.create("image.resize",this.app)),this._observeImages()},ondropimage:function(t,e,i){if(this.opts.imageUpload){var n={url:this.opts.imageUpload,event:!i&&t,files:e,name:"imagedrop",data:this.opts.imageData,paramName:this.opts.imageUploadParam};this.app.api("module.upload.send",n)}},onstop:function(){this.resizer&&this.resizer.stop()},onbottomclick:function(){this.insertion.insertToEnd(this.editor.getLastNode(),"image")},onimageresizer:{stop:function(){this.resizer&&this.resizer.hide()}},onsource:{open:function(){this.resizer&&this.resizer.hide()},closed:function(){this._observeImages(),this.resizer&&this.resizer.rebuild()}},onupload:{complete:function(){this._observeImages()},image:{complete:function(t){this._insert(t)},error:function(t){this._uploadError(t)}},imageedit:{complete:function(t){this._change(t)},error:function(t){this._uploadError(t)}},imagedrop:{complete:function(t,e){this._insert(t,e)},error:function(t){this._uploadError(t)}},imagereplace:{complete:function(t){this._change(t,!1)},error:function(t){this._uploadError(t)}}},onmodal:{image:{open:function(t,e){this._setUpload(t,e)}},imageedit:{open:function(t,e){this._setFormData(t,e)},opened:function(t,e){this._setFormFocus(e)},remove:function(){this._remove(this.$image)},save:function(t,e){this._save(t,e)}}},onimage:{observe:function(){this._observeImages()},resized:function(){this.justResized=!0}},oncontextbar:function(t,e){if(this.justResized)this.justResized=!1;else{var i=this.selection.getCurrent(),n=this.inspector.parse(i),r=$R.dom(i).closest("img");if(!n.isFigcaption()&&n.isComponentType("image")||0!==r.length){var o=0!==r.length?r.get():n.getComponent(),a={edit:{title:this.lang.get("edit"),api:"module.image.open"},remove:{title:this.lang.get("delete"),api:"module.image.remove",args:o}};e.set(t,o,a)}}},open:function(){this.$image=this._getCurrent(),this.app.api("module.modal.build",this._getModalData())},insert:function(t){this._insert(t)},remove:function(t){this._remove(t)},_getModalData:function(){return this._isImage()&&this.opts.imageEditable?{name:"imageedit",width:"800px",title:this.lang.get("edit"),handle:"save",commands:{save:{title:this.lang.get("save")},remove:{title:this.lang.get("delete"),type:"danger"},cancel:{title:this.lang.get("cancel")}}}:{name:"image",title:this.lang.get("image")}},_isImage:function(){return this.$image},_getCurrent:function(){var t=this.selection.getCurrent(),e=this.inspector.parse(t),i=$R.dom(t).closest("img");return 0!==i.length?this.component.create("image",i):!(!e.isComponentType("image")||!e.isComponentActive())&&this.component.create("image",e.getComponent())},_insert:function(t,e){if(this.app.api("module.modal.close"),Array.isArray(t)){for(var i={},n=0;n<t.length;n++)i=$R.extend(i,t[n]);t=i}else"string"==typeof t&&(t={file:{url:t}});if("object"==typeof t){var r=0;for(var o in t)"object"==typeof t[o]&&r++;r>1?this._insertMultiple(t,e):this._insertSingle(t,e)}},_insertSingle:function(t,e){for(var i in t)if("object"==typeof t[i]){var n=this._createImageAndStore(t[i]),r=e?this.insertion.insertToPoint(e,n,!1,!1):this.insertion.insertHtml(n,!1);this._removeSpaceBeforeFigure(r[0]),this.component.setActive(r[0]),this.app.broadcast("image.uploaded",r[0],t)}},_insertMultiple:function(t,e){var i,n=0,r=[];for(var o in t)if("object"==typeof t[o]){n++;var a=this._createImageAndStore(t[o]);1===n?r=e?this.insertion.insertToPoint(e,a,!1,!1):this.insertion.insertHtml(a,!1):($R.dom(r[0]).after(a),r=[a.get()],this.app.broadcast("image.inserted",a)),i=r[0],this._removeSpaceBeforeFigure(r[0]),this.app.broadcast("image.uploaded",r[0],t)}this.component.setActive(i)},_createImageAndStore:function(t){var e=this.component.create("image");return e.addClass("redactor-uploaded-figure"),e.setData({src:t.url,id:t.id?t.id:this.utils.getRandomId()}),this.storage.add("image",e.getElement()),e},_removeSpaceBeforeFigure:function(t){if(t){var e=t.previousSibling,i=t.nextSibling,n=$R.dom(e),r=$R.dom(i);this.opts.breakline&&(i&&"br"===r.attr("data-redactor-tag")&&r.find("br").first().remove(),e&&"br"===n.attr("data-redactor-tag")&&n.find("br").last().remove()),e&&(this._removeInvisibleSpace(e),this._removeInvisibleSpace(e.previousSibling))}},_removeInvisibleSpace:function(t){t&&3===t.nodeType&&-1!==this.utils.searchInvisibleChars(t.textContent)&&t.parentNode.removeChild(t)},_save:function(t,e){var i=e.getData(),n={title:i.title};this.opts.imageLink&&(n.link={url:i.url,target:i.target}),this.opts.imageCaption&&(n.caption=i.caption),this.opts.imagePosition&&(n.align=i.align),this.$image.setData(n),this.resizer&&this.resizer.rebuild(),this.app.broadcast("image.changed",this.$image),this.app.api("module.modal.close")},_change:function(t,e){if("string"==typeof t&&(t={file:{url:t}}),"object"==typeof t){var i;for(var n in t)if("object"==typeof t[n]){(i=$R.dom("<img>")).attr("src",t[n].url),this.$image.changeImage(t[n]),this.app.broadcast("image.changed",this.$image,t),this.app.broadcast("image.uploaded",this.$image,t),this.app.broadcast("hardsync");break}!1!==e&&i.on("load",function(){this.$previewBox.html(i)}.bind(this))}},_uploadError:function(t){this.app.broadcast("image.uploadError",t)},_remove:function(t){this.app.api("module.modal.close"),this.component.remove(t)},_observeImages:function(){var t=this.editor.getElement(),e=this;t.find("img").each((function(t){var i=$R.dom(t);i.off(".drop-to-replace"),i.on("dragover.drop-to-replace dragenter.drop-to-replace",(function(t){t.preventDefault()})),i.on("drop.drop-to-replace",(function(t){if(!e.app.isDragComponentInside())return e._setReplaceUpload(t,i)}))}))},_setFormData:function(t,e){this._buildPreview(t),this._buildPreviewUpload();var i=this.$image.getData(),n={title:i.title};this.opts.imageCaption?n.caption=i.caption:t.find(".form-item-caption").hide(),this.opts.imagePosition?n.align=i.align:t.find(".form-item-align").hide(),this.opts.imageLink?i.link&&(n.url=i.link.url,i.link.target&&(n.target=!0)):t.find(".form-item-link").hide(),e.setData(n)},_setFormFocus:function(t){t.getField("title").focus()},_setReplaceUpload:function(t,e){if((t=t.originalEvent||t).stopPropagation(),t.preventDefault(),this.opts.imageUpload){this.$image=this.component.create("image",e);var i={url:this.opts.imageUpload,files:t.dataTransfer.files,name:"imagereplace",data:this.opts.imageData,paramName:this.opts.imageUploadParam};this.app.api("module.upload.send",i)}},_setUpload:function(t,e){this.opts.imageUpload||t.getBody().find(".redactor-modal-tab-upload").remove();var i={url:this.opts.imageUpload,element:e.getField("file"),name:"image",data:this.opts.imageData,paramName:this.opts.imageUploadParam};this.app.api("module.upload.build",i)},_buildPreview:function(t){this.$preview=t.find("#redactor-modal-image-preview");var e=this.$image.getData(),i=$R.dom("<img>");i.attr("src",e.src),this.$previewBox=$R.dom("<div>"),this.$previewBox.append(i),this.$preview.html(""),this.$preview.append(this.$previewBox)},_buildPreviewUpload:function(){if(this.opts.imageUpload){var t=$R.dom('<div class="desc">');t.html(this.lang.get("upload-change-label")),this.$preview.append(t);var e={url:this.opts.imageUpload,element:this.$previewBox,name:"imageedit",data:this.opts.imageData,paramName:this.opts.imageUploadParam};this.app.api("module.upload.build",e)}}}),$R.add("class","image.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,this.opts=t.opts,this.selection=t.selection,e&&void 0!==e.cmnt?e:this._init(e)},setData:function(t){for(var e in t)this._set(e,t[e])},getData:function(){for(var t=["src","title","caption","align","link","id"],e={},i=0;i<t.length;i++)e[t[i]]=this._get(t[i]);return e},getElement:function(){return this.$element},changeImage:function(t){this.$element.attr("src",t.url)},_init:function(t){var e=$R.dom(t),i=e.closest("figure");void 0===t?(this.$element=$R.dom("<img>"),this.parse("<figure>"),this.append(this.$element)):0===i.length?(this.parse("<figure>"),this.$element=e,this.$element.wrap(this)):(this.parse(i),this.$element=this.find("img")),this._initWrapper()},_set:function(t,e){this["_set_"+t](e)},_get:function(t){return this["_get_"+t]()},_set_src:function(t){this.$element.attr("src",t)},_set_id:function(t){this.opts.imageObserve&&this.$element.attr("data-image",t)},_set_title:function(t){""===(t=t.trim().replace(/(<([^>]+)>)/gi,""))?this.$element.removeAttr("alt"):this.$element.attr("alt",t)},_set_caption:function(t){var e=this.find("figcaption");return 0===e.length&&((e=$R.dom("<figcaption>")).attr("contenteditable","true"),this.append(e)),""===t?e.remove():e.html(t),e},_set_align:function(t){var e="",i="",n="",r=this.find("img"),o=this.find("figcaption");if("object"==typeof this.opts.imagePosition){var a=this.opts.imagePosition;for(var s in a)this.removeClass(a[s]);var l=void 0!==a[t]&&a[t];l&&this.addClass(l)}else{var c=r.width();switch(t){case"left":e="left",i=this.opts.imageFloatMargin;break;case"right":e="right",i=this.opts.imageFloatMargin;break;case"center":n="center",i="auto"}this.css({float:e,width:c+"px",maxWidth:c+"px","margin-left":i,"margin-right":i,"text-align":n}),this.attr("rel",this.attr("style")),"none"===t&&(this.css("max-width",""),this.css("width","")),"center"===t?(this.css("max-width",""),this.css("width",""),o.css("text-align","center")):o.css("text-align","")}},_set_link:function(t){var e=this._findLink();if(""!==t.url)return e||(e=$R.dom("<a>"),this.$element.wrap(e)),e.attr("href",t.url),t.target?e.attr("target",!0===t.target?"_blank":t.target):e.removeAttr("target"),e;e&&e.unwrap()},_get_src:function(){return this.$element.attr("src")},_get_id:function(){return this.$element.attr("data-image")},_get_title:function(){return this.$element.attr("alt")||""},_get_caption:function(){var t=this.find("figcaption");return 0===t.length?"":t.html()},_get_align:function(){var t="";if("object"==typeof this.opts.imagePosition){t="none";var e=this.opts.imagePosition;for(var i in e)if(this.hasClass(e[i])){t=i;break}}else t="center"===this.css("text-align")?"center":this.css("float");return t},_get_link:function(){var t=this._findLink();if(t){var e=!!t.attr("target");return{url:t.attr("href"),target:e}}},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"image",tabindex:"-1",contenteditable:!1})},_findLink:function(){var t=this.find("a").filter((function(t){return 0===$R.dom(t).closest("figcaption").length}));return 0!==t.length&&t}}),$R.add("class","image.resize",{init:function(t){this.app=t,this.$doc=t.$doc,this.$win=t.$win,this.$body=t.$body,this.editor=t.editor,this.toolbar=t.toolbar,this.inspector=t.inspector,this.$target=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$body,this._init()},rebuild:function(){this._setResizerPosition()},hide:function(){this.$target.find("#redactor-image-resizer").remove()},stop:function(){this.editor.getElement().off(".redactor.image-resize"),this.$doc.off(".redactor.image-resize"),this.$win.off("resize.redactor.image-resize"),this.hide()},_init:function(){this.editor.getElement().on("click.redactor.image-resize",this._build.bind(this)),this.$win.on("resize.redactor.image-resize",this._setResizerPosition.bind(this))},_build:function(t){if(this.$target.find("#redactor-image-resizer").remove(),!this.app.isReadOnly()){var e=this.inspector.parse(t.target),i=this.editor.getElement();e.isComponentType("image")&&(this.$resizableBox=i,this.$resizableImage=$R.dom(e.getImageElement()),this.$resizer=$R.dom("<span>"),this.$resizer.attr("id","redactor-image-resizer"),this.$target.append(this.$resizer),this._setResizerPosition(),this.$resizer.on("mousedown touchstart",this._set.bind(this)))}},_setResizerPosition:function(){if(this.$resizer){var t=this.toolbar.isTarget(),e=this.$target.offset(),i=t?7-e.top+this.$target.scrollTop():7,n=t?7-e.left:7,r=this.$resizableImage.offset(),o=this.$resizableImage.width(),a=this.$resizableImage.height(),s=this.$resizer.width(),l=this.$resizer.height();this.$resizer.css({top:Math.round(r.top+a-l+i)+"px",left:Math.round(r.left+o-s+n)+"px"})}},_set:function(t){t.preventDefault(),this.resizeHandle={x:t.pageX,y:t.pageY,el:this.$resizableImage,$figure:this.$resizableImage.closest("figure"),ratio:this.$resizableImage.width()/this.$resizableImage.height(),h:this.$resizableImage.height()},(t=t.originalEvent||t).targetTouches&&(this.resizeHandle.x=t.targetTouches[0].pageX,this.resizeHandle.y=t.targetTouches[0].pageY),this.app.broadcast("contextbar.close"),this.app.broadcast("image.resize",this.$resizableImage),this._start()},_start:function(){this.$doc.on("mousemove.redactor.image-resize touchmove.redactor.image-resize",this._move.bind(this)),this.$doc.on("mouseup.redactor.image-resize touchend.redactor.image-resize",this._stop.bind(this))},_stop:function(){this.$doc.off(".redactor.image-resize"),this.app.broadcast("image.resized",this.$resizableImage)},_move:function(t){t.preventDefault(),t=t.originalEvent||t;var e=this.resizeHandle.h;t.targetTouches?e+=t.targetTouches[0].pageY-this.resizeHandle.y:e+=t.pageY-this.resizeHandle.y;var i=e*this.resizeHandle.ratio;i=Math.round(i),(e=Math.round(e))<20||i<100||this._getResizableBoxWidth()<=i||(0!==this.resizeHandle.$figure.length&&""!==this.resizeHandle.$figure.css("max-width")&&this.resizeHandle.$figure.css("max-width",i+"px"),this.resizeHandle.el.attr({width:i,height:e}),this.resizeHandle.el.width(i),this.resizeHandle.el.css("max-width",i+"px"),this.resizeHandle.el.height(e),this._setResizerPosition())},_getResizableBoxWidth:function(){return this.$resizableBox.width()-parseInt(this.$resizableBox.css("padding-left"))-parseInt(this.$resizableBox.css("padding-right"))}}),$R.add("module","file",{modals:{file:'<div class="redactor-modal-tab" data-title="## upload ##"><form action="">                  <div class="form-item form-item-title">                      <label for="modal-file-title"> ## filename ## <span class="desc">(## optional ##)</span></label>                      <input type="text" id="modal-file-title" name="title" />                  </div>                  <input type="file" name="file">              </form></div>'},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.caret=t.caret,this.utils=t.utils,this.storage=t.storage,this.component=t.component,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection},onstarted:function(){this.storage.observeFiles()},ondropfile:function(t,e,i){if(this.opts.fileUpload){var n={url:this.opts.fileUpload,event:!i&&t,files:e,name:"filedrop",data:this.opts.fileData};this.app.api("module.upload.send",n)}},onmodal:{file:{open:function(t,e){this._setFormData(t,e),this._setUpload(e)},opened:function(t,e){this._setFormFocus(e),this.$form=e}}},onupload:{file:{complete:function(t){this._insert(t)},error:function(t){this._uploadError(t)}},filedrop:{complete:function(t,e){this._insert(t,e)},error:function(t){this._uploadError(t)}}},open:function(){this._open()},insert:function(t){this._insert(t)},remove:function(t){this._remove(t)},_open:function(){this.app.api("module.modal.build",this._getModalData())},_getModalData:function(){return{name:"file",title:this.lang.get("file")}},_insert:function(t,e){if(this.app.api("module.modal.close"),"object"==typeof t){if(Array.isArray(t)){for(var i={},n=0;n<t.length;n++)i=$R.extend(i,t[n]);t=i}Object.keys(t).length>1?this._insertMultiple(t,e):this._insertSingle(t,e),this.$form=!1}},_insertSingle:function(t,e){var i=[];for(var n in t){var r=this._createFileAndStore(t[n]);i=this.opts.fileAttachment?this._insertAsAttachment(r):e?this.insertion.insertToPoint(e,r):this.insertion.insertRaw(r),this.app.broadcast("file.uploaded",i[0],t)}},_insertMultiple:function(t,e){var i,n=0,r=[];for(var o in t){n++;var a=this._createFileAndStore(t[o]);this.opts.fileAttachment?r=this._insertAsAttachment(a,t):1===n?r=e?this.insertion.insertToPoint(e,a):this.insertion.insertRaw(a):($R.dom(r[0]).after(a).after(" "),r=[a.get()],this.app.broadcast("file.inserted",a)),i=a,this.app.broadcast("file.uploaded",r[0],t)}this.opts.fileAttachment||this.caret.setAfter(i)},_insertAsAttachment:function(t,e){var i=$R.dom(this.opts.fileAttachment),n=t.wrapAttachment();i.append(n);var r=[n.get()];return this.app.broadcast("file.appended",r[0],e),r},_createFileAndStore:function(t){var e=!!this.$form&&this.$form.getData(),i=t.name?t.name:t.url,n=!this.opts.fileAttachment&&e&&""!==e.title?e.title:this._truncateUrl(i),r=this.component.create("file");return r.attr("href",t.url),r.attr("data-file",t.id?t.id:this.utils.getRandomId()),r.attr("data-name",t.name),r.html(n),this.storage.add("file",r),r},_remove:function(t){this.selection.save();var e=this.component.create("file",t);!1!==this.app.broadcast("file.delete",e)?(e.unwrap(),this.selection.restore(),this.app.broadcast("file.deleted",e)):this.selection.restore()},_truncateUrl:function(t){return-1!==t.search(/^http/)&&t.length>20?t.substring(0,20)+"...":t},_setUpload:function(t){var e={url:this.opts.fileUpload,element:t.getField("file"),name:"file",data:this.opts.fileData,paramName:this.opts.fileUploadParam};this.app.api("module.upload.build",e)},_setFormData:function(t,e){this.opts.fileAttachment?t.find(".form-item-title").hide():e.setData({title:this.selection.getText()})},_setFormFocus:function(t){t.getField("title").focus()},_uploadError:function(t){this.app.broadcast("file.uploadError",t)}}),$R.add("class","file.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,this.opts=t.opts,e&&void 0!==e.cmnt?e:this._init(e)},wrapAttachment:function(){return this.$wrapper=$R.dom('<span class="redactor-file-item">'),this.$remover=$R.dom('<span class="redactor-file-remover">'),this.$remover.html("&times;"),this.$remover.on("click",this.removeAttachment.bind(this)),this.$wrapper.append(this),this.$wrapper.append(this.$remover),this.$wrapper},removeAttachment:function(t){t.preventDefault(),!1!==this.app.broadcast("file.delete",this,this.$wrapper)&&(this.$wrapper.remove(),this.app.broadcast("file.deleted",this),this.app.broadcast("file.removeAttachment",this))},_init:function(t){if(void 0===t)this.parse("<a>");else{var e=$R.dom(t).closest("a");this.parse(e)}}}),$R.add("module","buffer",{init:function(t){this.app=t,this.opts=t.opts,this.editor=t.editor,this.offset=t.offset,this.keycodes=t.keycodes,this.selection=t.selection,this.state=!1,this.passed=!1,this.keyPressed=!1,this.undoStorage=[],this.redoStorage=[]},onkeydown:function(t){this._listen(t)},onsyncing:function(){this.keyPressed||this.trigger(),this.keyPressed=!1},onbuffer:{trigger:function(){this.trigger()}},onstate:function(t,e,i){t&&(t.ctrlKey||t.metaKey)||t&&(this._isUndo(t)||this._isRedo(t))||(this.passed=!1,this._saveState(e,i),!1===t&&this._setUndo())},onenable:function(){this.clear()},clear:function(){this.state=!1,this.undoStorage=[],this.redoStorage=[]},undo:function(){this._getUndo()},redo:function(){this._getRedo()},trigger:function(){this.state&&!1===this.passed&&this._setUndo()},_saveState:function(t,e){var i=this.editor.getElement();this.state={html:t||i.html(),offset:e||this.offset.get()}},_listen:function(t){var e=t.which,i=t.ctrlKey||t.metaKey,n=i||t.shiftKey||t.altKey,r=[this.keycodes.SPACE,this.keycodes.ENTER,this.keycodes.BACKSPACE,this.keycodes.DELETE,this.keycodes.TAB,this.keycodes.LEFT,this.keycodes.RIGHT,this.keycodes.UP,this.keycodes.DOWN];return this._isUndo(t)?(t.preventDefault(),void this.undo()):this._isRedo(t)?(t.preventDefault(),void this.redo()):((i||-1===r.indexOf(e))&&(!i||88!==e&&67!==e)||(n=!0,this.trigger()),n||this._hasUndo()||this.trigger(),void(this.keyPressed=!0))},_isUndo:function(t){var e=t.which;return(t.ctrlKey||t.metaKey)&&90===e&&!t.shiftKey&&!t.altKey},_isRedo:function(t){var e=t.which;return(t.ctrlKey||t.metaKey)&&(90===e&&t.shiftKey||89===e&&!t.shiftKey)&&!t.altKey},_setUndo:function(){var t=this.undoStorage[this.undoStorage.length-1];void 0!==t&&t[0]===this.state.html||(this.undoStorage.push([this.state.html,this.state.offset]),this._removeOverStorage())},_setRedo:function(){var t=this.editor.getElement(),e=this.offset.get(),i=t.html();this.redoStorage.push([i,e]),this.redoStorage=this.redoStorage.slice(0,this.opts.bufferLimit)},_getUndo:function(){if(this._hasUndo()){this.passed=!0;var t=this.editor.getElement(),e=this.undoStorage.pop();this._setRedo(),t.html(e[0]),this.offset.set(e[1]),this._saveState(e[0],e[1]),this.selection.restore(),this.app.broadcast("undo",e[0],e[1])}},_getRedo:function(){if(this._hasRedo()){this.passed=!0;var t=this.editor.getElement(),e=this.redoStorage.pop();this._setUndo(),t.html(e[0]),this.offset.set(e[1]),this._saveState(e[0],e[1]),this.app.broadcast("redo",e[0],e[1])}},_removeOverStorage:function(){this.undoStorage.length>this.opts.bufferLimit&&(this.undoStorage=this.undoStorage.slice(0,this.undoStorage.length-this.opts.bufferLimit))},_hasUndo:function(){return 0!==this.undoStorage.length},_hasRedo:function(){return 0!==this.redoStorage.length}}),$R.add("module","list",{init:function(t){this.app=t,this.uuid=t.uuid,this.opts=t.opts,this.utils=t.utils,this.block=t.block,this.editor=t.editor,this.toolbar=t.toolbar,this.inspector=t.inspector,this.selection=t.selection},onbutton:{list:{observe:function(t){this._observeButton(t)}}},ondropdown:{list:{observe:function(t){this._observeDropdown(t)}}},toggle:function(t){var e=this._getBlocks(),i=this.selection.getBlock(),n=$R.dom(i).parents("ul, ol",this.editor.getElement()).last();return 0===e.length&&0!==n.length&&(e=[n.get()]),!i||"TD"!==i.tagName&&"TH"!==i.tagName||(e=this.block.format("div")),this.selection.saveMarkers(),e=0!==e.length&&this._isUnformat(t,e)?this._unformat(t,e):this._format(t,e),this.selection.restoreMarkers(),e},indent:function(){var t=this.selection.isCollapsed(),e=this.selection.getCurrent(),i=this.inspector.parse(e),n=!!i.isList()&&i.getListItem(),r=$R.dom(n),o=r.prevElement(),a=o.get();if(t&&n&&a&&"LI"===a.tagName){this.selection.saveMarkers();var s=(o=$R.dom(a)).children("ul, ol"),l=r.closest("ul, ol");if(0!==s.length)s.append(r);else{var c=l.get().tagName.toLowerCase(),h=$R.dom("<"+c+">");h.append(r),o.append(h)}this.selection.restoreMarkers()}},outdent:function(){var t=this.selection.isCollapsed(),e=this.selection.getCurrent(),i=this.inspector.parse(e),n=!!i.isList()&&i.getListItem(),r=$R.dom(n);if(t&&n){var o,a,s,l=r.parent(),c=l.closest("li",".redactor-in-"+this.uuid),h=r.prevElement(),u=r.nextElement(),d=h.get(),p=u.get(),f=!1===d,m=!1!==d&&!1!==p,g=!f&&!1===p;if(this.selection.saveMarkers(),0!==c.length)if(m){o=this._getAllNext(r.get()),s=$R.dom("<"+l.get().tagName.toLowerCase()+">");for(var v=0;v<o.length;v++)s.append(o[v]);c.after(r),r.append(s)}else c.after(r),0===l.children().length?l.remove():f&&r.append(l);else{var b=this._createUnformatContainer(r),_=b.find("ul, ol").first();if(f)l.before(b);else if(g)l.after(b);else if(m){for(s=$R.dom("<"+l.get().tagName.toLowerCase()+">"),o=this._getAllNext(r.get()),v=0;v<o.length;v++)s.append(o[v]);l.after(b),b.after(s)}0!==_.length&&((a=b.nextElement().get())&&a.tagName===l.get().tagName?($R.dom(a).prepend(_),_.unwrap()):b.after(_)),r.remove()}this.selection.restoreMarkers()}},_getAllNext:function(t){for(var e=[];t;){if(!(t=$R.dom(t).nextElement().get()))return e;e.push(t)}return e},_isUnformat:function(t,e){for(var i=0,n=0;n<e.length;n++)if(3!==e[n].nodeType){var r=e[n].tagName.toLowerCase();r!==t&&"figure"!==r||i++}return i===e.length},_format:function(t,e){var i=this._uniteBlocks(e,["p","div","blockquote","pre","h1","h2","h3","h4","h5","h6","ul","ol"]),n=[];for(var r in i){for(var o=i[r],a=this._createList(t,i[r]),s=0;s<o.length;s++){var l;if(3===o[s].nodeType||"UL"!==o[s].tagName&&"OL"!==o[s].tagName){var c=(l=this._createListItem(o[s])).get().lastChild;c&&"BR"===c.tagName&&$R.dom(c).remove(),this.utils.normalizeTextNodes(l),a.append(l)}else{var h=$R.dom(o[s]);l=h.contents(),a.append(l),this.utils.isEmpty(h)&&h.remove()}}n.push(a.get())}return n},_uniteBlocks:function(t,e){for(var i=0,n={0:[]},r=!1,o=0;o<t.length;o++){var a=$R.dom(t[o]).closest("th, td");0!==a.length?(a.get()!==r&&(n[++i]=[]),this._isUniteBlock(t[o],e)&&n[i].push(t[o])):this._isUniteBlock(t[o],e)?n[i].push(t[o]):n[++i]=[],r=a.get()}return n},_isUniteBlock:function(t,e){return 3===t.nodeType||-1!==e.indexOf(t.tagName.toLowerCase())},_createList:function(t,e){var i=e[e.length-1],n=$R.dom(i),r=$R.dom("<"+t+">");return n.after(r),r},_createListItem:function(t){var e=$R.dom("<li>");if(3===t.nodeType)e.append(t);else{var i=$R.dom(t);e.append(i.contents()),i.remove()}return e},_unformat:function(t,e){if(1===e.length){var i=$R.dom(e[0]),n=i.find("li"),r=this.selection.getNodes({tags:["li"]}),o=this.selection.getBlock(),a=$R.dom(o).closest("li");if(0===r.length&&0!==a.length&&(r=[a.get()]),r.length===n.length)return this._unformatEntire(e[0]);var s=this._getItemsPosition(n,r);if("Top"===s)return this._unformatAtSide("before",r,i);if("Bottom"===s)return r.reverse(),this._unformatAtSide("after",r,i);if("Middle"===s){var l=$R.dom(r[r.length-1]),c=!1,h=!1,u=$R.dom("<"+i.get().tagName.toLowerCase()+">");n.each((function(t){if(c){var e=$R.dom(t);0!==e.closest(".redactor-split-item").length||!1!==h&&0!==e.closest(h).length||e.addClass("redactor-split-item"),h=e}t===l.get()&&(c=!0)})),n.filter(".redactor-split-item").each((function(t){$R.dom(t).removeClass("redactor-split-item"),u.append(t)})),i.after(u),r.reverse();for(var d=0;d<r.length;d++){var p=$R.dom(r[d]),f=this._createUnformatContainer(p);i.after(f),f.find("ul, ol").remove(),p.remove()}return}}else for(d=0;d<e.length;d++)3!==e[d].nodeType&&e[d].tagName.toLowerCase()===t&&this._unformatEntire(e[d])},_unformatEntire:function(t){var e=$R.dom(t);e.find("li").each(function(t){var i=$R.dom(t),n=this._createUnformatContainer(i);i.remove(),e.before(n)}.bind(this)),e.remove()},_unformatAtSide:function(t,e,i){for(var n=this,r=function(r){var o=$R.dom(e[r]),a=n._createUnformatContainer(o);i[t](a);var s=a.find("ul, ol").first();o.append(s),s.each((function(t){var i=$R.dom(t),n=i.closest("li");n.get()===e[r]&&(i.unwrap(),n.addClass("r-unwrapped"))})),n.utils.isEmptyHtml(o.html())&&o.remove()},o=0;o<e.length;o++)r(o);i.find(".r-unwrapped").each((function(t){var e=$R.dom(t);""===e.html().trim()?e.remove():e.removeClass("r-unwrapped")}))},_getItemsPosition:function(t,e){var i="Middle",n=e[0],r=e[e.length-1],o=t.first().get(),a=t.last().get();return o===n&&a!==r?i="Top":o!==n&&a===r&&(i="Bottom"),i},_createUnformatContainer:function(t){var e=$R.dom("<"+this.opts.markup+">");return this.opts.breakline&&e.attr("data-redactor-tag","br"),e.append(t.contents()),e},_getBlocks:function(){return this.selection.getBlocks({first:!0})},_observeButton:function(){var t=this.selection.getCurrent(),e=this.inspector.parse(t),i=e.isPre()||e.isCode()||e.isFigcaption();this._observeButtonsList(i,["lists","ul","ol","outdent","indent"]);var n=this.toolbar.getButton("outdent"),r=this.toolbar.getButton("indent");this._observeIndent(r,n)},_observeDropdown:function(t){var e=t.getItem("outdent"),i=t.getItem("indent");this._observeIndent(i,e)},_observeIndent:function(t,e){var i=this.selection.isCollapsed(),n=this.selection.getCurrent(),r=this.inspector.parse(n),o=!!r.isList()&&r.getListItem(),a=$R.dom(o).prevElement().get(),s=i&&o&&a&&"LI"===a.tagName;e&&(o&&i?e.enable():e.disable()),t&&(o&&s?t.enable():t.disable())},_observeButtonsList:function(t,e){for(var i=0;i<e.length;i++){var n=this.toolbar.getButton(e[i]);n&&(t?n.disable():n.enable())}}}),$R.add("class","video.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},_init:function(t){if(void 0!==t){var e=$R.dom(t).closest("figure");0!==e.length?this.parse(e):(this.parse("<figure>"),this.append(t))}else this.parse("<figure>");this._initWrapper()},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"video",tabindex:"-1",contenteditable:!1})}}),$R.add("class","widget.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},getData:function(){return{html:this._getHtml()}},_init:function(t){if(void 0!==t){var e=$R.dom(t).closest("figure");0!==e.length?this.parse(e):(this.parse("<figure>"),this.html(t))}else this.parse("<figure>");this._initWrapper()},_getHtml:function(){var t=$R.dom("<div>");return t.html(this.html()),t.find(".redactor-component-caret").remove(),t.html()},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"widget",tabindex:"-1",contenteditable:!1})}}),$R.add("plugin","table",{translations:{en:{table:"Table","insert-table":"Insert table","insert-row-above":"Insert row above","insert-row-below":"Insert row below","insert-column-left":"Insert column left","insert-column-right":"Insert column right","add-head":"Add head","delete-head":"Delete head","delete-column":"Delete column","delete-row":"Delete row","delete-table":"Delete table"}},init:function(t){this.app=t,this.lang=t.lang,this.opts=t.opts,this.caret=t.caret,this.editor=t.editor,this.toolbar=t.toolbar,this.component=t.component,this.inspector=t.inspector,this.insertion=t.insertion,this.selection=t.selection},ondropdown:{table:{observe:function(t){this._observeDropdown(t)}}},onbottomclick:function(){this.insertion.insertToEnd(this.editor.getLastNode(),"table")},start:function(){var t={observe:"table","insert-table":{title:this.lang.get("insert-table"),api:"plugin.table.insert"},"insert-row-above":{title:this.lang.get("insert-row-above"),classname:"redactor-table-item-observable",api:"plugin.table.addRowAbove"},"insert-row-below":{title:this.lang.get("insert-row-below"),classname:"redactor-table-item-observable",api:"plugin.table.addRowBelow"},"insert-column-left":{title:this.lang.get("insert-column-left"),classname:"redactor-table-item-observable",api:"plugin.table.addColumnLeft"},"insert-column-right":{title:this.lang.get("insert-column-right"),classname:"redactor-table-item-observable",api:"plugin.table.addColumnRight"},"add-head":{title:this.lang.get("add-head"),classname:"redactor-table-item-observable",api:"plugin.table.addHead"},"delete-head":{title:this.lang.get("delete-head"),classname:"redactor-table-item-observable",api:"plugin.table.deleteHead"},"delete-column":{title:this.lang.get("delete-column"),classname:"redactor-table-item-observable",api:"plugin.table.deleteColumn"},"delete-row":{title:this.lang.get("delete-row"),classname:"redactor-table-item-observable",api:"plugin.table.deleteRow"},"delete-table":{title:this.lang.get("delete-table"),classname:"redactor-table-item-observable",api:"plugin.table.deleteTable"}},e={title:this.lang.get("table")},i=this.toolbar.addButtonBefore("link","table",e);i.setIcon('<i class="re-icon-table"></i>'),i.setDropdown(t)},insert:function(){for(var t=this.component.create("table"),e=0;e<2;e++)t.addRow(3);t=this.insertion.insertHtml(t),this.caret.setStart(t)},addRowAbove:function(){var t=this._getComponent();if(t){var e=this.selection.getCurrent(),i=t.addRowTo(e,"before");this.caret.setStart(i)}},addRowBelow:function(){var t=this._getComponent();if(t){var e=this.selection.getCurrent(),i=t.addRowTo(e,"after");this.caret.setStart(i)}},addColumnLeft:function(){var t=this._getComponent();if(t){var e=this.selection.getCurrent();this.selection.save(),t.addColumnTo(e,"left"),this.selection.restore()}},addColumnRight:function(){var t=this._getComponent();if(t){var e=this.selection.getCurrent();this.selection.save(),t.addColumnTo(e,"right"),this.selection.restore()}},addHead:function(){var t=this._getComponent();t&&(this.selection.save(),t.addHead(),this.selection.restore())},deleteHead:function(){var t=this._getComponent();if(t){var e=this.selection.getCurrent();0!==$R.dom(e).closest("thead").length?(t.removeHead(),this.caret.setStart(t)):(this.selection.save(),t.removeHead(),this.selection.restore())}},deleteColumn:function(){var t=this._getComponent();if(t){var e=this.selection.getCurrent(),i=$R.dom(e).closest("td, th"),n=i.nextElement().get(),r=i.prevElement().get();t.removeColumn(e),n?this.caret.setStart(n):r?this.caret.setEnd(r):this.deleteTable()}},deleteRow:function(){var t=this._getComponent();if(t){var e=this.selection.getCurrent(),i=$R.dom(e).closest("tr"),n=i.nextElement().get(),r=i.prevElement().get();t.removeRow(e),n?this.caret.setStart(n):r?this.caret.setEnd(r):this.deleteTable()}},deleteTable:function(){var t=this._getTable();t&&this.component.remove(t)},_getTable:function(){var t=this.selection.getCurrent(),e=this.inspector.parse(t);if(e.isTable())return e.getTable()},_getComponent:function(){var t=this.selection.getCurrent(),e=this.inspector.parse(t);if(e.isTable()){var i=e.getTable();return this.component.create("table",i)}},_observeDropdown:function(t){var e=this._getTable(),i=t.getItemsByClass("redactor-table-item-observable"),n=t.getItem("insert-table");e?(this._observeItems(i,"enable"),n.disable()):(this._observeItems(i,"disable"),n.enable())},_observeItems:function(t,e){for(var i=0;i<t.length;i++)t[i][e]()}}),$R.add("class","table.component",{mixins:["dom","component"],init:function(t,e){return this.app=t,e&&void 0!==e.cmnt?e:this._init(e)},addHead:function(){this.removeHead();var t=this.$element.find("tr").first().children("td, th").length,e=$R.dom("<thead>"),i=this._buildRow(t,"<th>");e.append(i),this.$element.prepend(e)},addRow:function(t){var e=this._buildRow(t);return this.$element.append(e),e},addRowTo:function(t,e){return this._addRowTo(t,e)},addColumnTo:function(t,e){var i=$R.dom(t),n=i.closest("tr"),r=i.closest("td, th"),o=0;n.find("td, th").each((function(t,e){t===r.get()&&(o=e)})),this.$element.find("tr").each((function(t){var i=$R.dom(t).find("td, th").get(o),n=$R.dom(i),r=n.clone();r.html('<div data-redactor-tag="tbr"></div>'),"right"===e?n.after(r):n.before(r)}))},removeHead:function(){var t=this.$element.find("thead");0!==t.length&&t.remove()},removeRow:function(t){$R.dom(t).closest("tr").remove()},removeColumn:function(t){var e=$R.dom(t),i=e.closest("tr"),n=e.closest("td, th"),r=0;i.find("td, th").each((function(t,e){t===n.get()&&(r=e)})),this.$element.find("tr").each((function(t){var e=$R.dom(t).find("td, th").get(r);$R.dom(e).remove()}))},_init:function(t){var e,i;if(void 0!==t){var n=$R.dom(t),r=n.get(),o=n.closest("figure");0!==o.length?(e=o,i=o.find("table").get()):"TABLE"===r.tagName&&(i=r)}this._buildWrapper(e),this._buildElement(i),this._initWrapper()},_addRowTo:function(t,e){var i=$R.dom(t).closest("tr");if(0!==i.length){var n=i.children("td, th").length,r=this._buildRow(n);return i[e](r),r}},_buildRow:function(t,e){e=e||"<td>";for(var i=$R.dom("<tr>"),n=0;n<t;n++){var r=$R.dom(e);r.attr("contenteditable",!0),r.html('<div data-redactor-tag="tbr"></div>'),i.append(r)}return i},_buildElement:function(t){t?this.$element=$R.dom(t):(this.$element=$R.dom("<table>"),this.append(this.$element))},_buildWrapper:function(t){t=t||"<figure>",this.parse(t)},_initWrapper:function(){this.addClass("redactor-component"),this.attr({"data-redactor-type":"table",tabindex:"-1",contenteditable:!1}),this.app.detector.isIe()&&this.removeAttr("contenteditable")}}),$R.add("plugin","fontsize",{translations:{en:{size:"Size","remove-size":"Remove Font Size"}},init:function(t){this.app=t,this.lang=t.lang,this.inline=t.inline,this.toolbar=t.toolbar,this.sizes=[10,11,12,14,16,18,20,24,28,30]},start:function(){for(var t={},e=0;e<this.sizes.length;e++){var i=this.sizes[e];t[e]={title:i+"px",api:"plugin.fontsize.set",args:i}}t.remove={title:this.lang.get("remove-size"),api:"plugin.fontsize.remove"};var n=this.toolbar.addButton("fontsize",{title:this.lang.get("size")});n.setIcon('<i class="re-icon-fontsize"></i>'),n.setDropdown(t)},set:function(t){var e={tag:"span",style:{"font-size":t+"px"},type:"toggle"};this.inline.format(e)},remove:function(){this.inline.remove({style:"font-size"})}}),$R.add("plugin","fontcolor",{translations:{en:{fontcolor:"Text Color",text:"Text",highlight:"Highlight"}},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.inline=t.inline,this.toolbar=t.toolbar,this.selection=t.selection,this.colors=this.opts.fontcolors?this.opts.fontcolors:["#ffffff","#000000","#eeece1","#1f497d","#4f81bd","#c0504d","#9bbb59","#8064a2","#4bacc6","#f79646","#ffff00","#f2f2f2","#7f7f7f","#ddd9c3","#c6d9f0","#dbe5f1","#f2dcdb","#ebf1dd","#e5e0ec","#dbeef3","#fdeada","#fff2ca","#d8d8d8","#595959","#c4bd97","#8db3e2","#b8cce4","#e5b9b7","#d7e3bc","#ccc1d9","#b7dde8","#fbd5b5","#ffe694","#bfbfbf","#3f3f3f","#938953","#548dd4","#95b3d7","#d99694","#c3d69b","#b2a2c7","#b7dde8","#fac08f","#f2c314","#a5a5a5","#262626","#494429","#17365d","#366092","#953734","#76923c","#5f497a","#92cddc","#e36c09","#c09100","#7f7f7f","#0c0c0c","#1d1b10","#0f243e","#244061","#632423","#4f6128","#3f3151","#31859b","#974806","#7f6000"]},onfontcolor:{set:function(t,e){this._set(t,e)},remove:function(t){this._remove(t)}},start:function(){var t={title:this.lang.get("fontcolor")},e=this._buildDropdown();this.$button=this.toolbar.addButton("fontcolor",t),this.$button.setIcon('<i class="re-icon-fontcolor"></i>'),this.$button.setDropdown(e)},_buildDropdown:function(){var t=$R.dom('<div class="redactor-dropdown-cells">');return this.$selector=this._buildSelector(),this.$selectorText=this._buildSelectorItem("text",this.lang.get("text")),this.$selectorText.addClass("active"),this.$selectorBack=this._buildSelectorItem("back",this.lang.get("highlight")),this.$selector.append(this.$selectorText),this.$selector.append(this.$selectorBack),this.$pickerText=this._buildPicker("textcolor"),this.$pickerBack=this._buildPicker("backcolor"),t.append(this.$selector),t.append(this.$pickerText),t.append(this.$pickerBack),this._buildSelectorEvents(),t.width(242),t},_buildSelector:function(){var t=$R.dom("<div>");return t.addClass("redactor-dropdown-selector"),t},_buildSelectorItem:function(t,e){var i=$R.dom("<span>");return i.attr("rel",t).html(e),i.addClass("redactor-dropdown-not-close"),i},_buildSelectorEvents:function(){this.$selectorText.on("mousedown",function(t){t.preventDefault(),this.$selector.find("span").removeClass("active"),this.$pickerBack.hide(),this.$pickerText.show(),this.$selectorText.addClass("active")}.bind(this)),this.$selectorBack.on("mousedown",function(t){t.preventDefault(),this.$selector.find("span").removeClass("active"),this.$pickerText.hide(),this.$pickerBack.show(),this.$selectorBack.addClass("active")}.bind(this))},_buildPicker:function(t){for(var e=$R.dom('<div class="re-dropdown-box-'+t+'">'),i="backcolor"==t?"background-color":"color",n=this.colors.length,r=this,o=function(t){t.preventDefault();var e=$R.dom(t.target);r._set(e.data("rule"),e.attr("rel"))},a=0;a<n;a++){var s=this.colors[a],l=$R.dom("<span>");l.attr({rel:s,"data-rule":i}),l.css({"background-color":s,"font-size":0,border:"2px solid #fff",width:"22px",height:"22px"}),l.on("mousedown",o),e.append(l)}var c=$R.dom("<a>");return c.attr({href:"#"}),c.css({display:"block",clear:"both",padding:"8px 5px","font-size":"12px","line-height":1}),c.html(this.lang.get("none")),c.on("click",(function(t){t.preventDefault(),r._remove(i)})),e.append(c),"backcolor"==t&&e.hide(),e},_set:function(t,e){var i={};i[t]=e;var n={tag:"span",style:i,type:"toggle"};this.inline.format(n)},_remove:function(t){this.inline.remove({style:t})}}),$R.add("plugin","video",{translations:{en:{video:"Video","video-html-code":"Video Embed Code or Youtube/Vimeo Link"}},modals:{video:'<form action="">                     <div class="form-item">                         <label for="modal-video-input">## video-html-code ##</label>                         <textarea id="modal-video-input" name="video" style="height: 160px;"></textarea>                     </div>                 </form>'},init:function(t){this.app=t,this.lang=t.lang,this.opts=t.opts,this.toolbar=t.toolbar,this.component=t.component,this.insertion=t.insertion,this.inspector=t.inspector},onmodal:{video:{opened:function(t,e){e.getField("video").focus()},insert:function(t,e){var i=e.getData();this._insert(i)}}},oncontextbar:function(t,e){var i=this.inspector.parse(t.target);if(i.isComponentType("video")){var n=i.getComponent(),r={remove:{title:this.lang.get("delete"),api:"plugin.video.remove",args:n}};e.set(t,n,r,"bottom")}},start:function(){var t={title:this.lang.get("video"),api:"plugin.video.open"};this.toolbar.addButtonAfter("image","video",t).setIcon('<i class="re-icon-video"></i>')},open:function(){var t={title:this.lang.get("video"),width:"600px",name:"video",handle:"insert",commands:{insert:{title:this.lang.get("insert")},cancel:{title:this.lang.get("cancel")}}};this.app.api("module.modal.build",t)},remove:function(t){this.component.remove(t)},_insert:function(t){if(this.app.api("module.modal.close"),""!==t.video.trim()&&(t.video=this._matchData(t.video),this._isVideoIframe(t.video))){var e=this.component.create("video",t.video);this.insertion.insertHtml(e)}},_isVideoIframe:function(t){return null!==t.match(/<iframe|<video/gi)},_matchData:function(t){var e='<iframe style="width: 500px; height: 281px;" src="',i='" frameborder="0" allowfullscreen></iframe>';if(this._isVideoIframe(t)){var n=["iframe","video","source"];t=(t=t.replace(/<p(.*?[^>]?)>([\w\W]*?)<\/p>/gi,"")).replace(/<\/?([a-z][a-z0-9]*)\b[^>]*>/gi,(function(t,e){return-1===n.indexOf(e.toLowerCase())?"":t}))}else t.match(this.opts.regex.youtube)?t=t.replace(this.opts.regex.youtube,e+"//www.youtube.com/embed/$1"+i):t.match(this.opts.regex.vimeo)&&(t=t.replace(this.opts.regex.vimeo,e+"//player.vimeo.com/video/$2"+i));return t}}),$R.add("plugin","fullscreen",{translations:{en:{fullscreen:"Fullscreen"}},init:function(t){this.app=t,this.opts=t.opts,this.lang=t.lang,this.$win=t.$win,this.$doc=t.$doc,this.$body=t.$body,this.editor=t.editor,this.toolbar=t.toolbar,this.container=t.container,this.selection=t.selection,this.isOpen=!1,this.docScroll=0},start:function(){var t={title:this.lang.get("fullscreen"),api:"plugin.fullscreen.toggle"};this.toolbar.addButton("fullscreen",t).setIcon('<i class="re-icon-expand"></i>'),this.$target=this.toolbar.isTarget()?this.toolbar.getTargetElement():this.$body,this.opts.fullscreen&&this.toggle()},toggle:function(){return this.isOpen?this.close():this.open()},open:function(){this.docScroll=this.$doc.scrollTop(),this._createPlacemarker(),this.selection.save();var t=this.container.getElement(),e=this.editor.getElement(),i=this.toolbar.isTarget()?$R.dom("body, html"):this.$target;this.opts.toolbarExternal&&this._buildInternalToolbar(),this.$target.prepend(t),this.$target.addClass("redactor-body-fullscreen"),t.addClass("redactor-box-fullscreen"),this.isTarget&&t.addClass("redactor-box-fullscreen-target"),i.css("overflow","hidden"),this.opts.maxHeight&&e.css("max-height",""),this.opts.minHeight&&e.css("min-height",""),this._resize(),this.$win.on("resize.redactor-plugin-fullscreen",this._resize.bind(this)),this.$doc.scrollTop(0),this.toolbar.getButton("fullscreen").setIcon('<i class="re-icon-retract"></i>'),this.selection.restore(),this.isOpen=!0,this.opts.zindex=1051},close:function(){this.isOpen=!1,this.opts.zindex=!1,this.selection.save();var t=this.container.getElement(),e=this.editor.getElement(),i=$R.dom("body, html");this.opts.toolbarExternal&&this._buildExternalToolbar(),this.$target.removeClass("redactor-body-fullscreen"),this.$win.off("resize.redactor-plugin-fullscreen"),i.css("overflow",""),t.removeClass("redactor-box-fullscreen redactor-box-fullscreen-target"),e.css("height","auto"),this.opts.minHeight&&e.css("minHeight",this.opts.minHeight),this.opts.maxHeight&&e.css("maxHeight",this.opts.maxHeight),this.toolbar.getButton("fullscreen").setIcon('<i class="re-icon-expand"></i>'),this._removePlacemarker(t),this.selection.restore(),this.$doc.scrollTop(this.docScroll)},_resize:function(){var t=this.toolbar.getElement(),e=this.editor.getElement(),i=this.$win.height()-t.height();e.height(i)},_buildInternalToolbar:function(){var t=this.toolbar.getWrapper(),e=this.toolbar.getElement();t.addClass("redactor-toolbar-wrapper"),t.append(e);var i=this.container.getElement();e.removeClass("redactor-toolbar-external"),i.prepend(t)},_buildExternalToolbar:function(){var t=this.toolbar.getWrapper(),e=this.toolbar.getElement();this.$external=$R.dom(this.opts.toolbarExternal),e.addClass("redactor-toolbar-external"),this.$external.append(e),t.remove()},_createPlacemarker:function(){var t=this.container.getElement();this.$placemarker=$R.dom("<span />"),t.after(this.$placemarker)},_removePlacemarker:function(t){this.$placemarker.before(t),this.$placemarker.remove()}}),$R.add("plugin","inlinestyle",{translations:{en:{style:"Style"}},init:function(t){this.app=t,this.lang=t.lang,this.toolbar=t.toolbar,this.styles={marked:{title:"Marked",args:"mark"},code:{title:"Code",args:"code"},variable:{title:"Variable",args:"var"},shortcut:{title:"Shortcut",args:"kbd"},sup:{title:"Superscript",args:"sup"},sub:{title:"Subscript",args:"sub"}}},start:function(){var t={};for(var e in this.styles){var i=this.styles[e];t[e]={title:i.title,api:"module.inline.format",args:i.args}}var n=this.toolbar.addButtonAfter("format","inline",{title:this.lang.get("style")});n.setIcon('<i class="re-icon-inline"></i>'),n.setDropdown(t)}}),$R.add("plugin","mathequation",{translations:{en:{mathequation:"Math Equation",desc:"Simple Equation Formats:<br><br>1. \\( \\frac { dy }{ dx } \\sin { 2x } \\) <br><br>2. \\[ \\frac { dy }{ dx } \\sin { 2x } \\]"}},init:function(t){this.app=t,this.lang=t.lang,this.toolbar=t.toolbar},start:function(){var t={title:this.lang.get("desc"),icon:"<span>"+this.lang.get("mathequation")+"</span>",api:"plugin.mathequation.toggle"};this.toolbar.addButton("mathequation",t)},toggle:function(){window.open("https://arachnoid.com/latex/","_blank")}});var Redactor=$R;window.Redactor=window.$R=$R,window.addEventListener("load",(function(){$R("[data-redactor]")})),module.exports&&(module.exports=Redactor,module.exports.Redactor=Redactor)}()},74498:function(){},41173:function(){},84712:function(){}}]);